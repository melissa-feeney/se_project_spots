(self.webpackJsonp_N_E=self.webpackJsonp_N_E||[]).push([[23],{"+24j":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioNotificationsEnabledController=t.NotificationBodyEnabledController=t.NotificationsEnabledController=void 0;var i=l(n("YUSd")),r=l(n("Zv/C")),o=l(n("2lBV")),s=l(n("Dkg+")),a=l(n("Gjrs")),c=l(n("5rM0")),u=l(n("BGZc")),d=n("Lk+r");function l(e){return e&&e.__esModule?e:{default:e}}function h(){var e=new d.PushProcessor(u.default.get()).getPushRuleById(".m.rule.master");return e?!e.enabled:(console.warn("No master push rule! Notifications are disabled for this user."),!1)}t.NotificationsEnabledController=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValueOverride",value:function(e,t,i,r){return!!n("1//W").isPossible()&&(null===i||"default"===r?h():i)}},{key:"onChange",value:function(e,t,i){var r=n("1//W");r.supportsDesktopNotifications()&&r.setEnabled(i)}}]),t}(c.default),t.NotificationBodyEnabledController=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValueOverride",value:function(e,t,i){return!!n("1//W").isPossible()&&(null===i?h():i)}}]),t}(c.default),t.AudioNotificationsEnabledController=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValueOverride",value:function(e,t,i){return!!n("1//W").isPossible()&&i}}]),t}(c.default)},"+Kg/":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAIAAAC0Ujn1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6REEyRTJCRkE3REREMTFFNUFBMTdCQzcyNkY4QzcxODciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6REEyRTJCRkI3REREMTFFNUFBMTdCQzcyNkY4QzcxODciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpEQTJFMkJGODdEREQxMUU1QUExN0JDNzI2RjhDNzE4NyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpEQTJFMkJGOTdEREQxMUU1QUExN0JDNzI2RjhDNzE4NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pi9a/+sAAAH6SURBVHja7JY9LENRFMf/Lc0rQWqxGQkDJRYDCQaDRSRitVhsYmkjNQgWgsRSUolFiFDfhIjvLqUVyuAjqZY01dRQbZVS6jVKlXffB21icN7w7j33nd8759x7z72iYDCI+IgYcZO/gD6xo6of2S1omULgmY+FiFeu7S7I2+D0hrsNJdDUx8jrpvEIl5YhHTZOYoE2WDBh+KpUTIIrXB5ohRYfkHIZ8pNCjT0rw/+EoVeOsf4Wuww2Nda70ScPD6mm2eeTFU2HrJx670iRmhh6H1vCinMnBrd/ih7V4+Dqq5KiIu32edz5haMfA2id5UiXw4PeVeFo9SYubrgnuWsZTo8QtOcBnYvRqgf6YRCvHx0LQtDdy1F7JCQumN2E+LZw4eSHdrjRw5RBCSEnT89QzfBDt83B9yisyo3t4uCSC33ugGaH2V5CL7sAdFamHQAop7kqX90AJowE35JQDmzcE31fa0ZFLsFruhJNkrgymFRY6sBwFhGt1H6uWeJvYwSz6lLkZUCahuIcIpquWVojE/rwCmvkKmy2hRu3Prb5/LS0EiPazVM2m6N9yFuRT2HEyvaZ3gyfH8lUNDqBq8CarmHiPBBFEIu/JaS2CJnpvz3GG8sglTAtPrsrqNCK9iw4c+BFyNUnhUJBJmoK0Vwp8ET/vz3FQl4FGAB7267RGnZmOQAAAABJRU5ErkJggg=="},"+eLZ":function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=o;var r=i(n("dZ+v"));n("uZMU");function o(e,t){this.retryAlgorithm=e||o.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||o.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function s(e){e._procFn&&r.forEach(r.filter(r.keys(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),u("Spinning up queue: '%s'",t),a(e,t)}))}function a(e,t){const n=function(e,t){const n=e._queues[t];if(!r.isArray(n))return null;return n[0]}(e,t);if(!n){const n=e._activeQueues.indexOf(t);return n>=0&&e._activeQueues.splice(n,1),void u("Stopping queue '%s' as it is now empty",t)}u("Queue '%s' has %s pending events",t,e._queues[t].length),Promise.resolve().then((()=>e._procFn(n.event))).then((function(i){c(e,t),u("Queue '%s' sent event %s",t,n.event.getId()),n.defer.resolve(i),a(e,t)}),(function(i){n.attempts+=1;const r=e.retryAlgorithm(n.event,n.attempts,i);u("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,i,n.event.getId(),r),-1===r?(u("Queue '%s' giving up on event %s",t,n.event.getId()),c(e,t),n.defer.reject(i),a(e,t)):setTimeout((function(){a(e,t)}),r)}))}function c(e,t){const n=e._queues[t];return r.isArray(n)?n.shift():null}function u(){false}o.prototype.getQueueForEvent=function(e){const t=this.queueAlgorithm(e);return t&&this._queues[t]?r.map(this._queues[t],(function(e){return e.event})):null},o.prototype.removeEventFromQueue=function(e){const t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;let n=!1;return r.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return n=!0,!0})),n},o.prototype.setProcessFunction=function(e){this._procFn=e,s(this)},o.prototype.queueEvent=function(e){const t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);const n=r.defer();return this._queues[t].push({event:e,defer:n,attempts:0}),u("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),s(this),n.promise},o.RETRY_BACKOFF_RATELIMIT=function(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n.cors)return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)},o.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},"/0WT":function(e,t,n){"use strict";var i=n("Dlk0"),r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.getDesktopCapturerSources=function(){return window.electron.getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})},t.setAudioOutput=function(e){w=e},t.setAudioInput=function(e){E=e},t.setVideoInput=function(e){I=e},t.createNewMatrixCall=function(e,t,n){if("undefined"===typeof window||"undefined"===typeof document)return null;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return s.logger.error("WebRTC is not supported in this browser / environment"),null}catch(a){return s.logger.error("Exception thrown when trying to access WebRTC",a),null}const i=!!n&&n.forceTURN,r={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e._forceTURN||i},o=new S(r);return e.reEmitter.reEmit(o,Object.values(f)),o},t.MatrixCall=t.CallError=t.CallErrorCode=t.CallEvent=t.CallParty=t.CallDirection=t.CallType=t.CallState=void 0;var o=r(n("M6nr")),s=n("uZMU"),a=n("hBZP"),c=i(n("dZ+v")),u=n("76wp"),d=n("ns36");let l,h,g,p,f,y;var m;t.CallState=l,function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(l||(t.CallState=l={})),t.CallType=h,function(e){e.Voice="voice",e.Video="video"}(h||(t.CallType=h={})),t.CallDirection=g,function(e){e.Inbound="inbound",e.Outbound="outbound"}(g||(t.CallDirection=g={})),t.CallParty=p,function(e){e.Local="local",e.Remote="remote"}(p||(t.CallParty=p={})),t.CallEvent=f,function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold"}(f||(t.CallEvent=f={})),t.CallErrorCode=y,function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout"}(y||(t.CallErrorCode=y={})),function(e){e.Audio="audio",e.Video="video"}(m||(m={}));class v extends Error{constructor(e,t,n){super(t+": "+n),(0,o.default)(this,"code",void 0),this.code=e}}function _(){return Date.now().toString()+(0,d.randomString)(16)}t.CallError=v;class S extends a.EventEmitter{constructor(e){super(),(0,o.default)(this,"roomId",void 0),(0,o.default)(this,"type",void 0),(0,o.default)(this,"callId",void 0),(0,o.default)(this,"state",void 0),(0,o.default)(this,"hangupParty",void 0),(0,o.default)(this,"hangupReason",void 0),(0,o.default)(this,"direction",void 0),(0,o.default)(this,"ourPartyId",void 0),(0,o.default)(this,"client",void 0),(0,o.default)(this,"forceTURN",void 0),(0,o.default)(this,"turnServers",void 0),(0,o.default)(this,"candidateSendQueue",void 0),(0,o.default)(this,"candidateSendTries",void 0),(0,o.default)(this,"sentEndOfCandidates",void 0),(0,o.default)(this,"peerConn",void 0),(0,o.default)(this,"localVideoElement",void 0),(0,o.default)(this,"remoteVideoElement",void 0),(0,o.default)(this,"remoteAudioElement",void 0),(0,o.default)(this,"screenSharingStream",void 0),(0,o.default)(this,"remoteStream",void 0),(0,o.default)(this,"localAVStream",void 0),(0,o.default)(this,"inviteOrAnswerSent",void 0),(0,o.default)(this,"waitForLocalAVStream",void 0),(0,o.default)(this,"config",void 0),(0,o.default)(this,"successor",void 0),(0,o.default)(this,"opponentMember",void 0),(0,o.default)(this,"opponentVersion",void 0),(0,o.default)(this,"opponentPartyId",void 0),(0,o.default)(this,"opponentCaps",void 0),(0,o.default)(this,"inviteTimeout",void 0),(0,o.default)(this,"remoteOnHold",void 0),(0,o.default)(this,"unholdingRemote",void 0),(0,o.default)(this,"micMuted",void 0),(0,o.default)(this,"vidMuted",void 0),(0,o.default)(this,"callStatsAtEnd",void 0),(0,o.default)(this,"makingOffer",void 0),(0,o.default)(this,"ignoreOffer",void 0),(0,o.default)(this,"remoteCandidateBuffer",new Map),(0,o.default)(this,"gotUserMediaForInvite",(async e=>{if(this.successor)return void this.successor.gotUserMediaForAnswer(e);if(this.callHasEnded())return void this.stopAllMedia();this.localAVStream=e,s.logger.info("Got local AV stream with id "+this.localAVStream.id),this.setState(l.CreateOffer),s.logger.debug("gotUserMediaForInvite -> "+this.type);const t=this.getLocalVideoElement();if(t&&this.type===h.Video){t.autoplay=!0,this.screenSharingStream?(s.logger.debug("Setting screen sharing stream to the local video element"),t.srcObject=this.screenSharingStream):t.srcObject=e,t.muted=!0;try{await t.play()}catch(n){s.logger.info("Failed to play local video element",n)}}b(e.getAudioTracks(),!0);for(const i of e.getAudioTracks())s.logger.info("Adding audio track with id "+i.id),this.peerConn.addTrack(i,e);for(const i of(this.screenSharingStream||e).getVideoTracks())s.logger.info("Adding video track with id "+i.id),this.peerConn.addTrack(i,e)})),(0,o.default)(this,"gotUserMediaForAnswer",(async e=>{if(this.callHasEnded())return;const t=this.getLocalVideoElement();if(t&&this.type===h.Video){t.autoplay=!0,t.srcObject=e,t.muted=!0;try{await t.play()}catch(i){s.logger.info("Failed to play local video element",i)}}this.localAVStream=e,s.logger.info("Got local AV stream with id "+this.localAVStream.id),b(e.getAudioTracks(),!0);for(const o of e.getTracks())this.peerConn.addTrack(o,e);let n;this.setState(l.CreateAnswer);try{n=await this.peerConn.createAnswer()}catch(r){return s.logger.debug("Failed to create answer: ",r),void this.terminate(p.Local,y.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(n),this.setState(l.Connecting),await new Promise((e=>{setTimeout(e,200)})),this.sendAnswer()}catch(r){return s.logger.debug("Error setting local description!",r),void this.terminate(p.Local,y.SetLocalDescription,!0)}})),(0,o.default)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(s.logger.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}})),(0,o.default)(this,"onIceGatheringStateChange",(e=>{if(s.logger.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}})),(0,o.default)(this,"gotLocalOffer",(async e=>{if(s.logger.debug("Created offer: ",e),this.callHasEnded())return void s.logger.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(i){return s.logger.debug("Error setting local description!",i),void this.terminate(p.Local,y.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===l.CreateOffer?u.EventType.CallInvite:u.EventType.CallNegotiate,n={lifetime:6e4};this.state===l.CreateOffer?n.offer=this.peerConn.localDescription:n.description=this.peerConn.localDescription,this.client._supportsCallTransfer&&(n.capabilities={"m.call.transferee":!0}),s.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,n)}catch(r){s.logger.error("Failed to send invite",r),r.event&&this.client.cancelPendingEvent(r.event);let e=y.SignallingFailed,t="Signalling failed";return this.state===l.CreateOffer&&(e=y.SendInvite,t="Failed to send invite"),"UnknownDeviceError"==r.name&&(e=y.UnknownDevices,t="Unknown devices present in the room"),this.emit(f.Error,new v(e,t,r)),void this.terminate(p.Local,e,!1)}this.sendCandidateQueue(),this.state===l.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(l.InviteSent),this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=null,this.state===l.InviteSent&&this.hangup(y.InviteTimeout,!1)}),6e4))})),(0,o.default)(this,"getLocalOfferFailed",(e=>{s.logger.error("Failed to get local offer",e),this.emit(f.Error,new v(y.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(p.Local,y.LocalOfferFailed,!1)})),(0,o.default)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(s.logger.warn("Failed to get user media - ending call",e),this.emit(f.Error,new v(y.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(p.Local,y.NoUserMedia,!1))})),(0,o.default)(this,"onIceConnectionStateChanged",(()=>{this.callHasEnded()||(s.logger.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?this.setState(l.Connected):"failed"==this.peerConn.iceConnectionState&&this.hangup(y.IceFailed,!1))})),(0,o.default)(this,"onSignallingStateChanged",(()=>{s.logger.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)})),(0,o.default)(this,"onTrack",(e=>{0!==e.streams.length?this.remoteStream&&e.streams[0].id!==this.remoteStream.id?s.logger.warn(`Ignoring new stream ID ${e.streams[0].id}: we already have stream ID ${this.remoteStream.id}`):(this.remoteStream||s.logger.info("Got remote stream with id "+e.streams[0].id),this.remoteStream=e.streams[0],s.logger.debug(`Track id ${e.track.id} of kind ${e.track.kind} added`),"video"===e.track.kind?this.remoteVideoElement&&this.playRemoteVideo():this.remoteAudioElement&&this.playRemoteAudio()):s.logger.warn(`Streamless ${e.track.kind} found: ignoring.`)})),(0,o.default)(this,"onNegotiationNeeded",(async()=>{if(s.logger.info("Negotation is needed!"),this.state===l.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else s.logger.info("Opponent does not support renegotiation: ignoring negotiationneeded event")})),(0,o.default)(this,"onHangupReceived",(e=>{s.logger.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===l.Ringing?this.terminate(p.Remote,e.reason||y.UserHangup,!0):s.logger.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),(0,o.default)(this,"onRejectReceived",(e=>{s.logger.debug("Reject received for call ID "+this.callId);[l.InviteSent,l.Ringing].includes(this.state)||this.state===l.Fledgling&&this.direction===g.Inbound?this.terminate(p.Remote,y.UserHangup,!0):s.logger.debug(`Call is in state: ${this.state}: ignoring reject`)})),(0,o.default)(this,"onAnsweredElsewhere",(e=>{s.logger.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(p.Remote,y.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.client=e.client,this.type=null,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const t of this.turnServers)c.checkObjectHasKeys(t,["urls"]);this.callId=_(),this.state=l.Fledgling,this.candidateSendQueue=[],this.candidateSendTries=0,this.sentEndOfCandidates=!1,this.inviteOrAnswerSent=!1,this.makingOffer=!1,this.remoteOnHold=!1,this.unholdingRemote=!1,this.micMuted=!1,this.vidMuted=!1}async placeVoiceCall(){s.logger.debug("placeVoiceCall"),this.checkForErrorListener();const e=A(m.Audio);this.type=h.Voice,await this.placeCallWithConstraints(e)}async placeVideoCall(e,t){s.logger.debug("placeVideoCall"),this.checkForErrorListener(),this.localVideoElement=t,this.remoteVideoElement=e;const n=A(m.Video);this.type=h.Video,await this.placeCallWithConstraints(n)}async placeScreenSharingCall(e,t,n){s.logger.debug("placeScreenSharingCall"),this.checkForErrorListener(),this.localVideoElement=t,this.remoteVideoElement=e;try{var i;const e=await async function(e){var t;if(null!==(t=window.electron)&&void 0!==t&&t.getDesktopCapturerSources&&e){s.logger.debug("Electron getDesktopCapturerSources() is available...");const t=await e();return t?{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t.id}}}:null}return s.logger.debug("Electron desktopCapturer is not available..."),{audio:!1,video:!0}}(n);if(!e)return void this.terminate(p.Local,y.NoUserMedia,!1);null!==(i=window.electron)&&void 0!==i&&i.getDesktopCapturerSources?(s.logger.debug("Getting screen stream using getUserMedia()..."),this.screenSharingStream=await navigator.mediaDevices.getUserMedia(e)):(s.logger.debug("Getting screen stream using getDisplayMedia()..."),this.screenSharingStream=await navigator.mediaDevices.getDisplayMedia(e)),s.logger.debug("Got screen stream, requesting audio stream...");const t=A(m.Audio);this.placeCallWithConstraints(t)}catch(r){this.emit(f.Error,new v(y.NoUserMedia,"Failed to get screen-sharing stream: ",r)),this.terminate(p.Local,y.NoUserMedia,!1)}this.type=h.Video}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}getLocalVideoElement(){return this.localVideoElement}getRemoteVideoElement(){return this.remoteVideoElement}getRemoteAudioElement(){return this.remoteAudioElement}async setLocalVideoElement(e){if(this.localVideoElement=e,e&&this.localAVStream&&this.type===h.Video){e.autoplay=!0,e.srcObject=this.localAVStream,e.muted=!0;try{await e.play()}catch(t){s.logger.info("Failed to play local video element",t)}}}setRemoteVideoElement(e){e!==this.remoteVideoElement&&(e.autoplay=!0,this.remoteAudioElement&&(e.muted=!0),this.remoteVideoElement=e,this.remoteStream&&this.playRemoteVideo())}async setRemoteAudioElement(e){e!==this.remoteAudioElement&&(this.remoteAudioElement=e,this.remoteStream&&this.playRemoteAudio())}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];for(const n of e)t.push(n[1]);return t}async initWithInvite(e){const t=e.getContent();this.direction=g.Inbound;await this.client._checkTurnServers()||s.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(t.offer),await this.addBufferedIceCandidates()}catch(n){return s.logger.debug("Failed to set remote description",n),void this.terminate(p.Local,y.SetRemoteDescription,!1)}if(!this.remoteStream||0===this.remoteStream.getTracks().length)return s.logger.error("No remote stream or no tracks after setting remote description!"),void this.terminate(p.Local,y.SetRemoteDescription,!1);this.type=this.remoteStream.getTracks().some((e=>"video"===e.kind))?h.Video:h.Voice,this.setState(l.Ringing),e.getLocalAge()&&setTimeout((()=>{this.state==l.Ringing&&(s.logger.debug("Call invite has expired. Hanging up."),this.hangupParty=p.Remote,this.setState(l.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(f.Hangup))}),t.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(l.Ended)}async answer(){if(!this.inviteOrAnswerSent)if(s.logger.debug(`Answering call ${this.callId} of type ${this.type}`),this.localAVStream||this.waitForLocalAVStream)this.localAVStream?this.gotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&this.setState(l.WaitLocalMedia);else{const t=A(this.type==h.Video?m.Video:m.Audio);s.logger.log("Getting user media with constraints",t),this.setState(l.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const e=await navigator.mediaDevices.getUserMedia(t);this.waitForLocalAVStream=!1,this.gotUserMediaForAnswer(e)}catch(e){return void this.getUserMediaFailed(e)}}}replacedBy(e){s.logger.debug(this.callId+" being replaced by "+e.callId),this.state===l.WaitLocalMedia?(s.logger.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):(this.state===l.CreateOffer||this.state===l.InviteSent)&&(s.logger.debug("Handing local stream to new call"),e.gotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit(f.Replaced,e),this.hangup(y.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(s.logger.debug("Ending call "+this.callId),this.terminate(p.Local,e,!t),this.state===l.WaitLocalMedia)return;y.UserHangup,this.sendVoipEvent(u.EventType.CallHangup,{})}reject(){if(this.state!==l.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion<1)return s.logger.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(y.UserHangup,!0);s.logger.debug("Rejecting call: "+this.callId),this.terminate(p.Local,y.UserHangup,!0),this.sendVoipEvent(u.EventType.CallReject,{})}setLocalVideoMuted(e){this.vidMuted=e,this.updateMuteStatus()}isLocalVideoMuted(){return this.vidMuted}setMicrophoneMuted(e){this.micMuted=e,this.updateMuteStatus()}isMicrophoneMuted(){return this.micMuted}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e,e||(this.unholdingRemote=!0);for(const t of this.peerConn.getTransceivers())t.direction=e?"inactive":"sendrecv";this.updateMuteStatus(),e||this.playRemoteAudio(),this.emit(f.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==l.Connected)return!1;if(this.unholdingRemote)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){if(!this.localAVStream)return;const e=this.micMuted||this.remoteOnHold;b(this.localAVStream.getAudioTracks(),!e);const t=this.vidMuted||this.remoteOnHold;b(this.localAVStream.getVideoTracks(),!t),this.remoteOnHold?this.remoteAudioElement&&this.remoteAudioElement.srcObject===this.remoteStream?this.remoteAudioElement.muted=!0:this.remoteVideoElement&&this.remoteVideoElement.srcObject===this.remoteStream&&(this.remoteVideoElement.muted=!0):this.playRemoteAudio()}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type}};this.client._supportsCallTransfer&&(e.capabilities={"m.call.transferee":!0}),s.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(u.EventType.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(t){this.setState(l.Ringing),this.client.cancelPendingEvent(t.event);let e=y.SendAnswer,n="Failed to send answer";throw"UnknownDeviceError"==t.name&&(e=y.UnknownDevices,n="Unknown devices present in the room"),this.emit(f.Error,new v(e,n,t)),t}this.sendCandidateQueue()}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent().candidates;if(!t)return void s.logger.info("Ignoring candidates event with no candidates!");const n=0===e.getContent().version?null:e.getContent().party_id||null;if(void 0===this.opponentPartyId){s.logger.info(`Bufferring ${t.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(n)||[];return e.push(...t),void this.remoteCandidateBuffer.set(n,e)}this.partyIdMatches(e.getContent())?await this.addIceCandidates(t):s.logger.info(`Ignoring candidates from party ID ${e.getContent().party_id}: we have chosen party ID ${this.opponentPartyId}`)}async onAnswerReceived(e){if(s.logger.debug(`Got answer for call ID ${this.callId} from party ID ${e.getContent().party_id}`),this.callHasEnded())s.logger.debug(`Ignoring answer because call ID ${this.callId} has ended`);else if(void 0===this.opponentPartyId){this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(l.Connecting);try{await this.peerConn.setRemoteDescription(e.getContent().answer)}catch(t){return s.logger.debug("Failed to set remote description",t),void this.terminate(p.Local,y.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(u.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(n){s.logger.warn("Failed to send select_answer event",n)}}else s.logger.info(`Ignoring answer from party ID ${e.getContent().party_id}: we already have an answer/reject from ${this.opponentPartyId}`)}async onSelectAnswerReceived(e){if(this.direction!==g.Inbound)return void s.logger.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;void 0!==t&&null!==t?t!==this.ourPartyId&&(s.logger.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),this.terminate(p.Remote,y.AnsweredElsewhere,!0)):s.logger.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent().description;if(!t||!t.sdp||!t.type)return void s.logger.info("Ignoring invalid m.call.negotiate event");const n=this.direction===g.Inbound,i="offer"===t.type&&(this.makingOffer||"stable"!=this.peerConn.signalingState);if(this.ignoreOffer=!n&&i,this.ignoreOffer)return void s.logger.info("Ignoring colliding negotiate event because we're impolite");const r=this.isLocalOnHold();"answer"===t.type&&(this.unholdingRemote=!1);try{if(await this.peerConn.setRemoteDescription(t),"offer"===t.type){for(const t of this.peerConn.getTransceivers())t.direction=this.isRemoteOnHold()?"inactive":"sendrecv";const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e);for(const t of this.peerConn.getTransceivers())t.direction=t.currentDirection;this.sendVoipEvent(u.EventType.CallNegotiate,{description:this.peerConn.localDescription})}}catch(a){s.logger.warn("Failed to complete negotiation",a)}const o=this.isLocalOnHold();r!==o&&(this.emit(f.LocalHoldUnhold,o),this.emit(f.HoldUnhold,o))}callHasEnded(){return this.state===l.Ended}async playRemoteAudio(){this.remoteVideoElement&&(this.remoteVideoElement.muted=!0),this.remoteAudioElement.muted=!1,this.remoteAudioElement.srcObject=this.remoteStream;try{w&&(s.logger.info("Setting audio sink to "+w+", was "+this.remoteAudioElement.sinkId),await this.remoteAudioElement.setSinkId(w))}catch(e){s.logger.warn("Couldn't set requested audio output device: using default",e)}try{await this.remoteAudioElement.play()}catch(e){s.logger.error("Failed to play remote audio element",e)}}async playRemoteVideo(){this.remoteVideoElement.srcObject=this.remoteStream,s.logger.info("playing remote video. stream active? "+this.remoteStream.active);try{await this.remoteVideoElement.play()}catch(e){s.logger.info("Failed to play remote video element",e)}}setState(e){const t=this.state;this.state=e,this.emit(f.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:1,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===l.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===g.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}async transfer(e){const t=await this.client.getProfileInfo(e),n=_(),i={replacement_id:_(),target_user:{id:e,display_name:t.display_name,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(u.EventType.CallReplaces,i),await this.terminate(p.Local,y.Replaced,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),n=await this.client.getProfileInfo(this.getOpponentMember().userId),i=_(),r={replacement_id:_(),target_user:{id:this.getOpponentMember().userId,display_name:n.display_name,avatar_url:n.avatar_url},await_call:i};await e.sendVoipEvent(u.EventType.CallReplaces,r);const o={replacement_id:_(),target_user:{id:e.getOpponentMember().userId,display_name:t.display_name,avatar_url:t.avatar_url},create_call:i};await this.sendVoipEvent(u.EventType.CallReplaces,o),await this.terminate(p.Local,y.Replaced,!0),await e.terminate(p.Local,y.Replaced,!0)}async terminate(e,t,n){if(this.callHasEnded())return;this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null);const i=this.getRemoteVideoElement(),r=this.getRemoteAudioElement(),o=this.getLocalVideoElement();if(i&&(i.pause(),i.srcObject=null),r){r.pause(),r.srcObject=null;try{await this.remoteAudioElement.setSinkId("")}catch(a){s.logger.warn("Failed to set sink ID back to default")}}o&&(o.pause(),o.srcObject=null),this.hangupParty=e,this.hangupReason=t,this.setState(l.Ended),this.stopAllMedia(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),n&&this.emit(f.Hangup,this)}stopAllMedia(){if(s.logger.debug(`stopAllMedia (stream=${this.localAVStream})`),this.localAVStream)for(const e of this.localAVStream.getTracks())e.stop();if(this.screenSharingStream)for(const e of this.screenSharingStream.getTracks())e.stop();if(this.remoteStream)for(const e of this.remoteStream.getTracks())e.stop()}checkForErrorListener(){if(0===this.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};s.logger.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(u.EventType.CallCandidates,t)}catch(n){if(n.event&&this.client.cancelPendingEvent(n.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){s.logger.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",n);const e=y.SignallingFailed,t="Signalling failed";return this.emit(f.Error,new v(e,t,n)),void this.hangup(e,!1)}const t=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,s.logger.debug("Failed to send candidates. Retrying in "+t+"ms",n),setTimeout((()=>{this.sendCandidateQueue()}),t)}}async placeCallWithConstraints(e){s.logger.log("Getting user media with constraints",e),this.client._callEventHandler.calls.set(this.callId,this),this.setState(l.WaitLocalMedia),this.direction=g.Outbound,this.config=e;await this.client._checkTurnServers()||s.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection();try{const t=await navigator.mediaDevices.getUserMedia(e);this.gotUserMediaForInvite(t)}catch(t){return void this.getUserMediaFailed(t)}}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client._iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();s.logger.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(s.logger.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const n of e)if(null!==n.sdpMid&&void 0!==n.sdpMid||null!==n.sdpMLineIndex&&void 0!==n.sdpMLineIndex){s.logger.debug("Call "+this.callId+" got remote ICE "+n.sdpMid+" candidate: "+n.candidate);try{await this.peerConn.addIceCandidate(n)}catch(t){this.ignoreOffer||s.logger.info("Failed to add remote ICE candidate",t)}}else s.logger.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}}function b(e,t){for(let n=0;n<e.length;n++)e[n].enabled=t}function A(e){const t=!!navigator.webkitGetUserMedia;switch(e){case m.Audio:return{audio:{deviceId:E?{ideal:E}:void 0},video:!1};case m.Video:return{audio:{deviceId:E?{ideal:E}:void 0},video:{deviceId:I?{ideal:I}:void 0,width:t?{exact:640}:{ideal:640},height:t?{exact:360}:{ideal:360}}}}}let w,E,I;t.MatrixCall=S},"0PDV":function(e,t,n){"use strict";var i=n("Dlk0"),r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveAuth=d;var o=r(n("ly6l")),s=i(n("dZ+v")),a=n("uZMU");const c="m.login.email.identity",u="m.login.msisdn";function d(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}d.prototype={attemptAuth:function(){return new Promise(((e,t)=>{this._resolveFunc=e,this._rejectFunc=t;if(this._data&&this._data.flows)this._startNextAuthStage();else{this._busyChangedCallback&&this._busyChangedCallback(!0);let e=null;this._data.session&&(e={session:this._data.session}),this._doRequest(e).finally((()=>{this._busyChangedCallback&&this._busyChangedCallback(!1)}))}}))},poll:async function(){if(!this._data.session)return;if(!this._resolveFunc)return;if(this._submitPromise)return;let e={};if(this._currentStage==c&&this._emailSid){const t={sid:this._emailSid,client_secret:this._clientSecret};if(await this._matrixClient.doesServerRequireIdServerParam()){const e=o.default.parse(this._matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:c,threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){let t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow(){return this._chosenFlow},submitAuthDict:async function(e,t){if(!this._resolveFunc)throw new Error("submitAuthDict() called before attemptAuth()");for(!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);this._submitPromise;)try{await this._submitPromise}catch(i){}let n;this._data.session?(n={session:this._data.session},s.extend(n,e)):n=e;try{this._submitPromise=this._doRequest(n,t),await this._submitPromise}finally{this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1)}},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:async function(e,t){try{const n=await this._requestCallback(e,t);this._resolveFunc(n),this._resolveFunc=null,this._rejectFunc=null}catch(n){const e=n.data?n.data.flows:null,r=this._data.flows||Boolean(e);401===n.httpStatus&&n.data&&r||(t?a.logger.log("Background poll request failed doing UI auth: ignoring",n):this._rejectFunc(n)),n.data.flows||n.data.completed||n.data.session||(n.data.flows=this._data.flows,n.data.completed=this._data.completed,n.data.session=this._data.session),this._data=n.data;try{this._startNextAuthStage()}catch(i){this._rejectFunc(i),this._resolveFunc=null,this._rejectFunc=null}if(!this._emailSid&&!this._requestingEmailToken&&this._chosenFlow.stages.includes("m.login.email.identity")){this._requestingEmailToken=!0;try{const e=await this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);this._emailSid=e.sid}catch(i){this._rejectFunc(i),this._resolveFunc=null,this._rejectFunc=null}finally{this._requestingEmailToken=!1}}}},_startNextAuthStage:function(){const e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"===e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data&&this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});const t={};e==c&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),a.logger.log("Active flow => %s",JSON.stringify(this._chosenFlow));const e=this._firstUncompletedStage(this._chosenFlow);return a.logger.log("Next stage: %s",e),e},_chooseFlow:function(){const e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),n=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber);for(const r of e){let e=!1,i=!1;for(const t of r.stages)t===c?e=!0:t==u&&(i=!0);if(e==t&&i==n)return r}const i=new Error("No appropriate authentication flow found");throw i.name="NoAuthFlowFoundError",i.required_stages=[],t&&i.required_stages.push(c),n&&i.required_stages.push(u),i.available_flows=e,i},_firstUncompletedStage:function(e){const t=(this._data||{}).completed||[];for(let n=0;n<e.stages.length;++n){const i=e.stages[n];if(-1===t.indexOf(i))return i}}}},"0bNh":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAuRJREFUSA2tlj1oU1EUx/teTIoBxSpiMyWY1EEQRUE6xMGkTaRDpYuTgovQRQe1UHAoRQTroCAoguDgJFYHtcXmY5IgrpUOSpugAa2g4gcSJE0Tfyfm3ty80MQ2Xrg9/3s+/ufce0/uq9X1DyMSiRx2uVzTlmW5xb1SqZTBJ5LJ5Mt24XY7B7FDHlbksgbb5XJ5v+B2Y5PTYXBw8CQVjnR3d4/Nzs7mavbdTj98gkoXj8dDpVLpGokfpNPph0ov0jIX0Wj0HNWOiw6CXwRcoFIbOcHsNX3BH7FdRkqRU7Zte4npQo4nEon7ylcnoPJTkEwpw0alJGGMplKppwLMOxgWRaeDImX3xxWPTuB2uy+y5Z/KsFEJ+VePx3NJxbsUWFxc/OH3+3PcQUc74Q7OzM3NLShevQNRQL5ZGRxymcpG0R2QWcPLDp/qcnV1tcfUW7FYLCI9zdkFCTxCBTtNB/ByoVAYyGQy30x9OBzu8Xq9aXQ+Uw/HB7hS6JbAry26RxS6m0xnwVKt6ginjdhhQu849WpNbLXH1yQXRwheqQCnbGWrxdoNd+Ak+B9rW7bRigh7/1r2VjaJwV5xBYPBF8gFtvsOuQu51SRkfcjn803n8/nfpl4umX6/h26LqadhPrNOwDVDV95uOH8ubQTCW2ZADUubTmKr3ge4HzyBraGDxJcEZ3nwHtfiqg+VwvJQfSdYrw3gg1B3C9gwNUISFEyN9hwaGupdWVlJEbzDdFgvpkAp8hi7yEus7qJisXilU3IhhGMb4rpgGToBhpk1juev5zr+wvVEuevHLpfLvQmFQl9IMoCDXFYBfJ75jPVBAhq6Bf0n5hj6GeZRfDxCylt0leO5K1iGTiCLbDY7T5L3kG8n4DSOGRK/DQQCe2iAfeJjjCT2G2Lv6+t7TsxebDdNcvFt+ibzn8Ij9DL1IFlWL+pAfa+7+EQuoR6pm+pI30Fd1Yyofp7j0L94cJGjyDR7Nmv+AOmCNDWj3M87AAAAAElFTkSuQmCC"},"0c22":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0;const i=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"});t.SERVICE_TYPES=i},"1//W":function(e,t,n){"use strict";(function(t){var i=f(n("t3kO")),r=f(n("BGZc")),o=f(n("wrNs")),s=f(n("cfXf")),a=f(n("nE5R")),c=f(n("4ZFb")),u=f(n("v61F")),d=n("nPNV"),l=f(n("Uma8")),h=n("oOXF"),g=f(h),p=f(n("kPC3"));function f(e){return e&&e.__esModule?e:{default:e}}var y={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return s.default.textForEvent(e)},_displayPopupNotification:function(e,n){var i=o.default.get();if(i&&i.supportsNotifications()&&i.maySendNotifications()&&!t.document.hasFocus()){var r=this.notificationMessageForEvent(e);if(r){var s=void 0;e.sender&&n.name!==e.sender.name?"m.room.member"===e.getType()?s=n.name:e.sender&&(s=e.sender.name+" ("+n.name+")",e.getContent().body&&(r=e.getContent().body)):(s=n.name,e.getContent().body&&(r=e.getContent().body)),this.isBodyEnabled()||(r="");var c=a.default.avatarUrlForMember(e.sender,40,40,"crop"),u=i.displayNotification(s,r,c,n);u&&(void 0===this.notifsByRoom[e.getRoomId()]&&(this.notifsByRoom[e.getRoomId()]=[]),this.notifsByRoom[e.getRoomId()].push(u))}}},getSoundForRoom:async function(e){var t=g.default.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:r.default.get().mxcUrlToHttp(t.url),name:t.name,type:t.type,size:t.size}:(console.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(console.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){var n=await this.getSoundForRoom(t.roomId);console.log("Got sound "+(n&&n.name||"default")+" for "+t.roomId);try{var i=document.querySelector(n?"audio[src='"+n.url+"']":"#messageAudio"),r=i;if(!i){if(!n)return void console.error("No audio element or sound to play for notification");r=new Audio(n.url),n.type&&(r.type=n.type),document.body.appendChild(r)}await r.play()}catch(o){console.warn("Caught error when trying to fetch room notification sound:",o)}},start:function(){this.boundOnEvent=this.onEvent.bind(this),this.boundOnSyncStateChange=this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.onEventDecrypted.bind(this),r.default.get().on("event",this.boundOnEvent),r.default.get().on("Room.receipt",this.boundOnRoomReceipt),r.default.get().on("Event.decrypted",this.boundOnEventDecrypted),r.default.get().on("sync",this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){r.default.get()&&this.boundOnRoomTimeline&&(r.default.get().removeListener("Event",this.boundOnEvent),r.default.get().removeListener("Room.receipt",this.boundOnRoomReceipt),r.default.get().removeListener("Event.decrypted",this.boundOnEventDecrypted),r.default.get().removeListener("sync",this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){var e=o.default.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){var n=o.default.get();n&&(g.default.isLevelSupported(h.SettingLevel.DEVICE)&&g.default.setValue("audioNotificationsEnabled",null,h.SettingLevel.DEVICE,this.isEnabled()),e?n.requestNotificationPermission().then((function(e){if("granted"===e)t&&t(),c.default.dispatch({action:"notifier_enabled",value:!0});else{var n="denied"===e?(0,d._t)("Riot does not have permission to send you notifications - please check your browser settings"):(0,d._t)("Riot was not given permission to send notifications - please try again"),i=u.default.getComponent("dialogs.ErrorDialog");l.default.createTrackedDialog("Unable to enable Notifications",e,i,{title:(0,d._t)("Unable to enable Notifications"),description:n})}})):c.default.dispatch({action:"notifier_enabled",value:!1}),this.setToolbarHidden(!0))},isEnabled:function(){return this.isPossible()&&g.default.getValue("notificationsEnabled")},isPossible:function(){var e=o.default.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&g.default.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return this.isEnabled()&&g.default.getValue("audioNotificationsEnabled")},setToolbarHidden:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.toolbarHidden=e,c.default.dispatch({action:"notifier_enabled",value:this.isEnabled()}),t&&p.default&&p.default.setItem("notifications_hidden",e)},shouldShowToolbar:function(){var e=r.default.get();return!!e&&(!e.isGuest()&&this.supportsDesktopNotifications()&&!this.isEnabled()&&!this._isToolbarHidden())},_isToolbarHidden:function(){return p.default?"true"===p.default.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&(!e.sender||e.sender.userId!==r.default.get().credentials.userId))if(e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(!e.isDecryptionFailure()){var t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))}},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){var n=o.default.get();if(!n)return;if(void 0===this.notifsByRoom[t.roomId])return;var r=!0,s=!1,a=void 0;try{for(var c,u=(0,i.default)(this.notifsByRoom[t.roomId]);!(r=(c=u.next()).done);r=!0){var d=c.value;n.clearNotification(d)}}catch(l){s=!0,a=l}finally{try{!r&&u.return&&u.return()}finally{if(s)throw a}}delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){var t=r.default.get().getRoom(e.getRoomId()),n=r.default.get().getPushActionsForEvent(e);n&&n.notify&&(this.isEnabled()&&this._displayPopupNotification(e,t),n.tweaks.sound&&this.isAudioEnabled()&&(o.default.get().loudNotification(e,t),this._playAudioNotification(e,t)))}};t.mxNotifier||(t.mxNotifier=y),e.exports=t.mxNotifier}).call(this,n("bqPV"))},"1Tpr":function(e,t,n){"use strict";function i(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=i,i.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},i.prototype.getTimeline=function(){return this._timeline},i.prototype.getOurEventIndex=function(){return this._ourEventIndex},i.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},i.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},i.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)}},"24Dj":function(e,t,n){"use strict";n("EbPi");var i=n("8yKA");n.d(t,"e",(function(){return i.a})),n.d(t,"f",(function(){return i.c})),n.d(t,"g",(function(){return i.g})),n.d(t,"h",(function(){return i.h})),n.d(t,"i",(function(){return i.i})),n.d(t,"j",(function(){return i.k})),n.d(t,"k",(function(){return i.m}));var r=n("SDKZ");n.d(t,"a",(function(){return r.e})),n.d(t,"b",(function(){return r.k})),n.d(t,"c",(function(){return r.m})),n.d(t,"d",(function(){return r.n}))},"29T4":function(e,t,n){"use strict";var i=n("2Cuf"),r=n("WW3d"),o=n("TJNI");e.exports={formats:o,parse:r,stringify:i}},"2Cuf":function(e,t,n){"use strict";var i=n("OY4j"),r=n("TJNI"),o=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,c=Array.prototype.push,u=function(e,t){c.apply(e,a(t)?t:[t])},d=Date.prototype.toISOString,l=r.default,h={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:i.encode,encodeValuesOnly:!1,format:l,formatter:r.formatters[l],indices:!1,serializeDate:function(e){return d.call(e)},skipNulls:!1,strictNullHandling:!1},g=function e(t,n,r,o,s,c,d,l,g,p,f,y,m,v){var _,S=t;if("function"===typeof d?S=d(n,S):S instanceof Date?S=p(S):"comma"===r&&a(S)&&(S=i.maybeMap(S,(function(e){return e instanceof Date?p(e):e}))),null===S){if(o)return c&&!m?c(n,h.encoder,v,"key",f):n;S=""}if("string"===typeof(_=S)||"number"===typeof _||"boolean"===typeof _||"symbol"===typeof _||"bigint"===typeof _||i.isBuffer(S))return c?[y(m?n:c(n,h.encoder,v,"key",f))+"="+y(c(S,h.encoder,v,"value",f))]:[y(n)+"="+y(String(S))];var b,A=[];if("undefined"===typeof S)return A;if("comma"===r&&a(S))b=[{value:S.length>0?S.join(",")||null:void 0}];else if(a(d))b=d;else{var w=Object.keys(S);b=l?w.sort(l):w}for(var E=0;E<b.length;++E){var I=b[E],k="object"===typeof I&&void 0!==I.value?I.value:S[I];if(!s||null!==k){var R=a(S)?"function"===typeof r?r(n,I):n:n+(g?"."+I:"["+I+"]");u(A,e(k,R,r,o,s,c,d,l,g,p,f,y,m,v))}}return A};e.exports=function(e,t){var n,i=e,c=function(e){if(!e)return h;if(null!==e.encoder&&void 0!==e.encoder&&"function"!==typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||h.charset;if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=r.default;if("undefined"!==typeof e.format){if(!o.call(r.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var i=r.formatters[n],s=h.filter;return("function"===typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"===typeof e.addQueryPrefix?e.addQueryPrefix:h.addQueryPrefix,allowDots:"undefined"===typeof e.allowDots?h.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:h.charsetSentinel,delimiter:"undefined"===typeof e.delimiter?h.delimiter:e.delimiter,encode:"boolean"===typeof e.encode?e.encode:h.encode,encoder:"function"===typeof e.encoder?e.encoder:h.encoder,encodeValuesOnly:"boolean"===typeof e.encodeValuesOnly?e.encodeValuesOnly:h.encodeValuesOnly,filter:s,format:n,formatter:i,serializeDate:"function"===typeof e.serializeDate?e.serializeDate:h.serializeDate,skipNulls:"boolean"===typeof e.skipNulls?e.skipNulls:h.skipNulls,sort:"function"===typeof e.sort?e.sort:null,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:h.strictNullHandling}}(t);"function"===typeof c.filter?i=(0,c.filter)("",i):a(c.filter)&&(n=c.filter);var d,l=[];if("object"!==typeof i||null===i)return"";d=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var p=s[d];n||(n=Object.keys(i)),c.sort&&n.sort(c.sort);for(var f=0;f<n.length;++f){var y=n[f];c.skipNulls&&null===i[y]||u(l,g(i[y],y,p,c.strictNullHandling,c.skipNulls,c.encode?c.encoder:null,c.filter,c.sort,c.allowDots,c.serializeDate,c.format,c.formatter,c.encodeValuesOnly,c.charset))}var m=l.join(c.delimiter),v=!0===c.addQueryPrefix?"?":"";return c.charsetSentinel&&("iso-8859-1"===c.charset?v+="utf8=%26%2310003%3B&":v+="utf8=%E2%9C%93&"),m.length>0?v+m:""}},"2D+x":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAWCAYAAAAmaHdCAAAAAXNSR0IArs4c6QAAAbFJREFUOBFjZACCisNLBf/yMAYzMjCoMTAy8oPEUMC/f79Y/zB1tZpFPkYRh3IYIQYwVDH8Y9zL9J/leKdJ2Ed0hWXnljYxMDBy//v9Z0qPedx9dHkmkAtABnQbR+3AZgBIgxAbD7sij9AxJlaWnIqzq1QwDAF5gZvp5wl0CWQ+MzMTi7ukkb2ntMH2f4x/MsvOLtJElmcChUGDYeIHZEFsbEYmRnYHMc3AWGW7fQyMLCnlZ5bowtQxwRj4aF5Wrm83Pj4FKWHR4ZP2y1B1OfmfiSm+4vRyQ7AgPs0wOT0Bxc3HXl9LPvnmDgMTEzNI2JmDhfX3d8ZfySUnF/WywBTio61ElE79////+ctvnw3/Mf5jhand8OS00v2/LwSJMgSkiZGREZRGUNJJ2bnlGSA5osIEpBAfGDUEM3RGwwRLmPz7+/9jw/n5AphShEUYGf4L/PnP9IGJkYnh1lcmdgvCWlBVAJO81H8GBtGvjF8eszB/+b/2Lw9DVenZZQy4ikdk7bnbtrGzi39QZ2D8H8Hw79/qWSbpv4EFGxEFNbIpwEIbmBsf/f3/b2uvUcw1kBQAy+2RB0dlhYcAAAAASUVORK5CYII="},"2NLw":function(e,t,n){"use strict";function i(e,t){const n=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,i=Reflect.construct(Error,[n]);return Reflect.setPrototypeOf(i,Reflect.getPrototypeOf(this)),i.reason=e,i.value=t,i}function r(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.name="InvalidCryptoStoreError",n}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStoreError=i,t.InvalidCryptoStoreError=r,t.KeySignatureUploadError=void 0,i.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error),r.TOO_NEW="TOO_NEW",r.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(r,Error);class o extends Error{constructor(e,t){super(e),this.value=t}}t.KeySignatureUploadError=o},"2syV":function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.SyncApi=f;var r=n("D67U"),o=n("GqeV"),s=n("EfR+"),a=i(n("dZ+v")),c=n("uHjp"),u=n("apMS"),d=n("Lk+r"),l=n("uZMU"),h=n("2NLw");function g(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function p(...e){l.logger.log(...e)}function f(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoom=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function y(e,t){const n=new r.User(t);return e.reEmitter.reEmit(n,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),n}f.prototype.createRoom=function(e){const t=this.client,{timelineSupport:n,unstableClientRelationAggregation:i}=t,r=new o.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:n,unstableClientRelationAggregation:i});return t.reEmitter.reEmit(r,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(r),r},f.prototype.createGroup=function(e){const t=this.client,n=new s.Group(e);return t.reEmitter.reEmit(n,["Group.profile","Group.myMembership"]),t.store.storeGroup(n),n},f.prototype._registerStateListeners=function(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,n,i){i.user=t.getUser(i.userId),t.reEmitter.reEmit(i,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},f.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},f.prototype.syncLeftRooms=function(){const e=this.client,t=this,n=new c.Filter(this.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);const i=this.opts.pollTimeout+8e4,r={timeout:0};return e.getOrCreateFilter(g(e.credentials.userId,"LEFT_ROOMS"),n).then((function(t){return r.filter=t,e._http.authedRequest(void 0,"GET","/sync",r,void 0,i)})).then((function(n){let i=[];n.rooms&&n.rooms.leave&&(i=t._mapSyncResponseToRoomArray(n.rooms.leave));const r=[];return i.forEach((function(n){const i=n.room;if(r.push(i),!n.isBrandNewRoom)return;n.timeline=n.timeline||{};const o=t._mapSyncEventsFormat(n.timeline,i),s=t._mapSyncEventsFormat(n.state,i);i.getLiveTimeline().setPaginationToken(n.timeline.prev_batch,u.EventTimeline.BACKWARDS),t._processRoomEvents(i,s,o),i.recalculate(),e.store.storeRoom(i),e.emit("Room",i),t._processEventsForNotifs(i,o)})),r}))},f.prototype.peek=function(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((e=>{e.messages=e.messages||{},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const n=a.map(a.deepCopy(e.state),t.getEventMapper()),i=a.map(e.state,t.getEventMapper()),r=a.map(e.messages.chunk,t.getEventMapper());return e.presence&&a.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let n=t.store.getUser(e.getContent().user_id);n?n.setPresenceEvent(e):(n=y(t,e.getContent().user_id),n.setPresenceEvent(e),t.store.storeUser(n)),t.emit("event",e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(n),this._peekRoom.currentState.setStateEvents(i),this._resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(r.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit("Room",this._peekRoom),this._peekPoll(this._peekRoom),this._peekRoom}))},f.prototype.stopPeeking=function(){this._peekRoom=null},f.prototype._peekPoll=function(e,t){if(this._peekRoom!==e)return void p("Stopped peeking in room %s",e.roomId);const n=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(n._peekRoom!==e)return void p("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(n.client.getEventMapper()).forEach((function(e){let t=n.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=y(n.client,e.getContent().user_id),t.setPresenceEvent(e),n.client.store.storeUser(t)),n.client.emit("event",e)}));const i=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(n.client.getEventMapper());e.addLiveEvents(i),n._peekPoll(e,t.end)}),(function(i){l.logger.error("[%s] Peek poll failed: %s",e.roomId,i),setTimeout((function(){n._peekPoll(e,t)}),3e4)}))},f.prototype.getSyncState=function(){return this._syncState},f.prototype.getSyncStateData=function(){return this._syncStateData},f.prototype.recoverFromSyncStartupError=async function(e,t){await e;const n=this._startKeepAlives();this._updateSyncState("ERROR",{error:t}),await n},f.prototype._wasLazyLoadingToggled=async function(e){e=!!e;let t=!1;if(!(await this.client.store.isNewlyCreated())){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1},f.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(l.logger.warn("Token no longer valid - assuming logout"),this.stop(),!0)},f.prototype.sync=function(){const t=this.client,n=this;this._running=!0,e.window&&(this._onOnlineBound=this._onOnline.bind(this),e.window.addEventListener("online",this._onOnlineBound,!1));let i=Promise.resolve(),r=null;function o(){const e=new c.Filter(t.credentials.userId);return e.setTimelineLimit(n.opts.initialSyncLimit),e}const s=async()=>{if(p("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){p("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(p("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=o()),this.opts.filter.setLazyLoadMembers(!0)):(p("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}p("Checking whether lazy loading has changed in store...");if(await this._wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this._storeIsInvalid=!0;const e=h.InvalidStoreError.TOGGLED_LAZY_LOADING,t=new h.InvalidStoreError(e,!!this.opts.lazyLoadMembers);return this._updateSyncState("ERROR",{error:t}),void l.logger.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{p("Storing client options..."),await this.client._storeClientOptions(),p("Stored client options")}catch(e){throw l.logger.error("Storing client options failed",e),e}a()};async function a(){let e,s;p("Getting filter..."),e=n.opts.filter?n.opts.filter:o();try{s=await t.getOrCreateFilter(g(t.credentials.userId),e)}catch(c){if(l.logger.error("Getting filter failed",c),n._shouldAbortSync(c))return;return p("Waiting for saved sync before retrying filter..."),await n.recoverFromSyncStartupError(i,c),void a()}t.resetNotifTimelineSet(),null===n._currentSyncRequest&&(p("Sending first sync request..."),n._currentSyncRequest=n._doSyncRequest({filterId:s},r)),p("Waiting for saved sync before starting sync processing..."),await i,n._sync({filterId:s})}t.isGuest()?n._sync({}):(p("Getting saved sync token..."),i=t.store.getSavedSyncToken().then((e=>(p("Got saved sync token"),r=e,p("Getting saved sync..."),t.store.getSavedSync()))).then((e=>{if(p(`Got reply from saved sync, exists? ${!!e}`),e)return n._syncFromCache(e)})).catch((e=>{l.logger.error("Getting saved sync failed",e)})),async function e(){try{p("Getting push rules...");const e=await t.getPushRules();p("Got push rules"),t.pushRules=e}catch(r){if(l.logger.error("Getting push rules failed",r),n._shouldAbortSync(r))return;return p("Waiting for saved sync before retrying push rules..."),await n.recoverFromSyncStartupError(i,r),void e()}s()}())},f.prototype.stop=function(){p("SyncApi.stop"),e.window&&(e.window.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},f.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},f.prototype._syncFromCache=async function(e){p("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},i={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this._processSyncResponse(n,i)}catch(r){l.logger.error("Error processing cached sync",r.stack||r)}this._storeIsInvalid||this._updateSyncState("PREPARED",n)},f.prototype._sync=async function(e){const t=this.client;if(!this._running)return p("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");const n=t.store.getSyncToken();let i;try{null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,n)),i=await this._currentSyncRequest}catch(o){return void this._onSyncError(o,e)}finally{this._currentSyncRequest=null}t.store.setSyncToken(i.next_batch),this._failedSyncCount=0,await t.store.setSyncData(i);const r={oldSyncToken:n,nextSyncToken:i.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(r);try{await this._processSyncResponse(r,i)}catch(o){l.logger.error("Caught /sync error",o.stack||o),this.client.emit("sync.unexpectedError",o)}r.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",r),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(r),this._updateSyncState("SYNCING",r),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this._sync(e)},f.prototype._doSyncRequest=function(e,t){const n=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",n,void 0,n.timeout+8e4)},f.prototype._getSyncParams=function(e,t){let n=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,n=0);let i=e.filterId;this.client.isGuest()&&!i&&(i=this._getGuestFilter());const r={filter:i,timeout:n};return this.opts.disablePresence&&(r.set_presence="offline"),t?r.since=t:r._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(r.timeout=0),r},f.prototype._onSyncError=function(e,t){if(!this._running)return p("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");l.logger.error("/sync error %s",e),l.logger.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,l.logger.log("Number of consecutive failed sync requests:",this._failedSyncCount),p("Starting keep-alive"),this._startKeepAlives().then((e=>{e&&"ERROR"===this.getSyncState()&&this._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this._sync(t)})),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},f.prototype._processSyncResponse=async function(e,t){const n=this.client,i=this;if(t.presence&&a.isArray(t.presence.events)&&t.presence.events.map(n.getEventMapper()).forEach((function(e){let t=n.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=y(n,e.getSender()),t.setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)})),t.account_data&&a.isArray(t.account_data.events)){const e=t.account_data.events.map(n.getEventMapper()),i=e.reduce(((e,t)=>(e[t.getId()]=n.store.getAccountData(t.getType()),e)),{});n.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){const t=e.getContent();n.pushRules=d.PushProcessor.rewriteDefaultRules(t)}const t=i[e.getId()];return n.emit("accountData",e,t),e}))}if(t.to_device&&a.isArray(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(n.getEventMapper()).map((t=>{if("m.key.verification.cancel"===t.getType()){const n=t.getContent().transaction_id;n&&e.push(n)}return t})).forEach((function(t){const i=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=i.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const n=i.transaction_id;e.includes(n)&&t.flagCancelled()}n.emit("toDeviceEvent",t)}else l.logger.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this._catchingUp=!1;t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave"));let r=[],o=[],s=[];if(t.rooms&&(t.rooms.invite&&(r=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(o=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(s=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],r.forEach((function(e){const t=e.room,r=i._mapSyncEventsFormat(e.invite_state,t);i._processRoomEvents(t,r),e.isBrandNewRoom&&(t.recalculate(),n.store.storeRoom(t),n.emit("Room",t)),r.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("invite")})),await a.promiseMapSeries(o,(async function(t){const r=t.room,o=i._mapSyncEventsFormat(t.state,r),s=i._mapSyncEventsFormat(t.timeline,r),c=i._mapSyncEventsFormat(t.ephemeral),d=i._mapSyncEventsFormat(t.account_data);if(t.unread_notifications){r.setUnreadNotificationCount("total",t.unread_notifications.notification_count);const e=n.isRoomEncrypted(r.roomId);(!e||e&&r.getUnreadNotificationCount("highlight")<=0)&&r.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)}if(t.timeline=t.timeline||{},t.isBrandNewRoom)r.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,u.EventTimeline.BACKWARDS);else if(t.timeline.limited){let o=!0;for(let e=s.length-1;e>=0;e--){const t=s[e].getId();if(r.getTimelineForEvent(t)){p("Already have event "+t+" in limited sync - not resetting"),o=!1,s.splice(0,e);break}}o&&(i._deregisterStateListeners(r),r.resetLiveTimeline(t.timeline.prev_batch,i.opts.canResetEntireTimeline(r.roomId)?null:e.oldSyncToken),n.resetNotifTimelineSet(),i._registerStateListeners(r))}async function l(e){if(n.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&i.opts.crypto&&await i.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=n.store.getUser(e.getStateKey());t?t._unstable_updateStatusMessage(e):(t=y(n,e.getStateKey()),t._unstable_updateStatusMessage(e),n.store.storeUser(t))}}i._processRoomEvents(r,o,s,e.fromCache),t.summary&&r.setSummary(t.summary),r.addEphemeralEvents(c),r.addAccountData(d),r.recalculate(),t.isBrandNewRoom&&(n.store.storeRoom(r),n.emit("Room",r)),i._processEventsForNotifs(r,s),await a.promiseMapSeries(o,l),await a.promiseMapSeries(s,l),c.forEach((function(e){n.emit("event",e)})),d.forEach((function(e){n.emit("event",e)})),r.updateMyMembership("join")})),s.forEach((function(e){const t=e.room,r=i._mapSyncEventsFormat(e.state,t),o=i._mapSyncEventsFormat(e.timeline,t),s=i._mapSyncEventsFormat(e.account_data);i._processRoomEvents(t,r,o),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(n.store.storeRoom(t),n.emit("Room",t)),i._processEventsForNotifs(t,o),r.forEach((function(e){n.emit("event",e)})),o.forEach((function(e){n.emit("event",e)})),s.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){n.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&t["org.matrix.msc2732.device_unused_fallback_key_types"]){const e=t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}},f.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);const t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=a.defer()),this._connectionReturnedDefer.promise},f.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);const t=this;function n(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){n()}),(function(i){400==i.httpStatus||404==i.httpStatus?t._keepAliveTimer=setTimeout(n,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:i}))}))},f.prototype._processGroupSyncEntry=function(e,t){for(const n of Object.keys(e)){const i=e[n];let r=this.client.store.getGroup(n);const o=null===r;null===r&&(r=this.createGroup(n)),i.profile&&r.setProfile(i.profile.name,i.profile.avatar_url),i.inviter&&r.setInviter({userId:i.inviter}),r.setMyMembership(t),o&&this.client.emit("Group",r)}},f.prototype._mapSyncResponseToRoomArray=function(e){const t=this.client,n=this;return a.keys(e).map((function(i){const r=e[i];let o=t.store.getRoom(i),s=!1;return o||(o=n.createRoom(i),s=!0),r.room=o,r.isBrandNewRoom=s,r}))},f.prototype._mapSyncEventsFormat=function(e,t){if(!e||!a.isArray(e.events))return[];const n=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),n(e)}))},f.prototype._resolveInvites=function(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const i=t.getUser(n.userId);let r;r=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(n.userId),r.then((function(t){const i=n.events.member;"invite"===i.getContent().membership&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,n.setMembershipEvent(i,e.currentState))}),(function(e){}))}))},f.prototype._processRoomEvents=function(e,t,n,i){const r=e.getLiveTimeline(),o=0==r.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);r.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[],null,i)},f.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(let n=0;n<t.length;n++){const e=this.client.getPushActionsForEvent(t[n]);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this._notifEvents.push(t[n])}},f.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},f.prototype._updateSyncState=function(e,t){const n=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,n,t)},f.prototype._onOnline=function(){p("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,n("bqPV"))},"31LC":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAATCAYAAAB/TkaLAAAAAXNSR0IArs4c6QAAAqBJREFUOBGlVEtIVVEU3fuc6+cpJCXax4llFFlgZRoUaD8KJGuU4C9tJA1yoPl0eAcNUrSJsyik5KW8IshBEATRZ2LZsydIqYhWUpkFmZ98vnv27jzrye11r/Q5k7PPWmuvc+7d+xyEmGEOmvGLi9nZFliZzOABIWZQwejYqBi+WVKiYuSOS7SjDYEbhSigGBgmmdWEBDFFAOsZcCMAeciC2235Fc/sOU7xsqm331cOgNvAUp0teZVDseK6QGeORFGBLHpbdpfeiuXt6yXTpv6uA4rp8MKH1Rfai4pCdoE9Ph+8niyV4VWKH7fmld+3c/ZYVD/oSCTmYhW2OlcyjCS15pyeQ8QOlHiisc+fYjeyxyI9Re4QAicu7a0athNu8cVdpeOI3AtoFbhpBEBcJhG8dRM44qyGAGG7I6dBgUBJDDzlJnDCFRnjhJzqxEUwgboPgWmdm8AJl3GUqLvAtWeFrvqYdtZ9+OdDhmUGCv7oliGm1exg5FO8Qf9WN1EszgbsU2EeiMWja3F5T01YIN4BsqpM3V5Rwm2u7+/O01+XxYacdtPo6gM07yx7Aswv51cl1HsDXRvcxE0DvlwDqZJAXkOiU00B3xEn7fI1jZANL7qPC6CjTPhIX4hhyTOvieI9JOMzhAH5qHCzbv7PitQbFVq4G+fx1CLDq+aeET+Ypn4mfoxfTCPQuYA/LVFaBag4Wxuk6pdKMcKkIA5Ofl18mJmeTHOL4bO6+kxT4asyzagBpND8+zVXojfyN9Ofm604mWyK2eCWMkmwCQ1uVwpOImBG0pdQm3nwzMI/mUZ3bHzuO0YCD6GgdgrLAv2LCr+9S6ldKlRU9Ldzc275PSL2I2GdgfJpJD9h7af9/3XS6CEa+rqzQKhqBhhv7Rnp+A4ZPw4dYJKDLAAAAABJRU5ErkJggg=="},"3A0a":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=u(n("OBCi")),r=u(n("YUSd")),o=u(n("Zv/C")),s=u(n("2lBV")),a=u(n("Dkg+")),c=u(n("Gjrs"));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(e){(0,o.default)(this,t);var n=(0,a.default)(this,(t.__proto__||(0,r.default)(t)).call(this));return n._handler=e,n._cache={},n}return(0,c.default)(t,e),(0,s.default)(t,[{key:"getValue",value:function(e,t){var n=t||"UNDEFINED",i=this._cache[e];return i&&i.hasOwnProperty(n)?i[t]:this._handler.getValue(e,t)}},{key:"setValue",value:function(e,t,n){this._cache[e]||(this._cache[e]={});var r=this._cache[e],o=t||"UNDEFINED";r[o]=n;var s=this._handler.setValue(e,t,n);return i.default.resolve(s).finally((function(){delete r[o]}))}},{key:"canSetValue",value:function(e,t){return this._handler.canSetValue(e,t)}},{key:"isSupported",value:function(){return this._handler.isSupported()}}]),t}(u(n("SeIk")).default);t.default=d,e.exports=t.default},"3LMv":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Service=t.TermsNotSignedError=void 0;var i=w(n("7oj+")),r=w(n("rIjD")),o=w(n("ByL7")),s=w(n("6J4u")),a=w(n("XCkw")),c=w(n("tZmG")),u=w(n("08eb")),d=w(n("t3kO")),l=w(n("7lnb")),h=w(n("snOE")),g=w(n("fU9s")),p=w(n("OBCi")),f=w(n("YUSd")),y=w(n("Zv/C")),m=w(n("Dkg+")),v=w(n("Gjrs"));t.startTermsFlow=async function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I,n=e.map((function(e){return S.default.get().getTerms(e.serviceType,e.baseUrl)})),i=await p.default.all(n),r=i.map((function(t,n){return{service:e[n],policies:t.policies}})),o=await S.default.get().getAccountData("m.accepted_terms"),f=void 0;f=o&&o.getContent()&&o.getContent().accepted?new g.default(o.getContent().accepted):new g.default;var y=[],m=!0,v=!1,_=void 0;try{for(var b,A=(0,d.default)(r);!(m=(b=A.next()).done);m=!0){var w=b.value,E=w.service,k=w.policies,R={},C=!0,T=!1,D=void 0;try{for(var O,M=(0,d.default)((0,a.default)(k));!(C=(O=M.next()).done);C=!0){var N=(0,s.default)(O.value,2),P=N[0],U=N[1],B=!1,x=!0,j=!1,L=void 0;try{for(var G,F=(0,d.default)((0,c.default)(U));!(x=(G=F.next()).done);x=!0){var K=G.value;if("version"!==K&&f.has(U[K].url)){B=!0;break}}}catch(W){j=!0,L=W}finally{try{!x&&F.return&&F.return()}finally{if(j)throw L}}B||(R[P]=U)}}catch(W){T=!0,D=W}finally{try{!C&&M.return&&M.return()}finally{if(T)throw D}}(0,c.default)(R).length>0&&y.push({service:E,policies:R})}}catch(W){v=!0,_=W}finally{try{!m&&A.return&&A.return()}finally{if(v)throw _}}var V=f.size;if(y.length>0){var q=await t(y,[].concat((0,h.default)(f)));console.log("User has agreed to URLs",q),q.forEach((function(e){return f.add(e)}))}else console.log("User has already agreed to all required policies");if(f.size!==V){var Z={accepted:(0,l.default)(f)};await S.default.get().setAccountData("m.accepted_terms",Z)}var Y=r.map((function(e){var t=(0,l.default)(f).filter((function(t){var n=!0,i=!1,r=void 0;try{for(var o,s=(0,d.default)((0,u.default)(e.policies));!(n=(o=s.next()).done);n=!0){var a=o.value,l=!0,h=!1,g=void 0;try{for(var p,f=(0,d.default)((0,c.default)(a));!(l=(p=f.next()).done);l=!0){var y=p.value;if("version"!==y&&a[y].url===t)return!0}}catch(W){h=!0,g=W}finally{try{!l&&f.return&&f.return()}finally{if(h)throw g}}}}catch(W){i=!0,r=W}finally{try{!n&&s.return&&s.return()}finally{if(i)throw r}}return!1}));return 0===t.length?p.default.resolve():S.default.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)}));return p.default.all(Y)},t.dialogTermsInteractionCallback=I;var _=w(n("8Jek")),S=w(n("BGZc")),b=w(n("v61F")),A=w(n("Uma8"));function w(e){return e&&e.__esModule?e:{default:e}}var E=t.TermsNotSignedError=function(e){function t(){return(0,y.default)(this,t),(0,m.default)(this,(t.__proto__||(0,f.default)(t)).apply(this,arguments))}return(0,v.default)(t,e),t}(function(e){function t(){var t=(0,o.default)(e,(0,l.default)(arguments));return(0,r.default)(t,(0,f.default)(this)),t}return t.prototype=(0,i.default)(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r.default?(0,r.default)(t,e):t.__proto__=e,t}(Error));t.Service=function e(t,n,i){(0,y.default)(this,e),this.serviceType=t,this.baseUrl=n,this.accessToken=i};function I(e,t,n){return new p.default((function(i,r){console.log("Terms that need agreement",e);var o=b.default.getComponent("views.dialogs.TermsDialog");A.default.createTrackedDialog("Terms of Service","",o,{policiesAndServicePairs:e,agreedUrls:t,onFinished:function(e,t){e?i(t):r(new E)}},(0,_.default)("mx_TermsDialog",n))}))}},"3wb4":function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=t.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;var r=n("hBZP"),o=n("uZMU"),s=i(n("n/Lb")),a=n("ns36"),c=n("Ihe9");const u="m.secret_storage.v1.aes-hmac-sha2";t.SECRET_STORAGE_ALGORITHM_V1_AES=u;class d extends r.EventEmitter{constructor(e,t){super(),this._baseApis=e,this._cryptoCallbacks=t,this._requests={},this._incomingRequests={}}async getDefaultKeyId(){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise((async(t,n)=>{const i=n=>{"m.secret_storage.default_key"===n.getType()&&n.getContent().key===e&&(this._baseApis.removeListener("accountData",i),t())};this._baseApis.on("accountData",i);try{await this._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}catch(r){this._baseApis.removeListener("accountData",i),n(r)}}))}async addKey(e,t,n){const i={algorithm:e};if(t||(t={}),t.name&&(i.name=t.name),e!==u)throw new Error(`Unknown key algorithm ${t.algorithm}`);if(t.passphrase&&(i.passphrase=t.passphrase),t.key){const{iv:e,mac:n}=await d._calculateKeyCheck(t.key);i.iv=e,i.mac=n}if(!n)do{n=(0,a.randomString)(32)}while(await this._baseApis.getAccountDataFromServer(`m.secret_storage.key.${n}`));return await this._baseApis.setAccountData(`m.secret_storage.key.${n}`,i),{keyId:n,keyInfo:i}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!(await this.getKey(e))}async checkKey(e,t){if(t.algorithm===u){if(t.mac){const{mac:n}=await d._calculateKeyCheck(e,t.iv);return t.mac.replace(/=+$/g,"")===n.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}static async _calculateKeyCheck(e,t){return await(0,c.encryptAES)("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}async store(e,t,n){const i={};if(!n){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");n=[e]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(const r of n){const n=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+r);if(!n)throw new Error("Unknown key: "+r);if(n.algorithm===u){const o={[r]:n},[,s]=await this._getSecretStorageKey(o,e);i[r]=await s.encrypt(t)}else o.logger.warn("unknown algorithm for secret storage key "+r+": "+n.algorithm)}await this._baseApis.setAccountData(e,{encrypted:i})}async _fixupStoredSecret(e,t){const n=Object.keys(t);if(1===n.length&&"encrypted"!==n[0]&&t[n[0]].passthrough){if(await this.hasKey(n[0])){o.logger.log("Fixing up passthrough secret: "+e),await this.storePassthrough(e,n[0]);return await this._baseApis.getAccountDataFromServer(e)}}return null}async get(e){let t=await this._baseApis.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted&&(t=await this._fixupStoredSecret(e,t),!t||!t.encrypted))throw new Error("Content is not encrypted!");const n={};for(const o of Object.keys(t.encrypted)){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+o),i=t.encrypted[o];e.algorithm===u&&i.iv&&i.ciphertext&&i.mac&&(n[o]=e)}if(0===Object.keys(n).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let i,r;try{[i,r]=await this._getSecretStorageKey(n,e);const o=t.encrypted[i];return o.passthrough?(0,s.encodeBase64)(r.get_private_key()):await r.decrypt(o)}finally{r&&r.free&&r.free()}}async isStored(e,t){let n=await this._baseApis.getAccountDataFromServer(e);if(!n)return null;if(!n.encrypted&&(n=await this._fixupStoredSecret(e,n),!n||!n.encrypted))return null;void 0===t&&(t=!0);const i={};for(const r of Object.keys(n.encrypted)){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+r);if(!e)continue;const t=n.encrypted[r];e.algorithm===u&&t.iv&&t.ciphertext&&t.mac&&(i[r]=e)}return Object.keys(i).length?i:null}request(e,t){const n=this._baseApis.makeTxnId(),i=this._requests[n]={name:e,devices:t},r=new Promise(((e,t)=>{i.resolve=e,i.reject=t})),s={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:n},a={};for(const o of t)a[o]=s;return o.logger.info(`Request secret ${e} from ${t}, id ${n}`),this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:a}),{request_id:n,promise:r,cancel:e=>{const r={action:"request_cancellation",requesting_device_id:this._baseApis.deviceId,request_id:n},o={};for(const n of t)o[n]=r;this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:o}),i.reject(new Error(e||"Cancelled"))}}}async _onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this._baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const i=n.requesting_device_id;if("request_cancellation"===n.action)this._incomingRequests[i]&&this._incomingRequests[i][n.request_id]&&(o.logger.info("received request cancellation for secret ("+t+", "+i+", "+n.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:i,request_id:n.request_id}));else if("request"===n.action){if(i===this._baseApis.deviceId)return;if(o.logger.info("received request for secret ("+t+", "+i+", "+n.request_id+")"),!this._cryptoCallbacks.onSecretRequested)return;const e=await this._cryptoCallbacks.onSecretRequested(t,i,n.request_id,n.name,this._baseApis.checkDeviceTrust(t,i));if(e){o.logger.info(`Preparing ${n.name} secret for ${i}`);const r={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},a={algorithm:s.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.ensureOlmSessionsForDevices(this._baseApis._crypto._olmDevice,this._baseApis,{[t]:[this._baseApis.getStoredDevice(t,i)]}),await s.encryptMessageForDevice(a.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,t,this._baseApis.getStoredDevice(t,i),r);const c={[t]:{[i]:a}};o.logger.info(`Sending ${n.name} secret for ${i}`),this._baseApis.sendToDevice("m.room.encrypted",c)}else o.logger.info(`Request denied for ${n.name} secret for ${i}`)}}_onSecretReceived(e){if(e.getSender()!==this._baseApis.getUserId())return;const t=e.getContent();o.logger.log("got secret share for request",t.request_id);const n=this._requests[t.request_id];if(n){const i=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(s.OLM_ALGORITHM,e.getSenderKey());if(!i)return void o.logger.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(i.deviceId))return void o.logger.log("unsolicited secret share from device",i.deviceId);o.logger.log(`Successfully received secret ${n.name} from ${i.deviceId}`),n.resolve(t.secret)}}async _getSecretStorageKey(e,t){if(!this._cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this._cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[i,r]=n;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===u){return[i,{encrypt:async function(e){return await(0,c.encryptAES)(e,r,t)},decrypt:async function(e){return await(0,c.decryptAES)(e,r,t)}}]}throw new Error("Unknown key type: "+e[i].algorithm)}}t.SecretStorage=d},"40xR":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=o;var i=n("uZMU"),r=n("dZ+v");function o(e,t,n){this._workerScript=e,this._dbName=t,this._workerApi=n,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}o.prototype={connect:function(){return this._ensureStarted().then((()=>this._doCmd("connect")))},clearDatabase:function(){return this._ensureStarted().then((()=>this._doCmd("clearDatabase")))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then((()=>{i.logger.log("IndexedDB worker is ready")}))),this._startPromise},_doCmd:function(e,t){return Promise.resolve().then((()=>{const n=this._nextSeq++,i=(0,r.defer)();return this._inFlight[n]=i,this._worker.postMessage({command:e,seq:n,args:t}),i.promise}))},_onWorkerMessage:function(e){const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void i.logger.error("Got reply from worker with no seq");const e=this._inFlight[t.seq];if(void 0===e)return void i.logger.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else i.logger.warn("Unrecognised message from worker: "+t)}}},"4RXp":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAAXNSR0IArs4c6QAAAYZJREFUKBWNkrFqwlAUhv9ca3EQJJs4CI1CIg5ddZJOnbsV+ghKH8HBZ7BvYFftG4iTLg5FBAMaF0ELQhREoWLS+6e9IYgUz5B7w/m/c84952iIWLFYvK3VatVkMvmiaZpJl+/79m63e282m2/j8fhbyTV1aTQa94ZhdPL5/F0ul0MqlQpc2+0Ws9kM0+l07jjOU71e/1QMCLXbbW+5XMoEl40+aqgleMPymKlcLmvpdDoMpi6n0wmDwQCydFCz3+87krFiMsKrvDxblqW04Umo1+thsVhA13UUCgUcDgc9m826go3gm85NQbJEZDIZlEqlQEItGcHuqUYo+ByqVCoQQgRuasn8/ilCnv9BERmE7KHNltOugaglIzhczokmZwX1pmh5gfPvQy0ZcBytVsvhnNbrtT+ZTHyZ+eIwqaGWjOAacSP6/b5/PB5hmmbYiGim1WoFaqglE6Oz2+1+ySgfm83mkXNKJBKIx+PwPA+u62I0GmE4HM5t235QKxfuKgOwhGuX/AcHhiAESZNS6AAAAABJRU5ErkJggg=="},"4ZFb":function(e,t,n){"use strict";(function(t){var i=u(n("YUSd")),r=u(n("Zv/C")),o=u(n("2lBV")),s=u(n("Dkg+")),a=u(n("fJHd")),c=u(n("Gjrs"));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,c.default)(t,e),(0,o.default)(t,[{key:"dispatch",value:function(e,n){var r=this;"function"!==typeof e?n?(0,a.default)(t.prototype.__proto__||(0,i.default)(t.prototype),"dispatch",this).call(this,e):setTimeout((0,a.default)(t.prototype.__proto__||(0,i.default)(t.prototype),"dispatch",this).bind(this,e),0):e((function(e){r.dispatch(e,n)}))}}]),t}(n("/4mZ").Dispatcher);void 0===t.mxDispatcher&&(t.mxDispatcher=new d),e.exports=t.mxDispatcher}).call(this,n("bqPV"))},"5rM0":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=o(n("Zv/C")),r=o(n("2lBV"));function o(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(){(0,i.default)(this,e)}return(0,r.default)(e,[{key:"getValueOverride",value:function(e,t,n,i){return null}},{key:"onChange",value:function(e,t,n){}}]),e}();t.default=s,e.exports=t.default},"6/O3":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exists=function(e,t){return new Promise(((n,i)=>{let r=!0;const o=e.open(t);o.onupgradeneeded=()=>{r=!1},o.onblocked=()=>i(),o.onsuccess=()=>{o.result.close(),r||e.deleteDatabase(t),n(r)},o.onerror=e=>i(e.target.error)}))}},"65pn":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=d(n("YUSd")),r=d(n("Zv/C")),o=d(n("2lBV")),s=d(n("Dkg+")),a=d(n("Gjrs")),c=d(n("5rM0")),u=n("7FpV");function d(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValueOverride",value:function(e,t,n,i){return n?(0,u.enumerateThemes)()[n]?null:u.DEFAULT_THEME:null}}]),t}(c.default);t.default=l,e.exports=t.default},"6Aih":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=p(n("/9Wh")),r=p(n("OBCi")),o=p(n("YUSd")),s=p(n("Zv/C")),a=p(n("2lBV")),c=p(n("Dkg+")),u=p(n("Gjrs")),d=p(n("SeIk")),l=p(n("BGZc")),h=n("oOXF"),g=p(n("kPC3"));function p(e){return e&&e.__esModule?e:{default:e}}var f=function(e){function t(e,n){(0,s.default)(this,t);var i=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return i._featureNames=e,i._watchers=n,i}return(0,u.default)(t,e),(0,a.default)(t,[{key:"getValue",value:function(e,t){if(this._featureNames.includes(e))return this._readFeature(e);if("notificationsEnabled"===e){var n=g.default.getItem("notifications_enabled");return"string"===typeof n?"true"===n:null}if("notificationBodyEnabled"===e){var i=g.default.getItem("notifications_body_enabled");return"string"===typeof i?"true"===i:null}if("audioNotificationsEnabled"===e){var r=g.default.getItem("audio_notifications_enabled");return"string"===typeof r?"true"===r:null}return(this._getSettings()||{})[e]}},{key:"setValue",value:function(e,t,n){if(this._featureNames.includes(e))return this._writeFeature(e,n),r.default.resolve();if("notificationsEnabled"===e)return g.default.setItem("notifications_enabled",n),this._watchers.notifyUpdate(e,null,h.SettingLevel.DEVICE,n),r.default.resolve();if("notificationBodyEnabled"===e)return g.default.setItem("notifications_body_enabled",n),this._watchers.notifyUpdate(e,null,h.SettingLevel.DEVICE,n),r.default.resolve();if("audioNotificationsEnabled"===e)return g.default.setItem("audio_notifications_enabled",n),this._watchers.notifyUpdate(e,null,h.SettingLevel.DEVICE,n),r.default.resolve();var o=this._getSettings()||{};return o[e]=n,g.default.setItem("mx_local_settings",(0,i.default)(o)),this._watchers.notifyUpdate(e,null,h.SettingLevel.DEVICE,n),r.default.resolve()}},{key:"canSetValue",value:function(e,t){return!0}},{key:"isSupported",value:function(){return void 0!==g.default&&null!==g.default}},{key:"watchSetting",value:function(e,t,n){this._watchers.watchSetting(e,t,n)}},{key:"unwatchSetting",value:function(e){this._watchers.unwatchSetting(e)}},{key:"_getSettings",value:function(){var e=g.default.getItem("mx_local_settings");return e?JSON.parse(e):null}},{key:"_readFeature",value:function(e){if(l.default.get()&&l.default.get().isGuest())return!1;var t=g.default.getItem("mx_labs_feature_"+e);return"true"===t||"false"!==t&&null}},{key:"_writeFeature",value:function(e,t){g.default.setItem("mx_labs_feature_"+e,t),this._watchers.notifyUpdate(e,null,h.SettingLevel.DEVICE,t)}}]),t}(d.default);t.default=f,e.exports=t.default},"6Ssv":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IllegalMethod=void 0;var i=n("LLMt");class r extends i.VerificationBase{static factory(...e){return new r(...e)}static get NAME(){return"org.matrix.illegal_method"}async _doVerification(){throw new Error("Verification is not possible with this method")}}t.IllegalMethod=r},"6cee":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAIAAAD9b0jDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAIFJREFUeNpi/P//PwO1ARMDDcCooUPEUBZcEnuf/jz2+s8/HOmNiZHBUpTFRZqdNEOBJqapcXCwMGKV/fHn/6xbP3AZitP7QDfiMhEIgFL//g+SiAKGGtCPuGSBUkyMpEcUMB6AoYYnoqxEceplHDIFymg6HU2noyX/qKFUAwABBgDnn0mBt2Fx3wAAAABJRU5ErkJggg=="},"7FpV":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.ThemeWatcher=t.DEFAULT_THEME=void 0;var i=m(n("08eb")),r=m(n("OBCi")),o=m(n("7oj+")),s=m(n("6J4u")),a=m(n("XCkw")),c=m(n("t3kO")),u=m(n("PSh9")),d=m(n("Zv/C")),l=m(n("2lBV"));t.enumerateThemes=function(){var e={light:(0,h._t)("Light theme"),dark:(0,h._t)("Dark theme")},t=y.default.getValue("custom_themes"),n={},i=!0,r=!1,o=void 0;try{for(var s,a=(0,c.default)(t);!(i=(s=a.next()).done);i=!0){var d=s.value.name;n["custom-"+d]=d}}catch(l){r=!0,o=l}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return(0,u.default)({},n,e)},t.setTheme=_;var h=n("nPNV"),g=m(n("aFBq")),p=m(n("4ZFb")),f=n("oOXF"),y=m(f);function m(e){return e&&e.__esModule?e:{default:e}}t.DEFAULT_THEME="light";var v=t.ThemeWatcher=function(){function t(){var n=this;(0,d.default)(this,t),this._onChange=function(){n.recheck()},this._onAction=function(e){"recheck_theme"===e.action&&n.recheck(e.forceTheme)},this._themeWatchRef=null,this._systemThemeWatchRef=null,this._dispatcherRef=null,this._preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this._preferLight=e.matchMedia("(prefers-color-scheme: light)"),this._currentTheme=this.getEffectiveTheme()}return(0,l.default)(t,[{key:"start",value:function(){this._themeWatchRef=y.default.watchSetting("theme",null,this._onChange),this._systemThemeWatchRef=y.default.watchSetting("use_system_theme",null,this._onChange),this._preferDark.addEventListener&&(this._preferDark.addEventListener("change",this._onChange),this._preferLight.addEventListener("change",this._onChange)),this._dispatcherRef=p.default.register(this._onAction)}},{key:"stop",value:function(){this._preferDark.addEventListener&&(this._preferDark.removeEventListener("change",this._onChange),this._preferLight.removeEventListener("change",this._onChange)),y.default.unwatchSetting(this._systemThemeWatchRef),y.default.unwatchSetting(this._themeWatchRef),p.default.unregister(this._dispatcherRef)}},{key:"recheck",value:function(e){var t=this._currentTheme;this._currentTheme=void 0===e?this.getEffectiveTheme():e,t!==this._currentTheme&&_(this._currentTheme)}},{key:"getEffectiveTheme",value:function(){if(y.default.getValueAt(f.SettingLevel.DEVICE,"use_system_theme",null,!1,!0)){if(this._preferDark.matches)return"dark";if(this._preferLight.matches)return"light"}var e=y.default.getValueAt(f.SettingLevel.DEVICE,"theme",null,!1,!0);if(e)return e;if(y.default.getValue("use_system_theme")){if(this._preferDark.matches)return"dark";if(this._preferLight.matches)return"light"}return y.default.getValue("theme")}},{key:"isSystemThemeSupported",value:function(){return this._preferDark.matches||this._preferLight.matches}}]),t}();async function _(e){if(!e){var t=new v;e=t.getEffectiveTheme()}var n=e;if(e.startsWith("custom-")){var u=function(e){var t=y.default.getValue("custom_themes");if(!t)throw new Error("No custom themes set, can't set custom theme \""+e+'"');var n=t.find((function(t){return t.name===e}));if(!n){var i=t.map((function(e){return e.name})).join(", ");throw new Error("Can't find custom theme \""+e+'", only know '+i)}return n}(e.substr(7));n=u.is_dark?"dark-custom":"light-custom",function(e){var t=document.body.style;if(e.colors){var n=!0,i=!1,r=void 0;try{for(var o,u=(0,c.default)((0,a.default)(e.colors));!(n=(o=u.next()).done);n=!0){var d=(0,s.default)(o.value,2),l=d[0],h=d[1];t.setProperty("--"+l,h),t.setProperty("--"+l+"-0pct",h+"00"),t.setProperty("--"+l+"-50pct",h+"7F")}}catch(g){i=!0,r=g}finally{try{!n&&u.return&&u.return()}finally{if(i)throw r}}}}(u)}for(var d=(0,o.default)(null),l=void 0,h=0;l=document.getElementsByTagName("link")[h];h++){var p=l.getAttribute("href").match(/^bundles\/.*\/theme-(.*)\.css$/);p&&(d[p[1]]=l)}if(!(n in d))throw new Error("Unknown theme "+n);return d[n].disabled=!1,new r.default((function(t){var r=function(){d[n].disabled=!1,(0,i.default)(d).forEach((function(e){e!=d[n]&&(e.disabled=!0)})),g.default.setTheme(e),t()},o=!1;d[n].onload=function(){r()};for(var s=0;s<document.styleSheets.length;s++){var a=document.styleSheets[s];if(a&&a.href===d[n].href){o=!0;break}}o&&(d[n].onload=void 0,r())}))}v._instance=null}).call(this,n("bqPV"))},"86cC":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAA6hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgICAgICAgICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iPgogICAgICAgICA8eG1wOk1vZGlmeURhdGU+MjAxNS0wOC0xMVQyMTowODoxNTwveG1wOk1vZGlmeURhdGU+CiAgICAgICAgIDx4bXA6Q3JlYXRvclRvb2w+UGl4ZWxtYXRvciAzLjMuMjwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpDb21wcmVzc2lvbj41PC90aWZmOkNvbXByZXNzaW9uPgogICAgICAgICA8dGlmZjpSZXNvbHV0aW9uVW5pdD4yPC90aWZmOlJlc29sdXRpb25Vbml0PgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj43MjwvdGlmZjpZUmVzb2x1dGlvbj4KICAgICAgICAgPHRpZmY6WFJlc29sdXRpb24+NzI8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWERpbWVuc2lvbj4xNjwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+MTwvZXhpZjpDb2xvclNwYWNlPgogICAgICAgICA8ZXhpZjpQaXhlbFlEaW1lbnNpb24+MTY8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4K0Cm5ewAAAQpJREFUOBHFkb1OAlEQhXdXSahoNNQ+gBXRilhQyROQ0NnYWVgZEh4CCmsqChISCx4BLLHF0tZCY7RDzC7fJHdu9t7MlsRJvszPOWchu0lyiCqK4sh6btXdezGcwyN8wJUXGJz2SZ9Aq6z5GaEDOUi9Ql1E+jGsQeoXLnwoHhBH4nI1dg8Y6oE+iDPBjqEOGxeQf3MPW7cv6VkQsBZMl7BzIW3fDGeW37xhftKk6zPTaB0JtOHPBfWlSu9a/uCGqQFvICWf7Rr0HbwzN4NAvGCYglZfdJYHPdAXccbviL2Sca4CtwyeS9qNavEnqSG8wBfcqSlN05z5Frawgh+oLn7pxFK5n1r3/73tAdRIOOlwC4hyAAAAAElFTkSuQmCC"},"92AT":function(e,t,n){"use strict";(function(e,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createCryptoStoreCacheCallbacks=function(e,t){return{getCrossSigningKeyCache:async function(n,o){const s=await new Promise((t=>e.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(i=>{e.getSecretStorePrivateKey(i,t,n)}))));if(s&&s.ciphertext){const e=i.from(t._pickleKey),o=await(0,c.decryptAES)(s,e,n);return(0,r.decodeBase64)(o)}return s},storeCrossSigningKeyCache:async function(n,o){if(!(o instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${o}`);const s=i.from(t._pickleKey);return o=await(0,c.encryptAES)((0,r.encodeBase64)(o),s,n),e.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,n,o)}))}}},t.requestKeysDuringVerification=async function(e,t,n){if(e.getUserId()!==t)return;return s.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,i)=>{const o=e,a=o._crypto._crossSigningInfo,c=new d(a.userId,{getCrossSigningKey:async e=>{s.logger.debug("Cross-signing: requesting secret",e,n);const{promise:t}=o.requestSecret(`m.cross_signing.${e}`,[n]),i=await t,a=(0,r.decodeBase64)(i);return Uint8Array.from(a)}},a._cacheCallbacks);c.keys=a.keys;const u=new Promise(((e,t)=>{setTimeout(e,6e4,new Error("Timeout"))})),l=new Promise((async e=>{if(!(await o._crypto.getSessionBackupPrivateKey())){s.logger.info("No cached backup key found. Requesting...");const e=o.requestSecret("m.megolm_backup.v1",[n]),t=await e.promise;s.logger.info("Got key backup key, decoding...");const i=(0,r.decodeBase64)(t);s.logger.info("Decoded backup key, storing..."),o._crypto.storeSessionBackupPrivateKey(Uint8Array.from(i)),s.logger.info("Backup key stored. Starting backup restore...");const a=await o.getKeyBackupVersion();o.restoreKeyBackupWithCache(void 0,void 0,a).then((()=>{s.logger.info("Backup restored.")}))}e()}));return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),l]),u]).then(t,i)})).catch((e=>{s.logger.warn("Cross-signing: failure while requesting keys:",e)}))},t.DeviceTrustLevel=t.UserTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0;var r=n("n/Lb"),o=n("hBZP"),s=n("uZMU"),a=n("W92I"),c=n("Ihe9");function u(e){return Object.values(e.keys)[0]}class d extends o.EventEmitter{constructor(e,t,n){super(),Object.defineProperty(this,"userId",{enumerable:!0,value:e}),this._callbacks=t||{},this._cacheCallbacks=n||{},this.keys={},this.firstUse=!0,this.crossSigningVerifiedBefore=!1}static fromStorage(e,t){const n=new d(t);for(const i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,n){const i=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this._callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function r(t){if(!t)return;const i=new e.Olm.PkSigning,r=i.init_with_seed(t);if(r===n)return[r,i];i.free()}let o;void 0===n&&(n=this.getId(t)),this._cacheCallbacks.getCrossSigningKeyCache&&i&&(o=await this._cacheCallbacks.getCrossSigningKeyCache(t,n));const s=r(o);if(s)return s;o=await this._callbacks.getCrossSigningKey(t,n);const a=r(o);if(a)return this._cacheCallbacks.storeCrossSigningKeyCache&&i&&await this._cacheCallbacks.storeCrossSigningKeyCache(t,o),a;if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master",!1)||{};function n(e){for(const n of Object.keys(t))e[n]||delete t[n]}for(const i of["self_signing","user_signing"])n(await e.isStored(`m.cross_signing.${i}`,!1)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[n,i]of e){const e=(0,r.encodeBase64)(i);await t.store(`m.cross_signing.${n}`,e)}}static async getFromSecretStorage(e,t){const n=await t.get(`m.cross_signing.${e}`);return n?(0,r.decodeBase64)(n):null}async isStoredInKeyCache(e){const t=this._cacheCallbacks;if(!t)return!1;const n=e?[e]:["master","self_signing","user_signing"];for(const i of n)if(!(await t.getCrossSigningKeyCache(i)))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this._cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){const i=await t.getCrossSigningKeyCache(n);i&&e.set(n,i)}return e}getId(e){if(e=e||"master",!this.keys[e])return null;return u(this.keys[e])}async resetKeys(t){if(!this._callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&l.MASTER||!this.keys.master)t=l.MASTER|l.USER_SIGNING|l.SELF_SIGNING;else if(0===t)return;const n={},i={};let o,s;try{if(t&l.MASTER?(o=new e.Olm.PkSigning,n.master=o.generate_seed(),s=o.init_with_seed(n.master),i.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,o]=await this.getCrossSigningKey("master"),t&l.SELF_SIGNING){const t=new e.Olm.PkSigning;try{n.self_signing=t.generate_seed();const e=t.init_with_seed(n.self_signing);i.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},(0,r.pkSign)(i.self_signing,o,this.userId,s)}finally{t.free()}}if(t&l.USER_SIGNING){const t=new e.Olm.PkSigning;try{n.user_signing=t.generate_seed();const e=t.init_with_seed(n.user_signing);i.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},(0,r.pkSign)(i.user_signing,o,this.userId,s)}finally{t.free()}}Object.assign(this.keys,i),this._callbacks.saveCrossSigningKeys(n)}finally{o&&o.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw s.logger.error(t),new Error(t)}this.keys.master?u(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=u(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,r.pkVerify)(e.user_signing,n,this.userId)}catch(i){throw s.logger.error("invalid signature on user-signing key"),i}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,r.pkVerify)(e.self_signing,n,this.userId)}catch(i){throw s.logger.error("invalid signature on self-signing key"),i}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,i]=await this.getCrossSigningKey(t);try{return(0,r.pkSign)(e,i,this.userId,n),e}finally{i.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");s.logger.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");s.logger.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new h(!0,!0,this.firstUse);if(!this.keys.user_signing)return new h(!1,!1,e.firstUse);let t;const n=e.keys.master,i=this.getId("user_signing");try{(0,r.pkVerify)(n,i,this.userId),t=!0}catch(o){t=!1}return new h(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,n,i){const o=this.checkUserTrust(e),s=e.keys.self_signing;if(!s)return new g(!1,!1,n,i);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,r.pkVerify)(s,e.getId(),e.userId),(0,r.pkVerify)(a,u(s),e.userId),g.fromUserTrustLevel(o,n,i)}catch(c){return new g(!1,!1,n,i)}}getCacheCallbacks(){return this._cacheCallbacks}}t.CrossSigningInfo=d;const l={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};t.CrossSigningLevel=l;class h{constructor(e,t,n){this._crossSigningVerified=e,this._crossSigningVerifiedBefore=t,this._tofu=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this._crossSigningVerified}wasCrossSigningVerified(){return this._crossSigningVerifiedBefore}isTofu(){return this._tofu}}t.UserTrustLevel=h;class g{constructor(e,t,n,i){this._crossSigningVerified=e,this._tofu=t,this._localVerified=n,this._trustCrossSignedDevices=i}static fromUserTrustLevel(e,t,n){return new g(e._crossSigningVerified,e._tofu,t,n)}isVerified(){return Boolean(this.isLocallyVerified()||this._trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this._crossSigningVerified}isLocallyVerified(){return this._localVerified}isTofu(){return this._tofu}}t.DeviceTrustLevel=g}).call(this,n("bqPV"),n("qykS").Buffer)},"9gG6":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAUCAYAAAB8gkaAAAAAAXNSR0IArs4c6QAAADRJREFUSA1jbDj35RkDI4MkA43Br7/fpZhobMeo8aMhMBoCDAyMo5l6NBmMhsDwCoHhm6kBsi4S6Cya2OsAAAAASUVORK5CYII="},AYj1:function(e,t,n){"use strict";function i(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}n.d(t,"a",(function(){return i}))},Au0n:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODExOThCOUU3Q0U2MTFFNTk1Rjc5NzBENjhBQzNCMkYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODExOThCOUY3Q0U2MTFFNTk1Rjc5NzBENjhBQzNCMkYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1QjQxNTlGRjdDRTYxMUU1OTVGNzk3MEQ2OEFDM0IyRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1QjQxNUEwMDdDRTYxMUU1OTVGNzk3MEQ2OEFDM0IyRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsNfE+0AAAB3SURBVHjaYvz//z8DNQETA5XBqIGUA5aSi8seAmk5KpgFMscR5EIHIH5EDcOA+D7IwPsUGgo3DDkMyTUUxTD0SCHVUAzDsMUysYZiNQxXsiFkKE7D8KVDXIbiNYxQwkY3lKBhxOQUmKGHiTEMBBhHy0OKAUCAAQDZFyxiBO2sXgAAAABJRU5ErkJggg=="},Az4l:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAWCAYAAAAmaHdCAAAAAXNSR0IArs4c6QAAAkxJREFUOBHdVM+rElEUdn6IjVD4epo9aPHa+CLIfP1wIeSihaCiqCAtRCIQ/wxx4c6tf4APggghwZ9BtKxFbmyXGSnvTUFBpRg6mTP2nWgeM/OmZ+sujPfc73znu+ece72MBSOdTgvz+fwqy7Lb6/XaRphhyIIgvKjValMD/nvJkIAkSXcQPHI6nUfValUyEmOx2F1FUazAX7Xb7W9GP0sZkECr1RqaCVCA2+3mvF7vEUx/MpncPiFCJSBV0ejQrnmeZ7PZ7G4ul3u3XC5vIXuX1s9SD1DrQgua2QzDcIlE4kqhUBgh+xvxeNyt8ljVOG12OBw/e70eUVi/379XLpc/yLLsS6VSOwTy9LNpBIPBt+jZfrfbtaA0ol+22+0KZRSNRl9uEmFDoZAQiURElD0bj8c76OFx9pVKZWswGAh/Fcnn81ZRFNPoxS6O+BHmETLQ3RPgt4FbjlW1JYXDYRsEMsAu4kP58j00ck/L0donRKBuR8b38X1HCU+x01eO4x6vVqskyrqmDVZtnQh2O4tdHyD4Ixr5xGq1ykRsNpsjYA8hHEYjb6rB6qwTAXELu77udDotEBSVRDNORoTIATjntTjZusZix0Ng9JmORqPxCY5nRqcuE6PzX9f/mwjuwQ96mMzqt9lshziN52Y+wvBQnQFH4mF8WSwWl4ANjeQ/T8R7I07rTCZzbjKZ2JHAlPP5fBNcsOsej4cNBALzfr+/MgtSsWKxyLtcrguz2Wwf/+g3pVJpwpCTytnwUKsaNMu4dFNcymG9Xv9MwC+TDe7Hb1yrWQAAAABJRU5ErkJggg=="},BGZc:function(e,t,n){"use strict";(function(i){Object.defineProperty(t,"__esModule",{value:!0});var r=S(n("PSh9")),o=S(n("Zv/C")),s=S(n("2lBV")),a=n("F41g"),c=_(n("dZ+v")),u=n("2syV"),d=n("apMS"),l=n("6Mww"),h=(S(n("v61F")),S(n("zUyb"))),g=S(n("oOXF")),p=S(n("wIGm")),f=(S(n("Uma8")),S(n("pZ3Y"))),y=_(n("U4NU")),m=S(n("kPC3")),v=S(n("gePy"));function _(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function S(e){return e&&e.__esModule?e:{default:e}}var b=function(){function e(){(0,o.default)(this,e),this.matrixClient=null,this._justRegisteredUserId=null,this.createOpts={},this.opts={initialSyncLimit:20},this._currentClientCreds=null}return(0,s.default)(e,[{key:"setIndexedDbWorkerScript",value:function(e){h.default.indexedDbWorkerScript=e}},{key:"setCreateOptions",value:function(e){h.default.options=e}},{key:"get",value:function(){return this.matrixClient}},{key:"unset",value:function(){this.matrixClient=null,p.default.stop()}},{key:"setJustRegisteredUserId",value:function(e){this._justRegisteredUserId=e}},{key:"currentUserIsJustRegistered",value:function(){return this.matrixClient&&this.matrixClient.credentials.userId===this._justRegisteredUserId}},{key:"replaceUsingCreds",value:function(e){this._currentClientCreds=e,this._createClient(e)}},{key:"assign",value:async function(){for(var e=["indexeddb","memory"],t=0;t<e.length;t++){var n=e[t];try{var i=this.matrixClient.store.startup();console.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await i;break}catch(o){if("indexeddb"!==n)throw console.error("Failed to start memory store!",o),o;console.error("Error starting matrixclient store - falling back to memory store",o),this.matrixClient.store=new a.MemoryStore({localStorage:m.default})}}y.trackStores(this.matrixClient);var r=c.deepCopy(this.opts);return r.pendingEventOrdering="detached",r.lazyLoadMembers=!0,p.default.start(this.matrixClient),f.default.matrixClient=this.matrixClient,r}},{key:"monkeyPatchPresenceIntogetSyncParams",value:function(){if(!u.SyncApi.prototype._originalGetSyncParams){var e=this;u.SyncApi.prototype._originalGetSyncParams=u.SyncApi.prototype.getSyncParams,u.SyncApi.prototype.getSyncParams=function(t,n){var i=u.SyncApi.prototype._originalGetSyncParams.bind(this)(t,n);return i.set_presence="online"===e.presence?"online":"offline",i}}}},{key:"updateSyncPresence",value:function(e){this.presence=e}},{key:"start",value:async function(){var e=await this.assign();console.log("MatrixClientPeg: really starting MatrixClient"),this.monkeyPatchPresenceIntogetSyncParams(),await this.get().startClient(e),console.log("MatrixClientPeg: MatrixClient started")}},{key:"getCredentials",value:function(){return{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()}}},{key:"getHomeserverName",value:function(){var e=/^@.+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}},{key:"_createClient",value:function(e){var t=(0,r.default)({baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,timelineSupport:!0,fallbackICEServerAllowed:!!g.default.getValue("fallbackICEServerAllowed"),unstableClientRelationAggregation:!0,identityServer:new v.default},this.createOpts);this.matrixClient=(0,h.default)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));var n=new l.EventTimelineSet(null,{timelineSupport:!0});n.getLiveTimeline().setPaginationToken("",d.EventTimeline.BACKWARDS),this.matrixClient.setNotifTimelineSet(n)}}]),e}();i.mxMatrixClientPeg||(i.mxMatrixClientPeg=new b),t.default=i.mxMatrixClientPeg,e.exports=t.default}).call(this,n("bqPV"))},BbeL:function(e,t,n){"use strict";var i=n("AYj1"),r=n("mXGw"),o=n.n(r),s=n("aD51"),a=n("d/x8"),c=n("iBp1");o.a.createElement;function u(){var e=Object(i.a)(["\n  background: var(--color-paperWhite);\n  box-shadow: ",";\n"]);return u=function(){return e},e}function d(){var e=Object(i.a)(["\n  display: block;\n  flex: 0 0 auto;\n  margin-top: auto;\n  a,\n  a:visited {\n    font-weight: ",";\n    color: #45525e !important;\n  }\n  padding: 10px;\n  transition: ",";\n"]);return d=function(){return e},e}var l=Object(s.css)(d(),a.styles.typography.weight.medium,a.animation.generateTransition("background")),h=Object(s.css)(u(),a.styles.shadows.high);t.a=Object(c.b)((function(e){var t=e.s,n=e.padded,i=void 0!==n&&n,o=Object(r.useState)(!1),c=o[0],u=o[1],d=Object(r.useContext)(a.ContainerContext).contentSizeEmitter,g=Object(r.useCallback)((function(e){var t=null===e||void 0===e?void 0:e.parentNode;t&&u(t.scrollHeight>t.clientHeight)}),[]),p=Object(r.useCallback)((function(e){u(!e)}),[]);return Object(r.useEffect)((function(){return d.on("resize",g),d.on("chat-timeline-panel-is-at-bottom-changed",p),function(){d.off("resize",g),d.off("chat-timeline-panel-is-at-bottom-changed",p)}}),[d,p,g]),t("brandingDisabled")?null:Object(s.jsx)(a.Paragraph,{css:[l,c&&h],size:"small",align:"center",color:"stoneGrey",padded:i},Object(s.jsx)("a",{href:"https://www.groovehq.com/?utm_source=widget&utm_medium=footer-link&utm_campaign=2020",rel:"noopener",target:"_blank"},"Powered by Groove"))}))},"Bd+K":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.setNow=function(e){a=e||Date.now},t.setTimeout=function(e,t){(t=t||0)<0&&(t=0);const n=Array.prototype.slice.call(arguments,2),i=a()+t,r=o++;const u={runAt:i,func:e,params:n,key:r},l=d(s,(function(e){return e.runAt-i}));return s.splice(l,0,u),c(),r},t.clearTimeout=function(e){if(0===s.length)return;let t;for(t=0;t<s.length;t++){if(s[t].key==e){s.splice(t,1);break}}0===t&&c()};var i=n("uZMU");let r,o=0;const s=[];let a=Date.now;function c(){r&&e.clearTimeout(r);const t=s[0];if(!t)return;const n=a(),i=Math.min(t.runAt-n,1e3);r=e.setTimeout(u,i)}function u(){let t;const n=a(),r=[];for(;;){const e=s[0];if(!e||e.runAt>n)break;t=s.shift(),t.key,r.push(t)}c();for(let s=0;s<r.length;s++){t=r[s];try{t.func.apply(e,t.params)}catch(o){i.logger.error("Uncaught exception in callback function",o.stack||o)}}}function d(e,t){let n=0,i=e.length;for(;n<i;){const r=n+i>>1;t(e[r])>0?i=r:n=r+1}return n}}).call(this,n("bqPV"))},BdGh:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sleep=void 0;var i,r=n("OBCi"),o=(i=r)&&i.__esModule?i:{default:i};t.timeout=async function(e,t,n){var i=new o.default((function(i){var r=setTimeout(i,n,t);e.then((function(){clearTimeout(r)}))}));return o.default.race([e,i])},t.defer=function(){var e=void 0,t=void 0,n=new o.default((function(n,i){e=n,t=i}));return{resolve:e,reject:t,promise:n}},t.allSettled=function(e){if(o.default.allSettled)return o.default.allSettled(e);return o.default.all(e.map((function(e){return e.then((function(e){return{status:"fulfilled",value:e}})).catch((function(e){return{status:"rejected",reason:e}}))})))};t.sleep=function(e,t){return new o.default((function(n){setTimeout(n,e,t)}))}},D67U:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.User=s;var r=i(n("dZ+v")),o=n("hBZP");function s(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}r.inherits(s,o.EventEmitter),s.prototype.setPresenceEvent=function(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push("User.currentlyActive"),this.presence=e.getContent().presence,n.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(let i=0;i<n.length;i++)this.emit(n[i],e,this)},s.prototype.setDisplayName=function(e){const t=this.displayName;this.displayName="string"===typeof e?e:void 0,e!==t&&this._updateModifiedTime()},s.prototype.setRawDisplayName=function(e){this.rawDisplayName="string"===typeof e?e:void 0},s.prototype.setAvatarUrl=function(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},s.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},DLQN:function(e,t,n){"use strict";(function(e,i){var r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.DehydrationManager=t.DEHYDRATION_ALGORITHM=void 0;var o=r(n("M6nr")),s=n("n/Lb"),a=n("W92I"),c=n("Ihe9"),u=r(n("SBNP")),d=n("uZMU");const l="org.matrix.msc2697.v1.olm.libolm_pickle";t.DEHYDRATION_ALGORITHM=l;const h=6048e5;t.DehydrationManager=class{constructor(e){this.crypto=e,(0,o.default)(this,"inProgress",!1),(0,o.default)(this,"timeoutId",void 0),(0,o.default)(this,"key",void 0),(0,o.default)(this,"keyInfo",void 0),(0,o.default)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}async getDehydrationKeyFromCache(){return await this.crypto._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this.crypto._cryptoStore.getSecretStorePrivateKey(t,(async t=>{if(t){const{key:n,keyInfo:r,deviceDisplayName:o,time:a}=t,u=e.from(this.crypto._olmDevice._pickleKey),d=await(0,c.decryptAES)(n,u,l);this.key=(0,s.decodeBase64)(d),this.keyInfo=r,this.deviceDisplayName=o;const g=Date.now(),p=Math.max(1,a+h-g);this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),p)}}),"dehydration")}))}async setKeyAndQueueDehydration(e,t={},n){await this.setKey(e,t,n)||this.dehydrateDevice()}async setKey(e,t={},n){if(!e)return this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto._cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let r=this.key&&e.length==this.key.length;for(let i=0;r&&i<e.length;i++)e[i]!=this.key[i]&&(r=!1);return r||(this.key=e,this.keyInfo=t,this.deviceDisplayName=n),r}async dehydrateDevice(){if(this.inProgress)d.logger.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const t=e.from(this.crypto._olmDevice._pickleKey),n=await(0,c.encryptAES)((0,s.encodeBase64)(this.key),t,l);await this.crypto._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto._cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:n,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),d.logger.log("Attempting to dehydrate device"),d.logger.log("Creating account");const r=new i.Olm.Account;r.create();const o=JSON.parse(r.identity_keys()),g=r.max_number_of_one_time_keys();r.generate_one_time_keys(g/2),r.generate_fallback_key();const p=JSON.parse(r.one_time_keys()),f=JSON.parse(r.fallback_key());r.mark_keys_as_published();const y=r.pickle(new Uint8Array(this.key)),m={algorithm:l,account:y};this.keyInfo.passphrase&&(m.passphrase=this.keyInfo.passphrase),d.logger.log("Uploading account to server");const v=(await this.crypto._baseApis._http.authedRequest(void 0,"PUT","/dehydrated_device",void 0,{device_data:m,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;d.logger.log("Preparing device keys",v);const _={algorithms:this.crypto._supportedAlgorithms,device_id:v,user_id:this.crypto._userId,keys:{[`ed25519:${v}`]:o.ed25519,[`curve25519:${v}`]:o.curve25519}},S=r.sign(u.default.stringify(_));_.signatures={[this.crypto._userId]:{[`ed25519:${v}`]:S}},this.crypto._crossSigningInfo.getId("self_signing")&&await this.crypto._crossSigningInfo.signObject(_,"self_signing"),d.logger.log("Preparing one-time keys");const b={};for(const[e,i]of Object.entries(p.curve25519)){const t={key:i},n=r.sign(u.default.stringify(t));t.signatures={[this.crypto._userId]:{[`ed25519:${v}`]:n}},b[`signed_curve25519:${e}`]=t}d.logger.log("Preparing fallback keys");const A={};for(const[e,i]of Object.entries(f.curve25519)){const t={key:i,fallback:!0},n=r.sign(u.default.stringify(t));t.signatures={[this.crypto._userId]:{[`ed25519:${v}`]:n}},A[`signed_curve25519:${e}`]=t}return d.logger.log("Uploading keys to server"),await this.crypto._baseApis._http.authedRequest(void 0,"POST","/keys/upload/"+encodeURI(v),void 0,{device_keys:_,one_time_keys:b,"org.matrix.msc2732.fallback_keys":A}),d.logger.log("Done dehydrating"),this.timeoutId=i.setTimeout(this.dehydrateDevice.bind(this),h),v}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(i.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this,n("qykS").Buffer,n("bqPV"))},DQcM:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NUI0MTU5RkQ3Q0U2MTFFNTk1Rjc5NzBENjhBQzNCMkYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NUI0MTU5RkU3Q0U2MTFFNTk1Rjc5NzBENjhBQzNCMkYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1QjQxNTlGQjdDRTYxMUU1OTVGNzk3MEQ2OEFDM0IyRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1QjQxNTlGQzdDRTYxMUU1OTVGNzk3MEQ2OEFDM0IyRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgW11RMAAACRSURBVHjaYvz//z8DOii5uEwRSN1nIAB69KMwxJhwqN0PxIoMZABcBsqTaygTHjmyDGUiIE+yoUxEqCHJUCYiLSbaUCYSgocoQ5lIjESChjKRkdTwGkqOgTBDF1LTwEdAHE8tA0GGOeDK60zUNIxUAwkaRoqBRBlGrIFEG0aMgSQZRshAkg3DZyBZhoEAQIABAFLpIgbHCMuXAAAAAElFTkSuQmCC"},Df2i:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=c(n("YUSd")),r=c(n("Zv/C")),o=c(n("2lBV")),s=c(n("Dkg+")),a=c(n("Gjrs"));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e,n){(0,r.default)(this,t);var o=(0,s.default)(this,(t.__proto__||(0,i.default)(t)).call(this));return o._defaults=e,o._invertedDefaults=n,o}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValue",value:function(e,t){var n=this._defaults[e];return void 0===n&&(n=this._invertedDefaults[e]),n}},{key:"setValue",value:function(e,t,n){throw new Error("Cannot set values on the default level handler")}},{key:"canSetValue",value:function(e,t){return!1}},{key:"isSupported",value:function(){return!0}}]),t}(c(n("SeIk")).default);t.default=u,e.exports=t.default},ES26:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(n("tZmG"));t.getDefaultIdentityServerUrl=c,t.useDefaultIdentityServer=function(){var e=c();s.default.get().setAccountData("m.identity_server",{base_url:e})},t.doesIdentityServerHaveTerms=async function(e){var t=void 0;try{t=await s.default.get().getTerms(r.SERVICE_TYPES.IS,e)}catch(n){if(console.error(n),"rejected"!==n.cors&&404!==n.httpStatus)throw n;t=null}return t&&t.policies&&(0,i.default)(t.policies).length>0},t.doesAccountDataHaveIdentityServer=function(){var e=s.default.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url};var r=n("F41g"),o=a(n("FJJ4")),s=a(n("BGZc"));function a(e){return e&&e.__esModule?e:{default:e}}function c(){return o.default.get().validated_server_config.isUrl}},EbPi:function(e,t,n){"use strict";var i,r=n("ct0k"),o=n("I78n"),s=n("m6w3"),a=n("uEoR"),c=n("WGrI"),u=n.n(c),d=n("BWcO"),l=n("vwgk"),h=n("OQez"),g=n("e7Tu"),p=n("yFF4"),f=n("SDKZ");function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(Object(n),!0).forEach((function(t){Object(s.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function v(e,t){Object.entries(t).forEach((function(t){var n=Object(a.a)(t,2),i=n[0],r=n[1];"chat"===i?(e.translations.chat||(e.translations.chat={matrix:{}}),Object.entries(r).forEach((function(t){var n=Object(a.a)(t,2),i=n[0],r=n[1];i.startsWith("matrix")?Object.entries(r).forEach((function(t){var n=Object(a.a)(t,2),i=n[0],r=n[1];if(i.includes("|")){var o=i.split("|"),s=Object(a.a)(o,2),c=s[0],u=s[1];e.translations.chat.matrix[c]||(e.translations.chat.matrix[c]={}),e.translations.chat.matrix[c][u]=r}else e.translations.chat.matrix[i]=r})):e.translations.chat[i]=r}))):e.translations[i]=r}))}var _=Object(d.c)(Object(d.a)((i={},Object(s.default)(i,f.f,(function(e,t){var n=t.payload.widgetUuid;e.uuid=n})),Object(s.default)(i,f.s,(function(e){e.settingsStatus=h.a.PENDING,e.lastFetchedSettingsAt=Date.now()})),Object(s.default)(i,f.t,(function(e,t){var n=t.payload,i=(n=void 0===n?{}:n).rawData,r=(i=void 0===i?{}:i).widget,o=(r=void 0===r?{}:r).accountId,s=r.company,a=r.publishedSettings,c=r.translations,u=r.etag,d=t.meta,g=(d=void 0===d?{}:d).unchanged;if(e.lastFetchedSettingsAt=Date.now(),g)return e;c&&v(e,c);var p=Object(l.a)(a);return p.startScreen||("ask"===p.widgetStyle?p.startScreen="contact":"answer"===p.widgetStyle?p.startScreen="kb":p.startScreen="home"),e.settingsStatus=h.a.SUCCESS,e.data=p,e.account={id:o,company:s},e.etag=u,e})),Object(s.default)(i,f.r,(function(e){e.settingsStatus=h.a.ERROR,e.lastFetchedSettingsAt=0})),Object(s.default)(i,f.o,(function(e,t){var n=t.payload.data,i=t.requestId,r=u()(e.data,n,{arrayMerge:function(e,t){return t}});e.data=r,Object(g.a)({type:f.o,payload:JSON.parse(JSON.stringify(m({},r))),requestId:i})})),Object(s.default)(i,f.p,(function(e,t){var n=t.payload.translations,i=t.requestId,r=u()(e.translations,n);v(e,r);var o=Object(p.b)();o&&o.updateLanguage(e.translations.chat.matrix),Object(g.a)({type:f.p,payload:m({},r),requestId:i})})),i),{uuid:null,settingsStatus:h.a.IDLE,translationsStatus:h.a.IDLE,data:{},translations:{},locale:"en",account:{},lastFetchedSettingsAt:0})),S=n("tJzU"),b=function(e,t){return{type:t.type}};t.a=Object(r.a)({launcher:o.a,settings:_,tracker:S.a,lastAction:b})},"EfR+":function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.Group=s;var r=i(n("dZ+v")),o=n("hBZP");function s(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}r.inherits(s,o.EventEmitter),s.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},s.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},s.prototype.setInviter=function(e){this.inviter=e}},F41g:function(e,t,n){"use strict";(function(e){var i=n("cFGl"),r=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0});var o={};t.default=void 0;var s=r(n("pZw/"));Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=i(n("dJP9")),c=i(n("29T4"));let u;s.request((function(e,t){return e.qs=c.default.stringify(e.qs||{},e.qsStringifyOptions),(0,a.default)(e,t)}));try{u=e.indexedDB}catch(l){}u&&s.setCryptoStoreFactory((function(){return new s.IndexedDBCryptoStore(u,"matrix-js-sdk:crypto")}));var d=s;t.default=d,e.matrixcs=s}).call(this,n("bqPV"))},FJJ4:function(e,t,n){"use strict";(function(i){Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULTS=void 0;var r=c(n("PSh9")),o=c(n("tZmG")),s=c(n("Zv/C")),a=c(n("2lBV"));function c(e){return e&&e.__esModule?e:{default:e}}var u=t.DEFAULTS={integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null},d=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,null,[{key:"get",value:function(){return i.mxReactSdkConfig||{}}},{key:"put",value:function(e){for(var t=(0,o.default)(u),n=0;n<t.length;++n)void 0===e[t[n]]&&(e[t[n]]=u[t[n]]);i.mxReactSdkConfig=e}},{key:"unset",value:function(){i.mxReactSdkConfig=void 0}},{key:"add",value:function(t){var n=e.get(),i=(0,r.default)({},n,t);e.put(i)}}]),e}();e.exports=d}).call(this,n("bqPV"))},FXob:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAABGdBTUEAALGPC/xhBQAAAGJJREFUWAnt0rENwCAQBEFMUTTp/tyOkWhhEoIlX+k13LPe7x8Xv3nxbee0DtQfSjBBFdC+DSaoAtq3wQRVQPs2mKAKaN8GE1QB7dtggiqgfRtMUAW0b4MJqoD2bTBBFdB+AxEZAua7s9F2AAAAAElFTkSuQmCC"},GIk6:function(e,t,n){"use strict";(function(t){var i=s(n("tZmG")),r=s(n("Zv/C")),o=s(n("2lBV"));function s(e){return e&&e.__esModule?e:{default:e}}var a=function(){function e(){(0,r.default)(this,e),this.components=null}return(0,o.default)(e,[{key:"getComponent",value:function(e){if(null===this.components)throw new Error("Attempted to get a component before a skin has been loaded. This is probably because either: a) Your app has not called sdk.loadSkin(), or b) A component has called getComponent at the root level");var t=this.components[e];if(t||(t=this.components["views."+e]),!t)throw new Error("No such component: "+e);return t}},{key:"load",value:function(e){if(null!==this.components)throw new Error("Attempted to load a skin while a skin is already loadedIf you want to change the active skin, call resetSkin first");this.components={};for(var t=(0,i.default)(e.components),n=0;n<t.length;++n){var r=e.components[t[n]];this.addComponent(t[n],r)}}},{key:"addComponent",value:function(e,t){var n=e;void 0!==t.replaces&&(n=t.replaces.indexOf(".")>-1?t.replaces:e.substr(0,e.lastIndexOf(".")+1)+t.replaces.split(".").pop()),this.components[n]=t}},{key:"reset",value:function(){this.components=null}}]),e}();void 0===t.mxSkinner&&(t.mxSkinner=new a),e.exports=t.mxSkinner}).call(this,n("bqPV"))},HHot:function(e,t){e.exports="/_next/static/images/chevron-left-82128ee03d2047d204b1856f4f14fe1d.png"},HKjT:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAMCAYAAABbayygAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzZFRDJDRjkzQUFCMTFFNTk1Qjc5RjVFQTA3NTc3NkYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzZFRDJDRkEzQUFCMTFFNTk1Qjc5RjVFQTA3NTc3NkYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozNkVEMkNGNzNBQUIxMUU1OTVCNzlGNUVBMDc1Nzc2RiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozNkVEMkNGODNBQUIxMUU1OTVCNzlGNUVBMDc1Nzc2RiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvNjRSMAAAB/SURBVHjaYmw494UBDbQD8VMgnoIsyMKACSSB+B+6IBMDkWCAFaYAMR8eNWJAHA1SGArEO3EoBinaD8SeIIWBQPwdiHehKRaHKroJxIkghd+A2AdKgxTzQxXtA+IbQBwOxL9hnkFWHADEyciK0GMGpng9EL8D4lgg/gOTBAgwAG+FG/+W3BdNAAAAAElFTkSuQmCC"},I78n:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return l}));var i=n("m6w3"),r=n("e7Tu"),o=n("W4T4"),s=n("SDKZ");function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){Object(i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var u={isOpen:!1,isShimBootstrapped:!1,previewMode:!1,preferLocal:!!e.groove_preferLocal},d={};function l(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,t=arguments.length>1?arguments[1]:void 0,n=d[t.type];return n?n(e,t):e}d[s.f]=function(t,n){var i=n.payload,r=i.options,s=void 0===r?{}:r,a=i.layoutStrategy;return s.previewMode&&(o.b.additionalHeaders["X-Groove-Widget-Preview"]="t"),void 0!==s.preferLocal&&(e.groove_preferLocal=s.preferLocal),c(c({},t),{},{previewMode:!!s.previewMode,preferLocal:!!s.preferLocal,layoutStrategy:a})},d[s.n]=function(e,t){var n=t.payload,i=(n=void 0===n?{}:n).open,o=void 0===i?void 0:i,a=e.isOpen,u=void 0!==o?o:!a;return u?Object(r.a)({type:s.h}):Object(r.a)({type:s.b}),c(c({},e),{},{isOpen:u})},d[s.k]=function(e,t){var n=t.payload.wrapperLayout;return Object(r.a)({type:s.k,payload:{wrapperLayout:n,open:e.isOpen}}),e},d[s.h]=function(e){return Object(r.a)({type:s.h}),c(c({},e),{},{isOpen:!0})},d[s.b]=function(e){return Object(r.a)({type:s.b}),c(c({},e),{},{isOpen:!1})},d[s.t]=function(e){return e.isShimBootstrapped||Object(r.a)({type:s.a}),c(c({},e),{},{isShimBootstrapped:!0})},d[s.d]=function(e,t){return Object(r.d)(t),e},d[s.c]=function(e,t){return Object(r.c)(t),e},d[s.g]=function(e,t){return c(c({},e),{},{layoutStrategy:t.payload.strategy})}}).call(this,n("bqPV"))},Ihe9:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.encryptAES=function(...e){return o?async function(e,t,n,i){let s;i?s=(0,r.decodeBase64)(i):(s=new Uint8Array(16),window.crypto.getRandomValues(s));s[8]&=127;const[a,u]=await c(t,n),d=(new TextEncoder).encode(e),l=await o.encrypt({name:"AES-CTR",counter:s,length:64},a,d),h=await o.sign({name:"HMAC"},u,l);return{iv:(0,r.encodeBase64)(s),ciphertext:(0,r.encodeBase64)(l),mac:(0,r.encodeBase64)(h)}}(...e):async function(e,t,n,o){const s=(0,i.getCrypto)();if(!s)throw new Error("No usable crypto implementation");let c;c=o?(0,r.decodeBase64)(o):s.randomBytes(16);c[8]&=127;const[u,d]=a(t,n),l=s.createCipheriv("aes-256-ctr",u,c),h=l.update(e,"utf-8","base64")+l.final("base64"),g=s.createHmac("sha256",d).update(h,"base64").digest("base64");return{iv:(0,r.encodeBase64)(c),ciphertext:h,mac:g}}(...e)},t.decryptAES=function(...e){return o?async function(e,t,n){const[i,s]=await c(t,n),a=(0,r.decodeBase64)(e.ciphertext);if(!(await o.verify({name:"HMAC"},s,(0,r.decodeBase64)(e.mac),a)))throw new Error(`Error decrypting secret ${n}: bad MAC`);const u=await o.decrypt({name:"AES-CTR",counter:(0,r.decodeBase64)(e.iv),length:64},i,a);return(new TextDecoder).decode(new Uint8Array(u))}(...e):async function(e,t,n){const o=(0,i.getCrypto)();if(!o)throw new Error("No usable crypto implementation");const[s,c]=a(t,n);if(o.createHmac("sha256",c).update(e.ciphertext,"base64").digest("base64").replace(/=+$/g,"")!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${n}: bad MAC`);const u=o.createDecipheriv("aes-256-ctr",s,(0,r.decodeBase64)(e.iv));return u.update(e.ciphertext,"base64","utf-8")+u.final("utf-8")}(...e)};var i=n("dZ+v"),r=n("n/Lb");const o="undefined"!==typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,s=new Uint8Array(8);function a(t,n){const r=(0,i.getCrypto)(),o=r.createHmac("sha256",s).update(t).digest(),a=e.alloc(1,1),c=r.createHmac("sha256",o).update(n,"utf-8").update(a).digest();a[0]=2;return[c,r.createHmac("sha256",o).update(c).update(n,"utf-8").update(a).digest()]}async function c(e,t){const n=await o.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),i=await o.deriveBits({name:"HKDF",salt:s,info:(new TextEncoder).encode(t),hash:"SHA-256"},n,512),r=i.slice(0,32),a=i.slice(32),c=o.importKey("raw",r,{name:"AES-CTR"},!1,["encrypt","decrypt"]),u=o.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return await Promise.all([c,u])}}).call(this,n("qykS").Buffer)},JIfo:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=g(n("tZmG")),r=g(n("t3kO")),o=g(n("YUSd")),s=g(n("Zv/C")),a=g(n("2lBV")),c=g(n("Dkg+")),u=g(n("Gjrs")),d=g(n("BGZc")),l=g(n("pZ3Y")),h=n("oOXF");function g(e){return e&&e.__esModule?e:{default:e}}var p="im.vector.setting.allowed_widgets",f=function(e){function t(e){(0,s.default)(this,t);var n=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return n._watchers=e,n._onAccountData=n._onAccountData.bind(n),n}return(0,u.default)(t,e),(0,a.default)(t,[{key:"initMatrixClient",value:function(e,t){e&&e.removeListener("Room.accountData",this._onAccountData),t.on("Room.accountData",this._onAccountData)}},{key:"_onAccountData",value:function(e,t){var n=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){var o=e.getContent().disable;o="boolean"!==typeof o?null:!o,this._watchers.notifyUpdate("urlPreviewsEnabled",n,h.SettingLevel.ROOM_ACCOUNT,o)}else if("org.matrix.room.color_scheme"===e.getType())this._watchers.notifyUpdate("roomColor",n,h.SettingLevel.ROOM_ACCOUNT,e.getContent());else if("im.vector.web.settings"===e.getType()){var s=!0,a=!1,c=void 0;try{for(var u,d=(0,r.default)((0,i.default)(e.getContent()));!(s=(u=d.next()).done);s=!0){var l=u.value,g=e.getContent()[l];this._watchers.notifyUpdate(l,n,h.SettingLevel.ROOM_ACCOUNT,g)}}catch(f){a=!0,c=f}finally{try{!s&&d.return&&d.return()}finally{if(a)throw c}}}else e.getType()===p&&this._watchers.notifyUpdate("allowedWidgets",n,h.SettingLevel.ROOM_ACCOUNT,e.getContent())}},{key:"getValue",value:function(e,t){if("urlPreviewsEnabled"===e){var n=this._getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!==typeof n.disable?null:!n.disable}return"roomColor"===e?this._getSettings(t,"org.matrix.room.color_scheme"):"allowedWidgets"===e?this._getSettings(t,p):(this._getSettings(t)||{})[e]}},{key:"setValue",value:function(e,t,n){if("urlPreviewsEnabled"===e){var i=this._getSettings(t,"org.matrix.room.preview_urls")||{};return i.disable=!n,d.default.get().setRoomAccountData(t,"org.matrix.room.preview_urls",i)}if("roomColor"===e)return d.default.get().setRoomAccountData(t,"org.matrix.room.color_scheme",n);if("allowedWidgets"===e)return d.default.get().setRoomAccountData(t,p,n);var r=this._getSettings(t)||{};return r[e]=n,d.default.get().setRoomAccountData(t,"im.vector.web.settings",r)}},{key:"canSetValue",value:function(e,t){var n=d.default.get().getRoom(t);return void 0!==n&&null!==n}},{key:"isSupported",value:function(){var e=d.default.get();return void 0!==e&&null!==e}},{key:"_getSettings",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"im.vector.web.settings",n=d.default.get().getRoom(e);if(!n)return null;var i=n.getAccountData(t);return i&&i.getContent()?i.getContent():null}}]),t}(l.default);t.default=f,e.exports=t.default},JKMe:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAf9JREFUSA21ljFLw0AUx5PTpoO4F5dCuhSc6yZ0SAh06eoHUFwcHQsuHR0c/A4K3Quh2XRKoeDgYjHQRTqLDqWQ+v+3vRCba5JKPLje3bt3v3fv7uVedS2l2LZ9tFgsHCGEhbaKWqG6rutT1EkYhh5adzAYfGzD6KqJVqtVmc1m1wCfASBUOlIGo7ATPpbL5dt+vz+VctkmDFiW5QB6j3oglfK0MPSNeuV5nhvX34sPcCTnAN+hGnF5nv56TbtWq30GQTCSayID650TnvBKKme167VN0zRfYeSd+ksYz3w+nz9BYadj2WaQx1UqlU55J8sL5IXmgXe7XY01q5BFJvV0hiJaH8LUaKGy667uz3EcDlMLowsKJwIdRk0mPJWmmCSTbIS6sBTzhYjIppVqITQFhOx9/FTgTmKal9loNBJyCuRdyMnhcKh1Oh05jFqyCzl7gCLoZodR9AwPzM0J1VjuPE8UcT0MBwLwiQpWhIxswSe3CJiKQTY9cOEKP4pCC5lkCyYLvud56IwW3/fzqGpkkv3vj93yuR6Px194Yt+wtTbcSn4Uufa8UsLRsFwi4l4oifIB328mC8iafzVCMtbfIKv1CGeJDHAAIyMmC3RtGNkpq4HNlHkZh5P5ywAF9KRer/eQgA5h5DjLG0Bxn+GDYRgX8ljIkSX1vIv42/IDFrsGoapXGf4AAAAASUVORK5CYII="},K2c3:function(e,t,n){"use strict";var i=n("OQL8"),r=n("fwM5"),o=n("bkNG");function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}t.__esModule=!0,t.default=void 0;var d,l=(d=n("mXGw"))&&d.__esModule?d:{default:d},h=n("TW2t"),g=n("P09+");var p=[],f=[],y=!1;function m(e){var t=e(),n={loading:!0,loaded:null,error:null};return n.promise=t.then((function(e){return n.loading=!1,n.loaded=e,e})).catch((function(e){throw n.loading=!1,n.error=e,e})),n}function v(e){var t={loading:!1,loaded:{},error:null},n=[];try{Object.keys(e).forEach((function(i){var r=m(e[i]);r.loading?t.loading=!0:(t.loaded[i]=r.loaded,t.error=r.error),n.push(r.promise),r.promise.then((function(e){t.loaded[i]=e})).catch((function(e){t.error=e}))}))}catch(i){t.error=i}return t.promise=Promise.all(n).then((function(e){return t.loading=!1,e})).catch((function(e){throw t.loading=!1,e})),t}function _(e,t){return l.default.createElement(function(e){return e&&e.__esModule?e.default:e}(e),t)}function S(e,t){var n=Object.assign({loader:null,loading:null,delay:200,timeout:null,render:_,webpack:null,modules:null},t),i=null;function r(){if(!i){var t=new b(e,n);i={getCurrentValue:t.getCurrentValue.bind(t),subscribe:t.subscribe.bind(t),retry:t.retry.bind(t),promise:t.promise.bind(t)}}return i.promise()}if(!y&&"function"===typeof n.webpack){var o=n.webpack();f.push((function(e){var t,n=c(o);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(-1!==e.indexOf(i))return r()}}catch(s){n.e(s)}finally{n.f()}}))}var s=function(e,t){r();var o=l.default.useContext(g.LoadableContext),s=(0,h.useSubscription)(i);return l.default.useImperativeHandle(t,(function(){return{retry:i.retry}}),[]),o&&Array.isArray(n.modules)&&n.modules.forEach((function(e){o(e)})),l.default.useMemo((function(){return s.loading||s.error?l.default.createElement(n.loading,{isLoading:s.loading,pastDelay:s.pastDelay,timedOut:s.timedOut,error:s.error,retry:i.retry}):s.loaded?n.render(s.loaded,e):null}),[e,s])};return s.preload=function(){return r()},s.displayName="LoadableComponent",l.default.forwardRef(s)}var b=function(){function e(t,n){r(this,e),this._loadFn=t,this._opts=n,this._callbacks=new Set,this._delay=null,this._timeout=null,this.retry()}return o(e,[{key:"promise",value:function(){return this._res.promise}},{key:"retry",value:function(){var e=this;this._clearTimeouts(),this._res=this._loadFn(this._opts.loader),this._state={pastDelay:!1,timedOut:!1};var t=this._res,n=this._opts;t.loading&&("number"===typeof n.delay&&(0===n.delay?this._state.pastDelay=!0:this._delay=setTimeout((function(){e._update({pastDelay:!0})}),n.delay)),"number"===typeof n.timeout&&(this._timeout=setTimeout((function(){e._update({timedOut:!0})}),n.timeout))),this._res.promise.then((function(){e._update({}),e._clearTimeouts()})).catch((function(t){e._update({}),e._clearTimeouts()})),this._update({})}},{key:"_update",value:function(e){this._state=a(a({},this._state),{},{error:this._res.error,loaded:this._res.loaded,loading:this._res.loading},e),this._callbacks.forEach((function(e){return e()}))}},{key:"_clearTimeouts",value:function(){clearTimeout(this._delay),clearTimeout(this._timeout)}},{key:"getCurrentValue",value:function(){return this._state}},{key:"subscribe",value:function(e){var t=this;return this._callbacks.add(e),function(){t._callbacks.delete(e)}}}]),e}();function A(e){return S(m,e)}function w(e,t){for(var n=[];e.length;){var i=e.pop();n.push(i(t))}return Promise.all(n).then((function(){if(e.length)return w(e,t)}))}A.Map=function(e){if("function"!==typeof e.render)throw new Error("LoadableMap requires a `render(loaded, props)` function");return S(v,e)},A.preloadAll=function(){return new Promise((function(e,t){w(p).then(e,t)}))},A.preloadReady=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return new Promise((function(t){var n=function(){return y=!0,t()};w(f,e).then(n,n)}))},window.__NEXT_PRELOADREADY=A.preloadReady;var E=A;t.default=E},KCcI:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=d(n("YUSd")),r=d(n("Zv/C")),o=d(n("2lBV")),s=d(n("Dkg+")),a=d(n("Gjrs")),c=d(n("SeIk")),u=d(n("FJJ4"));function d(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"getValue",value:function(e,t){var n=u.default.get()||{};if("theme"===e)return n.default_theme;var i=n.settingDefaults;return i&&i[e]?i[e]:null}},{key:"setValue",value:function(e,t,n){throw new Error("Cannot change settings at the config level")}},{key:"canSetValue",value:function(e,t){return!1}},{key:"isSupported",value:function(){return!0}}]),t}(c.default);t.default=l,e.exports=t.default},LLMt:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationBase=t.SwitchStartEventError=void 0;var i=n("MwLI"),r=n("hBZP"),o=n("uZMU"),s=n("UESs"),a=n("nk7+"),c=n("92AT");const u=new Error("Verification timed out");class d extends Error{constructor(e){super(),this.startEvent=e}}t.SwitchStartEventError=d;class l extends r.EventEmitter{constructor(e,t,n,i,r,o){super(),this._channel=e,this._baseApis=t,this.userId=n,this.deviceId=i,this.startEvent=r,this.request=o,this.cancelled=!1,this._done=!1,this._promise=null,this._transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}_resetTimer(){o.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(o.logger.info("Triggering verification timeout"),this.cancel(u))}),6e5)}_endTimer(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}_send(e,t){return this._channel.send(e,t)}_waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this._expectedEvent=e,new Promise(((e,t)=>{this._resolveEvent=e,this._rejectEvent=t})))}canSwitchStartEvent(){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(o.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this._rejectEvent}),this._rejectEvent){const t=this._rejectEvent;this._rejectEvent=void 0,t(new d(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this._reject;if(this._reject=void 0,t){const n=e.getContent(),{reason:i,code:r}=n;t(new Error(`Other side cancelled verification because ${i} (${r})`))}}else if(this._expectedEvent){const t=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){const e=this._rejectEvent;this._rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this._endTimer(),!this._done)return this.request.onVerifierFinished(),this._resolve(),(0,c.requestKeysDuringVerification)(this._baseApis,this.userId,this.deviceId)}cancel(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===u){const e=(0,a.newTimeoutError)();this._send(e.getType(),e.getContent())}else if(e instanceof i.MatrixEvent){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this._send("m.key.verification.cancel",t)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this._promise||(this._promise=new Promise(((e,t)=>{this._resolve=(...t)=>{this._done=!0,this._endTimer(),e(...t)},this._reject=(...e)=>{this._done=!0,this._endTimer(),t(...e)}})),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this._promise}async _verifyKeys(e,t,n){const i=[];for(const[r,a]of Object.entries(t)){const t=r.split(":",2)[1],c=this._baseApis.getStoredDevice(e,t);if(c)await n(r,c,a),i.push(t);else{const c=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(await n(r,s.DeviceInfo.fromStorage({keys:{[r]:t}},t),a),i.push(t)):o.logger.warn(`verification: Could not find device ${t} to verify`)}}if(!i.length)throw new Error("No devices could be verified");o.logger.info("Verification completed! Marking devices verified: ",i);for(const r of i)await this._baseApis.setDeviceVerified(e,r)}}t.VerificationBase=l},LRih:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=n("TcPG"),o=(i=r)&&i.__esModule?i:{default:i};t.levelRoleMap=a,t.textualPowerLevel=function(e,t){var n=a(t);return n[e]?n[e]:(0,s._t)("Custom (%(level)s)",{level:e})};var s=n("nPNV");function a(e){var t;return t={undefined:(0,s._t)("Default"),0:(0,s._t)("Restricted")},(0,o.default)(t,e,(0,s._t)("Default")),(0,o.default)(t,50,(0,s._t)("Moderator")),(0,o.default)(t,100,(0,s._t)("Admin")),t}},LTeG:function(e,t,n){"use strict";var i=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationRequest=t.PHASE_DONE=t.PHASE_CANCELLED=t.PHASE_STARTED=t.PHASE_READY=t.PHASE_REQUESTED=t.PHASE_UNSENT=t.READY_TYPE=t.DONE_TYPE=t.CANCEL_TYPE=t.START_TYPE=t.REQUEST_TYPE=t.EVENT_PREFIX=void 0;var r=i(n("M6nr")),o=n("uZMU"),s=n("hBZP"),a=n("nk7+"),c=n("nlfO");const u="m.key.verification.";t.EVENT_PREFIX=u;const d=u+"request";t.REQUEST_TYPE=d;const l=u+"start";t.START_TYPE=l;const h=u+"cancel";t.CANCEL_TYPE=h;const g=u+"done";t.DONE_TYPE=g;const p=u+"ready";t.READY_TYPE=p;t.PHASE_UNSENT=1;t.PHASE_REQUESTED=2;t.PHASE_READY=3;t.PHASE_STARTED=4;t.PHASE_CANCELLED=5;t.PHASE_DONE=6;class f extends s.EventEmitter{constructor(e,t,n){super(),(0,r.default)(this,"_cancelOnTimeout",(()=>{try{this.initiatedByMe?this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.logger.error("Error while cancelling verification request",e)}})),this.channel=e,this.channel._request=this,this._verificationMethods=t,this._client=n,this._commonMethods=[],this._setPhase(1,!1),this._eventsByUs=new Map,this._eventsByThem=new Map,this._observeOnly=!1,this._timeoutTimer=null,this._accepting=!1,this._declining=!1,this._verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this._requestReceivedAt=null}static validateEvent(e,t,n){const i=t.getContent();return!(!e||!e.startsWith(u))&&(i?e!==d&&e!==p||Array.isArray(i.methods)?e!==d&&e!==p&&e!==l||"string"===typeof i.from_device&&0!==i.from_device.length||(o.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.logger.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return 1===this.phase}get requested(){return 2===this.phase}get cancelled(){return 5===this.phase}get ready(){return 3===this.phase}get started(){return 4===this.phase}get done(){return 6===this.phase}get methods(){return this._commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this._requestReceivedAt&&!this.initiatedByMe&&this.phase<=2){const e=this._requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this._getEventByEither(d);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this._getEventByEither(d)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<3&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&6!==this._phase&&5!==this._phase}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const n=this._eventsByThem.get(d)||this._eventsByThem.get(p);if(!n){if(this.started&&this.initiatedByMe){const t=this._eventsByUs.get(l),n=t&&t.getContent();return e==(n&&n.method)}return!1}const i=n.getContent();if(!i)return!1;const{methods:r}=i;return!!Array.isArray(r)&&r.includes(e)}get initiatedByMe(){const e=this._eventsByUs.size+this._eventsByThem.size===0;if(1===this._phase&&e)return!0;const t=this._eventsByUs.has(d),n=this._eventsByThem.has(d);if(t&&!n)return!0;if(!t&&n)return!1;const i=this._eventsByUs.has(l),r=this._eventsByThem.has(l);return!(!i||r)}get requestingUserId(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this._client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this._eventsByUs.get(h),t=this._eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this._getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this._eventsByThem.get(d)||this._eventsByThem.get(p)||this._eventsByThem.get(l)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(2===this.phase||3===this.phase||1===this.phase&&this.channel.constructor.canCreateRequest(l)){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw(0,a.newUnknownMethodError)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw(0,a.newUnknownMethodError)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&1===this._phase){const e=[...this._verificationMethods.keys()];await this.channel.send(d,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&5!==this._phase){if(this._declining=!0,this.emit("change"),this._verifier)return this._verifier.cancel((0,a.errorFactory)(t,e)());this._cancellingUserId=this._client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&2===this.phase&&!this.initiatedByMe){const e=[...this._verificationMethods.keys()];this._accepting=!0,this.emit("change"),await this.channel.send(p,{methods:e})}}waitFor(e){return new Promise(((t,n)=>{const i=()=>{let r=!1;return e(this)?(t(this),r=!0):this.cancelled&&(n(new Error("cancelled")),r=!0),r&&this.off("change",i),r};i()||this.on("change",i)}))}_setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}_getEventByEither(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}_getEventBy(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}_calculatePhaseTransitions(){const e=[{phase:1}],t=()=>e[e.length-1].phase,n=this._eventsByThem.has(d),i=this._getEventBy(d,n);i&&e.push({phase:2,event:i});const r=i&&this._getEventBy(p,!n);let o;if(r&&2===t()&&e.push({phase:3,event:r}),r||!i){const e=this._eventsByThem.get(l),t=this._eventsByUs.get(l);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this._getEventBy(l,!n);if(o){const n=2===t()&&i.getSender()!==o.getSender(),r=1===t()&&this.channel.constructor.canCreateRequest(l);(n||3===t()||r)&&e.push({phase:4,event:o})}const s=this._eventsByUs.get(g);(this._verifierHasFinished||s&&4===t())&&e.push({phase:6});const a=this._getEventByEither(h);return(this._cancelled||a)&&6!==t()?(e.push({phase:5,event:a}),e):e}_transitionToPhase(e){const{phase:t,event:n}=e;if((2===t||3===t)&&!this._wasSentByOwnDevice(n)){const e=n.getContent();this._commonMethods=e.methods.filter((e=>this._verificationMethods.has(e)))}if(this.observeOnly||2!==t&&4!==t&&3!==t||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(n)&&!this._wasSentByOwnDevice(n)&&(this._observeOnly=!0),4===t){const{method:e}=n.getContent();this._verifier||this.observeOnly||(this._verifier=this._createVerifier(e,n),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}_applyPhaseTransitions(){const e=this._calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),n=e.slice(t+1);for(const i of n)this._transitionToPhase(i);return n}_isWinningStartRace(e){if(e.getType()!==l)return!1;const t=this._verifier.startEvent;let n,i;if(this.isSelfVerification)if(t){const e=t.getContent();n=e&&e.from_device}else n=this._client.getDeviceId();else n=t?t.getSender():this._client.getUserId();if(this.isSelfVerification){const t=e.getContent();i=t&&t.from_device}else i=e.getSender();return i<n}hasEventId(e){for(const t of this._eventsByUs.values())if(t.getId()===e)return!0;for(const t of this._eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,n,i,r){if(this.done||this.cancelled)return;const s=this._observeOnly;if(this._adjustObserveOnly(t,n),!this.observeOnly&&!i&&await this._cancelOnError(e,t))return;if(r?this._eventsByUs.has(e):this._eventsByThem.has(e))return;const a=this.phase;this._addEvent(e,t,r);const u=this._applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const n=this._isWinningStartRace(t);this._verifier.canSwitchStartEvent(t)&&n?this._verifier.switchStartEvent(t):i||(e===h||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t)}if(u.length){if(n&&u.some((e=>3===e.phase))){this.otherPartySupportsMethod(c.SCAN_QR_CODE_METHOD,!0)&&(this._qrCodeData=await c.QRCodeData.create(this,this._client))}const e=u[u.length-1],{phase:t}=e;this._setupTimeout(t),this._setPhase(t)}else this._observeOnly!==s&&this.emit("change")}finally{o.logger.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${r}, isLiveEvent:${n}, isRemoteEcho:${i}, phase:${a}=>${this.phase}, observeOnly:${s}=>${this._observeOnly}`)}}_setupTimeout(e){if(!this._timeoutTimer&&!this.observeOnly&&2===e&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer){(4===e||3===e||6===e||5===e)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null)}}async _cancelOnError(e,t){if(e===l){const e=t.getContent().method;if(!this._verificationMethods.has(e))return await this.cancel((0,a.errorFromEvent)((0,a.newUnknownMethodError)())),!0}const n=e===d&&1!==this.phase,i=e===p&&2!==this.phase;if(1!==this.phase&&(n||i)){o.logger.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const n=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel((0,a.errorFromEvent)((0,a.newUnexpectedMessageError)({reason:n}))),!0}return!1}_adjustObserveOnly(e,t){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}_addEvent(e,t,n){if(n?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===d){for(const[e,t]of this._eventsByThem.entries())t.getSender()!==this.otherUserId&&this._eventsByThem.delete(e);this._requestReceivedAt=Date.now()}}_createVerifier(e,t=null,n=null){n||(n=this.targetDevice);const{userId:i,deviceId:r}=n,s=this._verificationMethods.get(e);if(s)return new s(this.channel,this._client,i,r,t,this);o.logger.warn("could not find verifier constructor for method",e)}_wasSentByOwnUser(e){return e.getSender()===this._client.getUserId()}_wasSentByOwnDevice(e){if(!this._wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this._verifierHasFinished=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this._eventsByThem.get(e)}}t.VerificationRequest=f},Ld9l:function(e,t,n){e.exports=n("mReo")},"Lk+r":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=a;var i=n("dZ+v"),r=n("uZMU");const o=["override","content","room","sender","underride"],s=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function a(e){const t={},n=(e,t)=>{for(let n=0;n<o.length;++n){const i=o[n],s=t[i];if(s)for(let t=0;t<s.length;++t){const n=s[t];if(!n.enabled)continue;const o=r(i,n);if(o&&this.ruleMatchesEvent(o,e))return n.kind=i,n}}return null},r=function(e,t){const n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":n.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;n.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return n},s=function(e,t){const n={event_match:l,contains_display_name:d,room_member_count:u,sender_notification_permission:c};return!!n[e.kind]&&n[e.kind](e,t)},c=function(t,n){const i=t.key;if(!i)return!1;const r=e.getRoom(n.getRoomId());return!(!r||!r.currentState)&&r.currentState.mayTriggerNotifOfType(i,n.getSender())},u=function(t,n){if(!t.is)return!1;const i=e.getRoom(n.getRoomId());if(!i||!i.currentState||!i.currentState.members)return!1;const r=i.currentState.getJoinedMemberCount(),o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;const s=o[1],a=parseInt(o[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return r==a;case"<":return r<a;case">":return r>a;case"<=":return r<=a;case">=":return r>=a;default:return!1}},d=function(t,n){let r=n.getContent();if(n.isEncrypted()&&n.getClearContent()&&(r=n.getClearContent()),!r||!r.body||"string"!=typeof r.body)return!1;const o=e.getRoom(n.getRoomId());if(!o||!o.currentState||!o.currentState.members||!o.currentState.getMember(e.credentials.userId))return!1;const s=o.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+(0,i.escapeRegExp)(s)+"(\\W|$)","i");return r.body.search(a)>-1},l=function(e,t){if(!e.key)return!1;const n=g(e.key,t);if("string"!==typeof n)return!1;if(e.value)return e.value===n;let i;return i="content.body"==e.key?h("(^|\\W)",e.pattern,"(\\W|$)"):h("^",e.pattern,"$"),!!n.match(i)},h=function(e,n,r){return t[n]||(t[n]=new RegExp(e+(0,i.globToRegexp)(n)+r,"i")),t[n]},g=function(e,t){const n=e.split(".");let r;const o=n[0];for("content"===o?(r=t.getContent(),n.shift()):"type"===o?(r=t.getType(),n.shift()):r=t.event;n.length>0;){const e=n.shift();if((0,i.isNullOrUndefined)(r[e]))return null;r=r[e]}return r},p=function(t,i){const r=function(t,i){return i?t.getSender()===e.credentials.userId?null:n(t,i.global):null}(t,i);if(!r)return{};const o=a.actionListToActionsObject(r.actions);return void 0===o.tweaks.highlight&&(o.tweaks.highlight="content"==r.kind),o};this.ruleMatchesEvent=function(e,t){let n=!0;for(let i=0;i<e.conditions.length;++i){const r=e.conditions[i];n&=s(r,t)}return n},this.actionsForEvent=function(t){return p(t,e.pushRules)},this.getPushRuleById=function(t){for(const n of["global"])if(void 0!==e.pushRules[n])for(const i of o)if(void 0!==e.pushRules[n][i])for(const r of e.pushRules[n][i])if(r.rule_id===t)return r;return null}}a.actionListToActionsObject=function(e){const t={notify:!1,tweaks:{}};for(let n=0;n<e.length;++n){const i=e[n];"notify"===i?t.notify=!0:"object"===typeof i&&(void 0===i.value&&(i.value=!0),t.tweaks[i.set_tweak]=i.value)}return t},a.rewriteDefaultRules=function(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const n=t.global.override;for(const i of s){const e=n.find((e=>e.rule_id===i.rule_id));if(e)e.default=i.default,e.conditions=i.conditions,e.actions=i.actions;else{const e=i.rule_id;r.logger.warn(`Adding default global override for ${e}`),n.push(i)}}return t}},MFoc:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=h;var r=n("utK+"),o=i(n("dZ+v")),s=i(n("6/O3")),a=n("uZMU");function c(e,t,n){const i=e.openCursor(t);return new Promise(((e,t)=>{const r=[];i.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},i.onsuccess=t=>{const i=t.target.result;i?(r.push(n(i)),i.continue()):e(r)}}))}function u(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(e){n(e.target.error)}}))}function d(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(e){n(e.target.error)}}))}function l(e){return d(e).then((e=>e.target.result))}function h(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new r.SyncAccumulator,this._isNewlyCreated=!1}h.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),s.exists(e,t)},h.prototype={connect:function(){if(!this._disconnected)return a.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,a.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this._dbName,3);return e.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion;a.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${n}`),n<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(t)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(t),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(t)},e.onblocked=()=>{a.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},a.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),d(e).then((e=>(a.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.target.result,this.db.onversionchange=()=>{this.db.close()},this._init())))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){return Promise.all([this._loadAccountData(),this._loadSyncData()]).then((([e,t])=>{a.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this._syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}},!0)}))},getOutOfBandMembers:function(e){return new Promise(((t,n)=>{const i=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),r=IDBKeyRange.only(e),o=i.openCursor(r),s=[];let a=!1;o.onsuccess=e=>{const n=e.target.result;if(!n)return s.length||a?t(s):t(null);const i=n.value;i.oob_written?a=!0:s.push(i),n.continue()},o.onerror=e=>{n(e)}})).then((t=>(a.logger.log(`LL: got ${t&&t.length} membershipEvents from storage for room ${e} ...`),t)))},setOutOfBandMembers:async function(e,t){a.logger.log(`LL: backend about to store ${t.length} members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events");t.forEach((e=>{i.put(e)}));const r={room_id:e,oob_written:!0,state_key:0};i.put(r),await u(n),a.logger.log(`LL: backend done storing for ${e}!`)},clearOutOfBandMembers:async function(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),i=l(t.openKeyCursor(n,"next")).then((e=>e&&e.primaryKey[1])),r=l(t.openKeyCursor(n,"prev")).then((e=>e&&e.primaryKey[1])),[o,s]=await Promise.all([i,r]),c=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),u=IDBKeyRange.bound([e,o],[e,s]);var d;a.logger.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,s]),await(d=c.delete(u),new Promise(((e,t)=>{d.onsuccess=()=>e(d),d.onerror=e=>t(e)})))},clearDatabase:function(){return new Promise(((e,t)=>{a.logger.log(`Removing indexeddb instance: ${this._dbName}`);const n=this.indexedDB.deleteDatabase(this._dbName);n.onblocked=()=>{a.logger.log(`can't yet delete indexeddb ${this._dbName} because it is open elsewhere`)},n.onerror=t=>{a.logger.warn(`unable to delete js-sdk store indexeddb: ${t.target.error}`),e()},n.onsuccess=()=>{a.logger.log(`Removed indexeddb instance: ${this._dbName}`),e()}}))},getSavedSync:function(e){void 0===e&&(e=!0);const t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(o.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){return Promise.resolve().then((()=>{this._syncAccumulator.accumulate(e)}))},syncToDatabase:function(e){const t=this._syncAccumulator.getJSON(!0);return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,n){return a.logger.log("Persisting sync data up to",e),o.promiseTry((()=>{const i=this.db.transaction(["sync"],"readwrite");return i.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:n}),u(i)}))},_persistAccountData:function(e){return o.promiseTry((()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let i=0;i<e.length;i++)n.put(e[i]);return u(t)}))},_persistUserPresenceEvents:function(e){return o.promiseTry((()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const i of e)n.put({userId:i[0],event:i[1]});return u(t)}))},getUserPresenceEvents:function(){return o.promiseTry((()=>c(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,(e=>[e.value.userId,e.value.event]))))},_loadAccountData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading account data..."),o.promiseTry((()=>c(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(e=>e.value)).then((e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e)))))},_loadSyncData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),o.promiseTry((()=>c(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(e=>e.value)).then((e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&a.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))))},getClientOptions:function(){return Promise.resolve().then((()=>c(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(e=>{if(e.value&&e.value&&e.value.options)return e.value.options})).then((e=>e[0]))))},storeClientOptions:async function(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await u(t)}}},Mv5s:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wwLDjk5ZlJG4gAAAyZJREFUSMfVVs1vVFUUP/fcd99Hp9N2wrzpQH3FARI1xIWJKRRJiBGjSbszwNJ/wT/GDXFlYtywIIGlhMTEChjHpAZhUAtt0dp2Xttp3ny9dz8Oi1oGZT46L3TBWd7c83F/53d+5zIigsM0hEO21ydBL6CtAzkT3a3KR7u6IYkxyNk441snxzq+q3X9646aD5w0CerSXHsSFz38dMr2LAYAYdv8uCkru3oucACgqej2P8knU05XdzaQRd8utd8e5yfH+P/Ob60lQQZnfPvmauy7eLYg0kBUqSkH4eXoAPBhUXyzFAtkiaEZX6Rs8nJdv5vrXgRHNj2K5VBdPOYgS8ui9ZaZcLp7a4KdmCY9HLdZepomGnpVt7itHA79o6efg/WWWa7r46P8UAYt1nRnU876wmKDL/dk0e21ZHFb6W4cvldVQQaPjmDYNuVQLW6r+cApZflwL7i/o7447TEg/K8KPI50JM17R8Ren6dH8bM3nZ9DOTREnAFjbFQgQQeISFI5VOcKgjMAAM+CvIMOMk2vogdEcGdTns7xnIOvTE2Rgdmv7n5NcQbvTHTapg0gA02QZtAsZImm6QwuRXpP4H7f1bMF8WKoPyNdyvKNlim4OHSCUpY/qKkPJsUvW6ohaWFTzvjWyAvE/KuhOWNvZPhvNXUiy4dOcH5S/LAhbWTnCuLm0zhnY5DpRFmp6+/X5VxgP4m0JpjuPXH95Locyoc1/X7euluVLUVZwcZtVIaqbTNm41xgNyRdX4kvldx8b4gG7IN71aQcqo+O2m9NWNW2qcVGIPNdzAhWqalba8mVkut7/ZgyIMGN1djhsFo3IxY7keVnfCuS9FNVLUXad9nFY/a4jSmlYk8vpaH5wEUGW21zfSU+leWVXUUAn59yvYMoUZ8mh21TDuXHU/8ukyMuju0rc9HDA0bv+QJF8N1aMlsQHodkXweeT5wy9PyQI3DGhu7BwkZSl7QVUySJs85UXy65Txt6YaMjbS1NZ3zRZycDvWTLkfr6j2a1pb6qNGmQRYm++rDftS4Q/d00F4p23uV5F7980MS+aGuCC0U7PU1fg8/vM7txuJ+tHlP7AAAAAElFTkSuQmCC"},OQL8:function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},OY4j:function(e,t,n){"use strict";var i=n("TJNI"),r=Object.prototype.hasOwnProperty,o=Array.isArray,s=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),a=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},i=0;i<e.length;++i)"undefined"!==typeof e[i]&&(n[i]=e[i]);return n};e.exports={arrayToObject:a,assign:function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],n=[],i=0;i<t.length;++i)for(var r=t[i],s=r.obj[r.prop],a=Object.keys(s),c=0;c<a.length;++c){var u=a[c],d=s[u];"object"===typeof d&&null!==d&&-1===n.indexOf(d)&&(t.push({obj:s,prop:u}),n.push(d))}return function(e){for(;e.length>1;){var t=e.pop(),n=t.obj[t.prop];if(o(n)){for(var i=[],r=0;r<n.length;++r)"undefined"!==typeof n[r]&&i.push(n[r]);t.obj[t.prop]=i}}}(t),e},decode:function(e,t,n){var i=e.replace(/\+/g," ");if("iso-8859-1"===n)return i.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(i)}catch(r){return i}},encode:function(e,t,n,r,o){if(0===e.length)return e;var a=e;if("symbol"===typeof e?a=Symbol.prototype.toString.call(e):"string"!==typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var c="",u=0;u<a.length;++u){var d=a.charCodeAt(u);45===d||46===d||95===d||126===d||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||o===i.RFC1738&&(40===d||41===d)?c+=a.charAt(u):d<128?c+=s[d]:d<2048?c+=s[192|d>>6]+s[128|63&d]:d<55296||d>=57344?c+=s[224|d>>12]+s[128|d>>6&63]+s[128|63&d]:(u+=1,d=65536+((1023&d)<<10|1023&a.charCodeAt(u)),c+=s[240|d>>18]+s[128|d>>12&63]+s[128|d>>6&63]+s[128|63&d])}return c},isBuffer:function(e){return!(!e||"object"!==typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(o(e)){for(var n=[],i=0;i<e.length;i+=1)n.push(t(e[i]));return n}return t(e)},merge:function e(t,n,i){if(!n)return t;if("object"!==typeof n){if(o(t))t.push(n);else{if(!t||"object"!==typeof t)return[t,n];(i&&(i.plainObjects||i.allowPrototypes)||!r.call(Object.prototype,n))&&(t[n]=!0)}return t}if(!t||"object"!==typeof t)return[t].concat(n);var s=t;return o(t)&&!o(n)&&(s=a(t,i)),o(t)&&o(n)?(n.forEach((function(n,o){if(r.call(t,o)){var s=t[o];s&&"object"===typeof s&&n&&"object"===typeof n?t[o]=e(s,n,i):t.push(n)}else t[o]=n})),t):Object.keys(n).reduce((function(t,o){var s=n[o];return r.call(t,o)?t[o]=e(t[o],s,i):t[o]=s,t}),s)}}},Ol2H:function(e,t,n){"use strict";var i=n("Udjz"),r=n("m6w3"),o=n("mXGw"),s=n.n(o),a=n("/m4v"),c=n("dAGg"),u=n("d/x8"),d=n("BbeL"),l=n("AYj1"),h=n("aD51"),g=n("XmMX"),p=n("3oVe");s.a.createElement;function f(){var e=Object(l.a)(["\n  margin-right: 4px;\n"]);return f=function(){return e},e}function y(){var e=Object(l.a)(["\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  align-self: stretch;\n  flex-shrink: 0;\n  height: 40px;\n  margin: 0;\n  border-radius: 0;\n  background-color: var(--color-jetBlack);\n  color: var(--color-paperWhite);\n  &:hover,\n  &:active,\n  &:disabled {\n    color: var(--color-paperWhite);\n  }\n  font-size: ","px;\n  font-weight: ",";\n"]);return y=function(){return e},e}var m=Object(h.css)(y(),u.styles.typography.sizes.p2.size,u.styles.typography.weight.medium),v=Object(h.css)(f()),_=Object(g.c)((function(e){var t=e.t,n=Object(a.d)(),i=Object(o.useCallback)((function(){n({type:p.GLOBAL_EVENTS_CLOSE})}),[n]);return Object(h.jsx)(u.Button,{variant:"primarySimple",css:m,size:"small",onClick:i},Object(h.jsx)(u.Icon,{icon:"close",color:"paperWhite",size:"small",css:v}),t("homeScreen.general.closeWidget"))})),S=n("sYZ1"),b=s.a.createElement;function A(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?A(Object(n),!0).forEach((function(t){Object(r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):A(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var E={backgroundColor:"moonGrey",padded:!0};t.a=function(e){var t=e.header,n=e.median,r=e.containerProps,o=void 0===r?{}:r,s=e.children,l=Object(c.useRouter)(),h=Object(a.e)(S.c),g=w({},w(w({},E),o)),p="full"===h;return b(u.Container,Object(i.a)({prefix:p&&b(_,null),header:t},w(w({},E),o),{median:n,branding:"/landing"!==l.asPath&&!0!==g.disableBranding&&b(d.a,null),headerKey:g.headerKey||l.asPath,medianKey:g.medianKey||l.asPath,bodyKey:g.bodyKey||l.asPath,overlap:"/"===l.asPath,fluid:p}),s)}},"P09+":function(e,t,n){"use strict";var i;t.__esModule=!0,t.LoadableContext=void 0;var r=((i=n("mXGw"))&&i.__esModule?i:{default:i}).default.createContext(null);t.LoadableContext=r},"QJ+M":function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixBaseApis=d;var r=n("0c22"),o=n("uZMU"),s=n("Lk+r"),a=i(n("dZ+v")),c=n("lWzV");function u(e,t){switch(e){case r.SERVICE_TYPES.IS:return t+c.PREFIX_IDENTITY_V2+"/terms";case r.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function d(e){a.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;const t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:c.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new c.MatrixHttpApi(this,t),this._txnCtr=0}d.prototype.getHomeserverUrl=function(){return this.baseUrl},d.prototype.getIdentityServerUrl=function(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},d.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=a.ensureNoTrailingSlash(e),this._http.setIdBaseUrl(this.idBaseUrl)},d.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},d.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},d.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},d.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then((e=>e.available))},d.prototype.register=function(e,t,n,i,r,o,s,a){!0===r?r={email:!0}:null!==r&&void 0!==r||(r={}),"function"===typeof s&&(a=s,s=void 0),n&&(i.session=n);const c={auth:i};return void 0!==e&&null!==e&&(c.username=e),void 0!==t&&null!==t&&(c.password=t),r.email&&(c.bind_email=!0),r.msisdn&&(c.bind_msisdn=!0),void 0!==o&&null!==o&&(c.guest_access_token=o),void 0!==s&&null!==s&&(c.inhibit_login=s),void 0!==t&&null!==t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)},d.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},d.prototype.registerRequest=function(e,t,n){const i={};return t&&(i.kind=t),this._http.request(n,"POST","/register",i,e)},d.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},d.prototype.login=function(e,t,n){const i={type:e};return a.extend(i,t),this._http.authedRequest(((e,t)=>{t&&t.access_token&&t.user_id&&(this._http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),n&&n(e,t)}),"POST","/login",void 0,i)},d.prototype.loginWithPassword=function(e,t,n){return this.login("m.login.password",{user:e,password:t},n)},d.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},d.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},d.prototype.getSsoLoginUrl=function(e,t,n){void 0===t&&(t="sso");let i=c.PREFIX_R0,r="/login/"+t+"/redirect";return n&&(r+="/"+n,i="/_matrix/client/unstable/org.matrix.msc2858"),this._http.getUrl(r,{redirectUrl:e},i)},d.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},d.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},d.prototype.deactivateAccount=function(e,t){if("function"===typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,n)},d.prototype.getFallbackAuthUrl=function(e,t){const n=a.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(n,{session:t},c.PREFIX_R0)},d.prototype.createRoom=async function(e,t){const n=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(n.length>0&&this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of n)t.id_access_token=e}return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},d.prototype.fetchRelations=async function(e,t,n,i,r){const o={};r.from&&(o.from=r.from);const s=a.encodeParams(o),u=a.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+s,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return await this._http.authedRequest(void 0,"GET",u,null,null,{prefix:c.PREFIX_UNSTABLE})},d.prototype.roomState=function(e,t){const n=a.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",n)},d.prototype.fetchRoomEvent=function(e,t,n){const i=a.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(n,"GET",i)},d.prototype.members=function(e,t,n,i,r){const o={};t&&(o.membership=t),n&&(o.not_membership=n),i&&(o.at=i);const s=a.encodeParams(o),c=a.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this._http.authedRequest(r,"GET",c)},d.prototype.upgradeRoom=function(e,t){const n=a.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",n,void 0,{new_version:t})},d.prototype.getGroupSummary=function(e){const t=a.encodeUri("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.getGroupProfile=function(e){const t=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.setGroupProfile=function(e,t){const n=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",n,void 0,t)},d.prototype.setGroupJoinPolicy=function(e,t){const n=a.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.join_policy":t})},d.prototype.getGroupUsers=function(e){const t=a.encodeUri("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.getGroupInvitedUsers=function(e){const t=a.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.getGroupRooms=function(e){const t=a.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.inviteUserToGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},d.prototype.removeUserFromGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},d.prototype.addUserToGroupSummary=function(e,t,n){const i=a.encodeUri(n?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:n,$userId:t});return this._http.authedRequest(void 0,"PUT",i,void 0,{})},d.prototype.removeUserFromGroupSummary=function(e,t){const n=a.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},d.prototype.addRoomToGroupSummary=function(e,t,n){const i=a.encodeUri(n?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:n,$roomId:t});return this._http.authedRequest(void 0,"PUT",i,void 0,{})},d.prototype.removeRoomFromGroupSummary=function(e,t){const n=a.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},d.prototype.addRoomToGroup=function(e,t,n){void 0===n&&(n=!0);const i=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",i,void 0,{"m.visibility":{type:n?"public":"private"}})},d.prototype.updateGroupRoomVisibility=function(e,t,n){const i=a.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",i,void 0,{type:n?"public":"private"})},d.prototype.removeRoomFromGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},d.prototype.acceptGroupInvite=function(e,t=null){const n=a.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,t||{})},d.prototype.joinGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},d.prototype.leaveGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},d.prototype.getJoinedGroups=function(){const e=a.encodeUri("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},d.prototype.createGroup=function(e){const t=a.encodeUri("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},d.prototype.getPublicisedGroups=function(e){const t=a.encodeUri("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},d.prototype.setGroupPublicity=function(e,t){const n=a.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,{publicise:t})},d.prototype.getStateEvent=function(e,t,n,i){const r={$roomId:e,$eventType:t,$stateKey:n};let o=a.encodeUri("/rooms/$roomId/state/$eventType",r);return void 0!==n&&(o=a.encodeUri(o+"/$stateKey",r)),this._http.authedRequest(i,"GET",o)},d.prototype.sendStateEvent=function(e,t,n,i,r){const o={$roomId:e,$eventType:t,$stateKey:i};let s=a.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==i&&(s=a.encodeUri(s+"/$stateKey",o)),this._http.authedRequest(r,"PUT",s,void 0,n)},d.prototype.roomInitialSync=function(e,t,n){a.isFunction(t)&&(n=t,t=void 0);const i=a.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(n,"GET",i,{limit:t})},d.prototype.setRoomReadMarkersHttpRequest=function(e,t,n,i){const r=a.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),o={"m.fully_read":t,"m.read":n,"m.hidden":Boolean(!!i&&i.hidden)};return this._http.authedRequest(void 0,"POST",r,void 0,o)},d.prototype.getJoinedRooms=function(){const e=a.encodeUri("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},d.prototype.getJoinedRoomMembers=function(e){const t=a.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},d.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",n,e)},d.prototype.createAlias=function(e,t,n){const i=a.encodeUri("/directory/room/$alias",{$alias:e}),r={room_id:t};return this._http.authedRequest(n,"PUT",i,void 0,r)},d.prototype.deleteAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",n,void 0,void 0)},d.prototype.unstableGetLocalAliases=function(e,t){const n=a.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),i=c.PREFIX_UNSTABLE+"/org.matrix.msc2432";return this._http.authedRequest(t,"GET",n,null,null,{prefix:i})},d.prototype.getRoomIdForAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",n)},d.prototype.resolveRoomAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",n)},d.prototype.getRoomDirectoryVisibility=function(e,t){const n=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",n)},d.prototype.setRoomDirectoryVisibility=function(e,t,n){const i=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(n,"PUT",i,void 0,{visibility:t})},d.prototype.setRoomDirectoryVisibilityAppService=function(e,t,n,i){const r=a.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(i,"PUT",r,void 0,{visibility:n})},d.prototype.searchUserDirectory=function(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},d.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},d.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},d.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},d.prototype.getProfileInfo=function(e,t,n){a.isFunction(t)&&(n=t,t=void 0);const i=t?a.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):a.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(n,"GET",i)},d.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},d.prototype.addThreePid=function(e,t,n){const i={threePidCreds:e,bind:t};return this._http.authedRequest(n,"POST","/account/3pid",null,i)},d.prototype.addThreePidOnly=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})},d.prototype.bindThreePid=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})},d.prototype.unbindThreePid=async function(e,t){const n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},i=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/unbind",null,n,{prefix:i})},d.prototype.deleteThreePid=function(e,t){const n={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,n)},d.prototype.setPassword=function(e,t,n){const i={auth:e,new_password:t};return this._http.authedRequest(n,"POST","/account/password",null,i)},d.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},d.prototype.getDevice=function(e){const t=a.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0)},d.prototype.setDeviceDetails=function(e,t){const n=a.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",n,void 0,t)},d.prototype.deleteDevice=function(e,t){const n=a.encodeUri("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this._http.authedRequest(void 0,"DELETE",n,void 0,i)},d.prototype.deleteMultipleDevices=function(e,t){const n={devices:e};t&&(n.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,n)},d.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},d.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},d.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then((e=>s.PushProcessor.rewriteDefaultRules(e)))},d.prototype.addPushRule=function(e,t,n,i,r){const o=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",o,void 0,i)},d.prototype.deletePushRule=function(e,t,n,i){const r=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(i,"DELETE",r)},d.prototype.setPushRuleEnabled=function(e,t,n,i,r){const o=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",o,void 0,{enabled:i})},d.prototype.setPushRuleActions=function(e,t,n,i,r){const o=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",o,void 0,{actions:i})},d.prototype.search=function(e,t){const n={};return e.next_batch&&(n.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",n,e.body)},d.prototype.uploadKeysRequest=function(e,t,n){return this._http.authedRequest(n,"POST","/keys/upload",void 0,e)},d.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:c.PREFIX_UNSTABLE})},d.prototype.downloadKeysForUsers=function(e,t){if(a.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const n={device_keys:{}};return"token"in(t=t||{})&&(n.token=t.token),e.forEach((e=>{n.device_keys[e]=[]})),this._http.authedRequest(void 0,"POST","/keys/query",void 0,n)},d.prototype.claimOneTimeKeys=function(e,t,n){const i={};void 0===t&&(t="signed_curve25519");for(let o=0;o<e.length;++o){const n=e[o][0],r=e[o][1],s=i[n]||{};i[n]=s,s[r]=t}const r={one_time_keys:i};n&&(r.timeout=n);return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,r)},d.prototype.getKeyChanges=function(e,t){const n={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",n,void 0)},d.prototype.uploadDeviceSigningKeys=function(e,t){const n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,n,{prefix:c.PREFIX_UNSTABLE})},d.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+c.PREFIX_IDENTITY_V2+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},d.prototype.requestEmailToken=async function(e,t,n,i,r,o){const s={client_secret:t,email:e,send_attempt:n,next_link:i};return await this._http.idServerRequest(r,"POST","/validate/email/requestToken",s,c.PREFIX_IDENTITY_V2,o)},d.prototype.requestMsisdnToken=async function(e,t,n,i,r,o,s){const a={client_secret:n,country:e,phone_number:t,send_attempt:i,next_link:r};return await this._http.idServerRequest(o,"POST","/validate/msisdn/requestToken",a,c.PREFIX_IDENTITY_V2,s)},d.prototype.submitMsisdnToken=async function(e,t,n,i){const r={sid:e,client_secret:t,token:n};return await this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",r,c.PREFIX_IDENTITY_V2,i)},d.prototype.submitMsisdnTokenOtherUrl=function(e,t,n,i){const r={sid:t,client_secret:n,token:i};return this._http.requestOtherUrl(void 0,"POST",e,void 0,r)},d.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,c.PREFIX_IDENTITY_V2,e)},d.prototype.identityHashedLookup=async function(t,n){const i={},r=await this.getIdentityHashDetails(n);if(!r||!r.lookup_pepper||!r.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=r.lookup_pepper;const o={};if(r.algorithms.includes("sha256")){const n=new e.Olm.Utility;i.addresses=t.map((e=>{const t=e[0].toLowerCase(),r=e[1].toLowerCase(),s=n.sha256(`${t} ${r} ${i.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[s]=e[0],s})),i.algorithm="sha256"}else{if(!r.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");i.addresses=t.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t})),i.algorithm="none"}const s=await this._http.idServerRequest(void 0,"POST","/lookup",i,c.PREFIX_IDENTITY_V2,n);if(!s||!s.mappings)return[];const a=[];for(const e of Object.keys(s.mappings)){const t=s.mappings[e],n=o[e];if(!n)throw new Error("Identity server returned more results than expected");a.push({address:n,mxid:t})}return a},d.prototype.lookupThreePid=async function(e,t,n,i){const r=(await this.identityHashedLookup([[t,e]],i)).find((e=>e.address===t));if(!r)return n&&n(null,{}),{};const o={address:t,medium:e,mxid:r.mxid};return n&&n(null,o),o},d.prototype.bulkLookupThreePids=async function(e,t){const n=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),i=[];for(const r of n){const t=e.find((e=>e[1]===r.address));if(!t)throw new Error("Identity sever returned unexpected results");i.push([t[0],r.address,r.mxid])}return{threepids:i}},d.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,c.PREFIX_IDENTITY_V2,e)},d.prototype.sendToDevice=function(e,t,n){const i=a.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),r={messages:t},s=Object.keys(t).reduce(((e,n)=>(e[n]=Object.keys(t[n]),e)),{});return o.logger.log(`PUT ${i}`,s),this._http.authedRequest(void 0,"PUT",i,void 0,r)},d.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then((e=>{if(!e||"object"!==typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))},d.prototype.getThirdpartyLocation=function(e,t){const n=a.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",n,t,void 0)},d.prototype.getThirdpartyUser=function(e,t){const n=a.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",n,t,void 0)},d.prototype.getTerms=function(e,t){const n=u(e,t);return this._http.requestOtherUrl(void 0,"GET",n)},d.prototype.agreeToTerms=function(e,t,n,i){const r=u(e,t),o={Authorization:"Bearer "+n};return this._http.requestOtherUrl(void 0,"POST",r,null,{user_accepts:i},{headers:o})},d.prototype.reportEvent=function(e,t,n,i){const r=a.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",r,null,{score:n,reason:i})},d.prototype.getSpaceSummary=function(e,t,n,i,r,o){const s=a.encodeUri("/rooms/$roomId/spaces",{$roomId:e});return this._http.authedRequest(void 0,"POST",s,null,{max_rooms_per_space:t,suggested_only:n,auto_join_only:i,limit:r,batch:o},{prefix:"/_matrix/client/unstable/org.matrix.msc2946"})}}).call(this,n("bqPV"))},QcLs:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=d(n("YUSd")),r=d(n("Zv/C")),o=d(n("2lBV")),s=d(n("Dkg+")),a=d(n("Gjrs")),c=d(n("5rM0")),u=d(n("4ZFb"));function d(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return(0,r.default)(this,t),(0,s.default)(this,(t.__proto__||(0,i.default)(t)).apply(this,arguments))}return(0,a.default)(t,e),(0,o.default)(t,[{key:"onChange",value:function(e,t,n){u.default.dispatch({action:"feature_custom_status_changed"})}}]),t}(c.default);t.default=l,e.exports=t.default},QjTS:function(e,t,n){"use strict";var i=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.CallEventHandler=void 0;var r=i(n("M6nr")),o=n("uZMU"),s=n("/0WT"),a=n("76wp");t.CallEventHandler=class{constructor(e){(0,r.default)(this,"client",void 0),(0,r.default)(this,"calls",void 0),(0,r.default)(this,"callEventBuffer",void 0),(0,r.default)(this,"candidateEventsByCall",void 0),(0,r.default)(this,"evaluateEventBuffer",(()=>{if("SYNCING"===this.client.getSyncState()){if(this.callEventBuffer.some((e=>e.isBeingDecrypted())))return;const t=new Set;for(const e of this.callEventBuffer)e.getType()!==a.EventType.CallAnswer&&e.getType()!==a.EventType.CallHangup||t.add(e.getContent().call_id);for(const n of this.callEventBuffer)if(n.getType()!==a.EventType.CallInvite||!t.has(n.getContent().call_id))try{this.handleCallEvent(n)}catch(e){o.logger.error("Caught exception handling call event",e)}this.callEventBuffer=[]}})),(0,r.default)(this,"onEvent",(e=>{(0===e.getType().indexOf("m.call.")||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",(()=>{if(-1!==e.getType().indexOf("m.call."))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{this.handleCallEvent(e)}catch(t){o.logger.error("Caught exception handling call event",t)}}))})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map,this.client.on("sync",this.evaluateEventBuffer),this.client.on("event",this.onEvent)}stop(){this.client.removeListener("sync",this.evaluateEventBuffer),this.client.removeListener("event",this.onEvent)}handleCallEvent(e){const t=e.getContent();let n=t.call_id?this.calls.get(t.call_id):void 0;if(e.getType()===a.EventType.CallInvite){if(e.getSender()===this.client.credentials.userId)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(n&&n.state===s.CallState.Ended)return;n&&o.logger.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const i=this.client.getTurnServersExpiry()-Date.now();if(o.logger.info("Current turn creds expire in "+i+" ms"),n=(0,s.createNewMatrixCall)(this.client,e.getRoomId(),{forceTURN:this.client._forceTURN}),!n)return void o.logger.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(n.callId=t.call_id,n.initWithInvite(e),this.calls.set(n.callId,n),this.candidateEventsByCall.get(n.callId))for(const e of this.candidateEventsByCall.get(n.callId))n.onRemoteIceCandidatesReceived(e);let r;for(const e of this.calls.values()){const t=[s.CallState.WaitLocalMedia,s.CallState.CreateOffer,s.CallState.InviteSent].includes(e.state);if(n.roomId===e.roomId&&e.direction===s.CallDirection.Outbound&&t){r=e;break}}r?r.state===s.CallState.WaitLocalMedia||r.state===s.CallState.CreateOffer||r.callId>n.callId?(o.logger.log("Glare detected: answering incoming call "+n.callId+" and canceling outgoing call "+r.callId),r.replacedBy(n),n.answer()):(o.logger.log("Glare detected: rejecting incoming call "+n.callId+" and keeping outgoing call "+r.callId),n.hangup(s.CallErrorCode.Replaced,!0)):this.client.emit("Call.incoming",n)}else if(e.getType()===a.EventType.CallAnswer){if(!n)return;e.getSender()===this.client.credentials.userId?n.state===s.CallState.Ringing&&n.onAnsweredElsewhere(t):n.onAnswerReceived(e)}else if(e.getType()===a.EventType.CallCandidates){if(e.getSender()===this.client.credentials.userId)return;n?n.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else if([a.EventType.CallHangup,a.EventType.CallReject].includes(e.getType()))n?n.state!==s.CallState.Ended&&(e.getType()===a.EventType.CallHangup?n.onHangupReceived(t):n.onRejectReceived(t),this.calls.delete(t.call_id)):(n=(0,s.createNewMatrixCall)(this.client,e.getRoomId()),n&&(n.callId=t.call_id,n.initWithHangup(e),this.calls.set(t.call_id,n)));else if(e.getType()===a.EventType.CallSelectAnswer){if(!n)return;if(e.getContent().party_id===n.ourPartyId)return;n.onSelectAnswerReceived(e)}else if(e.getType()===a.EventType.CallNegotiate){if(!n)return;if(e.getContent().party_id===n.ourPartyId)return;n.onNegotiateReceived(e)}}}},QzvL:function(e,t,n){"use strict";var i=n("Dlk0"),r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var o=r(n("M6nr")),s=n("uZMU"),a=i(n("dZ+v"));function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){(0,o.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.MemoryCryptoStore=class{constructor(){this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._privateKeys={},this._backupKeys={},this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={},this._sharedHistoryInboundGroupSessions={}}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return a.promiseTry((()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(s.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),n):(s.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this._outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this._outgoingRoomKeyRequests)if(a.deepCompare(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this._outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this._outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,n){const i=[];for(const r of this._outgoingRoomKeyRequests)for(const o of n)r.state===o&&r.recipients.includes({userId:e,deviceId:t})&&i.push(r);return Promise.resolve(i)}updateOutgoingRoomKeyRequest(e,t,n){for(const i of this._outgoingRoomKeyRequests)if(i.requestId===e)return i.state!=t?(s.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${i.state}`),Promise.resolve(null)):(Object.assign(i,n),Promise.resolve(i));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this._outgoingRoomKeyRequests.length;n++){const i=this._outgoingRoomKeyRequests[n];if(i.requestId===e)return i.state!=t?(s.logger.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(n,1),Promise.resolve(i))}return Promise.resolve(null)}getAccount(e,t){t(this._account)}storeAccount(e,t){this._account=t}getCrossSigningKeys(e,t){t(this._crossSigningKeys)}getSecretStorePrivateKey(e,t,n){return t(this._privateKeys[n]||null)}storeCrossSigningKeys(e,t){this._crossSigningKeys=t}storeSecretStorePrivateKey(e,t,n){this._privateKeys[t]=n}countEndToEndSessions(e,t){return Object.keys(this._sessions).length}getEndToEndSession(e,t,n,i){i((this._sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,n){n(this._sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this._sessions).forEach((([e,n])=>{Object.entries(n).forEach((([n,i])=>{t(u(u({},i),{},{deviceKey:e,sessionId:n}))}))}))}storeEndToEndSession(e,t,n,i){let r=this._sessions[e];void 0===r&&(r={},this._sessions[e]=r),r[t]=n}async storeEndToEndSessionProblem(e,t,n){const i=this._sessionProblems[e]=this._sessionProblems[e]||[];i.push({type:t,fixed:n,time:Date.now()}),i.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const n=this._sessionProblems[e]||[];if(!n.length)return null;const i=n[n.length-1];for(const r of n)if(r.time>t)return Object.assign({},r,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=this._notifiedErrorDevices,n=[];for(const i of e){const{userId:e,deviceInfo:r}=i;e in t?r.deviceId in t[e]||(n.push(i),t[e][r.deviceId]=!0):(n.push(i),t[e]={[r.deviceId]:!0})}return n}getEndToEndInboundGroupSession(e,t,n,i){const r=e+"/"+t;i(this._inboundGroupSessions[r]||null,this._inboundGroupSessionsWithheld[r]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const n of Object.keys(this._inboundGroupSessions))t({senderKey:n.substr(0,43),sessionId:n.substr(44),sessionData:this._inboundGroupSessions[n]});t(null)}addEndToEndInboundGroupSession(e,t,n,i){const r=e+"/"+t;void 0===this._inboundGroupSessions[r]&&(this._inboundGroupSessions[r]=n)}storeEndToEndInboundGroupSession(e,t,n,i){this._inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){const r=e+"/"+t;this._inboundGroupSessionsWithheld[r]=n}getEndToEndDeviceData(e,t){t(this._deviceData)}storeEndToEndDeviceData(e,t){this._deviceData=e}storeEndToEndRoom(e,t,n){this._rooms[e]=t}getEndToEndRooms(e,t){t(this._rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this._sessionsNeedingBackup)if(this._inboundGroupSessions[n]&&(t.push({senderKey:n.substr(0,43),sessionId:n.substr(44),sessionData:this._inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this._sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this._sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,n){const i=this._sharedHistoryInboundGroupSessions[e]||[];i.push([t,n]),this._sharedHistoryInboundGroupSessions[e]=i}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this._sharedHistoryInboundGroupSessions[e]||[])}doTxn(e,t,n){return Promise.resolve(n(null))}}},R0YP:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAAXNSR0IArs4c6QAAAUFJREFUKBWFkcFKw0AQhmfWDa3PoD3oTcFiVTx48uq5IIiVHMSLoNiiQXwBoVSKehSESMlBeq9PIFKtSn0FFd/AatIZZxcTohRd2M0/3/wZZmcRfq3djp9H5TwiAIZ9ytfnSk9pi3CASvs8p51MEwhOGDGHCIfWROAB8pvoTYBesTqz/qpNQuvMpRScBwUNW8G65VBQFW4j5mwgYlGZiACOLf3zwFOTVpVbvyAtjCde5lb4Ho6aDaITjjy207mYQO8h4ASKMMb6gvtiWPnaH3GGned03raUBv9p/UnRpEa9pBCOjNnJ6jOpvBHruAABHVDUv7Ij2LsPinKPZpwc9JUfVmuFUmBbQuDtQaY0U4xbJv6+Q29FJnLDzK7M2EuMzPtEtAbA7Sj6WDb8xzsZUL5rTDlDqiujY6Zwujbrdg2P1xc0xG1oEJta1gAAAABJRU5ErkJggg=="},RAuX:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=g(n("tZmG")),r=g(n("t3kO")),o=g(n("YUSd")),s=g(n("Zv/C")),a=g(n("2lBV")),c=g(n("Dkg+")),u=g(n("Gjrs")),d=g(n("BGZc")),l=g(n("pZ3Y")),h=n("oOXF");function g(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e){(0,s.default)(this,t);var n=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return n._watchers=e,n._onEvent=n._onEvent.bind(n),n}return(0,u.default)(t,e),(0,a.default)(t,[{key:"initMatrixClient",value:function(e,t){e&&e.removeListener("RoomState.events",this._onEvent),t.on("RoomState.events",this._onEvent)}},{key:"_onEvent",value:function(e){var t=e.getRoomId();if("org.matrix.room.preview_urls"===e.getType()){var n=e.getContent().disable;n="boolean"!==typeof n?null:!n,this._watchers.notifyUpdate("urlPreviewsEnabled",t,h.SettingLevel.ROOM,n)}else if("im.vector.web.settings"===e.getType()){var o=!0,s=!1,a=void 0;try{for(var c,u=(0,r.default)((0,i.default)(e.getContent()));!(o=(c=u.next()).done);o=!0){var d=c.value;this._watchers.notifyUpdate(d,t,h.SettingLevel.ROOM,e.getContent()[d])}}catch(l){s=!0,a=l}finally{try{!o&&u.return&&u.return()}finally{if(s)throw a}}}}},{key:"getValue",value:function(e,t){if("urlPreviewsEnabled"===e){var n=this._getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!==typeof n.disable?null:!n.disable}return(this._getSettings(t)||{})[e]}},{key:"setValue",value:function(e,t,n){if("urlPreviewsEnabled"===e){var i=this._getSettings(t,"org.matrix.room.preview_urls")||{};return i.disable=!n,d.default.get().sendStateEvent(t,"org.matrix.room.preview_urls",i)}var r=this._getSettings(t)||{};return r[e]=n,d.default.get().sendStateEvent(t,"im.vector.web.settings",r,"")}},{key:"canSetValue",value:function(e,t){var n=d.default.get(),i=n.getRoom(t),r="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(r="org.matrix.room.preview_urls"),!!i&&i.currentState.maySendStateEvent(r,n.getUserId())}},{key:"isSupported",value:function(){var e=d.default.get();return void 0!==e&&null!==e}},{key:"_getSettings",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"im.vector.web.settings",n=d.default.get().getRoom(e);if(!n)return null;var i=n.currentState.getStateEvents(t,"");return i&&i.getContent()?i.getContent():null}}]),t}(l.default);t.default=p,e.exports=t.default},S3RR:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAYRJREFUeNpi/P//PwMtAeOwtuDTr3+7nv568OXv1z8IQV4WxlgVdlFOZkotAJo+6+Z3AyEWLQEWblZGuPimhz9f/fgfo8wuzkWUHUy4JIBuB5puKsqKbDoQ3Pvyz1aCZdHdH8++/qXIAmDIAN2OVQoo7izJtvTuj8df/pBvATDc0dwOB9wsjOr8zG7SbMvv/Xzw+Q+ZFuCLN0ZGLhZGNX5mL1m2Vfd/3vn0h8oWQOzgZGFS4WPxlWNb9+DnzQ9/qGwBBHAwMyrzsgTIs296/PPq+9/UsYCPlfH9z39wLhszoyIvc5A8+/Ynvy69/U0FC7QEmDc++olsBysTowIPc6gi+/pHvzDVs5BqgZkoy6nXf+bf/vH5N1FlDMkWMDEyWoixAhGm1ISr36kcyRTl5FELRi0YtQBUqzB8/U1Cg+PL7/88LIwkWAAsv659+EO8Bdc//JHnYSLBAlcp1gvv/px+/ZugP4AKgMqAioFaqNAuwhqYQO8Cq2g+NqaR1nQcGhYABBgA1GCpg4mQ1jsAAAAASUVORK5CYII="},SWkS:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAABGdBTUEAALGPC/xhBQAAAGFJREFUWAnt0rENwCAQBEFMWzTswD0aiRYmIVjylV7DPd96/3Hxmxffdk7rQP2hBBNUAe3bYIIqoH0bTFAFtG+DCaqA9m0wQRXQvg0mqALat8EEVUD7NpigCmjfBhNUAe03SH4C3lGgzecAAAAASUVORK5CYII="},SeIk:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s(n("OBCi")),r=s(n("Zv/C")),o=s(n("2lBV"));function s(e){return e&&e.__esModule?e:{default:e}}var a=function(){function e(){(0,r.default)(this,e)}return(0,o.default)(e,[{key:"getValue",value:function(e,t){return console.error("Invalid operation: getValue was not overridden"),null}},{key:"setValue",value:function(e,t,n){return console.error("Invalid operation: setValue was not overridden"),i.default.reject()}},{key:"canSetValue",value:function(e,t){return!1}},{key:"isSupported",value:function(){return!1}}]),e}();t.default=a,e.exports=t.default},TJNI:function(e,t,n){"use strict";var i=String.prototype.replace,r=/%20/g,o="RFC1738",s="RFC3986";e.exports={default:s,formatters:{RFC1738:function(e){return i.call(e,r,"+")},RFC3986:function(e){return String(e)}},RFC1738:o,RFC3986:s}},U4NU:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkConsistency=async function(){c("Checking storage consistency"),c("Local storage supported? "+!!o.default),c("IndexedDB supported? "+!!s.default);var e=!1,t=!0;o.default?c("Local storage contains data? "+(e=o.default.length>0)):(t=!1,u("Local storage cannot be used on this browser"));if(s.default&&o.default){(await async function(){var e=!1,t=r.default.options.storeName;try{return c("Sync store using IndexedDB contains data? "+(e=await i.default.IndexedDBStore.exists(s.default,t))),{exists:e,healthy:!0}}catch(n){u("Sync store using IndexedDB inaccessible")}return c("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(t=!1)}else t=!1,u("Sync store cannot be used on this browser");t?c("Storage consistency checks passed"):u("Storage consistency checks failed");return{dataInLocalStorage:e,cryptoInited:!1,healthy:t}},t.trackStores=function(e){e.store&&e.store.on&&e.store.on("degraded",(function(){}))},t.setCryptoInitialised=function(e){o.default.setItem("mx_crypto_initialised",e)};var i=a(n("F41g")),r=a(n("zUyb")),o=a(n("kPC3")),s=a(n("bDtH"));function a(e){return e&&e.__esModule?e:{default:e}}function c(e){console.log("StorageManager: "+e)}function u(e){console.error("StorageManager: "+e)}},"U7/A":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAARNJREFUeNrslr8OQ0Acx3vXJkhMLIhBJBZPIDH6MzB6BgaJ0aMYiM0TeBomMXoBm0Qv7SKl7Ul7Qxvf7ffzu8/HJUcOzPN8IpnLskjT9CtQ13Udx9kQoARBIAjCJ/S6rp/uAAXRFUX5REDT9LKEJ8I5BL8m6Louy7JxHIkIEL0sy77vi6LAd8BddFmWz7fgOyA+3TRN27YhhGEY4jsgPt33/XuHYRh8B9xL3+t4I2jbdk1fOiiKGoYB93e9jud5L54iRxzHx5d8CEgLHo9pnucAgPVckiSiKC47VVU1TbOenKZJVdVtQRRFz16E47iHjmVZhmFsDvM8vy3QNA1/75IkHafoHwUsy+q6vmsJIH19vwowAKIcZ6YDvcyDAAAAAElFTkSuQmCC"},UESs:function(e,t,n){"use strict";function i(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=r.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=i,i.fromStorage=function(e,t){const n=new i(t);for(const i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n},i.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},i.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},i.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},i.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},i.prototype.isBlocked=function(){return this.verified==r.BLOCKED},i.prototype.isVerified=function(){return this.verified==r.VERIFIED},i.prototype.isUnverified=function(){return this.verified==r.UNVERIFIED},i.prototype.isKnown=function(){return 1==this.known},i.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};const r=i.DeviceVerification},Ug1r:function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.OutgoingRoomKeyRequestManager=t.ROOM_KEY_REQUEST_STATES=void 0;var r=n("uZMU"),o=i(n("dZ+v"));const s={UNSENT:0,SENT:1,CANCELLATION_PENDING:2,CANCELLATION_PENDING_AND_WILL_RESEND:3};t.ROOM_KEY_REQUEST_STATES=s;function a(e){return e.room_id+" / "+e.session_id}function c(e){return"["+o.map(e,(e=>`${e.userId}:${e.deviceId}`)).join(",")+"]"}t.OutgoingRoomKeyRequestManager=class{constructor(e,t,n){this._baseApis=e,this._deviceId=t,this._cryptoStore=n,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}start(){this._clientRunning=!0}stop(){r.logger.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}sendQueuedRequests(){this._startTimer()}async queueRoomKeyRequest(e,t,n=!1){const i=await this._cryptoStore.getOutgoingRoomKeyRequest(e);if(i)switch(i.state){case s.CANCELLATION_PENDING_AND_WILL_RESEND:case s.UNSENT:return;case s.CANCELLATION_PENDING:{const e=n?s.CANCELLATION_PENDING_AND_WILL_RESEND:s.SENT;await this._cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,s.CANCELLATION_PENDING,{state:e,cancellationTxnId:this._baseApis.makeTxnId()});break}case s.SENT:if(n){const a=s.CANCELLATION_PENDING_AND_WILL_RESEND,c=await this._cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,s.SENT,{state:a,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});if(!c)return await this.queueRoomKeyRequest(e,t,n);try{await this._sendOutgoingRoomKeyRequestCancellation(c,!0)}catch(o){r.logger.error("Error sending room key request cancellation; will retry later.",o)}}break;default:throw new Error("unhandled state: "+i.state)}else await this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:s.UNSENT})}cancelRoomKeyRequest(e){return this._cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case s.CANCELLATION_PENDING:case s.CANCELLATION_PENDING_AND_WILL_RESEND:return;case s.UNSENT:return r.logger.log("deleting unnecessary room key request for "+a(e)),this._cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,s.UNSENT);case s.SENT:return this._cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,s.SENT,{state:s.CANCELLATION_PENDING,cancellationTxnId:this._baseApis.makeTxnId()}).then((t=>{t?this._sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{r.logger.error("Error sending room key request cancellation; will retry later.",e),this._startTimer()})):r.logger.log("Tried to cancel room key request for "+a(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[s.SENT])}async cancelAndResendAllOutgoingRequests(){const e=await this._cryptoStore.getAllOutgoingRoomKeyRequestsByState(s.SENT);return Promise.all(e.map((({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0))))}_startTimer(){if(this._sendOutgoingRoomKeyRequestsTimer)return;this._sendOutgoingRoomKeyRequestsTimer=e.setTimeout((()=>{if(this._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this._sendOutgoingRoomKeyRequestsRunning=!0,this._sendOutgoingRoomKeyRequests().finally((()=>{this._sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{r.logger.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))}),500)}_sendOutgoingRoomKeyRequests(){return this._clientRunning?this._cryptoStore.getOutgoingRoomKeyRequestByState([s.CANCELLATION_PENDING,s.CANCELLATION_PENDING_AND_WILL_RESEND,s.UNSENT]).then((e=>{if(!e)return void(this._sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case s.UNSENT:t=this._sendOutgoingRoomKeyRequest(e);break;case s.CANCELLATION_PENDING:t=this._sendOutgoingRoomKeyRequestCancellation(e);break;case s.CANCELLATION_PENDING_AND_WILL_RESEND:t=this._sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then((()=>this._sendOutgoingRoomKeyRequests())).catch((e=>{r.logger.error("Error sending room key request; will retry later.",e),this._sendOutgoingRoomKeyRequestsTimer=null}))})):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}_sendOutgoingRoomKeyRequest(e){r.logger.log(`Requesting keys for ${a(e.requestBody)} from ${c(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,s.UNSENT,{state:s.SENT})))}_sendOutgoingRoomKeyRequestCancellation(e,t){r.logger.log(`Sending cancellation for key request for ${a(e.requestBody)} to ${c(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((()=>t?this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,s.CANCELLATION_PENDING_AND_WILL_RESEND,{state:s.UNSENT}):this._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,s.CANCELLATION_PENDING)))}_sendMessageToDevices(e,t,n){const i={};for(const r of t)i[r.userId]||(i[r.userId]={}),i[r.userId][r.deviceId]=e;return this._baseApis.sendToDevice("m.room_key_request",i,n)}}}).call(this,n("bqPV"))},UhrY:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var i=n("uZMU"),r=n("QzvL");const o="crypto.",s="crypto.account",a="crypto.cross_signing_keys",c="crypto.notified_error_devices",u="crypto.device_data",d="crypto.inboundgroupsessions/",l="crypto.sessionsneedingbackup";function h(e){return"crypto.sessions/"+e}function g(e){return"crypto.session.problems/"+e}function p(e,t){return d+e+"/"+t}function f(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function y(e){return"crypto.rooms/"+e}class m extends r.MemoryCryptoStore{constructor(e){super(),this.store=e}static exists(e){const t=e.length;for(let n=0;n<t;n++)if(e.key(n).startsWith(o))return!0;return!1}countEndToEndSessions(e,t){let n=0;for(let i=0;i<this.store.length;++i)this.store.key(i).startsWith(h(""))&&++n;t(n)}_getEndToEndSessions(e,t,n){const i=v(this.store,h(e)),r={};for(const[o,s]of Object.entries(i||{}))r[o]="string"===typeof s?{session:s}:s;return r}getEndToEndSession(e,t,n,i){i(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let n=0;n<this.store.length;++n)if(this.store.key(n).startsWith(h(""))){const e=this.store.key(n).split("/")[1];for(const n of Object.values(this._getEndToEndSessions(e)))t(n)}}storeEndToEndSession(e,t,n,i){const r=this._getEndToEndSessions(e)||{};r[t]=n,_(this.store,h(e),r)}async storeEndToEndSessionProblem(e,t,n){const i=g(e),r=v(this.store,i)||[];r.push({type:t,fixed:n,time:Date.now()}),r.sort(((e,t)=>e.time-t.time)),_(this.store,i,r)}async getEndToEndSessionProblem(e,t){const n=g(e),i=v(this.store,n)||[];if(!i.length)return null;const r=i[i.length-1];for(const o of i)if(o.time>t)return Object.assign({},o,{fixed:r.fixed});return r.fixed?null:r}async filterOutNotifiedErrorDevices(e){const t=v(this.store,c)||{},n=[];for(const i of e){const{userId:e,deviceInfo:r}=i;e in t?r.deviceId in t[e]||(n.push(i),t[e][r.deviceId]=!0):(n.push(i),t[e]={[r.deviceId]:!0})}return _(this.store,c,t),n}getEndToEndInboundGroupSession(e,t,n,i){i(v(this.store,p(e,t)),v(this.store,f(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let n=0;n<this.store.length;++n){const e=this.store.key(n);e.startsWith(d)&&t({senderKey:e.substr(d.length,43),sessionId:e.substr(d.length+44),sessionData:v(this.store,e)})}t(null)}addEndToEndInboundGroupSession(e,t,n,i){v(this.store,p(e,t))||this.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){_(this.store,p(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){_(this.store,f(e,t),n)}getEndToEndDeviceData(e,t){t(v(this.store,u))}storeEndToEndDeviceData(e,t){_(this.store,u,e)}storeEndToEndRoom(e,t,n){_(this.store,y(e),t)}getEndToEndRooms(e,t){const n={},i=y("");for(let r=0;r<this.store.length;++r){const e=this.store.key(r);if(e.startsWith(i)){n[e.substr(i.length)]=v(this.store,e)}}t(n)}getSessionsNeedingBackup(e){const t=v(this.store,l)||{},n=[];for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const t=i.substr(0,43),r=i.substr(44);if(this.getEndToEndInboundGroupSession(t,r,null,(e=>{n.push({senderKey:t,sessionId:r,sessionData:e})})),e&&i.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=v(this.store,l)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=v(this.store,l)||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return _(this.store,l,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=v(this.store,l)||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return _(this.store,l,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(s),Promise.resolve()}getAccount(e,t){t(v(this.store,s))}storeAccount(e,t){_(this.store,s,t)}getCrossSigningKeys(e,t){t(v(this.store,a))}getSecretStorePrivateKey(e,t,n){t(v(this.store,`crypto.ssss_cache.${n}`))}storeCrossSigningKeys(e,t){_(this.store,a,t)}storeSecretStorePrivateKey(e,t,n){_(this.store,`crypto.ssss_cache.${t}`,n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function v(e,t){try{return JSON.parse(e.getItem(t))}catch(n){i.logger.log("Error: Failed to get key %s: %s",t,n.stack||n),i.logger.log(n.stack)}return null}function _(e,t,n){e.setItem(t,JSON.stringify(n))}t.LocalStorageCryptoStore=m},Uma8:function(e,t,n){"use strict";(function(i){Object.defineProperty(t,"__esModule",{value:!0});var r=v(n("snOE")),o=v(n("Kz1y")),s=v(n("6J4u")),a=v(n("OBCi")),c=v(n("Zv/C")),u=v(n("2lBV")),d=v(n("mXGw")),l=v(n("xARA")),h=v(n("W0B4")),g=v(n("0VMN")),p=v(n("v61F")),f=v(n("4ZFb")),y=n("nPNV"),m=n("BdGh");function v(e){return e&&e.__esModule?e:{default:e}}var _="mx_Dialog_Container",S="mx_Dialog_StaticContainer",b=(0,g.default)({displayName:"AsyncWrapper",propTypes:{prom:h.default.object.isRequired},getInitialState:function(){return{component:null,error:null}},componentWillMount:function(){var e=this;this._unmounted=!1,console.log("Starting load of AsyncWrapper for modal"),this.props.prom.then((function(t){if(!e._unmounted){var n=t.default?t.default:t;e.setState({component:n})}})).catch((function(t){console.warn("AsyncWrapper promise failed",t),e.setState({error:t})}))},componentWillUnmount:function(){this._unmounted=!0},_onWrapperCancelClick:function(){this.props.onFinished(!1)},render:function(){if(this.state.component){var e=this.state.component;return d.default.createElement(e,this.props)}if(this.state.error){var t=p.default.getComponent("views.dialogs.BaseDialog"),n=p.default.getComponent("views.elements.DialogButtons");return d.default.createElement(t,{onFinished:this.props.onFinished,title:(0,y._t)("Error")},(0,y._t)("Unable to load! Check your network connectivity and try again."),d.default.createElement(n,{primaryButton:(0,y._t)("Dismiss"),onPrimaryButtonClick:this._onWrapperCancelClick,hasCancel:!1}))}return null}}),A=function(){function e(){(0,c.default)(this,e),this._counter=0,this._priorityModal=null,this._staticModal=null,this._modals=[],this.closeAll=this.closeAll.bind(this)}return(0,u.default)(e,[{key:"hasDialogs",value:function(){return this._priorityModal||this._staticModal||this._modals.length>0}},{key:"getOrCreateContainer",value:function(){var e=document.getElementById(_);return e||((e=document.createElement("div")).id=_,document.body.appendChild(e)),e}},{key:"getOrCreateStaticContainer",value:function(){var e=document.getElementById(S);return e||((e=document.createElement("div")).id=S,document.body.appendChild(e)),e}},{key:"createTrackedDialog",value:function(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.createDialog.apply(this,i)}},{key:"appendTrackedDialog",value:function(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.appendDialog.apply(this,i)}},{key:"createDialog",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.createDialogAsync.apply(this,[a.default.resolve(e)].concat(n))}},{key:"appendDialog",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.appendDialogAsync.apply(this,[a.default.resolve(e)].concat(n))}},{key:"createTrackedDialogAsync",value:function(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.createDialogAsync.apply(this,i)}},{key:"appendTrackedDialogAsync",value:function(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this.appendDialogAsync.apply(this,i)}},{key:"_buildModal",value:function(e,t,n){var i={},r=this._getCloseFn(i,t),a=(0,s.default)(r,2),c=a[0],u=a[1],l=this._counter++;return i.elem=d.default.createElement(b,(0,o.default)({key:l,prom:e},t,{onFinished:c})),i.onFinished=t?t.onFinished:null,i.className=n,{modal:i,closeDialog:c,onFinishedProm:u}}},{key:"_getCloseFn",value:function(e,t){var n=this,i=(0,m.defer)();return[function(){for(var r=arguments.length,o=Array(r),s=0;s<r;s++)o[s]=arguments[s];i.resolve(o),t&&t.onFinished&&t.onFinished.apply(null,o);var a=n._modals.indexOf(e);a>=0&&n._modals.splice(a,1),n._priorityModal===e&&(n._priorityModal=null,n._modals=[]),n._staticModal===e&&(n._staticModal=null,n._modals=[]),n._reRender()},i.promise]}},{key:"createDialogAsync",value:function(e,t,n,i,r){var o=this._buildModal(e,t,n),s=o.modal,a=o.closeDialog,c=o.onFinishedProm;return i?this._priorityModal=s:r?this._staticModal=s:this._modals.unshift(s),this._reRender(),{close:a,finished:c}}},{key:"appendDialogAsync",value:function(e,t,n){var i=this._buildModal(e,t,n),r=i.modal,o=i.closeDialog,s=i.onFinishedProm;return this._modals.push(r),this._reRender(),{close:o,finished:s}}},{key:"closeAll",value:function(){var e=[].concat((0,r.default)(this._modals),[this._priorityModal]);this._modals=[],this._priorityModal=null,this._staticModal&&0===e.length&&(e.push(this._staticModal),this._staticModal=null);for(var t=0;t<e.length;t++){var n=e[t];n&&n.onFinished&&n.onFinished(!1)}this._reRender()}},{key:"_reRender",value:function(){if(0===this._modals.length&&!this._priorityModal&&!this._staticModal)return f.default.dispatch({action:"aria_unhide_main_app"}),l.default.unmountComponentAtNode(this.getOrCreateContainer()),void l.default.unmountComponentAtNode(this.getOrCreateStaticContainer());if(f.default.dispatch({action:"aria_hide_main_app"}),this._staticModal){var e="mx_Dialog_wrapper mx_Dialog_staticWrapper "+(this._staticModal.className?this._staticModal.className:""),t=d.default.createElement("div",{className:e},d.default.createElement("div",{className:"mx_Dialog"},this._staticModal.elem),d.default.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.closeAll}));l.default.render(t,this.getOrCreateStaticContainer())}else l.default.unmountComponentAtNode(this.getOrCreateStaticContainer());var n=this._priorityModal?this._priorityModal:this._modals[0];if(n){var i="mx_Dialog_wrapper "+(this._staticModal?"mx_Dialog_wrapperWithStaticUnder ":"")+(n.className?n.className:""),r=d.default.createElement("div",{className:i},d.default.createElement("div",{className:"mx_Dialog"},n.elem),d.default.createElement("div",{className:"mx_Dialog_background",onClick:this.closeAll}));l.default.render(r,this.getOrCreateContainer())}else l.default.unmountComponentAtNode(this.getOrCreateContainer())}}]),e}();i.singletonModalManager||(i.singletonModalManager=new A),t.default=i.singletonModalManager,e.exports=t.default}).call(this,n("bqPV"))},Uq7W:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAXCAIAAABvSEP3AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6REEyRTJCRjY3REREMTFFNUFBMTdCQzcyNkY4QzcxODciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6REEyRTJCRjc3REREMTFFNUFBMTdCQzcyNkY4QzcxODciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpEQTJFMkJGNDdEREQxMUU1QUExN0JDNzI2RjhDNzE4NyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpEQTJFMkJGNTdEREQxMUU1QUExN0JDNzI2RjhDNzE4NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PtAx+9MAAAEMSURBVHjaYiw7v4yBYsDEQA1Apin////HYsqrI9eebj2NJocL/Pv77/G640AtcBEWiME/X334eO0xkC3lZcLIyIjfiCcbTny6/piFkw3FFKA2aX8LIOP9+Xv4DYIbIWioJOlpjGIKyGPMTAQNQjYCTQELIoTwGoTHCBRT8BiE3wh0U7Aa9P/ff/xGYDEF3aD/DH9//sZvBHZTUAy6AHIRfiMIpF3i0iButyAH57+fvwmmIxb8RkBCl2CCZCGYtBiZCadsFmJSJ8GUzUJk6sRvEAsxRhA0CFoyEDQCq0HS3qYoJQOnhACwvABmdvyFC7JBrPzc6D4StdYioZRlZpIJtES2j8xyF83JAAEGAN2f2Im4pRQ/AAAAAElFTkSuQmCC"},VXb2:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAIAAAD9b0jDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6REEyRTJCRjI3REREMTFFNUFBMTdCQzcyNkY4QzcxODciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6REEyRTJCRjM3REREMTFFNUFBMTdCQzcyNkY4QzcxODciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpDMEYzMUMwOTdEQTIxMUU1QUExN0JDNzI2RjhDNzE4NyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpDMEYzMUMwQTdEQTIxMUU1QUExN0JDNzI2RjhDNzE4NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PhV4i8MAAAI0SURBVHjaYiw7v4yB2oCJgQaAJoayEKNI9P5Xn947Io+/XXIR252p+I+FiVJDeV//zEg+x/P+N5DtNO8hz/tfa+s0KfW+b/dtiIkQYLb+udLp9xQZKnP1k97uV2iC3hPuMPz/T76hnhPvMsI5jgIMepwgm659xrSJWEPVjr1VgfpUgOHpdIZ93Qz9+hAp96n3mP78I93Q//89Jt6FcTgYeMFReuUBhC/y6LvZ2mckG2qw/aX0rS/oouzscKbL7Pts3/+SYCjz739ADxJIam9/2y5+RIKhFqueCj37QTC12S98xP3uF1GGsn394zT3AarYDwZsVrB/++s05wFRhgLtR07tYPCB4d4n7H5a/VTw6XcChvK8/WWHNaRYcWTzP/8xQx/dUJeZ99l+/COpTAKmE8mbn3EaKvzwm9k6HKmPFZiY/jAceYgpA8xynhPu4SylPKbeY/6LI1PrlTI4MjDsxy6pfuKt8ql3d82E0F0KLDt0ceZoAYZLNQzbWhjmq+IKBC9g9oOVMghDPSchlR1owN+WQVeMgYOPwUIDZ3l27bPuntcohgJDWuUU7lLy3lMo4+M3PDEGz2DQMFU68wFfBF8+x6Bfy6DHzrDkIR5Vcpc/AUuDX5zMUEP/sTASSDiXXjBcIqDkPyPDPyYk7192Fv0gzk5hJXo8TPoPOzOoPLLOCAZSv7hYLrqL87z7DSyfOD/+ZiTFrJ8czI+1+Y5Gy+7OVkZPp59F2Ve2aA3exgRAgAEArTbJVff6BXMAAAAASUVORK5CYII="},W92I:function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var r=n("uZMU"),o=n("UhrY"),s=n("QzvL"),a=i(n("qmkL")),c=n("2NLw"),u=i(n("6/O3"));class d{constructor(e,t){this._indexedDB=e,this._dbName=t,this._backendPromise=null,this._backend=null}static exists(e,t){return u.exists(e,t)}startup(){return this._backendPromise||(this._backendPromise=new Promise(((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));r.logger.log(`connecting to indexeddb ${this._dbName}`);const n=this._indexedDB.open(this._dbName,a.VERSION);n.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion;a.upgradeDatabase(t,n)},n.onblocked=()=>{r.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{r.logger.log("Error connecting to indexeddb",e),t(e.target.error)},n.onsuccess=t=>{const n=t.target.result;r.logger.log(`connected to indexeddb ${this._dbName}`),e(new a.Backend(n))}})).then((e=>e.doTxn("readonly",[d.STORE_INBOUND_GROUP_SESSIONS,d.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((t=>{if("VersionError"===t.name)throw r.logger.warn("Crypto DB is too new for us to use!",t),new c.InvalidCryptoStoreError(c.InvalidCryptoStoreError.TOO_NEW);r.logger.warn(`unable to connect to indexeddb ${this._dbName}: falling back to localStorage store: ${t}`);try{return new o.LocalStorageCryptoStore(e.localStorage)}catch(t){return r.logger.warn(`unable to open localStorage: falling back to in-memory store: ${t}`),new s.MemoryCryptoStore}})).then((e=>{this._backend=e}))),this._backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));r.logger.log(`Removing indexeddb instance: ${this._dbName}`);const n=this._indexedDB.deleteDatabase(this._dbName);n.onblocked=()=>{r.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{r.logger.log("Error deleting data from indexeddb",e),t(e.target.error)},n.onsuccess=()=>{r.logger.log(`Removed indexeddb instance: ${this._dbName}`),e()}})).catch((e=>{r.logger.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getOrAddOutgoingRoomKeyRequest(e){return this._backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this._backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this._backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this._backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this._backend.getOutgoingRoomKeyRequestsByTarget(e,t,n)}updateOutgoingRoomKeyRequest(e,t,n){return this._backend.updateOutgoingRoomKeyRequest(e,t,n)}deleteOutgoingRoomKeyRequest(e,t){return this._backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this._backend.getAccount(e,t)}storeAccount(e,t){this._backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this._backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this._backend.getSecretStorePrivateKey(e,t,n)}storeCrossSigningKeys(e,t){this._backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,n){this._backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this._backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this._backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this._backend.getEndToEndSessions(e,t,n)}getAllEndToEndSessions(e,t){this._backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,n,i){this._backend.storeEndToEndSession(e,t,n,i)}storeEndToEndSessionProblem(e,t,n){return this._backend.storeEndToEndSessionProblem(e,t,n)}getEndToEndSessionProblem(e,t){return this._backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this._backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,n,i){this._backend.getEndToEndInboundGroupSession(e,t,n,i)}getAllEndToEndInboundGroupSessions(e,t){this._backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,n,i){this._backend.addEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this._backend.storeEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){this._backend.storeEndToEndInboundGroupSessionWithheld(e,t,n,i)}storeEndToEndDeviceData(e,t){this._backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this._backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,n){this._backend.storeEndToEndRoom(e,t,n)}getEndToEndRooms(e,t){this._backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this._backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this._backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this._backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this._backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,n,i){this._backend.addSharedHistoryInboundGroupSession(e,t,n,i)}getSharedHistoryInboundGroupSessions(e,t){return this._backend.getSharedHistoryInboundGroupSessions(e,t)}doTxn(e,t,n,i){return this._backend.doTxn(e,t,n,i)}}t.IndexedDBCryptoStore=d,d.STORE_ACCOUNT="account",d.STORE_SESSIONS="sessions",d.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",d.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",d.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS="shared_history_inbound_group_sessions",d.STORE_DEVICE_DATA="device_data",d.STORE_ROOMS="rooms",d.STORE_BACKUP="sessions_needing_backup"}).call(this,n("bqPV"))},WW3d:function(e,t,n){"use strict";var i=n("OY4j"),r=Object.prototype.hasOwnProperty,o=Array.isArray,s={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:i.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"===typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},u=function(e,t,n,i){if(e){var o=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,s=/(\[[^[\]]*])/g,a=n.depth>0&&/(\[[^[\]]*])/.exec(o),u=a?o.slice(0,a.index):o,d=[];if(u){if(!n.plainObjects&&r.call(Object.prototype,u)&&!n.allowPrototypes)return;d.push(u)}for(var l=0;n.depth>0&&null!==(a=s.exec(o))&&l<n.depth;){if(l+=1,!n.plainObjects&&r.call(Object.prototype,a[1].slice(1,-1))&&!n.allowPrototypes)return;d.push(a[1])}return a&&d.push("["+o.slice(a.index)+"]"),function(e,t,n,i){for(var r=i?t:c(t,n),o=e.length-1;o>=0;--o){var s,a=e[o];if("[]"===a&&n.parseArrays)s=[].concat(r);else{s=n.plainObjects?Object.create(null):{};var u="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,d=parseInt(u,10);n.parseArrays||""!==u?!isNaN(d)&&a!==u&&String(d)===u&&d>=0&&n.parseArrays&&d<=n.arrayLimit?(s=[])[d]=r:s[u]=r:s={0:r}}r=s}return r}(d,t,n,i)}};e.exports=function(e,t){var n=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!==typeof e.decoder)throw new TypeError("Decoder has to be a function.");if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t="undefined"===typeof e.charset?s.charset:e.charset;return{allowDots:"undefined"===typeof e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"===typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,arrayLimit:"number"===typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"===typeof e.comma?e.comma:s.comma,decoder:"function"===typeof e.decoder?e.decoder:s.decoder,delimiter:"string"===typeof e.delimiter||i.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"===typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"===typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"===typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"===typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}}(t);if(""===e||null===e||"undefined"===typeof e)return n.plainObjects?Object.create(null):{};for(var d="string"===typeof e?function(e,t){var n,u={},d=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,l=t.parameterLimit===1/0?void 0:t.parameterLimit,h=d.split(t.delimiter,l),g=-1,p=t.charset;if(t.charsetSentinel)for(n=0;n<h.length;++n)0===h[n].indexOf("utf8=")&&("utf8=%E2%9C%93"===h[n]?p="utf-8":"utf8=%26%2310003%3B"===h[n]&&(p="iso-8859-1"),g=n,n=h.length);for(n=0;n<h.length;++n)if(n!==g){var f,y,m=h[n],v=m.indexOf("]="),_=-1===v?m.indexOf("="):v+1;-1===_?(f=t.decoder(m,s.decoder,p,"key"),y=t.strictNullHandling?null:""):(f=t.decoder(m.slice(0,_),s.decoder,p,"key"),y=i.maybeMap(c(m.slice(_+1),t),(function(e){return t.decoder(e,s.decoder,p,"value")}))),y&&t.interpretNumericEntities&&"iso-8859-1"===p&&(y=a(y)),m.indexOf("[]=")>-1&&(y=o(y)?[y]:y),r.call(u,f)?u[f]=i.combine(u[f],y):u[f]=y}return u}(e,n):e,l=n.plainObjects?Object.create(null):{},h=Object.keys(d),g=0;g<h.length;++g){var p=h[g],f=u(p,d[p],n,"string"===typeof e);l=i.merge(l,f,n)}return i.compact(l)}},Wy6s:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=a;var r=n("D67U"),o=i(n("dZ+v"));function s(e){return"string"===typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"===typeof e}function a(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}a.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return o.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));const t=this;e.currentState.getMembers().forEach((function(n){t._onRoomMember(null,e.currentState,n)}))},_onRoomMember:function(e,t,n){if("invite"===n.membership)return;const i=this.users[n.userId]||new r.User(n.userId);n.name&&(i.setDisplayName(n.name),n.events.member&&i.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&i.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[i.userId]=i},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return o.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return o.map(o.values(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return o.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,i){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(s(e))return e}catch(n){}return null},setFilterIdByName:function(e,t){if(!this.localStorage)return;const n="mxjssdk_memory_filter_"+e;try{s(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch(i){}},storeAccountDataEvents:function(e){const t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},X8E0:function(e,t){e.exports="/_next/static/images/chevron-right-0070bb42b28434dcfb177b555a6f3c3a.png"},XTIU:function(e,t){e.exports="/_next/static/images/chevron-dc904f3cb426fe749240bd84781f01c9.png"},"Y+q2":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RkJBRTI2ODMzQUM5MTFFNTlCQjRBNjE0OEE5MEM3REYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RkJBRTI2ODQzQUM5MTFFNTlCQjRBNjE0OEE5MEM3REYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpGQkFFMjY4MTNBQzkxMUU1OUJCNEE2MTQ4QTkwQzdERiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpGQkFFMjY4MjNBQzkxMUU1OUJCNEE2MTQ4QTkwQzdERiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pht27+IAAABcSURBVHjaYpwOBAwMDDVA/JYBN5jOBCQygbgFiIVxKQIZxATl4FIMt40JSRBdMYqTWNBMyIQq4ADiEmR3MzEQCZhwuCkR3c1M2ByOzc1MOBRheJAFjyIUDwIEGACm3hn7MliQ9AAAAABJRU5ErkJggg=="},"Yh/a":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.keyFromAuthData=async function(t,n){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await o(n,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)},t.keyFromPassphrase=async function(t){if(!e.Olm)throw new Error("Olm is not available");const n=(0,i.randomString)(32);return{key:await o(t,n,r,256),salt:n,iterations:r}},t.deriveKey=o;var i=n("ns36");const r=5e5;async function o(t,n,i,r=256){const o=e.crypto.subtle,s=e.TextEncoder;if(!o||!s)throw new Error("Password-based backup is not avaiable on this platform");const a=await o.importKey("raw",(new s).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await o.deriveBits({name:"PBKDF2",salt:(new s).encode(n),iterations:i,hash:"SHA-512"},a,r);return new Uint8Array(c)}}).call(this,n("bqPV"))},YoyG:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAI5JREFUeNpi/P//P8NgBkwMgxyMOnDUgaMOHHXgqANHHTjqwFEHjjpwZDuQhViF9Wc+eTIyM88Csf///ZvWZMq/HVm+7vRHkuQbTfi2U9WBIMMZGRhkwByIRbLUlB/+aRAULcDu1RMwBrKpLY8z5kZ7daMOHHXgqANHHTjqwFEHjjpw1IGjDhx1IAUAIMAA8FxCSpCE5scAAAAASUVORK5CYII="},ZcQO:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAPZJREFUOBGV1L0KwjAQAGCTFEQQBF8hAcHJB3BRl7Yv3G4uPoNTBnHWQXBt410hweY/GVKSy32kybWkbdvDOI7rvu9vi/JG6ro+U0rfVCm1ZYztYeJY6EwI5HLcCJNSPoQQG5jYcc5XMH5mgAYZhuGOb8MwqRBzEDQmqADzIjMoAwsiDhTBogjmEew8jTRNc4JrFXiYEF/i7eiD9awPQrjWYDiIIRin2IUa1Fhox06KuTUrMjsTiH1SdeaDZggWW06d2ZCD6J2msH8oiORgGkoiKQyhbCSGIXJJFZsGrKepM6wxWlXVK1VsFqCHquu6K/yLJHwB3x/4UvC2hbwGjAAAAABJRU5ErkJggg=="},aFBq:function(e,t,n){"use strict";(function(i){Object.defineProperty(t,"__esModule",{value:!0});var r=s(n("Zv/C")),o=s(n("2lBV"));function s(e){return e&&e.__esModule?e:{default:e}}var a=function(){function e(){(0,r.default)(this,e),this.keyRgb=["rgb(118, 207, 166)","rgb(234, 245, 240)","rgb(211, 239, 225)"],this.keyHex=["#76CFA6","#EAF5F0","#D3EFE1","#FFFFFF","#000000"],this.colors=[this.keyHex[0],this.keyHex[1],this.keyHex[2],this.keyHex[3],this.keyHex[4]],this.currentTint=[void 0,void 0,void 0,void 0,void 0],this.cssFixups=[],this.cssAttrs=["color","backgroundColor","borderColor","borderTopColor","borderBottomColor","borderLeftColor"],this.svgAttrs=["fill","stroke"],this.tintables=[],this.theme=void 0,this.forceTint=!1}return(0,o.default)(e,[{key:"registerTintable",value:function(e){this.tintables.push(e)}},{key:"getKeyRgb",value:function(){return this.keyRgb}},{key:"tint",value:function(e,t,n){}},{key:"tintSvgWhite",value:function(e){this.currentTint[3]=e,e||(e=this.colors[3]),this.colors[3]!==e&&(this.colors[3]=e,this.tintables.forEach((function(e){e()})))}},{key:"tintSvgBlack",value:function(e){this.currentTint[4]=e,e||(e=this.colors[4]),this.colors[4]!==e&&(this.colors[4]=e,this.tintables.forEach((function(e){e()})))}},{key:"setTheme",value:function(e){this.theme=e,document.getElementById("mx_theme_accentColor")&&(this.keyRgb[0]=window.getComputedStyle(document.getElementById("mx_theme_accentColor")).color),document.getElementById("mx_theme_secondaryAccentColor")&&(this.keyRgb[1]=window.getComputedStyle(document.getElementById("mx_theme_secondaryAccentColor")).color),document.getElementById("mx_theme_tertiaryAccentColor")&&(this.keyRgb[2]=window.getComputedStyle(document.getElementById("mx_theme_tertiaryAccentColor")).color),this.calcCssFixups(),this.forceTint=!0,this.tint(this.currentTint[0],this.currentTint[1],this.currentTint[2]),"dark"===e?(this.tintSvgWhite("#2d2d2d"),this.tintSvgBlack("#dddddd")):(this.tintSvgWhite("#ffffff"),this.tintSvgBlack("#000000"))}},{key:"calcCssFixups",value:function(){if(!this.cssFixups[this.theme]){0,this.cssFixups[this.theme]=[];for(var e=0;e<document.styleSheets.length;e++){var t=document.styleSheets[e];try{if(!t)continue;if(!t.href||!t.href.match(new RegExp("/theme-"+this.theme+".css$")))continue;if(t.disabled)continue;if(!t.cssRules)continue;0;for(var n=0;n<t.cssRules.length;n++){var i=t.cssRules[n];if(i.style&&(!i.selectorText||!i.selectorText.match(/#mx_theme/)))for(var r=0;r<this.cssAttrs.length;r++)for(var o=this.cssAttrs[r],s=0;s<this.keyRgb.length;s++)i.style[o]===this.keyRgb[s]&&this.cssFixups[this.theme].push({style:i.style,attr:o,index:s})}}catch(a){console.log("Failed to calculate CSS fixups for a stylesheet: "+t.href,a)}}0}}},{key:"applyCssFixups",value:function(){for(var e=0;e<this.cssFixups[this.theme].length;e++){var t=this.cssFixups[this.theme][e];try{t.style[t.attr]=this.colors[t.index]}catch(n){console.error("Failed to apply cssFixup in Tinter! ",n.name)}}}},{key:"calcSvgFixups",value:function(e){for(var t=[],n=0;n<e.length;n++){var i=void 0;try{i=e[n].contentDocument}catch(l){var r="Failed to get svg.contentDocument of "+e[n].toString();l.message&&(r+=l.message),l.stack&&(r+=" | stack: "+l.stack),console.error(r)}if(i)for(var o=i.getElementsByTagName("*"),s=0;s<o.length;s++)for(var a=o[s],c=0;c<this.svgAttrs.length;c++)for(var u=this.svgAttrs[c],d=0;d<this.keyHex.length;d++)a.getAttribute(u)&&a.getAttribute(u).toUpperCase()===this.keyHex[d]&&t.push({node:a,attr:u,index:d})}return t}},{key:"applySvgFixups",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];n.node.setAttribute(n.attr,this.colors[n.index])}}}]),e}();void 0===i.singletonTinter&&(i.singletonTinter=new a),t.default=i.singletonTinter,e.exports=t.default}).call(this,n("bqPV"))},bDtH:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.disableIndexedDB=function(){n=void 0};var n=void 0;try{n=e.indexedDB}catch(i){}t.default=n}).call(this,n("bqPV"))},cAsW:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerAlgorithm=function(e,t,n){i[e]=t,r[e]=n},t.UnknownDeviceError=t.DecryptionError=t.DecryptionAlgorithm=t.EncryptionAlgorithm=t.DECRYPTION_CLASSES=t.ENCRYPTION_CLASSES=void 0;const i={};t.ENCRYPTION_CLASSES=i;const r={};t.DECRYPTION_CLASSES=r;t.EncryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._deviceId=e.deviceId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,n){}};t.DecryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomKeyEvent(e){}importRoomKey(e){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){}};class o extends Error{constructor(e,t,n){super(t),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let n=e.name+"[msg: "+e.message;t&&(n+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", "));return n+="]",n}(this,n)}}t.DecryptionError=o;class s extends Error{constructor(e,t){super(e),this.name="UnknownDeviceError",this.devices=t}}t.UnknownDeviceError=s},cHEn:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EncryptionSetupOperation=t.EncryptionSetupBuilder=void 0;var i=n("uZMU"),r=n("MwLI"),o=n("hBZP"),s=n("92AT"),a=n("W92I"),c=n("lWzV");t.EncryptionSetupBuilder=class{constructor(e,t){this.accountDataClientAdapter=new d(e),this.crossSigningCallbacks=new l,this.ssssCryptoCallbacks=new h(t),this._crossSigningKeys=null,this._keySignatures=null,this._keyBackupInfo=null}addCrossSigningKeys(e,t){this._crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this._keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this._sessionBackupPrivateKey=e}addKeySignature(e,t,n){this._keySignatures||(this._keySignatures={});const i=this._keySignatures[e]||{};this._keySignatures[e]=i,i[t]=n}setAccountData(e,t){return this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter._values;return new u(e,this._crossSigningKeys,this._keyBackupInfo,this._keySignatures)}async persist(e){if(this._crossSigningKeys){const t=(0,s.createCryptoStoreCacheCallbacks)(e._cryptoStore,e._olmDevice);for(const e of["master","self_signing","user_signing"]){i.logger.log(`Cache ${e} cross-signing private key locally`);const n=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,n)}await e._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{e._cryptoStore.storeCrossSigningKeys(t,this._crossSigningKeys.keys)}))}this._sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this._sessionBackupPrivateKey)}};class u{constructor(e,t,n,i){this._accountData=e,this._crossSigningKeys=t,this._keyBackupInfo=n,this._keySignatures=i}async apply(e){const t=e._baseApis;if(this._crossSigningKeys){const n={};for(const[e,t]of Object.entries(this._crossSigningKeys.keys))n[e+"_key"]=t;await this._crossSigningKeys.authUpload((e=>t.uploadDeviceSigningKeys(e,n))),e._crossSigningInfo.setKeys(this._crossSigningKeys.keys)}if(this._accountData)for(const[n,i]of this._accountData)await t.setAccountData(n,i);this._keySignatures&&await t.uploadKeySignatures(this._keySignatures),this._keyBackupInfo&&(this._keyBackupInfo.version?await t._http.authedRequest(void 0,"PUT","/room_keys/version/"+this._keyBackupInfo.version,void 0,{algorithm:this._keyBackupInfo.algorithm,auth_data:this._keyBackupInfo.auth_data},{prefix:c.PREFIX_UNSTABLE}):await t._http.authedRequest(void 0,"POST","/room_keys/version",void 0,this._keyBackupInfo,{prefix:c.PREFIX_UNSTABLE}))}}t.EncryptionSetupOperation=u;class d extends o.EventEmitter{constructor(e){super(),this._existingValues=e,this._values=new Map}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this._values.get(e);if(t)return t;const n=this._existingValues[e];return n?n.getContent():null}setAccountData(e,t){const n=this._values.get(e);return this._values.set(e,t),Promise.resolve().then((()=>{const i=new r.MatrixEvent({type:e,content:t});this.emit("accountData",i,n)}))}}class l{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,n]of Object.entries(e))this.privateKeys.set(t,n)}}class h{constructor(e){this._privateKeys=new Map,this._delegateCryptoCallbacks=e}async getSecretStorageKey({keys:e},t){for(const n of Object.keys(e)){const e=this._privateKeys.get(n);if(e)return[n,e]}if(this._delegateCryptoCallbacks){const n=await this._delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(n){const[e,t]=n;this._privateKeys.set(e,t)}return n}}addPrivateKey(e,t,n){this._privateKeys.set(e,n),this._delegateCryptoCallbacks&&this._delegateCryptoCallbacks.cacheSecretStorageKey&&this._delegateCryptoCallbacks.cacheSecretStorageKey(e,t,n)}}},cfXf:function(e,t,n){"use strict";var i=c(n("tZmG")),r=c(n("BGZc")),o=n("nPNV"),s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n("LRih")),a=c(n("oOXF"));function c(e){return e&&e.__esModule?e:{default:e}}var u={"m.room.message":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=t+": "+e.getContent().body;return"m.emote"===e.getContent().msgtype?n="* "+t+" "+n:"m.image"===e.getContent().msgtype&&(n=(0,o._t)("%(senderDisplayName)s sent an image.",{senderDisplayName:t})),n},"m.call.invite":function(e){var t=e.sender?e.sender.name:(0,o._t)("Someone"),n=!0;e.getContent().offer&&e.getContent().offer.sdp&&-1!==e.getContent().offer.sdp.indexOf("m=video")&&(n=!1);var i=r.default.get().supportsVoip();return n&&i?(0,o._t)("%(senderName)s placed a voice call.",{senderName:t}):n&&!i?(0,o._t)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:t}):!n&&i?(0,o._t)("%(senderName)s placed a video call.",{senderName:t}):n||i?void 0:(0,o._t)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:t})},"m.call.answer":function(e){var t=e.sender?e.sender.name:(0,o._t)("Someone"),n=r.default.get().supportsVoip()?"":(0,o._t)("(not supported by this browser)");return(0,o._t)("%(senderName)s answered the call.",{senderName:t})+" "+n},"m.call.hangup":function(e){var t=e.sender?e.sender.name:(0,o._t)("Someone"),n=e.getContent(),i="";return r.default.get().supportsVoip()?n.reason&&(i="ice_failed"===n.reason?(0,o._t)("(could not connect media)"):"invite_timeout"===n.reason?(0,o._t)("(no answer)"):"user hangup"===n.reason?"":(0,o._t)("(unknown failure: %(reason)s)",{reason:n.reason})):i=(0,o._t)("(not supported by this browser)"),(0,o._t)("%(senderName)s ended the call.",{senderName:t})+" "+i}},d={"m.room.aliases":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=e.getPrevContent().aliases||[],i=e.getContent().aliases||[],r=i.filter((function(e){return!n.includes(e)})),s=n.filter((function(e){return!i.includes(e)}));return r.length||s.length?r.length&&!s.length?(0,o._t)("%(senderName)s added %(count)s %(addedAddresses)s as addresses for this room.",{senderName:t,count:r.length,addedAddresses:r.join(", ")}):!r.length&&s.length?(0,o._t)("%(senderName)s removed %(count)s %(removedAddresses)s as addresses for this room.",{senderName:t,count:s.length,removedAddresses:s.join(", ")}):(0,o._t)("%(senderName)s added %(addedAddresses)s and removed %(removedAddresses)s as addresses for this room.",{senderName:t,addedAddresses:r.join(", "),removedAddresses:s.join(", ")}):""},"m.room.canonical_alias":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=e.getPrevContent().alias;return e.getContent().alias?(0,o._t)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias}):n?(0,o._t)("%(senderName)s removed the main address for this room.",{senderName:t}):void 0},"m.room.name":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?(0,o._t)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):(0,o._t)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},"m.room.topic":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender();return(0,o._t)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},"m.room.member":function(e){var t=e.sender?e.sender.name:e.getSender(),n=e.target?e.target.name:e.getStateKey(),i=e.getPrevContent(),r=e.getContent(),s=r.reason?(0,o._t)("Reason")+": "+r.reason:"";switch(r.membership){case"invite":var c=r.third_party_invite;return c?c.display_name?(0,o._t)("%(targetName)s accepted the invitation for %(displayName)s.",{targetName:n,displayName:c.display_name}):(0,o._t)("%(targetName)s accepted an invitation.",{targetName:n}):(0,o._t)("%(senderName)s invited %(targetName)s.",{senderName:t,targetName:n});case"ban":return(0,o._t)("%(senderName)s banned %(targetName)s.",{senderName:t,targetName:n})+" "+s;case"join":return i&&"join"===i.membership?i.displayname&&r.displayname&&i.displayname!==r.displayname?(0,o._t)("%(oldDisplayName)s changed their display name to %(displayName)s.",{oldDisplayName:i.displayname,displayName:r.displayname}):!i.displayname&&r.displayname?(0,o._t)("%(senderName)s set their display name to %(displayName)s.",{senderName:e.getSender(),displayName:r.displayname}):i.displayname&&!r.displayname?(0,o._t)("%(senderName)s removed their display name (%(oldDisplayName)s).",{senderName:t,oldDisplayName:i.displayname}):i.avatar_url&&!r.avatar_url?(0,o._t)("%(senderName)s removed their profile picture.",{senderName:t}):i.avatar_url&&r.avatar_url&&i.avatar_url!==r.avatar_url?(0,o._t)("%(senderName)s changed their profile picture.",{senderName:t}):!i.avatar_url&&r.avatar_url?(0,o._t)("%(senderName)s set a profile picture.",{senderName:t}):a.default.getValue("showHiddenEventsInTimeline")?(0,o._t)("%(senderName)s made no change.",{senderName:t}):"":(e.target||console.warn("Join message has no target! -- "+e.getContent().state_key),(0,o._t)("%(targetName)s joined the room.",{targetName:n}));case"leave":return e.getSender()===e.getStateKey()?"invite"===i.membership?(0,o._t)("%(targetName)s rejected the invitation.",{targetName:n}):(0,o._t)("%(targetName)s left the room.",{targetName:n}):"ban"===i.membership?(0,o._t)("%(senderName)s unbanned %(targetName)s.",{senderName:t,targetName:n}):"invite"===i.membership?(0,o._t)("%(senderName)s withdrew %(targetName)s's invitation.",{senderName:t,targetName:n})+" "+s:(0,o._t)("%(senderName)s kicked %(targetName)s.",{senderName:t,targetName:n})+" "+s}},"m.room.history_visibility":function(e){var t=e.sender?e.sender.name:e.getSender();switch(e.getContent().history_visibility){case"invited":return(0,o._t)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case"joined":return(0,o._t)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case"shared":return(0,o._t)("%(senderName)s made future room history visible to all room members.",{senderName:t});case"world_readable":return(0,o._t)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return(0,o._t)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},"m.room.encryption":function(e){var t=e.sender?e.sender.name:e.getSender();return(0,o._t)("%(senderName)s turned on end-to-end encryption (algorithm %(algorithm)s).",{senderName:t,algorithm:e.getContent().algorithm})},"m.room.power_levels":function(e){var t=e.sender?e.sender.name:e.getSender();if(!e.getPrevContent()||!e.getPrevContent().users||!e.getContent()||!e.getContent().users)return"";var n=e.getContent().users_default||0,r=[];(0,i.default)(e.getContent().users).forEach((function(e){-1===r.indexOf(e)&&r.push(e)})),(0,i.default)(e.getPrevContent().users).forEach((function(e){-1===r.indexOf(e)&&r.push(e)}));var a=[];return r.forEach((function(t){var i=e.getPrevContent().users[t],r=e.getContent().users[t];r!==i&&a.push((0,o._t)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:t,fromPowerLevel:s.textualPowerLevel(i,n),toPowerLevel:s.textualPowerLevel(r,n)}))})),a.length?(0,o._t)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:a.join(", ")}):""},"m.room.pinned_events":function(e){var t=e.getSender();return(0,o._t)("%(senderName)s changed the pinned messages for the room.",{senderName:t})},"m.room.server_acl":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender(),n=e.getPrevContent(),i=[],r=e.getContent(),o={deny:Array.isArray(n.deny)?n.deny:[],allow:Array.isArray(n.allow)?n.allow:[],allow_ip_literals:!(!1===n.allow_ip_literals)},s="";if(s=0===o.deny.length&&0===o.allow.length?t+" set server ACLs for this room: ":t+" changed the server ACLs for this room: ",Array.isArray(r.allow)||(r.allow=[]),0===r.allow.length)return s+"\ud83c\udf89 All servers are banned from participating! This room can no longer be used.";Array.isArray(r.deny)||(r.deny=[]);var a=r.deny.filter((function(e){return"string"===typeof e&&!o.deny.includes(e)})),c=o.deny.filter((function(e){return"string"===typeof e&&!r.deny.includes(e)})),u=r.allow.filter((function(e){return"string"===typeof e&&!o.allow.includes(e)})),d=o.allow.filter((function(e){return"string"===typeof e&&!r.allow.includes(e)}));if(a.length>0&&i.push("Servers matching "+a.join(", ")+" are now banned."),c.length>0&&i.push("Servers matching "+c.join(", ")+" were removed from the ban list."),u.length>0&&i.push("Servers matching "+u.join(", ")+" are now allowed."),d.length>0&&i.push("Servers matching "+d.join(", ")+" were removed from the allowed list."),o.allow_ip_literals!==r.allow_ip_literals){var l=r.allow_ip_literals?"allowed":"banned";i.push("Participating from a server using an IP literal hostname is now "+l+".")}return s+i.join(" ")},"m.room.tombstone":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender();return(0,o._t)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},"m.room.join_rules":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case"public":return(0,o._t)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:t});case"invite":return(0,o._t)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:t});default:return(0,o._t)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:t,rule:e.getContent().join_rule})}},"m.room.guest_access":function(e){var t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case"can_join":return(0,o._t)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case"forbidden":return(0,o._t)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return(0,o._t)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"im.vector.modular.widgets":function(e){var t=e.getSender(),n=e.getPrevContent(),i=n.name,r=n.type,s=n.url,a=e.getContent()||{},c=a.name,u=a.type,d=a.url,l=c||i||u||r||"";return l&&l.length>0&&(l=l[0].toUpperCase()+l.slice(1)+" "),d?s?(0,o._t)("%(widgetName)s widget modified by %(senderName)s",{widgetName:l,senderName:t}):(0,o._t)("%(widgetName)s widget added by %(senderName)s",{widgetName:l,senderName:t}):(0,o._t)("%(widgetName)s widget removed by %(senderName)s",{widgetName:l,senderName:t})}};e.exports={textForEvent:function(e){var t=(e.isState()?d:u)[e.getType()];return t?t(e):""}}},cjii:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QUNBMTY4Rjk3NUMzMTFFNThFQTVBNEFEQzI4QTVEMTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QUNBMTY4RkE3NUMzMTFFNThFQTVBNEFEQzI4QTVEMTIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBQ0ExNjhGNzc1QzMxMUU1OEVBNUE0QURDMjhBNUQxMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBQ0ExNjhGODc1QzMxMUU1OEVBNUE0QURDMjhBNUQxMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pi36tG8AAAAtSURBVHjaYjxz5gwDNmBsbIxVnImBRDCqgRjA+P//f6wSZ8+eHQ0l+mkACDAAQrUIgLA0RfsAAAAASUVORK5CYII="},du21:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var i=n("W92I");t.RoomList=class{constructor(e){this._cryptoStore=e,this._roomEncryption={}}async init(){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ROOMS],(e=>{this._cryptoStore.getEndToEndRooms(e,(e=>{this._roomEncryption=e}))}))}getRoomEncryption(e){return this._roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this._roomEncryption[e]=t,await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ROOMS],(n=>{this._cryptoStore.storeEndToEndRoom(e,t,n)}))}}},e1BA:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAABMJJREFUWAnNmc+P20QUx984iZMmpWRL9wdi2x6QOPBD7R9QiRsHBFLhgARX/gFaDpy4ceHS8g/ABQQ3qFoJiUo9VK04IVFEOWx/SLTJttvNdr3pJo5/xBne18l4na2d8TrdkidFHo/nvffxzPjNvImgnPL3I+dVs0inDUO8LYRYHgzkEgk6HJqTtMn1a1LKJtdf9fp04a3Fyt08rsRelP5a216omuZnQtAnrDdfMw1RLYgDRUPQ8De01h8Q9Qcy/NmB7HU9viFqSUk/2p73zYmlF9az+s0E+M/6+sFS6cUvSNLZQ+VC4ZApykyV1UfYrsfUTzzpPnGDgHv6nO+3v35jYaGjM6IFvGW5HwoS39ZKwjxSKVRLBa3KRJ9+IGnDCeyuLz1J8tPX5so/T1SY8FDc2nS/umt5nR5bfdYCm7ANH8ywt7f+vdE4cNtyL91r+9t+MHjWbJE92IYP+ILPCZ019khAYbXj2wP+BPdb4AO+4DNTT6LL8VbPA069PHzB52i4x3pr7AYfBObFfg6rgtp9hc9wTjJDHCqanAglZqneWD5YqFf2GELiBqcpOxyKmp1gy/O3jqoQVFQGEecQStLgzt+0ab6yE/vudwN6d9mkky+VlInE643HPv3a9OhYrRA9bzkDOvNmNbpXBfiulQamJI65RF+qesIKwePf9Tj8p8n3t3vRo2trrvyt6Ub3ugLaQkdJ3JaqU1cwgAVMAAy7pGKaZ7BCZAnC1x95ZLmS3nnFjF5QV0Bb6EBXJ2AAC5ZUtA0Bue5jLF865etrHm2xow0eIsvlBTejbHHboQ5Dsg2dgGW03pOBXQkrzOvWVsw5OyB671iZPjhepgv33EyQeJFfuO1p1nmfdWEDtibJiGU+ZFt57Hz+sOvbag6kXW9seGOPLCeQ363YcpOvaZLW5s9dtpL0wQQ24gh+se32k9po69IAoDjpmdYwN2g7fQk2A5vNIg94HqmXjcThxpxTwzrHbfII9pdgM3iVWcJNXlGQD3s7H80DLmPO5YUDC5hCNmzTp104AImfktfrUfxXVXu+hkzMZpAU2I7PpjAbv7a0kENMIwglK+1+ZAJlzMNpZMgkLQPZFxKcvAI4xMTF2Dq9wGV8JNNAgglsBn/RzbyACg6BOz4H8XHgI5kGEkxgw1d8FamhrgdvWjtDiLZpcMrOJMjdtpRO/AomsBlIqkd5a/z5U+WL9126vDpcR3VwSjkJ8vKqS5fYlk7ABLYiMv47ltvivPX4pPUY+7kqb+lgHAv/7mFNcxiHPMJzc64s6Ghsb5ikhxyapQW2MHhxqvoTkuqkxvG6U0smzZki3LjG51y8TVIZkAru1KJ+mwYWnELAVgjoeN55ZPxIqnUCyDpDquHWtcdztEXPZYEDA1hwRALdMOTjrIQTpnOc8Z99uVZ8ei/ODbFN/+GOA51QGrxlWqwIOpFhy//Hhh9u+f/dHurDVprg1AFHI+r8JlqEZzVpihZQZFE4K3nQCbp542Jar2Sph0/4BoPK6BL1ZjpxHxHP1NFHNMSx7pStzvpHtj+40tgOOvs53LANH/AFn8ygDyMx0Jk4fou+4hjYWPH/PsDUAoJ2po+A492J4wicQiDR5/rZOUSPQ6ry8/ob4j9gccw6ukw9TgAAAABJRU5ErkJggg=="},eH6s:function(e,t,n){"use strict";(function(e,i){var r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.encodeRecoveryKey=function(t){const n=new e(s.length+t.length+1);n.set(s,0),n.set(t,s.length);let i=0;for(let e=0;e<n.length-1;++e)i^=n[e];n[n.length-1]=i;return o.default.encode(n).match(/.{1,4}/g).join(" ")},t.decodeRecoveryKey=function(e){const t=o.default.decode(e.replace(/ /g,""));let n=0;for(const i of t)n^=i;if(0!==n)throw new Error("Incorrect parity");for(let i=0;i<s.length;++i)if(t[i]!==s[i])throw new Error("Incorrect prefix");if(t.length!==s.length+i.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(s.length,s.length+i.Olm.PRIVATE_KEY_LENGTH))};var o=r(n("jzLy"));const s=[139,1]}).call(this,n("qykS").Buffer,n("bqPV"))},eNVr:function(e,t,n){"use strict";(function(e,i){var r=n("Dlk0"),o=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.isCryptoAvailable=function(){return Boolean(e.Olm)},t.Crypto=B,t.fixBackupKey=x,t.verificationMethods=void 0;var s=o(n("SBNP")),a=n("hBZP"),c=n("3Qxt"),u=n("uZMU"),d=r(n("dZ+v")),l=n("ye32"),h=r(n("n/Lb")),g=n("otDc"),p=n("UESs"),f=r(n("qfve")),y=n("92AT"),m=n("cHEn"),v=n("3wb4"),_=n("Ug1r"),S=n("W92I"),b=n("nlfO"),A=n("vIid"),w=n("Yh/a"),E=n("eH6s"),I=n("LTeG"),k=n("lyVl"),R=n("f3QS"),C=n("6Ssv"),T=n("2NLw"),D=n("Ihe9"),O=n("DLQN"),M=n("MwLI");const N=p.DeviceInfo.DeviceVerification,P={[b.ReciprocateQRCode.NAME]:b.ReciprocateQRCode,[A.SAS.NAME]:A.SAS,[b.SHOW_QR_CODE_METHOD]:C.IllegalMethod,[b.SCAN_QR_CODE_METHOD]:C.IllegalMethod},U={RECIPROCATE_QR_CODE:b.ReciprocateQRCode.NAME,SAS:A.SAS.NAME};t.verificationMethods=U;function B(e,t,n,i,r,o,s,a){if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._trustCrossSignedDevices=!0,this._reEmitter=new c.ReEmitter(this),this._baseApis=e,this._sessionStore=t,this._userId=n,this._deviceId=i,this._clientStore=r,this._cryptoStore=o,this._roomList=s,a){this._verificationMethods=new Map;for(const e of a)"string"===typeof e?P[e]&&this._verificationMethods.set(e,P[e]):e.NAME?this._verificationMethods.set(e.NAME,e):u.logger.warn(`Excluding unknown verification method ${e}`)}else this._verificationMethods=P;this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new l.OlmDevice(o),this._deviceList=new g.DeviceList(e,o,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=d.keys(f.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new _.OutgoingRoomKeyRequestManager(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new R.ToDeviceRequests,this._inRoomVerificationRequests=new k.InRoomRequests,this._sendKeyRequestsImmediately=!1;const h=this._baseApis._cryptoCallbacks||{},p=(0,y.createCryptoStoreCacheCallbacks)(o,this._olmDevice);this._crossSigningInfo=new y.CrossSigningInfo(n,h,p),this._secretStorage=new v.SecretStorage(e,h),this._dehydrationManager=new O.DehydrationManager(this),!h.getCrossSigningKey&&h.getSecretStorageKey&&(h.getCrossSigningKey=async e=>y.CrossSigningInfo.getFromSecretStorage(e,this._secretStorage))}function x(e){if("string"!==typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return h.encodeBase64(t)}function j(e){if(e._oneTimeKeyCheckInProgress)return;const t=Date.now();if(null!==e._lastOneTimeKeyCheck&&t-e._lastOneTimeKeyCheck<6e4)return;e._lastOneTimeKeyCheck=t;const n=e._olmDevice.maxNumberOfOneTimeKeys(),i=Math.floor(n/2);e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((t=>async function(t){for(;i>t||e.getNeedsNewFallback();){if(i>t){u.logger.info("generating oneTimeKeys");const n=Math.min(i-t,5);await e._olmDevice.generateOneTimeKeys(n)}e.getNeedsNewFallback()&&(u.logger.info("generating fallback key"),await e._olmDevice.generateFallbackKey()),u.logger.info("calling _uploadOneTimeKeys");const n=await L(e);if(!n.one_time_key_counts||!n.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");t=n.one_time_key_counts.signed_curve25519}}(t))).catch((e=>{u.logger.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1}))}async function L(e){const t=[],n={};if(e.getNeedsNewFallback()){const i=await e._olmDevice.getFallbackKey();for(const[r,o]of Object.entries(i.curve25519)){const i={key:o,fallback:!0};n["signed_curve25519:"+r]=i,t.push(e._signObject(i))}e.setNeedsNewFallback(!1)}const i=await e._olmDevice.getOneTimeKeys(),r={};for(const s in i.curve25519)if(i.curve25519.hasOwnProperty(s)){const n={key:i.curve25519[s]};r["signed_curve25519:"+s]=n,t.push(e._signObject(n))}await Promise.all(t);const o=await e._baseApis.uploadKeysRequest({one_time_keys:r,"org.matrix.msc2732.fallback_keys":n});return await e._olmDevice.markKeysAsPublished(),o}d.inherits(B,a.EventEmitter),B.prototype.init=async function(t){const{exportedOlmDevice:n,pickleKey:i}=t||{};u.logger.log("Crypto: initialising Olm..."),await e.Olm.init(),u.logger.log(n?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this._olmDevice.init({fromExportedDevice:n,pickleKey:i}),u.logger.log("Crypto: loading device list..."),await this._deviceList.load(),this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,u.logger.log("Crypto: fetching own devices...");let r=this._deviceList.getRawStoredDevicesForUser(this._userId);if(r||(r={}),!r[this._deviceId]){u.logger.log("Crypto: adding this device to the store...");const e={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:N.VERIFIED,known:!0};r[this._deviceId]=e,this._deviceList.storeDevicesForUser(this._userId,r),this._deviceList.saveIfDirty()}await this._cryptoStore.doTxn("readonly",[S.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this._cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(u.logger.log("Loaded cross-signing public keys from crypto store"),this._crossSigningInfo.setKeys(e))}))})),this._deviceList.startTrackingDeviceList(this._userId),u.logger.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup()},B.prototype.getCryptoTrustCrossSignedDevices=function(){return this._trustCrossSignedDevices},B.prototype.setCryptoTrustCrossSignedDevices=function(e){this._trustCrossSignedDevices=e;for(const t of this._deviceList.getKnownUserIds()){const e=this._deviceList.getRawStoredDevicesForUser(t);for(const n of Object.keys(e)){const e=this.checkDeviceTrust(t,n);if(!e.isLocallyVerified()&&e.isCrossSigningVerified()){const e=this._deviceList.getStoredDevice(t,n);this.emit("deviceVerificationChanged",t,n,e)}}}},B.prototype.createRecoveryKeyFromPassphrase=async function(t){const n=new e.Olm.PkDecryption;try{const e={};if(t){const i=await(0,w.keyFromPassphrase)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt},e.pubkey=n.init_with_private_key(i.key)}else e.pubkey=n.generate_key();const i=n.get_private_key();return{keyInfo:e,encodedPrivateKey:(0,E.encodeRecoveryKey)(i),privateKey:i}}finally{n&&n.free()}},B.prototype.isCrossSigningReady=async function(){const e=this._crossSigningInfo.getId(),t=await this._crossSigningInfo.isStoredInKeyCache()||await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);return!(!e||!t)},B.prototype.isSecretStorageReady=async function(){const e=await this._secretStorage.hasKey(),t=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage),n=!this._baseApis.getKeyBackupEnabled()||this._baseApis.isKeyBackupKeyStored();return!!(e&&t&&n)},B.prototype.bootstrapCrossSigning=async function({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){u.logger.log("Bootstrapping cross-signing");const n=this._baseApis._cryptoCallbacks,i=new m.EncryptionSetupBuilder(this._baseApis.store.accountData,n),r=new y.CrossSigningInfo(this._userId,i.crossSigningCallbacks,i.crossSigningCallbacks),o=async()=>{r.resetKeys(),await this._signObject(r.keys.master),i.addCrossSigningKeys(e,r.keys);const t=this._deviceList.getStoredDevice(this._userId,this._deviceId),n=await r.signDevice(this._userId,t);i.addKeySignature(this._userId,this._deviceId,n),this.backupInfo&&(await r.signObject(this.backupInfo.auth_data,"master"),i.addSessionBackup(this.backupInfo))},s=this._crossSigningInfo.getId(),a=await this._crossSigningInfo.isStoredInKeyCache(),c=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage),d=a||c;u.logger.log({setupNewCrossSigning:t,publicKeysOnDevice:s,privateKeysInCache:a,privateKeysInStorage:c,privateKeysExistSomewhere:d}),!d||t?(u.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):s&&a?u.logger.log("Cross-signing public keys trusted and private keys found locally"):c&&(u.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const l=i.crossSigningCallbacks.privateKeys;if(l.size&&!this._baseApis._cryptoCallbacks.saveCrossSigningKeys){const e=new v.SecretStorage(i.accountDataClientAdapter,i.ssssCryptoCallbacks);await e.hasKey()&&(u.logger.log("Storing new cross-signing private keys in secret storage"),await y.CrossSigningInfo.storeInSecretStorage(l,e))}const h=i.buildOperation();await h.apply(this),await i.persist(this),u.logger.log("Cross-signing ready")},B.prototype.bootstrapSecretStorage=async function({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,getKeyBackupPassphrase:r}={}){u.logger.log("Bootstrapping Secure Secret Storage");const o=this._baseApis._cryptoCallbacks,s=new m.EncryptionSetupBuilder(this._baseApis.store.accountData,o),a=new v.SecretStorage(s.accountDataClientAdapter,s.ssssCryptoCallbacks);let c=null;const d=async(e,t)=>{e=e||{},t&&(e.key=t);const{keyId:n,keyInfo:i}=await a.addKey(v.SECRET_STORAGE_ALGORITHM_V1_AES,e);return t&&s.ssssCryptoCallbacks.addPrivateKey(n,i,t),await a.setDefaultKeyId(n),n},l=async(e,t)=>{if(!t.mac){const n=await this._baseApis._cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(n){const i=n[1];s.ssssCryptoCallbacks.addPrivateKey(e,t,i);const{iv:r,mac:o}=await v.SecretStorage._calculateKeyCheck(i);t.iv=r,t.mac=o,await s.setAccountData(`m.secret_storage.key.${e}`,t)}}},g=async e=>{if(this._crossSigningInfo.getId()&&await this._crossSigningInfo.isStoredInKeyCache("master"))try{u.logger.log("Adding cross-signing signature to key backup"),await this._crossSigningInfo.signObject(e,"master")}catch(t){u.logger.error("Signing key backup with cross-signing keys failed",t)}else u.logger.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[f,_]=p||[null,null],S=!i&&_&&_.algorithm===v.SECRET_STORAGE_ALGORITHM_V1_AES;if(u.logger.log({keyBackupInfo:t,setupNewKeyBackup:n,setupNewSecretStorage:i,storageExists:S,oldKeyInfo:_}),S||t)if(!S&&t){u.logger.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await r(),n={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(n.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await d(n,e),await a.store("m.megolm_backup.v1",h.encodeBase64(e),[c]),await g(t.auth_data),s.addSessionBackup(t)}else u.logger.log("Secret storage exists"),_&&_.algorithm===v.SECRET_STORAGE_ALGORITHM_V1_AES&&await l(f,_);else{u.logger.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:n}=await e();c=await d(t,n)}if(!this._baseApis._cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!(await this._crossSigningInfo.isStoredInSecretStorage(a)))){u.logger.log("Copying cross-signing private keys from cache to secret storage");const e=await this._crossSigningInfo.getCrossSigningKeysFromCache();await y.CrossSigningInfo.storeInSecretStorage(e,a)}if(n&&!t){u.logger.log("Creating new message key backup version");const e=await this._baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,E.decodeRecoveryKey)(e.recovery_key);await a.store("m.megolm_backup.v1",h.encodeBase64(t));const n={algorithm:e.algorithm,auth_data:e.auth_data};await g(n.auth_data),await this._signObject(n.auth_data),s.addSessionBackup(n)}const b=await a.get("m.megolm_backup.v1");if(b){u.logger.info("Got session backup key from secret storage: caching");const e=x(b);e&&await a.store("m.megolm_backup.v1",e,[c||f]);const t=new Uint8Array(h.decodeBase64(e||b));await s.addSessionBackupPrivateKeyToCache(t)}const A=s.buildOperation();await A.apply(this),await s.persist(this),u.logger.log("Secure Secret Storage ready")},B.prototype.addSecretStorageKey=function(e,t,n){return this._secretStorage.addKey(e,t,n)},B.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},B.prototype.getSecretStorageKey=function(e){return this._secretStorage.getKey(e)},B.prototype.storeSecret=function(e,t,n){return this._secretStorage.store(e,t,n)},B.prototype.getSecret=function(e){return this._secretStorage.get(e)},B.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},B.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},B.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},B.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},B.prototype.checkSecretStorageKey=function(e,t){return this._secretStorage.checkKey(e,t)},B.prototype.checkSecretStoragePrivateKey=function(t,n){let i=null;try{i=new e.Olm.PkDecryption;return i.init_with_private_key(t)===n}finally{i&&i.free()}},B.prototype.getSessionBackupPrivateKey=async function(){let e=await new Promise((e=>{this._cryptoStore.doTxn("readonly",[S.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this._cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));if(e&&"string"===typeof e&&(e=new Uint8Array(h.decodeBase64(x(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=i.from(this._olmDevice._pickleKey),n=await(0,D.decryptAES)(e,t,"m.megolm_backup.v1");e=h.decodeBase64(n)}return e},B.prototype.storeSessionBackupPrivateKey=async function(e){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const t=i.from(this._olmDevice._pickleKey);return e=await(0,D.encryptAES)(h.encodeBase64(e),t,"m.megolm_backup.v1"),this._cryptoStore.doTxn("readwrite",[S.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this._cryptoStore.storeSecretStorePrivateKey(t,"m.megolm_backup.v1",e)}))},B.prototype.checkCrossSigningPrivateKey=function(t,n){let i=null;try{i=new e.Olm.PkSigning;return i.init_with_seed(t)===n}finally{i&&i.free()}},B.prototype._afterCrossSigningLocalKeyChange=async function(){u.logger.info("Starting cross-signing key change post-processing");const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),t=await this._crossSigningInfo.signDevice(this._userId,e);u.logger.info(`Starting background key sig upload for ${this._deviceId}`);const n=({shouldEmit:e})=>this._baseApis.uploadKeySignatures({[this._userId]:{[this._deviceId]:t}}).then((t=>{const{failures:i}=t||{};if(Object.keys(i||[]).length>0)throw e&&this._baseApis.emit("crypto.keySignatureUploadFailure",i,"_afterCrossSigningLocalKeyChange",n),new T.KeySignatureUploadError("Key upload failed",{failures:i});u.logger.info(`Finished background key sig upload for ${this._deviceId}`)})).catch((e=>{u.logger.error(`Error during background key sig upload for ${this._deviceId}`,e)}));n({shouldEmit:!0});const i=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(i){u.logger.info("Starting device verification upgrade");const e={};for(const[t,n]of Object.entries(this._deviceList._crossSigningInfo)){const i=await this._checkForDeviceVerificationUpgrade(t,y.CrossSigningInfo.fromStorage(n,t));i&&(e[t]=i)}if(Object.keys(e).length>0){u.logger.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await i({users:e});if(t)for(const n of t)n in e&&await this._baseApis.setDeviceVerified(n,e[n].crossSigningInfo.getId())}catch(r){u.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",r)}}u.logger.info("Finished device verification upgrade")}u.logger.info("Finished cross-signing key change post-processing")},B.prototype._checkForDeviceVerificationUpgrade=async function(e,t){const n=this._crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.verified){const n=this._deviceList.getRawStoredDevicesForUser(e),i=await this._checkForValidDeviceSignature(e,t.keys.master,n);if(i.length)return{devices:i.map((e=>p.DeviceInfo.fromStorage(n[e],e))),crossSigningInfo:t}}},B.prototype._checkForValidDeviceSignature=async function(e,t,n){const i=[];if(n&&t.signatures&&t.signatures[e])for(const o of Object.keys(t.signatures[e])){const[,s]=o.split(":",2);if(s in n&&n[s].verified===N.VERIFIED)try{await h.verifySignature(this._olmDevice,t,e,s,n[s].keys[o]),i.push(s)}catch(r){}}return i},B.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},B.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},B.prototype.checkUserTrust=function(e){const t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new y.UserTrustLevel(!1,!1,!1)},B.prototype.checkDeviceTrust=function(e,t){const n=this._deviceList.getStoredDevice(e,t);return this._checkDeviceInfoTrust(e,n)},B.prototype._checkDeviceInfoTrust=function(e,t){const n=!(!t||!t.isVerified()),i=this._deviceList.getStoredCrossSigningForUser(e);if(t&&i){const r=this._trustCrossSignedDevices||e===this._userId;return this._crossSigningInfo.checkDeviceTrust(i,t,n,r)}return new y.DeviceTrustLevel(!1,!1,n,!1)},B.prototype._onDeviceListUserCrossSigningUpdated=async function(e){if(e===this._userId){const t=this._deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,i=this._crossSigningInfo.getId(),r=i!==n;i&&n&&!r?await this.checkOwnCrossSigningTrust():(this._storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e)))}else{await this._checkDeviceVerifications(e);const t=this._deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))}},B.prototype.checkOwnCrossSigningTrust=async function({allowPrivateKeyRequests:e=!1}={}){const t=this._userId;await this.downloadKeys([this._userId]);const n=await this._crossSigningInfo.getCrossSigningKeysFromCache(),i=this._deviceList.getStoredCrossSigningForUser(t);if(!i)return void u.logger.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const r=i.getId(),o=this._crossSigningInfo.getId()!==r,s=i.getId()&&!n.has("master");if(o&&u.logger.info("Got new master public key",r),e&&(o||s)){u.logger.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this._crossSigningInfo.getCrossSigningKey("master",r))[1],u.logger.info("Got cross-signing master private key")}finally{e&&e.free()}}const a=this._crossSigningInfo.getId("self_signing"),c=this._crossSigningInfo.getId("user_signing");this._storeTrustedSelfKeys(i.keys);const d=a!==i.getId("self_signing"),l=c!==i.getId("user_signing"),h=i.getId("self_signing")&&!n.has("self_signing"),g=i.getId("user_signing")&&!n.has("user_signing"),p={};if(d&&u.logger.info("Got new self-signing key",i.getId("self_signing")),e&&(d||h)){u.logger.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this._crossSigningInfo.getCrossSigningKey("self_signing",i.getId("self_signing")))[1],u.logger.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this._deviceList.getStoredDevice(this._userId,this._deviceId),n=await this._crossSigningInfo.signDevice(this._userId,t);p[this._deviceId]=n}if(l&&u.logger.info("Got new user-signing key",i.getId("user_signing")),e&&(l||g)){u.logger.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this._crossSigningInfo.getCrossSigningKey("user_signing",i.getId("user_signing")))[1],u.logger.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(o){const e=this._crossSigningInfo.keys.master;await this._signObject(e);const t=e.signatures[this._userId]["ed25519:"+this._deviceId];p[this._crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this._userId]:{["ed25519:"+this._deviceId]:t}}})}const f=Object.keys(p);if(f.length){const e=({shouldEmit:t})=>(u.logger.info(`Starting background key sig upload for ${f}`),this._baseApis.uploadKeySignatures({[this._userId]:p}).then((n=>{const{failures:i}=n||{};if(u.logger.info(`Finished background key sig upload for ${f}`),Object.keys(i||[]).length>0)throw t&&this._baseApis.emit("crypto.keySignatureUploadFailure",i,"checkOwnCrossSigningTrust",e),new T.KeySignatureUploadError("Key upload failed",{failures:i})})).catch((e=>{u.logger.error(`Error during background key sig upload for ${f}`,e)})));e({shouldEmit:!0})}this.emit("userTrustStatusChanged",t,this.checkUserTrust(t)),o&&(this._baseApis.emit("crossSigning.keysChanged",{}),await this._afterCrossSigningLocalKeyChange()),await this.checkKeyBackup()},B.prototype._storeTrustedSelfKeys=async function(e){e?this._crossSigningInfo.setKeys(e):this._crossSigningInfo.clearKeys(),await this._cryptoStore.doTxn("readwrite",[S.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this._cryptoStore.storeCrossSigningKeys(e,this._crossSigningInfo.keys)}))},B.prototype._checkDeviceVerifications=async function(e){const t=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(u.logger.info(`Starting device verification upgrade for ${e}`),this._crossSigningInfo.keys.user_signing){const n=this._deviceList.getStoredCrossSigningForUser(e);if(n){const i=await this._checkForDeviceVerificationUpgrade(e,n);if(i){(await t({users:{[e]:i}})).includes(e)&&await this._baseApis.setDeviceVerified(e,n.getId())}}}u.logger.info(`Finished device verification upgrade for ${e}`)}},B.prototype._checkAndStartKeyBackup=async function(){if(u.logger.log("Checking key backup status..."),this._baseApis.isGuest())return u.logger.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,null;let e;try{e=await this._baseApis.getKeyBackupVersion()}catch(n){return u.logger.log("Error checking for active key backup",n),404===n.httpStatus&&(this._checkedForBackup=!0),null}this._checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(u.logger.log("Found usable key backup v"+e.version+": enabling key backups"),this._baseApis.enableKeyBackup(e)):!t.usable&&this.backupInfo?(u.logger.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(u.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):u.logger.log("Backup version "+e.version+" still current")):u.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}},B.prototype.setTrustedBackupPubKey=async function(e){this._sessionStore.setLocalTrustedBackupPubKey(e),await this.checkKeyBackup()},B.prototype.checkKeyBackup=async function(){return this._checkedForBackup=!1,this._checkAndStartKeyBackup()},B.prototype.isKeyBackupTrusted=async function(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.public_key||!e.auth_data.signatures)return u.logger.info("Key backup is absent or missing required data"),t;const n=this._sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===n&&(u.logger.info("Backup public key "+n+" is trusted locally"),t.trusted_locally=!0);const i=e.auth_data.signatures[this._userId]||[];for(const o of Object.keys(i)){const n=o.split(":");if("ed25519"!==n[0]){u.logger.log("Ignoring unknown signature type: "+n[0]);continue}const i={deviceId:n[1]},s=this._crossSigningInfo.getId();if(s===i.deviceId){i.crossSigningId=!0;try{await h.verifySignature(this._olmDevice,e.auth_data,this._userId,i.deviceId,s),i.valid=!0}catch(r){u.logger.warning("Bad signature from cross signing key "+s,r),i.valid=!1}t.sigs.push(i);continue}const a=this._deviceList.getStoredDevice(this._userId,i.deviceId);if(a){i.device=a,i.deviceTrust=await this.checkDeviceTrust(this._userId,i.deviceId);try{await h.verifySignature(this._olmDevice,e.auth_data,this._userId,a.deviceId,a.getFingerprint()),i.valid=!0}catch(r){u.logger.info("Bad signature from key ID "+o+" userID "+this._userId+" device ID "+a.deviceId+" fingerprint: "+a.getFingerprint(),e.auth_data,r),i.valid=!1}}else i.valid=null,u.logger.info("Ignoring signature from unknown key "+o);t.sigs.push(i)}return t.usable=t.sigs.some((e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId))),t.usable|=t.trusted_locally,t},B.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},B.prototype.registerEventHandlers=function(e){const t=this;e.on("RoomMember.membership",(function(e,n,i){try{t._onRoomMembership(e,n,i)}catch(r){u.logger.error("Error handling membership change:",r)}})),e.on("toDeviceEvent",t._onToDeviceEvent.bind(t));const n=t._onTimelineEvent.bind(t);e.on("Room.timeline",n),e.on("Event.decrypted",n)},B.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},B.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop(),this._dehydrationManager.stop()},B.getOlmVersion=function(){return l.OlmDevice.getOlmVersion()},B.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},B.prototype.getDeviceCurve25519Key=function(){return this._olmDevice.deviceCurve25519Key},B.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},B.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},B.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},B.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},B.prototype.uploadDeviceKeys=function(){const e=this,t=e._userId,n=e._deviceId,i={algorithms:e._supportedAlgorithms,device_id:n,keys:e._deviceKeys,user_id:t};return e._signObject(i).then((()=>e._baseApis.uploadKeysRequest({device_keys:i})))},B.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},B.prototype.setNeedsNewFallback=function(e){this._needsNewFallback=!!e},B.prototype.getNeedsNewFallback=function(){return this._needsNewFallback},B.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},B.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},B.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},B.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},B.prototype.setDeviceVerification=async function(e,t,n,i,r){void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null);const o=this._deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==i||null!==r)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");if(this._crossSigningInfo.getId()||e!==this._crossSigningInfo.userId||(this._storeTrustedSelfKeys(o.keys),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e))),e!==this._userId){u.logger.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const n=await this._crossSigningInfo.signUser(o);if(n){const i=async({shouldEmit:r})=>{u.logger.info("Uploading signature for "+e+"...");const o=await this._baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw r&&this._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",i),new T.KeySignatureUploadError("Key upload failed",{failures:s})};await i({shouldEmit:!0})}return n}return o}const s=this._deviceList.getRawStoredDevicesForUser(e);if(!s||!s[t])throw new Error("Unknown device "+e+":"+t);const a=s[t];let c=a.verified;n?c=N.VERIFIED:null!==n&&c==N.VERIFIED&&(c=N.UNVERIFIED),i?c=N.BLOCKED:null!==i&&c==N.BLOCKED&&(c=N.UNVERIFIED);let d=a.known;if(null!==r&&(d=r),a.verified===c&&a.known===d||(a.verified=c,a.known=d,this._deviceList.storeDevicesForUser(e,s),this._deviceList.saveIfDirty()),n&&e===this._userId){let n;u.logger.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?u.logger.log(`Own device ${t} already cross-signing verified`):n=await this._crossSigningInfo.signDevice(e,p.DeviceInfo.fromStorage(a,t)),n){const i=async({shouldEmit:r})=>{u.logger.info("Uploading signature for "+t);const o=await this._baseApis.uploadKeySignatures({[e]:{[t]:n}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw r&&this._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",i),new T.KeySignatureUploadError("Key upload failed",{failures:s})};await i({shouldEmit:!0})}}const l=p.DeviceInfo.fromStorage(a,t);return this.emit("deviceVerificationChanged",e,t,l),l},B.prototype.findVerificationRequestDMInProgress=function(e){return this._inRoomVerificationRequests.findRequestInProgress(e)},B.prototype.getVerificationRequestsToDeviceInProgress=function(e){return this._toDeviceVerificationRequests.getRequestsInProgress(e)},B.prototype.requestVerificationDM=function(e,t){const n=this._inRoomVerificationRequests.findRequestInProgress(t);if(n)return Promise.resolve(n);const i=new k.InRoomChannel(this._baseApis,t,e);return this._requestVerificationWithChannel(e,i,this._inRoomVerificationRequests)},B.prototype.requestVerification=function(e,t){t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));const n=this._toDeviceVerificationRequests.findRequestInProgress(e,t);if(n)return Promise.resolve(n);const i=new R.ToDeviceChannel(this._baseApis,e,t,R.ToDeviceChannel.makeTransactionId());return this._requestVerificationWithChannel(e,i,this._toDeviceVerificationRequests)},B.prototype._requestVerificationWithChannel=async function(e,t,n){let i=new I.VerificationRequest(t,this._verificationMethods,this._baseApis);t.transactionId&&n.setRequestByChannel(t,i),await i.sendRequest();const r=n.getRequestByChannel(t);return r?i=r:(u.logger.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),n.setRequestByChannel(t,i)),i},B.prototype.beginKeyVerification=function(e,t,n,i=null){let r;if(i){if(r=this._toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,i),!r)throw new Error(`No request found for user ${t} with transactionId ${i}`)}else{i=R.ToDeviceChannel.makeTransactionId();const e=new R.ToDeviceChannel(this._baseApis,t,[n],i,n);r=new I.VerificationRequest(e,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,r)}return r.beginKeyVerification(e,{userId:t,deviceId:n})},B.prototype.legacyDeviceVerification=async function(e,t,n){const i=R.ToDeviceChannel.makeTransactionId(),r=new R.ToDeviceChannel(this._baseApis,e,[t],i,t),o=new I.VerificationRequest(r,this._verificationMethods,this._baseApis);this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,i,o);const s=o.beginKeyVerification(n,{userId:e,deviceId:t});return await Promise.race([s.verify(),o.waitFor((e=>e.started))]),o},B.prototype.getOlmSessionsForUser=async function(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(let i=0;i<t.length;++i){const e=t[i],r=e.getIdentityKey(),o=await this._olmDevice.getSessionInfoForDevice(r);n[e.deviceId]={deviceIdKey:r,sessions:o}}return n},B.prototype.getEventSenderDeviceInfo=function(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const i=this._deviceList.getDeviceByIdentityKey(n,t);if(null===i)return null;const r=e.getClaimedEd25519Key();return r?r!==i.getFingerprint()?(u.logger.warn("Event "+e.getId()+" claims ed25519 key "+r+" but sender device has key "+i.getFingerprint()),null):i:(u.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},B.prototype.getEventEncryptionInfo=function(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this._deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const n=e.getClaimedEd25519Key();return n||(u.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&n!==t.sender.getFingerprint()&&(u.logger.warn("Event "+e.getId()+" claims ed25519 key "+n+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t},B.prototype.forceDiscardSession=function(e){const t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},B.prototype.setRoomEncryption=async function(e,t,n){if(!t.algorithm)return void u.logger.log("Ignoring setRoomEncryption with no algorithm");const i=this._roomList.getRoomEncryption(e);if(i&&JSON.stringify(i)!=JSON.stringify(t))return void u.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this._roomEncryptors[e])return;let r=null;i||(r=this._roomList.setRoomEncryption(e,t));const o=f.ENCRYPTION_CLASSES[t.algorithm];if(!o)throw new Error("Unable to encrypt with "+t.algorithm);const s=new o({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t});this._roomEncryptors[e]=s,r&&await r,this._lazyLoadMembers?u.logger.log("Enabling encryption in "+e):(u.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists())},B.prototype.trackRoomDevices=function(e){const t=async()=>{if(!this._roomEncryptors[e])return;const t=this._clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);u.logger.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach((e=>{this._deviceList.startTrackingDeviceList(e.userId)}))};let n=this._roomDeviceTrackingState[e];return n||(n=t(),this._roomDeviceTrackingState[e]=n.catch((t=>{throw this._roomDeviceTrackingState[e]=null,t}))),n},B.prototype.ensureOlmSessionsForUsers=function(e){const t={};for(let n=0;n<e.length;++n){const i=e[n];t[i]=[];const r=this.getStoredDevicesForUser(i)||[];for(let e=0;e<r.length;++e){const n=r[e];n.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(n.verified!=N.BLOCKED&&t[i].push(n))}}return h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},B.prototype.exportRoomKeys=async function(){const e=[];return await this._cryptoStore.doTxn("readonly",[S.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],(t=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const n=this._olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=h.MEGOLM_ALGORITHM,e.push(n)}))})),e},B.prototype.importRoomKeys=function(e,t={}){let n=0,i=0;const r=e.length;function o(){t.progressCallback({stage:"load_keys",successes:n,failures:i,total:r})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return u.logger.warn("ignoring room key entry with missing fields",e),i++,t.progressCallback&&o(),null;return this._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally((e=>{n++,t.progressCallback&&o()}))})))},B.prototype.scheduleKeyBackupSend=async function(e=1e4){if(!this._sendingBackups){this._sendingBackups=!0;try{const n=Math.random()*e;await(0,d.sleep)(n);let i=0;for(;;){if(!this.backupKey)return;try{if(0===await this._backupPendingKeys(200))return;i=0}catch(t){if(i++,u.logger.log("Key backup request failed",t),t.data&&("M_NOT_FOUND"==t.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==t.data.errcode))throw await this.checkKeyBackup(),this.emit("crypto.keyBackupFailed",t.data.errcode),t}i&&await(0,d.sleep)(1e3*Math.pow(2,Math.min(i-1,4)))}}finally{this._sendingBackups=!1}}},B.prototype._backupPendingKeys=async function(e){const t=await this._cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this._cryptoStore.countSessionsNeedingBackup();this.emit("crypto.keyBackupSessionsRemaining",n);const i={};for(const r of t){const e=r.sessionData.room_id;void 0===i[e]&&(i[e]={sessions:{}});const t=await this._olmDevice.exportInboundGroupSession(r.senderKey,r.sessionId,r.sessionData);t.algorithm=h.MEGOLM_ALGORITHM,delete t.session_id,delete t.room_id;const n=t.first_known_index;delete t.first_known_index;const o=this.backupKey.encrypt(JSON.stringify(t)),s=(t.forwarding_curve25519_key_chain||[]).length,a=this._deviceList.getUserByIdentityKey(h.MEGOLM_ALGORITHM,r.senderKey),c=this._deviceList.getDeviceByIdentityKey(h.MEGOLM_ALGORITHM,r.senderKey),u=this._checkDeviceInfoTrust(a,c).isVerified();i[e].sessions[r.sessionId]={first_message_index:n,forwarded_count:s,is_verified:u,session_data:o}}return await this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:i}),await this._cryptoStore.unmarkSessionsNeedingBackup(t),n=await this._cryptoStore.countSessionsNeedingBackup(),this.emit("crypto.keyBackupSessionsRemaining",n),t.length},B.prototype.backupGroupSession=async function(e,t,n,i,r,o,s){await this._cryptoStore.markSessionsNeedingBackup([{senderKey:t,sessionId:i}]),this.backupInfo&&this.scheduleKeyBackupSend()},B.prototype.scheduleAllGroupSessionsForBackup=async function(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)},B.prototype.flagAllGroupSessionsForBackup=async function(){await this._cryptoStore.doTxn("readwrite",[S.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,S.IndexedDBCryptoStore.STORE_BACKUP],(e=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this._cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this._cryptoStore.countSessionsNeedingBackup();return this.emit("crypto.keyBackupSessionsRemaining",e),e},B.prototype.countSessionsNeedingBackup=function(){return this._cryptoStore.countSessionsNeedingBackup()},B.prototype.prepareToEncrypt=function(e){const t=e.roomId,n=this._roomEncryptors[t];n&&n.prepareToEncrypt(e)},B.prototype.encryptEvent=async function(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const n=e.getRoomId(),i=this._roomEncryptors[n];if(!i)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this._roomDeviceTrackingState[n]||this.trackRoomDevices(n),await this._roomDeviceTrackingState[n];let r=e.getContent();const o=r["m.relates_to"];o&&(r=Object.assign({},r),delete r["m.relates_to"]);const s=await i.encryptMessage(t,e.getType(),r);o&&(s["m.relates_to"]=o),e.makeEncrypted("m.room.encrypted",s,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key)},B.prototype.decryptEvent=async function(e){if(e.isRedacted()){const t=new M.MatrixEvent(e.getUnsigned().redacted_because),n=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n.clearEvent}}}}{const t=e.getWireContent(),n=this._getRoomDecryptor(e.getRoomId(),t.algorithm);return await n.decryptEvent(e)}},B.prototype.handleDeviceListChanges=async function(e,t){e.oldSyncToken&&await this._evalDeviceListChanges(t)},B.prototype.requestRoomKey=function(e,t,n=!1){return this._outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then((()=>{this._sendKeyRequestsImmediately&&this._outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{u.logger.error("Error requesting key for event",e)}))},B.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{u.logger.warn("Error clearing pending room key requests",e)}))},B.prototype.cancelAndResendAllOutgoingKeyRequests=function(){return this._outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()},B.prototype.onCryptoEvent=async function(e){const t=e.getRoomId(),n=e.getContent();try{await this.setRoomEncryption(t,n,!0)}catch(i){u.logger.error("Error configuring encryption in room "+t+":",i)}},B.prototype.onSyncWillProcess=async function(e){e.oldSyncToken||(u.logger.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={}),this._sendKeyRequestsImmediately=!1},B.prototype.onSyncCompleted=async function(e){const t=e.nextSyncToken;this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(j(this),this._processReceivedRoomKeyRequests(),this._outgoingRoomKeyRequestManager.sendQueuedRequests(),this._sendKeyRequestsImmediately=!0)},B.prototype._evalDeviceListChanges=async function(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach((e=>{this._deviceList.invalidateUserDeviceList(e)})),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this._getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this._deviceList.stopTrackingDeviceList(e)}))}},B.prototype._getTrackedE2eUsers=async function(){const e=[];for(const t of this._getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e},B.prototype._getTrackedE2eRooms=function(){return this._clientStore.getRooms().filter((e=>{if(!this._roomEncryptors[e.roomId])return!1;if(!this._roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t}))},B.prototype._onToDeviceEvent=function(e){try{u.logger.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",(e=>{this._onToDeviceEvent(e)}))}catch(t){u.logger.error("Error handling toDeviceEvent:",t)}},B.prototype._onRoomKeyEvent=function(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void u.logger.error("key event is missing fields");this._checkedForBackup||this._checkAndStartKeyBackup();this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)},B.prototype._onRoomKeyWithheldEvent=function(e){const t=e.getContent();if("m.no_olm"!==t.code&&(!t.room_id||!t.session_id)||!t.algorithm||!t.sender_key)return void u.logger.error("key withheld event is missing fields");u.logger.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const n=this._getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this._getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}},B.prototype._onKeyVerificationMessage=function(e){if(!R.ToDeviceChannel.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._toDeviceVerificationRequests,(e=>{if(!R.ToDeviceChannel.canCreateRequest(R.ToDeviceChannel.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const i=e.getSender(),r=new R.ToDeviceChannel(this._baseApis,i,[n]);return new I.VerificationRequest(r,this._verificationMethods,this._baseApis)}))},B.prototype._onTimelineEvent=function(e,t,n,i,{liveEvent:r}={}){if(!k.InRoomChannel.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._inRoomVerificationRequests,(e=>{const t=new k.InRoomChannel(this._baseApis,e.getRoomId());return new I.VerificationRequest(t,this._verificationMethods,this._baseApis)}),r)},B.prototype._handleVerificationEvent=async function(e,t,n,i=!0){let r=t.getRequest(e),o=!1;if(!r){if(r=n(e),!r)return void u.logger.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);o=!0,t.setRequest(e,r)}e.setVerificationRequest(r);try{await r.channel.handleEvent(e,r,i)}catch(s){u.logger.error("error while handling verification event: "+s.message)}o&&!r.initiatedByMe&&!r.invalid&&!r.observeOnly&&this._baseApis.emit("crypto.verification.request",r)},B.prototype._onToDeviceBadEncrypted=async function(e){const t=e.getWireContent(),n=e.getSender(),i=t.algorithm,r=t.sender_key,o=()=>{const e=this._getRoomDecryptors(h.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(r)};if(void 0===n||void 0===r||void 0===r)return;this._lastNewSessionForced[n]=this._lastNewSessionForced[n]||{};const s=this._lastNewSessionForced[n][r]||0;if(s+36e5>Date.now())return u.logger.debug("New session already forced with device "+n+":"+r+" at "+s+": not forcing another"),await this._olmDevice.recordSessionProblem(r,"wedged",!0),void o();let a=this._deviceList.getDeviceByIdentityKey(i,r);if(!a&&(await this.downloadKeys([n],!1),a=this._deviceList.getDeviceByIdentityKey(i,r),!a))return u.logger.info("Couldn't find device for identity key "+r+": not re-establishing session"),await this._olmDevice.recordSessionProblem(r,"wedged",!1),void o();const c={};c[n]=[a],await h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,c,!0),this._lastNewSessionForced[n][r]=Date.now();const d={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await h.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,n,a,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(r,"wedged",!0),o(),await this._baseApis.sendToDevice("m.room.encrypted",{[n]:{[a.deviceId]:d}});const l=await this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,a.deviceId);for(const u of l)this.requestRoomKey(u.requestBody,u.recipients,!0)},B.prototype._onRoomMembership=function(e,t,n){const i=t.roomId,r=this._roomEncryptors[i];r&&(this._roomDeviceTrackingState[i]&&("join"==t.membership?(u.logger.log("Join event for "+t.userId+" in "+i),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(i).shouldEncryptForInvitedMembers()&&(u.logger.log("Invite event for "+t.userId+" in "+i),this._deviceList.startTrackingDeviceList(t.userId))),r.onRoomMembership(e,t,n))},B.prototype._onRoomKeyRequestEvent=function(e){const t=e.getContent();if("request"===t.action){const t=new G(e);this._receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new F(e);this._receivedRoomKeyRequestCancellations.push(t)}},B.prototype._processReceivedRoomKeyRequests=async function(){if(!this._processingRoomKeyRequests){this._processingRoomKeyRequests=!0;try{const e=this._receivedRoomKeyRequests;this._receivedRoomKeyRequests=[];const t=this._receivedRoomKeyRequestCancellations;this._receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this._processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this._processReceivedRoomKeyRequestCancellation(e))))}catch(e){u.logger.error(`Error processing room key requsts: ${e}`)}finally{this._processingRoomKeyRequests=!1}}},B.prototype._processReceivedRoomKeyRequest=async function(e){const t=e.userId,n=e.deviceId,i=e.requestBody,r=i.room_id,o=i.algorithm;if(u.logger.log(`m.room_key_request from ${t}:${n} for ${r} / ${i.session_id} (id ${e.requestId})`),t!==this._userId){if(!this._roomEncryptors[r])return void u.logger.debug(`room key request for unencrypted room ${r}`);const e=this._roomEncryptors[r],o=this._deviceList.getStoredDevice(t,n);if(!o)return void u.logger.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(i.sender_key,i.session_id,t,o)}catch(a){u.logger.warn("Failed to re-share keys for session "+i.session_id+" with device "+t+":"+o.deviceId,a)}return}if(n===this._deviceId)return void u.logger.log("Ignoring room key request from ourselves");if(!this._roomDecryptors[r])return void u.logger.log(`room key request for unencrypted room ${r}`);const s=this._roomDecryptors[r][o];if(s)if(await s.hasKeysForKeyRequest(e)){if(e.share=()=>{s.shareKeysWithDevice(e)},this.checkDeviceTrust(t,n).isVerified())return u.logger.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)}else u.logger.log(`room key request for unknown session ${r} / `+i.session_id);else u.logger.log(`room key request for unknown alg ${o} in room ${r}`)},B.prototype._processReceivedRoomKeyRequestCancellation=async function(e){u.logger.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)},B.prototype._getRoomDecryptor=function(e,t){let n,i;if((e=e||null)&&(n=this._roomDecryptors[e],n||(this._roomDecryptors[e]=n={}),i=n[t],i))return i;const r=f.DECRYPTION_CLASSES[t];if(!r)throw new f.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return i=new r({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),n&&(n[t]=i),i},B.prototype._getRoomDecryptors=function(e){const t=[];for(const n of Object.values(this._roomDecryptors))e in n&&t.push(n[e]);return t},B.prototype._signObject=async function(e){const t=e.signatures||{},n=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=await this._olmDevice.sign(s.default.stringify(e)),e.signatures=t,void 0!==n&&(e.unsigned=n)};class G{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class F{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,n("bqPV"),n("qykS").Buffer)},f3QS:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceRequests=t.ToDeviceChannel=void 0;var i=n("ns36"),r=n("uZMU"),o=n("LTeG"),s=n("nk7+"),a=n("MwLI");class c{constructor(e,t,n,i=null,r=null){this._client=e,this.userId=t,this._devices=n,this.transactionId=i,this._deviceId=r}isToDevices(e){if(e.length===this._devices.length){for(const t of e){if(!this._devices.find((e=>e.deviceId===t.deviceId)))return!1}return!0}return!1}get deviceId(){return this._deviceId}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===o.REQUEST_TYPE||e===o.START_TYPE}static validateEvent(e,t){if(e.isCancelled())return r.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return r.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!n.transaction_id)return r.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const i=e.getType();if(i===o.REQUEST_TYPE){if(!Number.isFinite(n.timestamp))return r.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return r.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return o.VerificationRequest.validateEvent(i,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,n){const i=e.getType(),r=e.getContent();if(i===o.REQUEST_TYPE||i===o.READY_TYPE||i===o.START_TYPE){this.transactionId||(this.transactionId=r.transaction_id);const e=r.from_device;if(!this._deviceId&&this._devices.includes(e)&&(this._deviceId=e),!this._deviceId||this._deviceId!==e){const t=this.completeContent((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)()));return this._sendToDevices(o.CANCEL_TYPE,t,[e])}}const a=t.phase===o.PHASE_STARTED||t.phase===o.PHASE_READY;await t.handleEvent(e.getType(),e,n,!1,!1);const c=t.phase===o.PHASE_STARTED||t.phase===o.PHASE_READY;if((i===o.START_TYPE||i===o.READY_TYPE)&&!a&&c&&this._deviceId){const e=this._devices.filter((e=>e!==this._deviceId&&e!==this._client.getDeviceId()));if(e.length){const t=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"});await this._sendToDevices(o.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==o.REQUEST_TYPE&&e!==o.READY_TYPE&&e!==o.START_TYPE||(t.from_device=this._client.getDeviceId()),e===o.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e,t={}){e!==o.REQUEST_TYPE&&e!==o.START_TYPE||this.transactionId||(this.transactionId=c.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n;n=e===o.REQUEST_TYPE?await this._sendToDevices(e,t,this._devices):await this._sendToDevices(e,t,[this._deviceId]);const i=new a.MatrixEvent({sender:this._client.getUserId(),content:t,type:e});return await this._request.handleEvent(e,i,!0,!0,!0),n}_sendToDevices(e,t,n){if(n.length){const i={};for(const e of n)i[e]=t;return this._client.sendToDevice(e,{[this.userId]:i})}return Promise.resolve()}static makeTransactionId(){return(0,i.randomString)(32)}}t.ToDeviceChannel=c;t.ToDeviceRequests=class{constructor(){this._requestsByUserId=new Map}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const n=this._requestsByUserId.get(e);if(n)return n.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,n){let i=this._requestsByUserId.get(e);i||(i=new Map,this._requestsByUserId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getSender(),n=this._requestsByUserId.get(t);n&&(n.delete(c.getTransactionId(e)),0===n.size&&this._requestsByUserId.delete(t))}findRequestInProgress(e,t){const n=this._requestsByUserId.get(e);if(n)for(const i of n.values())if(i.pending&&i.channel.isToDevices(t))return i}getRequestsInProgress(e){const t=this._requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}},fWms:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=s;var r=i(n("dZ+v")),o=n("1Tpr");function s(e,t){this.rank=e,this.context=t}s.fromJson=function(e,t){const n=e.context||{},i=n.events_before||[],a=n.events_after||[],c=new o.EventContext(t(e.result));return c.setPaginateToken(n.start,!0),c.addEvents(r.map(i,t),!0),c.addEvents(r.map(a,t),!1),c.setPaginateToken(n.end,!1),new s(e.rank,c)}},g7Jc:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAUCAYAAACeXl35AAAAAXNSR0IArs4c6QAAAgZJREFUSA1jZACCisNLBZn5WUMZ/v/X/P3/HxdIjFjAysj0jYGR8frfj79Xd9hGvyekjxFsGR9LnYuYDoexsBITLysHIT0o8p9//2A4+/bevz2vrvz4++lPEyFLmUA+A1nmIKFFsmUgm0EOBOkFmQEOJRTnYHKYQMEI8hmmFGkiYDOAZhHSxQKKM1KDEZuhIDPQ4794/0wRZj5eXwaGfyaM/xlmdJrEXKbYZ9gsB4lVnJ+vwCzI18rA8P8j83/mRf9ZmHOy9q/iYcGlgRLxstOL1f8xshT9+/m7o8c87j7IrLJzy8LExBgYqO7Dshtzef8xMScz/vszDWYZ2PGMDEyvXtHAQobvnBZMjP8vdxrFXsQWSlT3IeM/BqW/f/7fwGYZSIzqcfiP6T8HCzOw9MEBqO5Dhv//Xv37yyCLwz7qJ5o/f5lOMjIxODWcmYm1TKa6D/tNo+/9/8ew7ysTd23D1QY2uE//M/yjSbYAWdBtHLWDkYHx2pefquWgAqDh6iq2/wwMrM+OvP9JdR/CfNRlFL34/z/G/f8Y2XO+/f47mYmJ4cis9PTfLKD6DFjFUFyegqopcN0IsxFI95pEHVn1f9Xxwyd/cU+2iPkEkmIBVZ7A+swQVMUgqSWZCaoTQWahawxjDPsLFANbBpJjAdXUe/5fAVUr1KiAV4MMxQcYQZL0bGIAAPPQ0h88Cct1AAAAAElFTkSuQmCC"},gP8h:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=o,t.TimelineIndex=s;var i=n("apMS");n("uZMU");const r=function(){};function o(e,t,n){n=n||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=n.windowLimit||1e3}function s(e,t){this.timeline=e,this.index=t}o.prototype.load=function(e,t){const n=this;t=t||20;const i=function(i){let r;const o=i.getEvents();if(e){for(let t=0;t<o.length;t++)if(o[t].getId()==e){r=t;break}if(void 0===r)throw new Error("getEventTimeline result didn't include requested event")}else r=o.length;const a=Math.min(o.length,r+Math.ceil(t/2)),c=Math.max(0,a-t);n._start=new s(i,c-i.getBaseIndex()),n._end=new s(i,a-i.getBaseIndex()),n._eventCount=a-c};if(e){const t=this._timelineSet.getTimelineForEvent(e);if(t)return i(t),Promise.resolve(t);return this._client.getEventTimeline(this._timelineSet,e).then(i)}return i(this._timelineSet.getLiveTimeline()),Promise.resolve()},o.prototype.getTimelineIndex=function(e){if(e==i.EventTimeline.BACKWARDS)return this._start;if(e==i.EventTimeline.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},o.prototype.extend=function(e,t){const n=this.getTimelineIndex(e);if(!n)return r("TimelineWindow: no timeline yet"),!1;const o=e==i.EventTimeline.BACKWARDS?n.retreat(t):n.advance(t);if(o){this._eventCount+=o,r("TimelineWindow: increased cap by "+o+" (now "+this._eventCount+")");const t=this._eventCount-this._windowLimit;return t>0&&this.unpaginate(t,e!=i.EventTimeline.BACKWARDS),!0}return!1},o.prototype.canPaginate=function(e){const t=this.getTimelineIndex(e);if(!t)return r("TimelineWindow: no timeline yet"),!1;if(e==i.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},o.prototype.paginate=function(e,t,n,o){void 0===n&&(n=!0),void 0===o&&(o=5);const s=this.getTimelineIndex(e);if(!s)return r("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!n||0===o)return Promise.resolve(!1);if(!s.timeline.getPaginationToken(e))return r("TimelineWindow: no token"),Promise.resolve(!1);r("TimelineWindow: starting request");const a=this,c=this._client.paginateEventTimeline(s.timeline,{backwards:e==i.EventTimeline.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then((function(n){return r("TimelineWindow: request completed with result "+n),!!n&&a.paginate(e,t,!0,o-1)}));return s.pendingPaginate=c,c},o.prototype.unpaginate=function(e,t){const n=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){const i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=i,this._eventCount-=i,r("TimelineWindow.unpaginate: dropped "+i+" (now "+this._eventCount+")")}},o.prototype.getEvents=function(){if(!this._start)return[];const e=[];let t=this._start.timeline;for(;;){const n=t.getEvents();let r=0,o=n.length;t===this._start.timeline&&(r=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(let t=r;t<o;t++)e.push(n[t]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(i.EventTimeline.FORWARDS)}return e},s.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},s.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},s.prototype.advance=function(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),r("paginate: switched to new neighbour"),this.advance(e)):0},s.prototype.retreat=function(e){return-1*this.advance(-1*e)}},gePy:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbortedIdentityActionError=void 0;var i=A(n("7oj+")),r=A(n("rIjD")),o=A(n("7lnb")),s=A(n("ByL7")),a=A(n("6J4u")),c=A(n("2lBV")),u=A(n("YUSd")),d=A(n("Zv/C")),l=A(n("Dkg+")),h=A(n("Gjrs")),g=n("F41g"),p=A(n("BGZc")),f=A(n("Uma8")),y=A(n("v61F")),m=n("nPNV"),v=n("3LMv"),_=n("ES26"),S=n("ymnI"),b=A(n("kPC3"));function A(e){return e&&e.__esModule?e:{default:e}}var w=t.AbortedIdentityActionError=function(e){function t(){return(0,d.default)(this,t),(0,l.default)(this,(t.__proto__||(0,u.default)(t)).apply(this,arguments))}return(0,h.default)(t,e),t}(function(e){function t(){var t=(0,s.default)(e,(0,o.default)(arguments));return(0,r.default)(t,(0,u.default)(this)),t}return t.prototype=(0,i.default)(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r.default?(0,r.default)(t,e):t.__proto__=e,t}(Error)),E=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,d.default)(this,e),this.accessToken=null,this.authEnabled=!0,this.tempClient=t?(0,g.createClient)({baseUrl:"",idBaseUrl:t}):null}return(0,c.default)(e,[{key:"_writeToken",value:function(){this.tempClient||b.default.setItem("mx_is_access_token",this.accessToken)}},{key:"_readToken",value:function(){return this.tempClient?null:b.default.getItem("mx_is_access_token")}},{key:"hasCredentials",value:function(){return null!=this.accessToken}},{key:"getAccessToken",value:async function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.check,n=void 0===t||t;if(!this.authEnabled)return null;var i=this.accessToken;if(i||(i=this._readToken()),!i)return(i=await this.registerForToken(n))&&(this.accessToken=i,this._writeToken()),i;if(n)try{await this._checkToken(i)}catch(r){if(r instanceof v.TermsNotSignedError||r instanceof w)throw r;(i=await this.registerForToken())&&(this.accessToken=i,this._writeToken())}return i}},{key:"_checkToken",value:async function(e){var t=this._matrixClient.getIdentityServerUrl();try{await this._matrixClient.getIdentityAccount(e)}catch(o){if("M_TERMS_NOT_SIGNED"===o.errcode)return console.log("Identity Server requires new terms to be agreed to"),void(await(0,v.startTermsFlow)([new v.Service(g.SERVICE_TYPES.IS,t,e)]));throw o}if(!this.tempClient&&!(0,_.doesAccountDataHaveIdentityServer)()&&!(await(0,_.doesIdentityServerHaveTerms)(t))){var n=y.default.getComponent("dialogs.QuestionDialog"),i=f.default.createTrackedDialog("Default identity server terms warning","",n,{title:(0,m._t)("Identity server has no terms of service"),description:React.createElement("div",null,React.createElement("p",null,(0,m._t)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:function(){return React.createElement("b",null,(0,S.abbreviateUrl)(t))}})),React.createElement("p",null,(0,m._t)("Only continue if you trust the owner of the server."))),button:(0,m._t)("Trust")}).finished,r=await i;if(!(0,a.default)(r,1)[0])throw new w("User aborted identity server action without terms");(0,_.useDefaultIdentityServer)()}}},{key:"registerForToken",value:async function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];try{var t=await p.default.get().getOpenIdToken(),n=await this._matrixClient.registerWithIdentityServer(t),i=n.access_token,r=n.token,o=r||i;return e&&await this._checkToken(o),o}catch(s){if("rejected"===s.cors||404===s.httpStatus)return console.warn("IS doesn't support v2 auth"),void(this.authEnabled=!1);throw s}}},{key:"_matrixClient",get:function(){return this.tempClient?this.tempClient:p.default.get()}}]),e}();t.default=E},gl1w:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeHtmlMessage=function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlNotice=function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlEmote=function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeTextMessage=function(e){return{msgtype:"m.text",body:e}},t.makeNotice=function(e){return{msgtype:"m.notice",body:e}},t.makeEmoteMessage=function(e){return{msgtype:"m.emote",body:e}}},hRic:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAUCAYAAAC58NwRAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTlDMTIzMDc2N0QzMTFFNUFGRTJCNkYzRDkzNDkyODkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTlDMTIzMDg2N0QzMTFFNUFGRTJCNkYzRDkzNDkyODkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5OUMxMjMwNTY3RDMxMUU1QUZFMkI2RjNEOTM0OTI4OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5OUMxMjMwNjY3RDMxMUU1QUZFMkI2RjNEOTM0OTI4OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvlvmmIAAAD7SURBVHjaYvz//z8DKYCRVA0MIA348Ieff8UPPPvxH8bHa8OLb38dV9z9vu/L3/8M7tLsn0xF2fiZcCm+9+lP/aLb38CK5bmZGXSFWCVx+uHC218Ptj7+KQ+S0RFgYfCV42BmZmL8h1XDwec//x9++QvMthJjY3CSYmfEGUpbHv74f+H9bwaQCg8Z9ofGImwKWIP159//XGvu//h6/8sfBlag6iAFzhWq/CyRWOPh06+/4svv/njx6sdfBqDfGCKUuZwkuZj34woMJgYSAelOIsvTZAcrWREHA3eBSWPt/e8Nv4DSoKQRqsTJzcHM+I3kxEfd5E2VHAcQYAB4APDTI61WUgAAAABJRU5ErkJggg=="},hlFd:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAghJREFUSA21VjsvREEYPbMSrwQdsVFINAqlRKNRCiEkorAKrEYQEr2o/ACJxFtBa0MoKPgH6lVIFCIqjXg/xnfmzu663Nm9Hvckkzt757vnfDPzPVYhDzQG6oCSbkB1yGgQ07g1vwL0uYwD4GlXYfvSRaOCFjSGhUjNydqQPIuCbHLv9JvMN0RsVmFdhP34JiDkXUK6JaPCb1rol74VkYSI7H22jH3+oZGcBGKpn5OThQ7FUh5HjjW7A89zksMnmjMNPXsH3nsyOzEC9szTv/M8SNgcVyPvxHrLCw1x5vO9wHhbEOOXd+QyQYKYF4qMlhCorQI4wmGI3LIDE+cFQjEco9+K4V3SLQJMoqigOijADI0IqoGXnEn/KETiFHAj2QpUlrrXqyVYBlrc67JCgW/1I/tFXzNwOBUsQvKTGaC9KWseMGEesCo60LMIPLwAR9N+kRpLfnYt5XDT8TFf63MKSMl14P4Z6FwA+KRIVRlQUwkci+dpIe9fBl5YTF3QB8pLtNILiSZ3LpQXA/sTQFujx7RzKuRLwKuUHSdYxh/rbS0aWRGBpNOWCxRJjQE3d8DgWgFyfqBXFdZGrYBpMNEVO68T6YTI5tsz3QoD4TCNx0RnNg9s/Zab/JMIHZzO9AJ6Y46IkwwibZkU8dS1hItelZEvBq1PtDG2bDC+fuzxWbOgx3/8bfkAwwCdoh3EeogAAAAASUVORK5CYII="},iBp1:function(e,t,n){"use strict";n.d(t,"a",(function(){return g})),n.d(t,"b",(function(){return p}));var i=n("Udjz"),r=n("mXGw"),o=n.n(r),s=n("/m4v"),a=n("S7sX"),c=n("8yKA"),u=n("OlfC"),d=n.n(u),l=n("OQez"),h=o.a.createElement,g=function(){var e=Object(s.e)(c.j),t=Object(s.e)(c.m),n=Object(s.e)(c.i),i=Object(s.d)();return Object(r.useEffect)((function(){e===l.a.IDLE&&t&&i(Object(a.b)(t))}),[i,e,t]),{settings:n,status:e}},p=function(e){var t=function(t,n){var o=g().settings,s=Object(r.useMemo)((function(){return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t.join(".");return d.a.pick(i,o)||!1}}),[o]);return h(e,Object(i.a)({s:s},t,{ref:n}))};return o.a.forwardRef(t)}},kPC3:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=n("LomB"),o=(i=r)&&i.__esModule?i:{default:i};var s=void 0;try{s=window.localStorage}catch(a){s=new o.default}t.default=s,e.exports=t.default},kdap:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SETTINGS=void 0;var i=n("nPNV"),r=n("+24j"),o=a(n("QcLs")),s=a(n("65pn"));function a(e){return e&&e.__esModule?e:{default:e}}var c=["device","room-device","room-account","account","config"],u=["device","room-device","room-account","account","config","room"],d=["device","account","config"],l=["device","config"],h=["device"],g=["device","config"];t.SETTINGS={feature_pinning:{isFeature:!0,displayName:(0,i._td)("Message Pinning"),supportedLevels:l,default:!1},feature_custom_status:{isFeature:!0,displayName:(0,i._td)("Custom user status messages"),supportedLevels:l,default:!1,controller:new o.default},feature_custom_tags:{isFeature:!0,displayName:(0,i._td)("Group & filter rooms by custom tags (refresh to apply changes)"),supportedLevels:l,default:!1},feature_state_counters:{isFeature:!0,displayName:(0,i._td)("Render simple counters in room header"),supportedLevels:l,default:!1},feature_many_integration_managers:{isFeature:!0,displayName:(0,i._td)("Multiple integration managers"),supportedLevels:l,default:!1},feature_dm_verification:{isFeature:!0,displayName:(0,i._td)("Send verification requests in direct message, including a new verification UX in the member panel."),supportedLevels:l,default:!1},useCiderComposer:{displayName:(0,i._td)("Use the new, faster, composer for writing messages"),supportedLevels:d,default:!0},"presence.unavailableTimeMs":{displayName:(0,i._td)("Time in ms before your presence changes to away"),supportedLevels:d,default:3e5},"presence.offlineTimeMs":{displayName:(0,i._td)("Time in ms before your presence changes to offline"),supportedLevels:d,default:9e5},"presence.state":{displayName:(0,i._td)("The initial state for the chat client"),supportedLevels:d,default:null},"presence.autoPresence":{displayName:(0,i._td)("Rresence automatically changes based on the configured timeouts"),supportedLevels:d,default:!0},"MessageComposerInput.suggestEmoji":{supportedLevels:d,displayName:(0,i._td)("Enable Emoji suggestions while typing"),default:!1,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},useCompactLayout:{supportedLevels:d,displayName:(0,i._td)("Use compact timeline layout"),default:!1},showRedactions:{supportedLevels:u,displayName:(0,i._td)("Show a placeholder for removed messages"),default:!1,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:u,displayName:(0,i._td)("Show join/leave messages (invites/kicks/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:u,displayName:(0,i._td)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:u,displayName:(0,i._td)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:c,displayName:(0,i._td)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:d,displayName:(0,i._td)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:d,displayName:(0,i._td)("Always show message timestamps"),default:!1},autoplayGifsAndVideos:{supportedLevels:d,displayName:(0,i._td)("Autoplay GIFs and videos"),default:!1},alwaysShowEncryptionIcons:{supportedLevels:d,displayName:(0,i._td)("Always show encryption icons"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:d,displayName:(0,i._td)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:d,displayName:(0,i._td)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:d,default:!1},"MessageComposer.showFormatting":{supportedLevels:d,default:!1},sendTypingNotifications:{supportedLevels:d,displayName:(0,i._td)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:d,displayName:(0,i._td)("Automatically replace plain text Emoji"),default:!0},"TagPanel.enableTagPanel":{supportedLevels:d,displayName:(0,i._td)("Enable Community Filter Panel"),default:!0,invertedSettingName:"TagPanel.disableTagPanel"},theme:{supportedLevels:d,default:"light",controller:new s.default},custom_themes:{supportedLevels:d,default:[]},use_system_theme:{supportedLevels:h,default:!0,displayName:(0,i._td)("Match system theme")},webRtcAllowPeerToPeer:{supportedLevels:g,displayName:(0,i._td)("Allow Peer-to-Peer for 1:1 calls"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:h,default:null},webrtc_audioinput:{supportedLevels:h,default:null},webrtc_videoinput:{supportedLevels:h,default:null},language:{supportedLevels:g,default:"en"},breadcrumb_rooms:{supportedLevels:["account"],default:[]},integrationProvisioning:{supportedLevels:["account"],default:!0},allowedWidgets:{supportedLevels:["room-account"],default:{}},analyticsOptIn:{supportedLevels:g,displayName:(0,i._td)("Send analytics data"),default:!1},autocompleteDelay:{supportedLevels:g,default:200},readMarkerInViewThresholdMs:{supportedLevels:g,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:g,default:3e4},blacklistUnverifiedDevices:{supportedLevels:["room-device","device"],supportedLevelsAreOrdered:!0,displayName:{default:(0,i._td)("Never send encrypted messages to unverified devices from this device"),"room-device":(0,i._td)("Never send encrypted messages to unverified devices in this room from this device")},default:!1},urlPreviewsEnabled:{supportedLevels:u,displayName:{default:(0,i._td)("Enable inline URL previews by default"),"room-account":(0,i._td)("Enable URL previews for this room (only affects you)"),room:(0,i._td)("Enable URL previews by default for participants in this room")},default:!0},urlPreviewsEnabled_e2ee:{supportedLevels:["room-device","room-account"],displayName:{"room-account":(0,i._td)("Enable URL previews for this room (only affects you)")},default:!1},roomColor:{supportedLevels:u,displayName:(0,i._td)("Room Colour"),default:{primary_color:null,secondary_color:null}},notificationsEnabled:{supportedLevels:h,default:!1,controller:new r.NotificationsEnabledController},notificationSound:{supportedLevels:["room-account","account"],default:!1},notificationBodyEnabled:{supportedLevels:h,default:!0,controller:new r.NotificationBodyEnabledController},audioNotificationsEnabled:{supportedLevels:h,default:!0,controller:new r.AudioNotificationsEnabledController},enableWidgetScreenshots:{supportedLevels:d,displayName:(0,i._td)("Enable widget screenshots on supported widgets"),default:!1},"PinnedEvents.isOpen":{supportedLevels:["room-device"],default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:d,displayName:(0,i._td)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},showDeveloperTools:{supportedLevels:d,displayName:(0,i._td)("Show developer tools"),default:!1},widgetOpenIDPermissions:{supportedLevels:h,default:{allow:[],deny:[]}},"RoomList.orderByImportance":{supportedLevels:d,displayName:(0,i._td)("Order rooms in the room list by most important first instead of most recent"),default:!0},breadcrumbs:{supportedLevels:d,displayName:(0,i._td)("Show recently visited rooms above the room list"),default:!0},showHiddenEventsInTimeline:{displayName:(0,i._td)("Show hidden events in timeline"),supportedLevels:h,default:!1},fallbackICEServerAllowed:{supportedLevels:h,displayName:(0,i._td)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},sendReadReceipts:{supportedLevels:c,displayName:(0,i._td)("Send read receipts for messages (requires compatible homeserver to disable)"),default:!0},showImages:{supportedLevels:d,displayName:(0,i._td)("Show previews/thumbnails for images"),default:!0}}},lWzV:function(e,t,n){"use strict";(function(e){var i=n("Dlk0"),r=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixHttpApi=h,t.retryNetworkOperation=async function(e,t){let n=0,i=null;for(;n<e;)try{if(n>0){const e=1e3*Math.pow(2,n);c.logger.log(`network operation failed ${n} times, retrying in ${e}ms...`),await new Promise((t=>setTimeout(t,e)))}return await t()}catch(r){if(!(r instanceof f))throw r;n+=1,i=r}throw i},t.AbortError=t.ConnectionError=t.MatrixError=t.PREFIX_MEDIA_R0=t.PREFIX_IDENTITY_V2=t.PREFIX_IDENTITY_V1=t.PREFIX_UNSTABLE=t.PREFIX_R0=void 0;var o=r(n("M6nr")),s=n("MoSH"),a=i(n("dZ+v")),c=n("uZMU"),u=i(n("Bd+K"));function d(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?d(Object(n),!0).forEach((function(t){(0,o.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.PREFIX_R0="/_matrix/client/r0";t.PREFIX_UNSTABLE="/_matrix/client/unstable";t.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1";t.PREFIX_IDENTITY_V2="/_matrix/identity/v2";function h(e,t){a.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}t.PREFIX_MEDIA_R0="/_matrix/media/r0",h.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,n){a.isFunction(n)?n={callback:n}:void 0===n&&(n={});const i=!1!==n.includeFilename,r=n.type||t.type||"application/octet-stream",o=n.name||t.name;let s=t;s.stream&&"function"!==typeof s.stream&&(c.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),s=s.stream);let d=n.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(c.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let l=n.onlyContentUri;d||void 0!==l||(e.XMLHttpRequest?(c.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),l=!0):l=!1);const h={loaded:0,total:0};let p,f=null;if(d||(f=function(e){let t=JSON.parse(e);if(l&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=a.defer(),c=new e.XMLHttpRequest;h.xhr=c;const d=g(t,n.callback,this.opts.onlyData),l=function(){c.abort(),d(new Error("Timeout"))};c.timeout_timer=u.setTimeout(l,3e4),c.onreadystatechange=function(){let t;switch(c.readyState){case e.XMLHttpRequest.DONE:u.clearTimeout(c.timeout_timer);try{if(0===c.status)throw new y;if(!c.responseText)throw new Error("No response body.");t=c.responseText,f&&(t=f(t))}catch(n){return n.http_status=c.status,void d(n)}d(void 0,c,t)}},c.upload.addEventListener("progress",(function(e){u.clearTimeout(c.timeout_timer),h.loaded=e.loaded,h.total=e.total,c.timeout_timer=u.setTimeout(l,3e4),n.progressHandler&&n.progressHandler({loaded:e.loaded,total:e.total})}));let m=this.opts.baseUrl+"/_matrix/media/r0/upload";const v=[];i&&o&&v.push("filename="+encodeURIComponent(o)),this.useAuthorizationHeader||v.push("access_token="+encodeURIComponent(this.opts.accessToken)),v.length>0&&(m+="?"+v.join("&")),c.open("POST",m),this.useAuthorizationHeader&&c.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),c.setRequestHeader("Content-Type",r),c.send(s),p=t.promise,p.abort=c.abort.bind(c)}else{const e={};i&&o&&(e.filename=o),p=this.authedRequest(n.callback,"POST","/upload",e,s,{prefix:"/_matrix/media/r0",headers:{"Content-Type":r},json:!1,bodyParser:f})}const m=this,v=p.finally((function(){for(let e=0;e<m.uploads.length;++e)if(m.uploads[e]===h)return void m.uploads.splice(e,1)}));return v.abort=p.abort,h.promise=v,this.uploads.push(h),v},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,n,i,r,o){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");const s=this.opts.idBaseUrl+r+n;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:s,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=i:"object"===typeof i&&(c.json=i),o&&(c.headers.Authorization=`Bearer ${o}`);const u=a.defer();return this.opts.request(c,g(u,e,this.opts.onlyData)),u.promise},authedRequest:function(e,t,n,i,r,o){i||(i={}),this.useAuthorizationHeader?(isFinite(o)&&(o={localTimeoutMs:o}),o||(o={}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),i.access_token&&delete i.access_token):i.access_token||(i.access_token=this.opts.accessToken);const s=this.request(e,t,n,i,r,o),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,n,i,r,o){const s=void 0!==(o=o||{}).prefix?o.prefix:this.opts.prefix,a=this.opts.baseUrl+s+n;return this.requestOtherUrl(e,t,a,i,r,o)},requestOtherUrl:function(e,t,n,i,r,o){return void 0===o||null===o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,n,i,r,o)},getUrl:function(e,t,n){let i="";return t&&(i="?"+a.encodeParams(t)),this.opts.baseUrl+n+e+i},_request:function(e,t,n,i,r,o){if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);o=o||{};const s=this;this.opts.extraParams&&(i=l(l({},i),this.opts.extraParams));const c=a.extend({},o.headers||{}),d=void 0===o.json||o.json;let h=o.bodyParser;d&&(r&&(r=JSON.stringify(r),c["content-type"]="application/json"),c.accept||(c.accept="application/json"),void 0===h&&(h=function(e){return JSON.parse(e)}));const f=a.defer();let y,m,v=!1;const _=o.localTimeoutMs||this.opts.localTimeoutMs,S=()=>{_&&(y&&u.clearTimeout(y),y=u.setTimeout((function(){v=!0,m&&m.abort&&m.abort(),f.reject(new p({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:_}))}),_))};S();const b=f.promise;try{m=this.opts.request({uri:n,method:t,withCredentials:!1,qs:i,qsStringifyOptions:o.qsStringifyOptions,useQuerystring:!0,body:r,json:!1,timeout:_,headers:c||{},_matrix_opts:this.opts},(function(t,n,i){if(_&&(u.clearTimeout(y),v))return;g(f,e,s.opts.onlyData,h)(t,n,i)})),m&&("onprogress"in m&&(m.onprogress=e=>{S()}),m.abort&&(b.abort=m.abort.bind(m)))}catch(A){f.reject(A),e&&e(A)}return b}};const g=function(e,t,n,i){return t=t||function(){},function(r,o,a){if(r){"AbortError"===r.name||"aborted"===r||r instanceof p||(r=new f("request failed",r))}if(!r)try{o.statusCode>=400?r=function(e,t){const n=e.statusCode,i=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return(0,s.parse)(t)}catch(n){throw new Error(`Error parsing Content-Type '${t}': ${n}`)}}(e);let r;if(i)if("application/json"===i.type){const e="object"===typeof t?t:JSON.parse(t);r=new p(e)}else"text/plain"===i.type&&(r=new Error(`Server returned ${n} error: ${t}`));r||(r=new Error(`Server returned ${n} error`));return r.httpStatus=n,r}(o,a):i&&(a=i(a))}catch(c){r=new Error(`Error parsing server response: ${c}`)}if(r)e.reject(r),t(r);else{const i={code:o.statusCode,headers:o.headers,data:a};e.resolve(n?a:i),t(null,n?a:i)}}};class p extends Error{constructor(e){super(`MatrixError: ${(e=e||{}).errcode}`),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}t.MatrixError=p;class f extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:"")),this._cause=t}get name(){return"ConnectionError"}get cause(){return this._cause}}t.ConnectionError=f;class y extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}t.AbortError=y}).call(this,n("bqPV"))},lkaF:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAMCAYAAABfnvydAAAAAXNSR0IArs4c6QAAAMlJREFUGBljYIACbW1tNhgbmWYCcpiMjY0XsrOzX9DR0RFHlgSxGQ0NDZ2ZmJj2gDj///+//uvXL8crV668BPFBgPnFixf3JSUlGYHAAYhFmZmZvYWFhde8evXqK1gBiHj+/PkBXIqYQQpAAJcikCPhAGj/dCDnDUgAaJ0mKyurG1wByAdsbGz7gXIiIAVABzeeP39+MSOIA5ME6YJJnjt3rgHEBnlTFChxEJskSAET0ChpoKQ8iAMyFqYTxIcDoCn2wNDMhwsgMQCmtk9b8gdyZQAAAABJRU5ErkJggg=="},lyVl:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomRequests=t.InRoomChannel=void 0;var i=n("LTeG"),r=n("uZMU");const o="m.room.message",s="m.reference",a="m.relates_to";class c{constructor(e,t,n=null){this._client=e,this._roomId=t,this.userId=n,this._requestEventId=null}get receiveStartFromOtherDevices(){return!0}get roomId(){return this._roomId}get transactionId(){return this._requestEventId}static getOtherPartyUserId(e,t){if(c.getEventType(e)!==i.REQUEST_TYPE)return;const n=t.getUserId(),r=e.getSender(),o=e.getContent().to;return r===n?o:o===n?r:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===i.REQUEST_TYPE}static getTransactionId(e){if(c.getEventType(e)===i.REQUEST_TYPE)return e.getId();{const t=e.getRelation();if(t&&t.rel_type===s)return t.event_id}}static validateEvent(e,t){const n=c.getTransactionId(e);if("string"!==typeof n||0===n.length)return!1;const o=c.getEventType(e),s=e.getContent();if(o===i.REQUEST_TYPE){if(!s||"string"!==typeof s.to||!s.to.length)return r.logger.log("InRoomChannel: validateEvent: no valid to "+(s&&s.to)),!1;if(!c.getOtherPartyUserId(e,t))return r.logger.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${s&&s.to}`),!1}return i.VerificationRequest.validateEvent(o,e,t)}static getEventType(e){const t=e.getType();if(t===o){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===i.REQUEST_TYPE)return i.REQUEST_TYPE}}return t&&t!==i.REQUEST_TYPE?t:""}async handleEvent(e,t,n){if(t.hasEventId(e.getId()))return;const i=c.getEventType(e);if(e.getRoomId()!==this._roomId)return;if(null===this.userId){const t=c.getOtherPartyUserId(e,this._client);t&&(this.userId=t)}const o=this._client.getUserId(),s=e.getSender();if(null!==this.userId&&s!==o&&s!==this.userId)return void r.logger.log(`InRoomChannel: ignoring verification event from non-participating sender ${s}`);null===this._requestEventId&&(this._requestEventId=c.getTransactionId(e));const a=!!e.getUnsigned().transaction_id,u=e.getSender()===this._client.getUserId();return await t.handleEvent(i,e,n,a,u)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[a]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==i.REQUEST_TYPE&&e!==i.READY_TYPE&&e!==i.START_TYPE||(t.from_device=this._client.getDeviceId()),e===i.REQUEST_TYPE?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:i.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t[a]={rel_type:s,event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===i.REQUEST_TYPE&&(n=o);const r=await this._client.sendEvent(this._roomId,n,t);e===i.REQUEST_TYPE&&(this._requestEventId=r.event_id)}}t.InRoomChannel=c;t.InRoomRequests=class{constructor(){this._requestsByRoomId=new Map}getRequest(e){const t=e.getRoomId(),n=c.getTransactionId(e);return this._getRequestByTxnId(t,n)}getRequestByChannel(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}_getRequestByTxnId(e,t){const n=this._requestsByRoomId.get(e);if(n)return n.get(t)}setRequest(e,t){this._setRequest(e.getRoomId(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this._setRequest(e.roomId,e.transactionId,t)}_setRequest(e,t,n){let i=this._requestsByRoomId.get(e);i||(i=new Map,this._requestsByRoomId.set(e,i)),i.set(t,n)}removeRequest(e){const t=e.getRoomId(),n=this._requestsByRoomId.get(t);n&&(n.delete(c.getTransactionId(e)),0===n.size&&this._requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this._requestsByRoomId.get(e);if(t)for(const n of t.values())if(n.pending)return n}}},mReo:function(e,t,n){"use strict";var i=n("OQL8");function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}t.__esModule=!0,t.noSSR=c,t.default=function(e,t){var n=s.default,i={loading:function(e){e.error,e.isLoading;return e.pastDelay,null}};e instanceof Promise?i.loader=function(){return e}:"function"===typeof e?i.loader=e:"object"===typeof e&&(i=o(o({},i),e));if(i=o(o({},i),t),"object"===typeof e&&!(e instanceof Promise)&&(e.render&&(i.render=function(t,n){return e.render(n,t)}),e.modules)){n=s.default.Map;var r={},a=e.modules();Object.keys(a).forEach((function(e){var t=a[e];"function"!==typeof t.then?r[e]=t:r[e]=function(){return t.then((function(e){return e.default||e}))}})),i.loader=r}i.loadableGenerated&&delete(i=o(o({},i),i.loadableGenerated)).loadableGenerated;if("boolean"===typeof i.ssr){if(!i.ssr)return delete i.ssr,c(n,i);delete i.ssr}return n(i)};a(n("mXGw"));var s=a(n("K2c3"));function a(e){return e&&e.__esModule?e:{default:e}}function c(e,t){return delete t.webpack,delete t.modules,e(t)}},mrGT:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAaRJREFUeNpi/P//PwMtAeOoBSPMgk+//u16+uvBl79f/xDWyc3CoMDD7CbNxsfGRJQFQNNn3fxuIMSiJcDCzcpI0IKvv/9f+/Dnwrs/aeqceOxAWLDm/g8BNkZTUVaSQuD0698ffv0PUeTApQBhMzBkgG4nNYiBWoAa8ShAmAgMd2JCBj0mWBmRI+zDz3/7n/+6+uFvuCK7Kj8Lig8oB8++/Z147TsbM6OLFOuyez+//fmP4gMKwYPPfxfe+RGhyC7BBXL0oRe/0eOAEgBMUWsf/PSVZYOYDgT/MSOZEnDx3W8FHiZlPmZ8qYgS8PjrP1keJgLJlBLw699/dmZGGlogzM70+vs/GlqgJ8QCLDN+/P1PKwtkuJktRFmX3v355x/UDkbqWgAENhJsKrxMK+//fPn93+9//4GegRSALFTMyX7yHOfe/N748Oe3vwzmoiwsTIwoFgDLd2B+IbU4AmlBcqSRCKu+MMsPpGINEUTA2gNYvpPqaqAWoEZkEWZGRmRXIiwA1k3AlAAs34GOItLtQMVALUCNg6PKHG22jFpALgAIMABSi9bViajVBgAAAABJRU5ErkJggg=="},"n/Lb":function(e,t,n){"use strict";(function(e,i){var r=n("cFGl"),o=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.encryptMessageForDevice=async function(e,t,n,i,r,o,c){const u=o.getIdentityKey(),d=await i.getSessionIdForDevice(u);if(null===d)return;s.logger.log("Using sessionid "+d+" for device "+r+":"+o.deviceId);const l={sender:t,sender_device:n,keys:{ed25519:i.deviceEd25519Key},recipient:r,recipient_keys:{ed25519:o.getFingerprint()}};a.extend(l,c),e[u]=await i.encryptMessage(u,d,JSON.stringify(l))},t.getExistingOlmSessions=async function(e,t,n){const i={},r={},o=[];for(const[s,a]of Object.entries(n))for(const t of a){const n=t.deviceId,a=t.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(a,!0);null===o?(i[s]=i[s]||[],i[s].push(t)):(r[s]=r[s]||{},r[s][n]={device:t,sessionId:o})})())}return await Promise.all(o),[i,r]},t.ensureOlmSessionsForDevices=async function(e,t,n,i,r,o,a){"number"===typeof i&&(a=o,o=r,r=i,i=!1);a||(a=s.logger);const c=[],d={},l={};for(const[,s]of Object.entries(n))for(const t of s){const n=t.getIdentityKey();n!==e.deviceCurve25519Key&&(e._sessionsInProgress[n]||(e._sessionsInProgress[n]=new Promise((t=>{l[n]=(...i)=>{delete e._sessionsInProgress[n],t(...i)}}))))}for(const[s,u]of Object.entries(n)){d[s]={};for(const t of u){const n=t.deviceId,r=t.getIdentityKey();if(r===e.deviceCurve25519Key){a.info("Attempted to start session with ourself! Ignoring"),d[s][n]={device:t,sessionId:null};continue}const o=`for ${r} (${s}:${n})`,u=await e.getSessionIdForDevice(r,l[r],a);null!==u&&l[r]&&l[r](),(null===u||i)&&(i?a.info(`Forcing new Olm session ${o}`):a.info(`Making new Olm session ${o}`),c.push([s,n])),d[s][n]={device:t,sessionId:u}}}if(0===c.length)return d;const h="signed_curve25519";let g,p=`one-time keys for ${c.length} devices`;try{a.debug(`Claiming ${p}`),g=await t.claimOneTimeKeys(c,h,r),a.debug(`Claimed ${p}`)}catch(m){for(const e of Object.values(l))e();throw a.log(`Failed to claim ${p}`,m,c),m}o&&"failures"in g&&o.push(...Object.keys(g.failures));const f=g.one_time_keys||{},y=[];for(const[s,v]of Object.entries(n)){const t=f[s]||{};for(let n=0;n<v.length;n++){const r=v[n],o=r.deviceId,c=r.getIdentityKey();if(c===e.deviceCurve25519Key)continue;if(d[s][o].sessionId&&!i)continue;const h=t[o]||{};let g=null;for(const e in h)0===e.indexOf("signed_curve25519:")&&(g=h[e]);g?y.push(u(e,g,s,r).then((e=>{l[c]&&l[c](e),d[s][o].sessionId=e}),(e=>{throw l[c]&&l[c](),e}))):(a.warn(`No one-time keys (alg=signed_curve25519) for device ${s}:${o}`),l[c]&&l[c]())}}return p=`Olm sessions for ${y.length} devices`,a.debug(`Starting ${p}`),await Promise.all(y),a.debug(`Started ${p}`),d},t.verifySignature=d,t.pkSign=function(t,n,i,r){let o=!1;if(n instanceof Uint8Array){const t=new e.Olm.PkSigning;r=t.init_with_seed(n),n=t,o=!0}const s=t.signatures||{};delete t.signatures;const a=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=s[i]||{};return s[i]=e,e["ed25519:"+r]=n.sign(c.default.stringify(t))}finally{t.signatures=s,a&&(t.unsigned=a),o&&n.free()}},t.pkVerify=function(t,n,i){const r="ed25519:"+n;if(!(t.signatures&&t.signatures[i]&&t.signatures[i][r]))throw new Error("No signature");const o=t.signatures[i][r],s=new e.Olm.Utility,a=t.signatures;delete t.signatures;const u=t.unsigned;t.unsigned&&delete t.unsigned;try{s.ed25519_verify(n,c.default.stringify(t),o)}finally{t.signatures=a,u&&(t.unsigned=u),s.free()}},t.encodeBase64=l,t.encodeUnpaddedBase64=function(e){return l(e).replace(/=+$/g,"")},t.decodeBase64=function(e){return i.from(e,"base64")},t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=t.OLM_ALGORITHM=void 0;var s=n("uZMU"),a=o(n("dZ+v")),c=r(n("SBNP"));t.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2";t.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2";async function u(e,t,n,i){const r=i.deviceId;try{await d(e,t,n,r,i.getFingerprint())}catch(a){return s.logger.error("Unable to verify signature on one-time key for device "+n+":"+r+":",a),null}let o;try{o=await e.createOutboundSession(i.getIdentityKey(),t.key)}catch(a){return s.logger.error("Error starting olm session with device "+n+":"+r+": "+a),null}return s.logger.log("Started new olm sessionid "+o+" for device "+n+":"+r),o}async function d(e,t,n,i,r){const o="ed25519:"+i,s=((t.signatures||{})[n]||{})[o];if(!s)throw Error("No signature");const a=Object.assign({},t);delete a.unsigned,delete a.signatures;const u=c.default.stringify(a);e.verifySignature(r,u,s)}function l(e){return i.from(e).toString("base64")}t.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2"}).call(this,n("bqPV"),n("qykS").Buffer)},nCQY:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAA5CAYAAACvQ9JQAAAAAXNSR0IArs4c6QAABj9JREFUaAXtmn9sE1UcwN97d93WddANRIaQjF8DoxDY1sj+YJCBiglqMHNDxxg/TAYkDthcixL/OGMiwjpBIBJQQBgdWDSCBCNTQoBFIelaDBHNGCCBiGPiVuhGt/bu+X1dS5py7XVtD/6wL7nc+/H98blv371fPYwgvXvWkiVm4BKM0CSEsZ7VJSpRiVJewns3GN48H69NPACK1iMJnySU/2WjocwZr9GA/nvn9w33pmhMrCyJ6FiDobwl0BbLnbCIMtD6gvIfEgn6AIZKEiXeBp5H8002S/GD+hgyhEpoko70nYtBN2oV87TK26TPY8Ycet7kaHohasUQQUI4rBfylnWH1Ce8uGHGkjvYhcyI0qJ1tsb5sTggsSgNRkfHa3WU0kym83HRoq77/dRMOd4AEV4wGDtMVnVYHhMO/KwD4FHM4bbCiruubq6BYjzF6LCUsrpok+qwfpBhcDcBcC4rf1Zc5tJ5735CMJ6wznGw3C+jeHtUsAwkHa61AJzPCoJhRa+2q28LRXQ0dIklUAXDfOT0KGEZCQ9XFQDPYQWheJk7PYX/FCaOYSb7weUCFSLyRGxkBlVILIILAbgELiw8W9bvpK7tEOH0XsfkqlKrlfVx2fQ4YAMgL0JmOQDzuwwrPDpn2w4Ks9O4SdIq4ZTAfoGHkqqwbtEDc07E9By0rgZgrVAseP9s1+yiVHL3DM2tFn4TUkI1VYXd3Hyzu0/yEg8sDCKkydBmBODMw2VlYv3Rtj0woMJ4nLt66am9acF6qsIiQZCyeG3PlZ7bwT7l8qOhko3FTzGd+rxF+yhCt0bqU9fW3LBqAwrqwoKX6Vk5F47dsCGF6DIeNhazCLOxmG7KW2QRKbqq+cdbW/frfh0TUB127qgpR8YPHdm/s/0kut2nuPoMjMUFDM5cUG4lEr7Eifw7dSf262TfOiaYqIQxdkG0dtv+vbpyR9tJrNdoUXZ6JtKEjxMPL2XV9svNV2/c67wlIYnCdEE0I1NGqw7LHhqALwDwRsOw8UtvuZ3ZHfe7kIdGfOnQWPTE+Jy0Ee6Wjt9bYSqZyOw8Elg/8DUAFkal6Z+EKwfqfP2QtYVN0ItfHjP9sqm1qZAAaUJhjfam2TA9vS1RqdlcUPF5KAREGF5y1OG/QpvDlo02i68tYS/YwHKP/gj963VCyC5jq2ULeFBcnIQllGlICGyd3fIWUB2CyGkCPjDBa0wOy+5Sa2nYuT4gG+09btg6e1MtrEu/gCDK2MLLxk5c8FWp9eGpM1rAYDkZB8HNkfNGu+VDglHDAylKe4PybpaHaJeMm5j7XZVtJxtD40qxwmJ4mbYCyPsD3mG/LaGVMCC2BmhgrHwFJqIuXxnjeZlcxgkAjusAZdCwrA9CRL/EGFUzEBiOPLBSqoDZZmcAlN17nd3nPCKdTSn6e6Aez8zkhpyqtu8ZESw3mPygYKu/35o6NnfB1xDRSp8TSt0Q09fq8xcflHO62VBx0UvFInig6/72vDSUeqb63IExcvJKdVHDsrlZmz38OEbYt4WGlf09+NlfMhsWH4/kZHPB4nZ3P50JwH8wOXjQp9NScEtNa6NvVoqkG9oWFewqOLgjI7ifwNNcnwFK72AqzqnPLz8dalCuDNvvm27UNwvaHKwdgHN4zJ2tsR2YKicfrk4Rlr0UQ3ToNHgoZEagD/4lIjprU36lLZxRufpt+cs7u8V7xWChhbVDn8/WcPh0rb1xmpy8XJ0irJ7oSsCyLwIAeoV6vDMb8isuyRlTqoO9lrNbdM2DJz4xIIuzOERqlfQC7Yqw7n7UDMbPwKT+LSygi8wzKq8FlGO5A3DvtfbLr4LNrXBdBLuN0dpRXMiw/gbGZkdrMBq5w2VCP8itiUY2WEYxssHCjzufhFXrF0hGNhlZiECyGyS7QbIbqNUH/t+RxXTgmBC2O52dnWyxktCkuOoajDfYPXxA4Q9aWPYd8a+sBqOuKJtQWP/uAbbg6qTkpKBOXJPTrVpxhchKInUKjr2+7wHUcxOnZYL02C05CRxUtvWQVN+ZQJwmVVE32g5NgKOAlI8Kyzt4zkW/ETPQemNrE0r010fx0Nf8bNWmZnie8XqkhZwo+bbrcGCt7nddMQNLkhvO1a5LGnK0fuobV5id/wAB6klEbVS/ggAAAABJRU5ErkJggg=="},nE5R:function(e,t,n){"use strict";var i,r=n("IAeZ"),o=n("BGZc"),s=(i=o)&&i.__esModule?i:{default:i};e.exports={avatarUrlForMember:function(e,t,n,i){var r=e.getAvatarUrl(s.default.get().getHomeserverUrl(),Math.floor(t*window.devicePixelRatio),Math.floor(n*window.devicePixelRatio),i,!1,!1);return r||(r=this.defaultAvatarUrlForString(e?e.userId:"")),r},avatarUrlForUser:function(e,t,n,i){var o=(0,r.getHttpUriForMxc)(s.default.get().getHomeserverUrl(),e.avatarUrl,Math.floor(t*window.devicePixelRatio),Math.floor(n*window.devicePixelRatio),i);return o&&0!==o.length?o:null},defaultAvatarUrlForString:function(e){for(var t=["03b381","368bd6","ac3ba8"],i=0,r=0;r<e.length;++r)i+=e.charCodeAt(r);return n("y7ae")("./"+t[i%t.length]+".png")},getInitialLetter:function(e){if(e){if(!(e.length<1)){var t=0,n=e[0];"@"!==n&&"#"!==n&&"+"!==n||!e[1]||t++;var i=1,r=e.charCodeAt(t);if(r>=55296&&r<=56319&&e[t+1]){var o=e.charCodeAt(t+1);o>=56320&&o<=57343&&i++}return e.substring(t,t+i).toUpperCase()}}else console.trace("`name` argument to `getInitialLetter` not supplied")},getInitialLetters:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e.split(" ").reduce((function(e,t){return e+(t[0]||"")}),"").substring(0,t).toUpperCase()},avatarUrlForRoom:function(e,t,n,i){var r=e.getAvatarUrl(s.default.get().getHomeserverUrl(),t,n,i,!1);if(r)return r;var o=e.getAvatarFallbackMember();return o?o.getAvatarUrl(s.default.get().getHomeserverUrl(),t,n,i,!1):null},avatarBackgroundColorForString:function(e){e||(e="");for(var t=0,n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);for(var i="#",r=0;r<3;r++){i+=("00"+(t>>8*r&255).toString(16)).substr(-2)}return i}}},nPNV:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=g(n("t3kO")),r=g(n("OBCi")),o=g(n("PSh9")),s=g(n("tZmG")),a=g(n("wv3L"));t.newTranslatableError=function(e){var t=new Error(e);return t.translatedMessage=f(e),t},t._td=function(e){return e},t._t=f,t.substitute=y,t.replaceByRegexes=m,t.setMissingEntryGenerator=function(e){u.default.setMissingEntryGenerator(e)},t.setLanguage=function(e){Array.isArray(e)||(e=[e]);var t=void 0,n=void 0;return S().then((function(i){n=i;for(var r=0;r<e.length;++r)if(n.hasOwnProperty(e[r])){t=e[r];break}return t||(t="en",console.error("Unable to find an appropriate language")),b(p+n[t].fileName)})).then((function(e){if(u.default.registerTranslations(t,e),u.default.setLocale(t),h.default.setValue("language",null,l.SettingLevel.DEVICE,t),console.log("set language to "+t),"en"!==t)return b(p+n.en.fileName)})).then((function(e){e&&u.default.registerTranslations("en",e)}))},t.getAllLanguagesFromJson=function(){return S().then((function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({value:n,label:e[n].label});return t}))},t.getLanguagesFromBrowser=function(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]},t.getNormalizedLanguageKeys=function(e){var t=[],n=v(e),i=n.split("-");2===i.length&&i[0]===i[1]?t.push(i[0]):(t.push(n),2===i.length&&t.push(i[0]));return t},t.normalizeLanguageKey=v,t.getCurrentLanguage=_,t.pickBestLanguage=function(e){var t=_(),n=e.map(v),i=n.indexOf(t);if(i>-1)return e[i];var r=n.find((function(e){return e.substr(0,2)===t.substr(0,2)}));if(r>-1)return e[r];var o=n.find((function(e){return e.startsWith("en")}));return o>-1?e[o]:e[0]};var c=g(n("dJP9")),u=g(n("OXF8")),d=g(n("mXGw")),l=n("oOXF"),h=g(l);function g(e){return e&&e.__esModule?e:{default:e}}var p="i18n/";function f(e,t,n){var i=y(function(e,t){var n=void 0;t&&"object"===("undefined"===typeof t?"undefined":(0,a.default)(t))&&(n=t.count,(0,s.default)(t).forEach((function(e){void 0===t[e]&&(console.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),t[e]="undefined"),null===t[e]&&(console.warn("safeCounterpartTranslate called with null interpolation name: "+e),t[e]="null")})));var i=u.default.translate(e,t);return void 0===i&&void 0!==n&&(i=u.default.translate(e,(0,o.default)({},t,{locale:"en"}))),i}(e,(0,o.default)({interpolate:!1},t)),t,n);return i}function y(e,t,n){var i=e;if(void 0!==t){var r={};for(var o in t)r["%\\("+o+"\\)s"]=t[o];i=m(i,r)}if(void 0!==n){var s={};for(var a in n)s["(<"+a+">(.*?)<\\/"+a+">|<"+a+">|<"+a+"\\s*\\/>)"]=n[a];i=m(i,s)}return i}function m(e,t){var n=[e],i=!1;for(var r in t){var o=new RegExp(r,"g"),s=!1;for(var c in n){var u=n[c];if("string"===typeof u){var l=o.exec(u);if(l){s=!0;for(var h=u.substr(0,l.index),g=[],p=void 0;l;){p=l;var f=l.slice(2),y=void 0;"object"===("undefined"===typeof(y=t[r]instanceof Function?t[r].apply(null,f):t[r])?"undefined":(0,a.default)(y))&&(i=!0),"string"===typeof y&&""===y||g.push(y);var m=void 0;if(l=o.exec(u)){var v=p.index+p[0].length;m=u.substr(v,l.index-v)}else m=u.substr(p.index+p[0].length);m&&g.push(m)}n.splice.apply(n,[c,1].concat(g)),""!==h&&n.splice(c,0,h)}}}s||"%\\(count\\)s"!==r&&console.log("Could not find "+o+" in "+e)}return i?d.default.createElement.apply(d.default,["span",null].concat(n)):n.join("")}function v(e){return e.toLowerCase().replace("_","-")}function _(){return u.default.getLocale()}function S(){return new r.default((function(e,t){var i=void 0;try{i=n("/V6Y")}catch(r){i="i18n/languages.json"}(0,c.default)({method:"GET",url:i},(function(n,i,r){n||i.status<200||i.status>=300?t({err:n,response:i}):e(JSON.parse(r))}))}))}function b(e){return new r.default((function(t,n){(0,c.default)({method:"GET",url:e},(function(e,r,o){e||r.status<200||r.status>=300?n({err:e,response:r}):t(function(t){var n={},r=!0,o=!1,a=void 0;try{for(var c,u=(0,i.default)((0,s.default)(t));!(r=(c=u.next()).done);r=!0){var d=c.value,l=d.split("|",2);if(2===l.length){var h=n[l[0]];void 0===h&&(h={},n[l[0]]=h),h[l[1]]=t[d]}else n[d]=t[d]}}catch(e){o=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw a}}return n}(JSON.parse(o)))}))}))}u.default.setSeparator("|"),u.default.setFallbackLocale("en")},"nk7+":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newVerificationError=r,t.errorFactory=o,t.errorFromEvent=function(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}},t.newInvalidMessageError=t.newUserMismatchError=t.newKeyMismatchError=t.newUnexpectedMessageError=t.newUnknownMethodError=t.newUnknownTransactionError=t.newTimeoutError=t.newUserCancelledError=void 0;var i=n("MwLI");function r(e,t,n){const r=Object.assign({},{code:e,reason:t},n);return new i.MatrixEvent({type:"m.key.verification.cancel",content:r})}function o(e,t){return function(n){return r(e,t,n)}}const s=o("m.user","Cancelled by user");t.newUserCancelledError=s;const a=o("m.timeout","Timed out");t.newTimeoutError=a;const c=o("m.unknown_transaction","Unknown transaction");t.newUnknownTransactionError=c;const u=o("m.unknown_method","Unknown method");t.newUnknownMethodError=u;const d=o("m.unexpected_message","Unexpected message");t.newUnexpectedMessageError=d;const l=o("m.key_mismatch","Key mismatch");t.newKeyMismatchError=l;const h=o("m.user_error","User mismatch");t.newUserMismatchError=h;const g=o("m.invalid_message","Invalid message");t.newInvalidMessageError=g},nlfO:function(e,t,n){"use strict";(function(e,i){Object.defineProperty(t,"__esModule",{value:!0}),t.QRCodeData=t.ReciprocateQRCode=t.SCAN_QR_CODE_METHOD=t.SHOW_QR_CODE_METHOD=void 0;var r=n("LLMt"),o=n("nk7+"),s=n("n/Lb"),a=n("uZMU");t.SHOW_QR_CODE_METHOD="m.qr_code.show.v1";t.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";class c extends r.VerificationBase{static factory(...e){return new c(...e)}static get NAME(){return"m.reciprocate.v1"}async _doVerification(){if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw(0,o.newKeyMismatchError)();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t((0,o.newUserCancelledError)())},this.emit("show_reciprocate_qr",this.reciprocateQREvent)}));const t={};switch(e.mode){case u:{const n=e.otherUserMasterKey;t[`ed25519:${n}`]=n;break}case d:{const n=this.request.targetDevice.deviceId;t[`ed25519:${n}`]=e.otherDeviceKey;break}case l:{const n=e.myMasterKey;t[`ed25519:${n}`]=n;break}}await this._verifyKeys(this.userId,t,((e,n,i)=>{const r=t[e];if(!r)throw(0,o.newKeyMismatchError)();if(i!==r)throw a.logger.error("key ID from key info does not match"),(0,o.newKeyMismatchError)();for(const s in n.keys){if(!s.startsWith("ed25519"))continue;const e=t[s];if(!e)throw(0,o.newKeyMismatchError)();if(n.keys[s]!==e)throw a.logger.error("master key does not match"),(0,o.newKeyMismatchError)()}}))}}t.ReciprocateQRCode=c;const u=0,d=1,l=2;class h{constructor(e,t,n,i,r,o){this._sharedSecret=t,this._mode=e,this._otherUserMasterKey=n,this._otherDeviceKey=i,this._myMasterKey=r,this._buffer=o}static async create(e,t){const n=h._generateSharedSecret(),i=h._determineMode(e,t);let r=null,o=null,s=null;if(i===u){r=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(i===d)o=await h._getOtherDeviceKey(e,t);else if(i===l){const e=t.getUserId();s=t.getStoredCrossSigningForUser(e).getId("master")}const a=h._generateQrData(e,t,i,n,r,o,s),c=h._generateBuffer(a);return new h(i,n,r,o,s,c)}get buffer(){return this._buffer}get mode(){return this._mode}get otherDeviceKey(){return this._otherDeviceKey}get otherUserMasterKey(){return this._otherUserMasterKey}get myMasterKey(){return this._myMasterKey}get encodedSharedSecret(){return this._sharedSecret}static _generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),(0,s.encodeUnpaddedBase64)(t)}static async _getOtherDeviceKey(e,t){const n=t.getUserId(),i=e.targetDevice,r=i?i.deviceId:null,o=t.getStoredDevice(n,r);if(!o)throw new Error("could not find device "+r);return o.getFingerprint()}static _determineMode(e,t){const n=t.getUserId(),i=e.otherUserId;let r=u;if(n===i){r=t.checkUserTrust(n).isCrossSigningVerified()?d:l}return r}static _generateQrData(e,t,n,i,r,o,s){const a=t.getUserId(),c={prefix:"MATRIX",version:2,mode:n,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:i},h=t.getStoredCrossSigningForUser(a);return n===u?(c.firstKeyB64=h.getId("master"),c.secondKeyB64=r):n===d?(c.firstKeyB64=h.getId("master"),c.secondKeyB64=o):n===l&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=s),c}static _generateBuffer(e){let t=i.alloc(0);const n=e=>{const n=i.from([e]);t=i.concat([t,n])},r=(e,n,r=!0)=>{const o=i.from(e,n);r&&(e=>{const n=i.alloc(2);n.writeInt16BE(e,0),t=i.concat([t,n])})(o.byteLength),t=i.concat([t,o])},o=e=>{const n=(0,s.decodeBase64)(e),r=i.from(n);t=i.concat([t,r])};return r(e.prefix,"ascii",!1),n(e.version),n(e.mode),r(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}t.QRCodeData=h}).call(this,n("bqPV"),n("qykS").Buffer)},ns36:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomString=function(e){return o(e,r+i+"0123456789")},t.randomLowercaseString=function(e){return o(e,i)},t.randomUppercaseString=function(e){return o(e,r)};const i="abcdefghijklmnopqrstuvwxyz",r="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function o(e,t){let n="";for(let i=0;i<e;++i)n+=t.charAt(Math.floor(Math.random()*t.length));return n}},o0Xp:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAmdJREFUeNrsVs1rE1EQfzO7b3dj2tR+bBPEBGM9COLBSwt+IIK3Ch5E/Tf8Y7yIdz148OC1CoJKUasI2kawrRUJTZNowqZJdt/HOlprUbNb200RxDm+N29+b37zezMPwjBke2nwH6AvAOQzWxVvm2pdhABs2MJJ15zImP0BaAl9Z9nPpfDEqJkygVZqXf1kTYzYOJ23+wBwa7F7dMiYyBi/rM+Ug3yaUrHij2P8dqkhbWS/Ryc7l+Oza9JXYSKA9y11fLg31wbCkYxRbutEAKsdvd+GqN0RG8ghEUCgGEJ0ARkTOhlFyW3PASIfy4Ny8OqTjNeI0GyuJsntQt4uDho7y+D1Z3ntWApYiCwShOALA3jpkP28JnacgQEMAAY4hiyyyimTjTG0EWIS/dtFJo3G6FDprw50/RgpRwKYCIEKC2lc9FSUzztPUW0rHT3u4I4B6OR8Q57K8hf13g3n47oyAA6mjTcNeThCQnEAp7P8UUVYCCfH+b0PgSd+wlhpqYerYjpvLXvqm5aM3bTruZpYaKgrRZvCUXMe5DBkodRhtaszFg0Di+bP3RX/ctEZi6Zom3nwsi6eVSUpfdRBitvwNUdwHUxzoE5OqFeLjpvCRANnyVP3y8E+E4joKdckrp5WJVXedeD8AYty6s/Qr3c1sXGxYJeasqPYmSzfGJ99a3ZEUcb6HpHm8x9Gj2sVm+1sK8MfL47qHGwK10BqKrAbAAp8e8knxg3YetV0cRLM44qgx7Gx2FHhlMsnXR735+lpTV/dLLXD7cwL1I2FOLfIDEjpdNnr822MZZuoOpuz/um/6RcBBgCSxncz1hpYFgAAAABJRU5ErkJggg=="},o3A1:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=g(n("tZmG")),r=g(n("t3kO")),o=g(n("YUSd")),s=g(n("Zv/C")),a=g(n("2lBV")),c=g(n("Dkg+")),u=g(n("Gjrs")),d=g(n("BGZc")),l=g(n("pZ3Y")),h=n("oOXF");function g(e){return e&&e.__esModule?e:{default:e}}var p="im.vector.riot.breadcrumb_rooms",f="im.vector.setting.breadcrumbs",y=[p,f],m="im.vector.setting.integration_provisioning",v=function(e){function t(e){(0,s.default)(this,t);var n=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return n._watchers=e,n._onAccountData=n._onAccountData.bind(n),n}return(0,u.default)(t,e),(0,a.default)(t,[{key:"initMatrixClient",value:function(e,t){e&&e.removeListener("accountData",this._onAccountData),t.on("accountData",this._onAccountData)}},{key:"_onAccountData",value:function(e){if("org.matrix.preview_urls"===e.getType()){var t=e.getContent().disable;t="boolean"!==typeof t?null:!t,this._watchers.notifyUpdate("urlPreviewsEnabled",null,h.SettingLevel.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){var n=!0,o=!1,s=void 0;try{for(var a,c=(0,r.default)((0,i.default)(e.getContent()));!(n=(a=c.next()).done);n=!0){var u=a.value,d=e.getContent()[u];this._watchers.notifyUpdate(u,null,h.SettingLevel.ACCOUNT,d)}}catch(g){o=!0,s=g}finally{try{!n&&c.return&&c.return()}finally{if(o)throw s}}}else if(y.includes(e.getType()))this._notifyBreadcrumbsUpdate(e);else if(e.getType()===m){var l=e.getContent().enabled;this._watchers.notifyUpdate("integrationProvisioning",null,h.SettingLevel.ACCOUNT,l)}}},{key:"getValue",value:function(e,t){if("urlPreviewsEnabled"===e){var n=this._getSettings("org.matrix.preview_urls")||{};return"boolean"!==typeof n.disable?null:!n.disable}if("breadcrumb_rooms"===e){var i=this._getSettings(f);return i&&i.recent_rooms||(i=this._getSettings(p))&&(i.recent_rooms=i.rooms),i&&i.recent_rooms?i.recent_rooms:[]}if("integrationProvisioning"===e){var r=this._getSettings(m);return r?r.enabled:null}var o=this._getSettings()||{},s=o[e];return null!==s&&void 0!==s||"hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(s=o.hideAvatarDisplaynameChanges),s}},{key:"setValue",value:function(e,t,n){if("urlPreviewsEnabled"===e){var i=this._getSettings("org.matrix.preview_urls")||{};return i.disable=!n,d.default.get().setAccountData("org.matrix.preview_urls",i)}if("breadcrumb_rooms"===e){var r=this._getSettings(f);return r&&r.recent_rooms||(r=this._getSettings(p)),r||(r={}),r.recent_rooms=n,d.default.get().setAccountData(f,r)}if("integrationProvisioning"===e){var o=this._getSettings(m)||{};return o.enabled=n,d.default.get().setAccountData(m,o)}var s=this._getSettings()||{};return s[e]=n,d.default.get().setAccountData("im.vector.web.settings",s)}},{key:"canSetValue",value:function(e,t){return!0}},{key:"isSupported",value:function(){var e=d.default.get();return void 0!==e&&null!==e}},{key:"_getSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im.vector.web.settings",t=d.default.get();if(!t)return null;var n=t.getAccountData(e);return n&&n.getContent()?n.getContent():null}},{key:"_notifyBreadcrumbsUpdate",value:function(e){var t=[];if(e.getType()===p){var n=this._getSettings(f);t=n?n.recent_rooms:e.getContent().rooms}else{if(e.getType()!==f)return;t=e.getContent().recent_rooms}this._watchers.notifyUpdate("breadcrumb_rooms",null,h.SettingLevel.ACCOUNT,t||[])}}]),t}(l.default);t.default=v,e.exports=t.default},oOXF:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.SettingLevel=void 0;var i=b(n("/9Wh")),r=b(n("t3kO")),o=b(n("tZmG")),s=b(n("Zv/C")),a=b(n("2lBV")),c=b(n("6Aih")),u=b(n("qGAZ")),d=b(n("Df2i")),l=b(n("JIfo")),h=b(n("o3A1")),g=b(n("RAuX")),p=b(n("KCcI")),f=n("nPNV"),y=b(n("FJJ4")),m=b(n("4ZFb")),v=n("kdap"),_=b(n("3A0a")),S=n("vtWn");function b(e){return e&&e.__esModule?e:{default:e}}t.SettingLevel={DEVICE:"device",ROOM_DEVICE:"room-device",ROOM_ACCOUNT:"room-account",ACCOUNT:"account",ROOM:"room",CONFIG:"config",DEFAULT:"default"};var A=new S.WatchManager,w={},E={},I=[],k=!0,R=!1,C=void 0;try{for(var T,D=(0,r.default)((0,o.default)(v.SETTINGS));!(k=(T=D.next()).done);k=!0){var O=T.value;w[O]=v.SETTINGS[O].default,v.SETTINGS[O].isFeature&&I.push(O),v.SETTINGS[O].invertedSettingName&&(E[O]=!v.SETTINGS[O].default)}}catch(F){R=!0,C=F}finally{try{!k&&D.return&&D.return()}finally{if(R)throw C}}var M={device:new c.default(I,A),"room-device":new u.default(A),"room-account":new l.default(A),account:new h.default(A),room:new g.default(A),config:new p.default,default:new d.default(w,E)},N=!0,P=!1,U=void 0;try{for(var B,x=(0,r.default)((0,o.default)(M));!(N=(B=x.next()).done);N=!0){var j=B.value;M[j]=new _.default(M[j])}}catch(F){P=!0,U=F}finally{try{!N&&x.return&&x.return()}finally{if(P)throw U}}var L=["device","room-device","room-account","account","room","config","default"],G=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,null,[{key:"watchSetting",value:function(t,n,i){var r=v.SETTINGS[t],o=t;if(!r)throw new Error(t+" is not a setting");r.invertedSettingName&&(t=r.invertedSettingName);var s=(new Date).getTime()+"_"+t+"_"+n,a=function(t,n,r){var s=e.getValue(o);i(o,t,n,r,s)};return console.log("Starting watcher for "+t+"@"+(n||"<null room>")),e._watchers[s]=a,A.watchSetting(t,n,a),s}},{key:"unwatchSetting",value:function(t){e._watchers[t]&&(A.unwatchSetting(e._watchers[t]),delete e._watchers[t])}},{key:"monitorSetting",value:function(t,n){var i=this;this._monitors[t]||(this._monitors[t]={});var s=function(){i._monitors[t][n]=e.watchSetting(t,n,(function(e,t,n,i,r){m.default.dispatch({action:"setting_updated",settingName:e,roomId:t,level:n,newValueAtLevel:i,newValue:r})}))};if((0,o.default)(this._monitors[t]).find((function(e){return e===n||null===e}))){if(null===n){var a=!0,c=!1,u=void 0;try{for(var d,l=(0,r.default)((0,o.default)(this._monitors[t]));!(a=(d=l.next()).done);a=!0){var h=d.value;e.unwatchSetting(this._monitors[t][h])}}catch(F){c=!0,u=F}finally{try{!a&&l.return&&l.return()}finally{if(c)throw u}}this._monitors[t]={},s()}}else s()}},{key:"getDisplayName",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";if(!v.SETTINGS[e]||!v.SETTINGS[e].displayName)return null;var n=v.SETTINGS[e].displayName;return n instanceof Object&&(n=n[t]?n[t]:n.default),(0,f._t)(n)}},{key:"getLabsFeatures",value:function(){var t=(0,o.default)(v.SETTINGS).filter((function(t){return e.isFeature(t)}));return y.default.get().enableLabs?t:t.filter((function(t){return"labs"===e._getFeatureState(t)}))}},{key:"isFeature",value:function(e){return!!v.SETTINGS[e]&&v.SETTINGS[e].isFeature}},{key:"isFeatureEnabled",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e.isFeature(t))throw new Error("Setting "+t+" is not a feature");return e.getValue(t,n)}},{key:"setFeatureEnabled",value:function(t,n){if(!v.SETTINGS[t])throw new Error("Setting '"+t+"' does not appear to be a setting.");if(!e.isFeature(t))throw new Error("Setting "+t+" is not a feature");return e.setValue(t,null,"device",n)}},{key:"getValue",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!v.SETTINGS[t])throw new Error("Setting '"+t+"' does not appear to be a setting.");var r=v.SETTINGS[t],o=r.supportedLevelsAreOrdered?r.supportedLevels:L;return e.getValueAt(o[0],t,n,!1,i)}},{key:"getValueAt",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=v.SETTINGS[n];if(!s)throw new Error("Setting '"+n+"' does not appear to be a setting.");var a=s.supportedLevelsAreOrdered?s.supportedLevels:L;a.includes("default")||a.push("default");var c=a.indexOf(t);if(-1===c)throw new Error("Level "+t+" is not prioritized");if(e.isFeature(n)){var u=e._getFeatureState(n);if("enable"===u)return!0;if("disable"===u)return!1}var d=e._getHandlers(n);if(s.invertedSettingName&&(n=s.invertedSettingName),r){var l=d[t];if(!l)return e._getFinalValue(s,t,i,null,null);var h=l.getValue(n,i);return e._getFinalValue(s,t,i,h,t)}for(var g=c;g<a.length;g++){var p=d[a[g]];if(p&&(!o||"default"!==a[g])){var f=p.getValue(n,i);if(null!==f&&void 0!==f)return e._getFinalValue(s,t,i,f,a[g])}}return e._getFinalValue(s,t,i,null,null)}},{key:"_getFinalValue",value:function(e,t,n,i,r){var o=i;if(e.controller){var s=e.controller.getValueOverride(t,n,i,r);void 0!==s&&null!==s&&(o=s)}return e.invertedSettingName&&(o=!o),o}},{key:"setValue",value:async function(t,n,i,r){var o=v.SETTINGS[t];if(!o)throw new Error("Setting '"+t+"' does not appear to be a setting.");var s=e._getHandler(t,i);if(!s)throw new Error("Setting "+t+" does not have a handler for "+i);if(o.invertedSettingName&&(t=o.invertedSettingName,r=!r),!s.canSetValue(t,n))throw new Error("User cannot set "+t+" at "+i+" in "+n);await s.setValue(t,n,r);var a=o.controller;a&&a.onChange(i,n,r)}},{key:"canSetValue",value:function(t,n,i){if(!v.SETTINGS[t])throw new Error("Setting '"+t+"' does not appear to be a setting.");var r=e._getHandler(t,i);return!!r&&r.canSetValue(t,n)}},{key:"isLevelSupported",value:function(e){return!!M[e]&&M[e].isSupported()}},{key:"debugSetting",value:function(t,n){console.log("--- DEBUG "+t);var s=v.SETTINGS[t];console.log("--- definition: "+(s?(0,i.default)(s):"<NOT_FOUND>")),console.log("--- default level order: "+(0,i.default)(L)),console.log("--- registered handlers: "+(0,i.default)((0,o.default)(M)));var a=function(t){var s=!0,a=!1,c=void 0;try{for(var u,d=(0,r.default)((0,o.default)(M));!(s=(u=d.next()).done);s=!0){var l=u.value,h=M[l];try{var g=h.getValue(t,n);console.log("---     "+l+"@"+(n||"<no_room>")+" = "+(0,i.default)(g))}catch(I){console.log("---     "+h+"@"+(n||"<no_room>")+" THREW ERROR: "+I.message),console.error(I)}if(n)try{var p=h.getValue(t,null);console.log("---     "+l+"@<no_room> = "+(0,i.default)(p))}catch(I){console.log("---     "+h+"@<no_room> THREW ERROR: "+I.message),console.error(I)}}}catch(F){a=!0,c=F}finally{try{!s&&d.return&&d.return()}finally{if(a)throw c}}console.log("--- calculating as returned by SettingsStore"),console.log("--- these might not match if the setting uses a controller - be warned!");try{var f=e.getValue(t,n);console.log("---     SettingsStore#generic@"+(n||"<no_room>")+"  = "+(0,i.default)(f))}catch(I){console.log("---     SettingsStore#generic@"+(n||"<no_room>")+" THREW ERROR: "+I.message),console.error(I)}if(n)try{var y=e.getValue(t,null);console.log("---     SettingsStore#generic@<no_room>  = "+(0,i.default)(y))}catch(I){console.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+I.message),console.error(I)}var m=!0,v=!1,_=void 0;try{for(var S,b=(0,r.default)(L);!(m=(S=b.next()).done);m=!0){var A=S.value;try{var w=e.getValueAt(A,t,n);console.log("---     SettingsStore#"+A+"@"+(n||"<no_room>")+" = "+(0,i.default)(w))}catch(I){console.log("---     SettingsStore#"+A+"@"+(n||"<no_room>")+" THREW ERROR: "+I.message),console.error(I)}if(n)try{var E=e.getValueAt(A,t,null);console.log("---     SettingsStore#"+A+"@<no_room> = "+(0,i.default)(E))}catch(I){console.log("---     SettingsStore#"+A+"@$<no_room> THREW ERROR: "+I.message),console.error(I)}}}catch(F){v=!0,_=F}finally{try{!m&&b.return&&b.return()}finally{if(v)throw _}}};a(t),s.invertedSettingName&&(console.log("--- TESTING INVERTED SETTING NAME"),console.log("--- inverted: "+s.invertedSettingName),a(s.invertedSettingName)),console.log("--- END DEBUG")}},{key:"_getHandler",value:function(t,n){var i=e._getHandlers(t);return i[n]?i[n]:null}},{key:"_getHandlers",value:function(e){if(!v.SETTINGS[e])return{};var t={},n=!0,i=!1,o=void 0;try{for(var s,a=(0,r.default)(v.SETTINGS[e].supportedLevels);!(n=(s=a.next()).done);n=!0){var c=s.value;if(!M[c])throw new Error("Unexpected level "+c);t[c]=M[c]}}catch(F){i=!0,o=F}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}return t.default||(t.default=M.default),t}},{key:"_getFeatureState",value:function(e){var t=y.default.get().features,n=y.default.get().enableLabs?"labs":"disable";t&&void 0!==t[e]&&(n=t[e]);return["enable","disable","labs"].includes(n)||(console.warn("Feature state '"+n+"' is invalid for "+e),n="disable"),n}}]),e}();G._watchers={},G._monitors={},t.default=G,e.mxSettingsStore=G}).call(this,n("bqPV"))},otDc:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceList=void 0;var r=n("hBZP"),o=n("uZMU"),s=n("UESs"),a=n("92AT"),c=i(n("n/Lb")),u=n("W92I"),d=n("dZ+v");class l extends r.EventEmitter{constructor(e,t,n,i=250){super(),this._cryptoStore=t,this._devices={},this._crossSigningInfo={},this._userByIdentityKey={},this._deviceTrackingStatus={},this._syncToken=null,this._serialiser=new h(e,n,this),this._keyDownloadsInProgressByUser={},this._keyDownloadChunkSize=i,this._dirty=!1,this._savePromise=null,this._resolveSavePromise=null,this._savePromiseTime=null,this._saveTimer=null,this._hasFetched=null}async load(){await this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this._cryptoStore.getEndToEndDeviceData(e,(e=>{this._hasFetched=Boolean(e&&e.devices),this._devices=e?e.devices:{},this._crossSigningInfo=e&&e.crossSigningInfo||{},this._deviceTrackingStatus=e?e.trackingStatus:{},this._syncToken=e?e.syncToken:null,this._userByIdentityKey={};for(const t of Object.keys(this._devices)){const e=this._devices[t];for(const n of Object.keys(e)){const i=e[n].keys["curve25519:"+n];void 0!==i&&(this._userByIdentityKey[i]=t)}}}))}));for(const e of Object.keys(this._deviceTrackingStatus))2==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=1)}stop(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}async saveIfDirty(e){if(!this._dirty)return Promise.resolve(!1);void 0===e&&(e=500);const t=Date.now+e;this._savePromiseTime&&t<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null);let n=this._savePromise;if(null===n&&(n=new Promise(((e,t)=>{this._resolveSavePromise=e})),this._savePromise=n),null===this._saveTimer){const n=this._resolveSavePromise;this._savePromiseTime=t,this._saveTimer=setTimeout((()=>{o.logger.log("Saving device tracking data",this._syncToken),this._savePromiseTime=null,this._saveTimer=null,this._savePromise=null,this._resolveSavePromise=null,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],(e=>{this._cryptoStore.storeEndToEndDeviceData({devices:this._devices,crossSigningInfo:this._crossSigningInfo,trackingStatus:this._deviceTrackingStatus,syncToken:this._syncToken},e)})).then((()=>{this._dirty=!1,n()}),(e=>{o.logger.error("Failed to save device tracking data",this._syncToken),o.logger.error(e)}))}),e)}return n}getSyncToken(){return this._syncToken}setSyncToken(e){this._syncToken=e}downloadKeys(e,t){const n=[],i=[];if(e.forEach((e=>{const r=this._deviceTrackingStatus[e];this._keyDownloadsInProgressByUser[e]?(o.logger.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),i.push(this._keyDownloadsInProgressByUser[e])):(t||3!=r)&&n.push(e)})),0!=n.length){o.logger.log("downloadKeys: downloading for",n);const e=this._doKeyDownload(n);i.push(e)}return 0===i.length&&o.logger.log("downloadKeys: already have all necessary keys"),Promise.all(i).then((()=>this._getDevicesFromStore(e)))}_getDevicesFromStore(e){const t={},n=this;return e.map((function(e){t[e]={};(n.getStoredDevicesForUser(e)||[]).map((function(n){t[e][n.deviceId]=n}))})),t}getKnownUserIds(){return Object.keys(this._devices)}getStoredDevicesForUser(e){const t=this._devices[e];if(!t)return null;const n=[];for(const i in t)t.hasOwnProperty(i)&&n.push(s.DeviceInfo.fromStorage(t[i],i));return n}getRawStoredDevicesForUser(e){return this._devices[e]}getStoredCrossSigningForUser(e){return this._crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}getStoredDevice(e,t){const n=this._devices[e];if(n&&n[t])return s.DeviceInfo.fromStorage(n[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this._userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const n=this.getUserByIdentityKey(e,t);if(!n)return null;const i=this._devices[n];if(!i)return null;for(const r in i){if(!i.hasOwnProperty(r))continue;const e=i[r];for(const n in e.keys){if(!e.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(e.keys[n]==t)return s.DeviceInfo.fromStorage(e,r)}}return null}storeDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[n,i]of Object.entries(this._devices[e])){const e=i.keys["curve25519:"+n];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[n,i]of Object.entries(t)){const t=i.keys["curve25519:"+n];this._userByIdentityKey[t]=e}this._dirty=!0}startTrackingDeviceList(e){if("string"!==typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(o.logger.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}stopTrackingDeviceList(e){this._deviceTrackingStatus[e]&&(o.logger.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this._deviceTrackingStatus))this._deviceTrackingStatus[e]=0;this._dirty=!0}invalidateUserDeviceList(e){this._deviceTrackingStatus[e]&&(o.logger.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this._deviceTrackingStatus)){1==this._deviceTrackingStatus[t]&&e.push(t)}return this._doKeyDownload(e)}_setRawStoredDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[n,i]of Object.entries(this._devices[e])){const e=i.keys["curve25519:"+n];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[n,i]of Object.entries(t)){const t=i.keys["curve25519:"+n];this._userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this._crossSigningInfo[e]=t}_doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this._serialiser.updateDevicesForUsers(e,this._syncToken).then((()=>{n(!0)}),(t=>{throw o.logger.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((e=>{this._keyDownloadsInProgressByUser[e]=t;1==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=2)}));const n=n=>{this.emit("crypto.willUpdateDevices",e,!this._hasFetched),e.forEach((e=>{if(this._dirty=!0,this._keyDownloadsInProgressByUser[e]!==t)return void o.logger.log("Another update in the queue for",e,"- not marking up-to-date");delete this._keyDownloadsInProgressByUser[e];2==this._deviceTrackingStatus[e]&&(n?(this._deviceTrackingStatus[e]=3,o.logger.log("Device list for",e,"now up to date")):this._deviceTrackingStatus[e]=1)})),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e,!this._hasFetched),this._hasFetched=!0};return t}}t.DeviceList=l;class h{constructor(e,t,n){this._baseApis=e,this._olmDevice=t,this._deviceList=n,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}updateDevicesForUsers(e,t){return e.forEach((e=>{this._keyDownloadsQueuedByUser[e]=!0})),this._queuedQueryDeferred||(this._queuedQueryDeferred=(0,d.defer)()),this._syncToken=t,this._downloadInProgress?(o.logger.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}_doQueuedQueries(){if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");const e=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};const t=this._queuedQueryDeferred;this._queuedQueryDeferred=null,o.logger.log("Starting key download for",e),this._downloadInProgress=!0;const n={};this._syncToken&&(n.token=this._syncToken);const i=[];for(let r=0;r<e.length;r+=this._deviceList._keyDownloadChunkSize){const t=e.slice(r,r+this._deviceList._keyDownloadChunkSize);i.push((()=>this._baseApis.downloadKeysForUsers(t,n)))}return(0,d.chunkPromises)(i,3).then((async t=>{const n=Object.assign({},...t.map((e=>e.device_keys||{}))),i=Object.assign({},...t.map((e=>e.master_keys||{}))),r=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),s=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const c of e){await(0,d.sleep)(5);try{await this._processQueryResponseForUser(c,n[c],{master:i[c],self_signing:r[c],user_signing:s[c]})}catch(a){o.logger.error(`Error processing keys for ${c}:`,a)}}})).then((()=>{o.logger.log("Completed key download for "+e),this._downloadInProgress=!1,t.resolve(),this._queuedQueryDeferred&&this._doQueuedQueries()}),(n=>{o.logger.warn("Error downloading keys for "+e+":",n),this._downloadInProgress=!1,t.reject(n)})),t.promise}async _processQueryResponseForUser(e,t,n){o.logger.log("got device keys for "+e+":",t),o.logger.log("got cross-signing keys for "+e+":",n);{const n={},i=this._deviceList.getRawStoredDevicesForUser(e);i&&Object.keys(i).forEach((e=>{const t=s.DeviceInfo.fromStorage(i[e],e);n[e]=t})),await async function(e,t,n,i,r,s){let a=!1;for(const c in n)if(n.hasOwnProperty(c)&&!(c in i)){if(t===r&&c===s){o.logger.warn(`Local device ${c} missing from sync, skipping removal`);continue}o.logger.log("Device "+t+":"+c+" has been removed"),delete n[c],a=!0}for(const c in i){if(!i.hasOwnProperty(c))continue;const r=i[c];r.user_id===t?r.device_id===c?await g(e,n,r)&&(a=!0):o.logger.warn("Mismatched device_id "+r.device_id+" in keys from "+t+":"+c):o.logger.warn("Mismatched user_id "+r.user_id+" in keys from "+t+":"+c)}return a}(this._olmDevice,e,n,t||{},this._baseApis.getUserId(),this._baseApis.deviceId);const r={};Object.keys(n).forEach((e=>{r[e]=n[e].toStorage()})),this._deviceList._setRawStoredDevicesForUser(e,r)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this._deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(n),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this._deviceList.emit("userCrossSigningUpdated",e)}}}async function g(e,t,n){if(!n.keys)return!1;const i=n.device_id,r=n.user_id,a="ed25519:"+i,u=n.keys[a];if(!u)return o.logger.warn("Device "+r+":"+i+" has no ed25519 key"),!1;const d=n.unsigned||{},l=n.signatures||{};try{await c.verifySignature(e,n,r,i,u)}catch(g){return o.logger.warn("Unable to verify signature on device "+r+":"+i+":"+g),!1}let h;if(i in t){if(h=t[i],h.getFingerprint()!=u)return o.logger.warn("Ed25519 key for device "+r+":"+i+" has changed"),!1}else t[i]=h=new s.DeviceInfo(i);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=d,h.signatures=l,!0}},pZ3Y:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=u(n("YUSd")),r=u(n("t3kO")),o=u(n("Zv/C")),s=u(n("Dkg+")),a=u(n("2lBV")),c=u(n("Gjrs"));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(){(0,o.default)(this,t);var e=(0,s.default)(this,(t.__proto__||(0,i.default)(t)).call(this));return t._instances.push(e),e}return(0,c.default)(t,e),(0,a.default)(t,null,[{key:"matrixClient",set:function(e){var n=t._matrixClient;t._matrixClient=e;var i=!0,o=!1,s=void 0;try{for(var a,c=(0,r.default)(t._instances);!(i=(a=c.next()).done);i=!0){a.value.initMatrixClient(n,e)}}catch(u){o=!0,s=u}finally{try{!i&&c.return&&c.return()}finally{if(o)throw s}}}}]),(0,a.default)(t,[{key:"initMatrixClient",value:function(){console.warn("initMatrixClient not overridden")}}]),t}(u(n("SeIk")).default);d._instances=[],t.default=d,e.exports=t.default},"pZw/":function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0});var r={request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,ContentHelpers:!0,createNewMatrixCall:!0,setMatrixCallAudioOutput:!0,setMatrixCallAudioInput:!0,setMatrixCallVideoInput:!0};t.request=function(e){O=e},t.getRequest=function(){return O},t.wrapRequest=function(e){const t=O;O=function(n,i){return e(t,n,i)}},t.setCryptoStoreFactory=function(e){M=e},t.createClient=function(t){"string"===typeof t&&(t={baseUrl:t});return t.request=t.request||O,t.store=t.store||new s.MemoryStore({localStorage:e.localStorage}),t.scheduler=t.scheduler||new a.MatrixScheduler,t.cryptoStore=t.cryptoStore||M(),new c.MatrixClient(t)},Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return D.createNewMatrixCall}}),Object.defineProperty(t,"setMatrixCallAudioOutput",{enumerable:!0,get:function(){return D.setAudioOutput}}),Object.defineProperty(t,"setMatrixCallAudioInput",{enumerable:!0,get:function(){return D.setAudioInput}}),Object.defineProperty(t,"setMatrixCallVideoInput",{enumerable:!0,get:function(){return D.setVideoInput}}),t.ContentHelpers=void 0;var o=n("QzvL");Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=n("Wy6s");Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=n("+eLZ");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n("L++b");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var u=n("lWzV");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var d=n("vlvg");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var l=n("utK+");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var h=n("2NLw");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var g=n("MwLI");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var p=n("GqeV");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=n("EfR+");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=n("apMS");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var m=n("6Mww");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var v=n("QUNv");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var _=n("UDUm");Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var S=n("D67U");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=n("uHjp");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var A=n("gP8h");Object.keys(A).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))}));var w=n("0PDV");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var E=n("0c22");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var I=n("v4tl");Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var k=n("stot");Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var R=n("W92I");Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var C=n("IAeZ");Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var T=i(n("gl1w"));t.ContentHelpers=T;var D=n("/0WT");let O;let M=()=>new o.MemoryCryptoStore}).call(this,n("bqPV"))},purq:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAaCAYAAAC+aNwHAAAABGdBTUEAALGPC/xhBQAAAw9JREFUOBGlVFtIlFEQnjn7u+u2aVoE0gV88a2brlkUdCEKehArS9I1g5IM0Ydsd+1RKpK8gmWQL4W6SyBBPvTUxR6spNSlh0q0K0W9pGJitrv/f6b51bOti7KFP/zMOTPzfWfOnJlBiP1qaoQ7N6McBeQCYRoiGAT0jnR5o2HriSex7hit8Ly4lQaazYcon0+FjObWbSdHTbv7ZfsGtFguA8KH+kxXVTRm3toz6O92B3x585RRG2/A3+Ye8JdFqUCojbfff4jXPxoyXd1KFys/jgxXCAFVlX2dycoWISCkPbpBN5VhIdlVUBMCgrt2DZ3KHiHg+21hgiFlWFzSW2JfZf9LAOiwTUhDGRaTEsngwxzKHkWgVP8nl0ygeQZ9l7gYSgjA+k9nE9rZr5RxJUTGWY4AC+uyXOkIRD2rpkPxSASSjXPwVBIUCqGVCT7dBBFH8H3jpNUSj0ASjrHzENfDTyKyLTkHEQJuGt2aFLLFiwAJEgFJ18NhKwKGBXfadHlP63KusN5kTDoSj4CLP19K6NE0yya++GvBwMeO5JSjpIfquYXn1XksGTfbbvanJmdxH6AoMAgfCk7KVc5qNY1bJkFSo92G97lZ1sWCzwc69rOuJSSNCm+/by9fxdaYXdQ7Mw+8A74zhHh4amL8mCMlZRcPklp+mM/8xMOccTs/XRaDvwH8rtTBuloD0WFILGCCoZkk1jldbQCyy7EitYcdR+qzijaHyaiWIB+BNLrktJHHtZIP0p5jAXHHADpugs0oZyIwF+bnHezcB4hX+J6jfPKDT+/vtaxPP7jGkpBYwREdYP0bQw9eaMo59WUWEUOglJ6AL4Pv2M4nnebnzUOJK/XgdG3zjtIx5aNkpA6UwpQ890aY+6vSceJfLQQ27ZpyOvesyR4M2iKlzKAEZUMhEmdqZU6hJ2nBtuyysLlF4DHuycvo5qpay/0Q1UxcGcFf+VrCsp1CoFeRzYIgVUq61uB0XQfzzT0Bf1+0Q7y1Of69g77+OTIz+/7bPFS3cxR6PLBp5y608n+xwVnc+Qd0xTaaQDLU+AAAAABJRU5ErkJggg=="},qGAZ:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=g(n("OBCi")),r=g(n("/9Wh")),o=g(n("YUSd")),s=g(n("Zv/C")),a=g(n("2lBV")),c=g(n("Dkg+")),u=g(n("Gjrs")),d=g(n("SeIk")),l=n("oOXF"),h=g(n("kPC3"));function g(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e){(0,s.default)(this,t);var n=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return n._watchers=e,n}return(0,u.default)(t,e),(0,a.default)(t,[{key:"getValue",value:function(e,t){if("blacklistUnverifiedDevices"===e){var n=this._read("mx_local_settings");if(n&&n.blacklistUnverifiedDevicesPerRoom)return n.blacklistUnverifiedDevicesPerRoom[t]}var i=this._read(this._getKey(e,t));return i?i.value:null}},{key:"setValue",value:function(e,t,n){if("blacklistUnverifiedDevices"===e){var o=this._read("mx_local_settings");return o||(o={}),o.blacklistUnverifiedDevicesPerRoom||(o.blacklistUnverifiedDevicesPerRoom={}),o.blacklistUnverifiedDevicesPerRoom[t]=n,h.default.setItem("mx_local_settings",(0,r.default)(o)),this._watchers.notifyUpdate(e,t,l.SettingLevel.ROOM_DEVICE,n),i.default.resolve()}return null===n?h.default.removeItem(this._getKey(e,t)):(n=(0,r.default)({value:n}),h.default.setItem(this._getKey(e,t),n)),this._watchers.notifyUpdate(e,t,l.SettingLevel.ROOM_DEVICE,n),i.default.resolve()}},{key:"canSetValue",value:function(e,t){return!0}},{key:"isSupported",value:function(){return void 0!==h.default&&null!==h.default}},{key:"_read",value:function(e){var t=h.default.getItem(e);return t?JSON.parse(t):null}},{key:"_getKey",value:function(e,t){return"mx_setting_"+e+"_"+t}}]),t}(d.default);t.default=p,e.exports=t.default},qfve:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n("rsVN"),n("sFvr");var i=n("cAsW");Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}))},qmkL:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.upgradeDatabase=function(e,t){r.logger.log(`Upgrading IndexedDBCryptoStore from version ${t} to 10`),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]});t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]});if(t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},t.Backend=t.VERSION=void 0;var r=n("uZMU"),o=i(n("dZ+v"));t.VERSION=10;function s(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function a(e){return new Promise(((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t()},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(r.logger.log("Error performing indexeddb txn",t),n(t.target.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(r.logger.log("Error performing indexeddb txn",t),n(t.target.error))}}))}t.Backend=class{constructor(e){this._db=e,this._nextTxnId=0,e.onversionchange=t=>{r.logger.log(`versionchange for indexeddb ${this._dbName}: closing`),e.close()}}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((n,i)=>{const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");o.onerror=i,this._getOutgoingRoomKeyRequest(o,t,(i=>{if(i)return r.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void n(i);r.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),o.oncomplete=()=>{n(e)};o.objectStore("outgoingRoomKeyRequests").add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,n)=>{const i=this._db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=n,this._getOutgoingRoomKeyRequest(i,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,n){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=e=>{const i=e.target.result;if(!i)return void n(null);const r=i.value;o.deepCompare(r.requestBody,t)?n(r):i.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;const i=this._db.transaction("outgoingRoomKeyRequests","readonly"),r=i.objectStore("outgoingRoomKeyRequests"),o=e[n];return r.index("state").openCursor(o).onsuccess=function i(r){const o=r.target.result;if(o)return void(t=o.value);if(n++,n>=e.length)return;const s=e[n];r.target.source.openCursor(s).onsuccess=i},a(i).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,n)=>{const i=this._db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);i.onsuccess=e=>t(e.target.result),i.onerror=e=>n(e.target.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,n){let i=0;const r=[];const o=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=o.objectStore("outgoingRoomKeyRequests"),c=n[i];return s.index("state").openCursor(c).onsuccess=function o(s){const a=s.target.result;if(a){const n=a.value;n.recipients.includes({userId:e,deviceId:t})&&r.push(n),a.continue()}else{if(i++,i>=n.length)return;const e=n[i];s.target.source.openCursor(e).onsuccess=o}},a(o).then((()=>r))}updateOutgoingRoomKeyRequest(e,t,n){let i=null;const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");return o.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const o=e.target.result;if(!o)return;const s=o.value;s.state==t?(Object.assign(s,n),o.update(s),i=s):r.logger.warn(`Cannot update room key request from ${t} as it was already updated to ${s.state}`)},a(o).then((()=>i))}deleteOutgoingRoomKeyRequest(e,t){const n=this._db.transaction("outgoingRoomKeyRequests","readwrite");return n.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=e=>{const n=e.target.result;if(!n)return;const i=n.value;i.state==t?n.delete():r.logger.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`)},a(n)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(i){s(e,i)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(i){s(e,i)}}}getSecretStorePrivateKey(e,t,n){const i=e.objectStore("account").get(`ssss_cache:${n}`);i.onsuccess=function(){try{t(i.result||null)}catch(n){s(e,n)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,n){e.objectStore("account").put(n,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){try{t(n.result)}catch(i){s(e,i)}}}getEndToEndSessions(e,t,n){const i=t.objectStore("sessions").index("deviceKey").openCursor(e),r={};i.onsuccess=function(){const e=i.result;if(e)r[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(r)}catch(o){s(t,o)}}}getEndToEndSession(e,t,n,i){const r=n.objectStore("sessions").get([e,t]);r.onsuccess=function(){try{r.result?i({session:r.result.session,lastReceivedMessageTs:r.result.lastReceivedMessageTs}):i(null)}catch(e){s(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){try{const e=n.result;e?(t(e.value),e.continue()):t(null)}catch(i){s(e,i)}}}storeEndToEndSession(e,t,n,i){i.objectStore("sessions").put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const i=this._db.transaction("session_problems","readwrite");return i.objectStore("session_problems").put({deviceKey:e,type:t,fixed:n,time:Date.now()}),a(i)}async getEndToEndSessionProblem(e,t){let n;const i=this._db.transaction("session_problems","readwrite"),r=i.objectStore("session_problems").index("deviceKey").getAll(e);return r.onsuccess=e=>{const i=r.result;if(!i.length)return void(n=null);i.sort(((e,t)=>e.time-t.time));const o=i[i.length-1];for(const r of i)if(r.time>t)return void(n=Object.assign({},r,{fixed:o.fixed}));n=o.fixed?null:o},await a(i),n}async filterOutNotifiedErrorDevices(e){const t=this._db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map((e=>new Promise((i=>{const{userId:r,deviceInfo:o}=e,s=t.get([r,o.deviceId]);s.onsuccess=function(){s.result||(t.put({userId:r,deviceId:o.deviceId}),n.push(e)),i()}}))))),n}getEndToEndInboundGroupSession(e,t,n,i){let r=!1,o=!1;const a=n.objectStore("inbound_group_sessions").get([e,t]);a.onsuccess=function(){try{r=a.result?a.result.session:null,!1!==o&&i(r,o)}catch(e){s(n,e)}};const c=n.objectStore("inbound_group_sessions_withheld").get([e,t]);c.onsuccess=function(){try{o=c.result?c.result.session:null,!1!==r&&i(r,o)}catch(e){s(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const i=n.result;if(i){try{t({senderKey:i.value.senderCurve25519Key,sessionId:i.value.sessionId,sessionData:i.value.session})}catch(r){s(e,r)}i.continue()}else try{t(null)}catch(r){s(e,r)}}}addEndToEndInboundGroupSession(e,t,n,i){const o=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:n});o.onerror=n=>{"ConstraintError"===o.error.name?(n.stopPropagation(),n.preventDefault(),r.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):s(i,new Error("Failed to add inbound group session: "+o.error))}}storeEndToEndInboundGroupSession(e,t,n,i){i.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,i){i.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(i){s(e,i)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,n){n.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const n={},i=e.objectStore("rooms").openCursor();i.onsuccess=function(){const r=i.result;if(r)n[r.key]=r.value,r.continue();else try{t(n)}catch(o){s(e,o)}}}getSessionsNeedingBackup(e){return new Promise(((t,n)=>{const i=[],r=this._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");r.onerror=n,r.oncomplete=function(){t(i)};const o=r.objectStore("sessions_needing_backup"),s=r.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=s.get(t.key);n.onsuccess=function(){i.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||i.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,n)=>{const i=t.count();i.onerror=n,i.onsuccess=()=>e(i.result)}))}unmarkSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");return Promise.all(e.map((e=>new Promise(((t,i)=>{const r=n.delete([e.senderKey,e.sessionId]);r.onsuccess=t,r.onerror=i})))))}markSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");return Promise.all(e.map((e=>new Promise(((t,i)=>{const r=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});r.onsuccess=t,r.onerror=i})))))}addSharedHistoryInboundGroupSession(e,t,n,i){i||(i=this._db.transaction("shared_history_inbound_group_sessions","readwrite"));const r=i.objectStore("shared_history_inbound_group_sessions"),o=r.get([e]);o.onsuccess=()=>{const{sessions:i}=o.result||{sessions:[]};i.push([t,n]),r.put({roomId:e,sessions:i})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this._db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise(((e,t)=>{n.onsuccess=()=>{const{sessions:t}=n.result||{sessions:[]};e(t)},n.onerror=t}))}doTxn(e,t,n,i=r.logger){const o=this._db.transaction(t,e),s=a(o),c=n(o);return s.then((()=>c))}}},rL4X:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAWCAYAAAAmaHdCAAAAAXNSR0IArs4c6QAAAoNJREFUOBHVVG9IU1EUP+fuPSdz5rTWPyFw6w9ChZpWBJVRUEEIFka2ZYVFSgV9cGvYlxH0IacEEQRBSHMmLKIoUr9Mo9La1uxLSIggZGFR0CRd5Pbu7d5q8PZ8ml878Hj3/H6/8+Pc+867CDw8zzvzFTMeQoC1gJgnsIygdEZOkZYrm2vHM/C/Cf4xgGagGCJMenm1/PCkVuge6rwMgDk0mbrRuqVuTMsT0YEw8G062qtnIAoKsszGInPBIJGlc55YcPUsE7GFHPLzlZZQ5wYDkfauKNu5v7Ckh2Kq0R3zF6t5Is7AW3oyrgb11kjQWLm0uPqYfUcfoHTq4uvAhrSOpBfzvXNlU+Ld5EchkdYvKqxqWLMnzAg57ol2lf4G5ytOcxstRY8HvwzXh7+OAiEGAe/OluTkD5ypbwr726S0UO9dE6wxrLJV529bYoswxiY+J76XUqRyWvvwQ9Q2pnzKn9PkRH97tjUvKwjIKpuiHVWI+JQXZ8yJe6irQRjqnon7xe1cq8XYw2ejBBnMoEQeuGKBA6JAL2aZnA3fWcxM2SFgMEEZu8AQR1GBg/zr+F1DHbX/NHFF2pebZOkZF8Z8j0acCJgURS3ljv5kCvbxxq83xQKntUaZnaBs58Pn95U5GsHrpWrxtQpHhCnKLj5XdjUu1hkH66twDnBMPLrRWlH3lhMeLZnZiZZdYP6fmCBQtpAdEaqwSe+bdoueeCqBA8joJT1OYAjMkmIkLiGBkWli3MqxXq345nbHN46FtLjI+civZMCs0zg1Lhmm2H3FDM2u2F2Y63pUm5zv7jYal8XX8X/qCFB671b5mSSfrQVc1GoXfmnzgXuvMPqkrcw5LKhfxWfYOSdzfOQAAAAASUVORK5CYII="},rnAe:function(e,t,n){"use strict";var i=n("mXGw"),r=n.n(i),o=n("iM8r"),s=r.a.createElement;var a=n("S6BY");t.a=Object(a.a)((function(e){var t=e.children,n=e.isMatrixReady;return Object(o.b)({isMatrixReady:n}),s(i.Fragment,null,t)}))},rsVN:function(e,t,n){"use strict";var i=n("Dlk0"),r=n("uZMU"),o=i(n("dZ+v")),s=i(n("n/Lb")),a=n("UESs"),c=n("cAsW");const u=a.DeviceInfo.DeviceVerification;function d(e){(0,o.polyfillSuper)(this,c.EncryptionAlgorithm,e),this._sessionPrepared=!1,this._prepPromise=null}function l(e){(0,o.polyfillSuper)(this,c.DecryptionAlgorithm,e)}o.inherits(d,c.EncryptionAlgorithm),d.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();const t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(n){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},d.prototype.encryptMessage=async function(e,t,n){const i=await e.getEncryptionTargetMembers(),r=o.map(i,(function(e){return e.userId})),a=this;await this._ensureSession(r);const c={room_id:e.roomId,type:t,content:n},d={algorithm:s.OLM_ALGORITHM,sender_key:a._olmDevice.deviceCurve25519Key,ciphertext:{}},l=[];for(let o=0;o<r.length;++o){const e=r[o],t=a._crypto.getStoredDevicesForUser(e);for(let n=0;n<t.length;++n){const i=t[n];i.getIdentityKey()!=a._olmDevice.deviceCurve25519Key&&(i.verified!=u.BLOCKED&&l.push(s.encryptMessageForDevice(d.ciphertext,a._userId,a._deviceId,a._olmDevice,e,i,c)))}}return await Promise.all(l).then((()=>d))},o.inherits(l,c.DecryptionAlgorithm),l.prototype.decryptEvent=async function(e){const t=e.getWireContent(),n=t.sender_key,i=t.ciphertext;if(!i)throw new c.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in i))throw new c.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const r=i[this._olmDevice.deviceCurve25519Key];let o;try{o=await this._decryptMessage(n,r)}catch(a){throw new c.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:a})}const s=JSON.parse(o);if(s.recipient!=this._userId)throw new c.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+s.recipient);if(s.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new c.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:s.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(s.sender!=e.getSender())throw new c.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+s.sender,{reported_sender:e.getSender()});if(s.room_id!==e.getRoomId())throw new c.DecryptionError("OLM_BAD_ROOM","Message intended for room "+s.room_id,{reported_room:e.room_id});return{clearEvent:s,senderCurve25519Key:n,claimedEd25519Key:(s.keys||{}).ed25519||null}},l.prototype._decryptMessage=async function(e,t){if(0!==t.type)return this._reallyDecryptMessage(e,t);{const n=this._olmDevice._olmPrekeyPromise.then((()=>this._reallyDecryptMessage(e,t)));return this._olmDevice._olmPrekeyPromise=n.catch((()=>{})),await n}},l.prototype._reallyDecryptMessage=async function(e,t){const n=await this._olmDevice.getSessionIdsForDevice(e),i={};for(let a=0;a<n.length;a++){const o=n[a];try{const n=await this._olmDevice.decryptMessage(e,o,t.type,t.body);return r.logger.log("Decrypted Olm message from "+e+" with session "+o),n}catch(s){if(await this._olmDevice.matchesSession(e,o,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+o+": "+s.message);i[o]=s.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let o;try{o=await this._olmDevice.createInboundSession(e,t.type,t.body)}catch(s){throw i["(new)"]=s.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return r.logger.log("created new inbound Olm session ID "+o.session_id+" with "+e),o.payload},(0,c.registerAlgorithm)(s.OLM_ALGORITHM,d,l)},sFvr:function(e,t,n){"use strict";var i=n("Dlk0"),r=n("uZMU"),o=i(n("dZ+v")),s=i(n("n/Lb")),a=n("cAsW"),c=n("ye32");function u(e,t=!1){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={},this.sharedHistory=t}function d(e){(0,o.polyfillSuper)(this,a.EncryptionAlgorithm,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function l(e){(0,o.polyfillSuper)(this,a.DecryptionAlgorithm,e),this._pendingEvents={},this.olmlib=s}u.prototype.needsRotation=function(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(r.logger.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)},u.prototype.markSharedWithDevice=function(e,t,n){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=n},u.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},u.prototype.sharedWithTooManyDevices=function(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return r.logger.log("Starting new megolm session because we shared with "+t),!0;for(const n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return r.logger.log("Starting new megolm session because we shared with "+t+":"+n),!0}},o.inherits(d,a.EncryptionAlgorithm),d.prototype._ensureOutboundSession=async function(e,t,n,i){let o;function a(){return o}const c=this._setupPromise.then((async a=>{o=a;const c=function(e){const t=e.currentState&&e.currentState.getStateEvents("m.room.history_visibility",""),n=t&&t.getContent()&&t.getContent().history_visibility;return["world_readable","shared"].includes(n)}(e);o&&c!==o.sharedHistory&&(o=null),o&&o.needsRotation(this._sessionRotationPeriodMsgs,this._sessionRotationPeriodMs)&&(r.logger.log("Starting new megolm session because we need to rotate."),o=null),o&&o.sharedWithTooManyDevices(t)&&(o=null),o||(r.logger.log(`Starting new megolm session for room ${this._roomId}`),o=await this._prepareNewSession(c),r.logger.log(`Started new megolm session ${o.sessionId} for room ${this._roomId}`),this._outboundSessions[o.sessionId]=o);const u={};for(const[e,n]of Object.entries(t))for(const[t,i]of Object.entries(n)){i.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(o.sharedWithDevices[e]&&void 0!==o.sharedWithDevices[e][t]||(u[e]=u[e]||[],u[e].push(i)))}const d=this._olmDevice.getOutboundGroupSessionKey(o.sessionId),l={type:"m.room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:o.sessionId,session_key:d.key,chain_index:d.chain_index,"org.matrix.msc3061.shared_history":c}},[h,g]=await s.getExistingOlmSessions(this._olmDevice,this._baseApis,u);await Promise.all([(async()=>{r.logger.debug(`Sharing keys with existing Olm sessions in ${this._roomId}`),await this._shareKeyWithOlmSessions(o,d,l,g),r.logger.debug(`Shared keys with existing Olm sessions in ${this._roomId}`)})(),(async()=>{r.logger.debug(`Sharing keys (start phase 1) with new Olm sessions in ${this._roomId}`);const e=[],t=Date.now(),n=[];await this._shareKeyWithDevices(o,d,l,h,e,i?1e4:2e3,n),r.logger.debug(`Shared keys (end phase 1) with new Olm sessions in ${this._roomId}`),!i&&Date.now()-t<1e4?(async()=>{const t={},i=new Set;for(const e of n)i.add(e);const s=[];for(const{userId:n,deviceInfo:r}of e){const e=n.slice(n.indexOf(":")+1);i.has(e)?(t[n]=t[n]||[],t[n].push(r)):s.push({userId:n,deviceInfo:r})}r.logger.debug(`Sharing keys (start phase 2) with new Olm sessions in ${this._roomId}`),await this._shareKeyWithDevices(o,d,l,t,s,3e4),r.logger.debug(`Shared keys (end phase 2) with new Olm sessions in ${this._roomId}`),await this._notifyFailedOlmDevices(o,d,s)})():await this._notifyFailedOlmDevices(o,d,e),r.logger.debug(`Shared keys (all phases done) with new Olm sessions in ${this._roomId}`)})(),(async()=>{r.logger.debug(`Notifying blocked devices in ${this._roomId}`);const e={};let t=0;for(const[i,r]of Object.entries(n))for(const[n,s]of Object.entries(r))o.blockedDevicesNotified[i]&&void 0!==o.blockedDevicesNotified[i][n]||(e[i]=e[i]||{},e[i][n]={device:s},t++);await this._notifyBlockedDevices(o,e),r.logger.debug(`Notified ${t} blocked devices in ${this._roomId}`)})()])}));return c.catch((e=>{r.logger.error(`Failed to ensure outbound session in ${this._roomId}`,e)})),this._setupPromise=c.then(a,a),c.then(a)},d.prototype._prepareNewSession=async function(e){const t=this._olmDevice.createOutboundGroupSession(),n=this._olmDevice.getOutboundGroupSessionKey(t);return await this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],t,n.key,{ed25519:this._olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],t,n.key),new u(t,e)},d.prototype._getDevicesWithoutSessions=function(e,t,n){n=n||[];for(const[i,r]of Object.entries(t)){const t=e[i];for(const e of r){const r=e.deviceId;t[r].sessionId||(n.push({userId:i,deviceInfo:e}),delete t[r])}}return n},d.prototype._splitDevices=function(e){let t=[];const n=[t];for(const[i,r]of Object.entries(e)){for(const e of Object.values(r))t.push({userId:i,deviceInfo:e.device});t.length>20&&(t=[],n.push(t))}return 0===t.length&&n.pop(),n},d.prototype._encryptAndSendKeysToDevices=function(e,t,n,i){const o={},a=[];for(let r=0;r<n.length;r++){const e={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},t=n[r],c=t.userId,u=t.deviceInfo,d=u.deviceId;o[c]||(o[c]={}),o[c][d]=e,a.push(s.encryptMessageForDevice(e.ciphertext,this._userId,this._deviceId,this._olmDevice,c,u,i))}return Promise.all(a).then((()=>{for(const e of Object.keys(o)){for(const t of Object.keys(o[e]))0===Object.keys(o[e][t].ciphertext).length&&(r.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete o[e][t]);0===Object.keys(o[e]).length&&(r.logger.log("Pruned all devices for user "+e),delete o[e])}if(0!==Object.keys(o).length)return this._baseApis.sendToDevice("m.room.encrypted",o).then((()=>{for(const n of Object.keys(o))for(const i of Object.keys(o[n]))e.markSharedWithDevice(n,i,t)}));r.logger.log("No users left to send to: aborting")}))},d.prototype._sendBlockedNotificationsToDevices=async function(e,t,n){const i={};for(const r of t){const e=r.userId,t=r.deviceInfo,o=t.deviceInfo.deviceId,s=Object.assign({},n);s.code=t.code,s.reason=t.reason,"m.no_olm"===s.code&&(delete s.room_id,delete s.session_id),i[e]||(i[e]={}),i[e][o]=s}await this._baseApis.sendToDevice("org.matrix.room_key.withheld",i);for(const r of Object.keys(i))for(const t of Object.keys(i[r]))e.markNotifiedBlockedDevice(r,t)},d.prototype.reshareKeyWithDevice=async function(e,t,n,i){const o=this._outboundSessions[t];if(!o)return void r.logger.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===o.sharedWithDevices[n])return void r.logger.debug(`megolm session ${t} never shared with user ${n}`);const a=o.sharedWithDevices[n][i.deviceId];if(void 0===a)return void r.logger.debug("megolm session ID "+t+" never shared with device "+n+":"+i.deviceId);const c=await this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,a);if(!c)return void r.logger.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[n]:[i]});const u={type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},d={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,n,i,u),await this._baseApis.sendToDevice("m.room.encrypted",{[n]:{[i.deviceId]:d}}),r.logger.debug(`Re-shared key for megolm session ${t} with ${n}:${i.deviceId}`)},d.prototype._shareKeyWithDevices=async function(e,t,n,i,o,a,c){r.logger.debug(`Ensuring Olm sessions for devices in ${this._roomId}`);const u=await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,i,a,c,r.logger.withPrefix(`[${this._roomId}]`));r.logger.debug(`Ensured Olm sessions for devices in ${this._roomId}`),this._getDevicesWithoutSessions(u,i,o),r.logger.debug(`Sharing keys with Olm sessions in ${this._roomId}`),await this._shareKeyWithOlmSessions(e,t,n,u),r.logger.debug(`Shared keys with Olm sessions in ${this._roomId}`)},d.prototype._shareKeyWithOlmSessions=async function(e,t,n,i){const o=this._splitDevices(i);for(let a=0;a<o.length;a++){const i=`megolm keys for ${e.sessionId} in ${this._roomId} (slice ${a+1}/${o.length})`;try{r.logger.debug(`Sharing ${i}`),await this._encryptAndSendKeysToDevices(e,t.chain_index,o[a],n),r.logger.debug(`Shared ${i}`)}catch(s){throw r.logger.error(`Failed to share ${i}`),s}}},d.prototype._notifyFailedOlmDevices=async function(e,t,n){r.logger.debug(`Notifying ${n.length} devices we failed to create Olm sessions in ${this._roomId}`);for(const{userId:r,deviceInfo:s}of n){const n=s.deviceId;e.markSharedWithDevice(r,n,t.chain_index)}const i=await this._olmDevice.filterOutNotifiedErrorDevices(n);r.logger.debug(`Filtered down to ${i.length} error devices in ${this._roomId}`);const o={};for(const{userId:r,deviceInfo:s}of i)o[r]=o[r]||{},o[r][s.deviceId]={device:{code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:s}};await this._notifyBlockedDevices(e,o),r.logger.debug(`Notified ${i.length} devices we failed to create Olm sessions in ${this._roomId}`)},d.prototype._notifyBlockedDevices=async function(e,t){const n={room_id:this._roomId,session_id:e.sessionId,algorithm:s.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},i=this._splitDevices(t);for(let s=0;s<i.length;s++)try{await this._sendBlockedNotificationsToDevices(e,i[s],n),r.logger.log(`Completed blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${s+1}/${i.length})`)}catch(o){throw r.logger.log(`blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${s+1}/${i.length}) failed`),o}},d.prototype.prepareToEncrypt=function(e){if(this.encryptionPreparation){const e=Date.now()-this.encryptionPreparationMetadata.startTime;r.logger.debug(`Already started preparing to encrypt for ${this._roomId} ${e} ms ago, skipping`)}else r.logger.debug(`Preparing to encrypt events for ${this._roomId}`),this.encryptionPreparationMetadata={startTime:Date.now()},this.encryptionPreparation=(async()=>{try{r.logger.debug(`Getting devices in ${this._roomId}`);const[t,n]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._removeUnknownDevices(t),r.logger.debug(`Ensuring outbound session in ${this._roomId}`),await this._ensureOutboundSession(e,t,n,!0),r.logger.debug(`Ready to encrypt events for ${this._roomId}`)}catch(t){r.logger.error(`Failed to prepare to encrypt events for ${this._roomId}`,t)}finally{delete this.encryptionPreparationMetadata,delete this.encryptionPreparation}})()},d.prototype.encryptMessage=async function(e,t,n){if(r.logger.log(`Starting to encrypt event for ${this._roomId}`),this.encryptionPreparation)try{await this.encryptionPreparation}catch(l){}const[i,o]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._checkForUnknownDevices(i);const a=await this._ensureOutboundSession(e,i,o),c={room_id:this._roomId,type:t,content:n},u=this._olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),d={algorithm:s.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:u,session_id:a.sessionId,device_id:this._deviceId};return a.useCount++,d},d.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then((()=>null))},d.prototype._checkForUnknownDevices=function(e){const t={};if(Object.keys(e).forEach((n=>{Object.keys(e[n]).forEach((i=>{const r=e[n][i];r.isUnverified()&&!r.isKnown()&&(t[n]||(t[n]={}),t[n][i]=r)}))})),Object.keys(t).length)throw new a.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},d.prototype._removeUnknownDevices=function(e){for(const[t,n]of Object.entries(e)){for(const[e,t]of Object.entries(n))t.isUnverified()&&!t.isKnown()&&delete n[e];0===Object.keys(n).length&&delete e[t]}},d.prototype._getDevicesInRoom=async function(e){const t=await e.getEncryptionTargetMembers(),n=o.map(t,(function(e){return e.userId}));let i=this._crypto.getGlobalBlacklistUnverifiedDevices();"boolean"===typeof e.getBlacklistUnverifiedDevices()&&(i=e.getBlacklistUnverifiedDevices());const r=await this._crypto.downloadKeys(n,!1),s={};for(const o in r){if(!r.hasOwnProperty(o))continue;const e=r[o];for(const t in e){if(!e.hasOwnProperty(t))continue;const n=this._crypto.checkDeviceTrust(o,t);if(e[t].isBlocked()||!n.isVerified()&&i){s[o]||(s[o]={});const n=e[t].isBlocked()?{code:"m.blacklisted",reason:c.WITHHELD_MESSAGES["m.blacklisted"]}:{code:"m.unverified",reason:c.WITHHELD_MESSAGES["m.unverified"]};n.deviceInfo=e[t],s[o][t]=n,delete e[t]}}}return[r,s]},o.inherits(l,a.DecryptionAlgorithm);const h={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};l.prototype.decryptEvent=async function(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this._addEventToPendingList(e);try{n=await this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(r){if("DecryptionError"===r.name)throw r;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw r&&"OLM.UNKNOWN_MESSAGE_INDEX"===r.message&&(this._requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new a.DecryptionError(n,r?r.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this._requestKeysForEvent(e);const n=await this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){let e=h[n.type]||h.unknown;throw n.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this._removeEventFromPendingList(e);const i=JSON.parse(n.result);if(i.room_id!==e.getRoomId())throw new a.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+i.room_id);return{clearEvent:i,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}},l.prototype._requestKeysForEvent=function(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)},l.prototype._addEventToPendingList=function(e){const t=e.getWireContent(),n=t.sender_key,i=t.session_id;this._pendingEvents[n]||(this._pendingEvents[n]=new Map);const r=this._pendingEvents[n];r.has(i)||r.set(i,new Set),r.get(i).add(e)},l.prototype._removeEventFromPendingList=function(e){const t=e.getWireContent(),n=t.sender_key,i=t.session_id,r=this._pendingEvents[n],o=r&&r.get(i);o&&(o.delete(e),0===o.size&&r.delete(n),0===r.size&&delete this._pendingEvents[n])},l.prototype.onRoomKeyEvent=function(e){const t=e.getContent(),n=t.session_id;let i,s=e.getSenderKey(),a=[],c=!1;if(!t.room_id||!n||!t.session_key)return void r.logger.error("key event is missing fields");if(!s)return void r.logger.error("key event has no sender key (not encrypted?)");if("m.forwarded_room_key"==e.getType()){if(c=!0,a=t.forwarding_curve25519_key_chain,o.isArray(a)||(a=[]),a=a.slice(),a.push(s),s=t.sender_key,!s)return void r.logger.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void r.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");i={ed25519:e}}else i=e.getKeysClaimed();const u={};return t["org.matrix.msc3061.shared_history"]&&(u.sharedHistory=!0),this._olmDevice.addInboundGroupSession(t.room_id,s,a,n,t.session_key,i,c,u).then((()=>{this._retryDecryption(s,n).then((e=>{e&&this._crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:s})}))})).then((()=>{this._crypto.backupGroupSession(t.room_id,s,a,t.session_id,t.session_key,i,c)})).catch((e=>{r.logger.error(`Error handling m.room_key_event: ${e}`)}))},l.prototype.onRoomKeyWithheldEvent=async function(e){const t=e.getContent(),n=t.sender_key;if("m.no_olm"===t.code){const i=e.getSender();if(r.logger.warn(`${i}:${n} was unable to establish an olm session with us`),await this._olmDevice.getSessionIdForDevice(n))return r.logger.debug("New session already created.  Not creating a new one."),await this._olmDevice.recordSessionProblem(n,"no_olm",!0),void this.retryDecryptionFromSender(n);let o=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!o&&(await this._crypto.downloadKeys([i],!1),o=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,n),!o))return r.logger.info("Couldn't find device for identity key "+n+": not establishing session"),await this._olmDevice.recordSessionProblem(n,"no_olm",!1),void this.retryDecryptionFromSender(n);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[i]:[o]},!1);const a={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(a.ciphertext,this._userId,this._deviceId,this._olmDevice,i,o,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(n,"no_olm",!0),this.retryDecryptionFromSender(n),await this._baseApis.sendToDevice("m.room.encrypted",{[i]:{[o.deviceId]:a}})}else await this._olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason)},l.prototype.hasKeysForKeyRequest=function(e){const t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},l.prototype.shareKeysWithDevice=function(e){const t=e.userId,n=e.deviceId,i=this._crypto.getStoredDevice(t,n),o=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[t]:[i]}).then((e=>e[t][n].sessionId?(r.logger.log("sharing keys for session "+o.sender_key+"|"+o.session_id+" with device "+t+":"+n),this._buildKeyForwardingMessage(o.room_id,o.sender_key,o.session_id)):null)).then((e=>{const r={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(r.ciphertext,this._userId,this._deviceId,this._olmDevice,t,i,e).then((()=>{const e={[t]:{[n]:r}};return this._baseApis.sendToDevice("m.room.encrypted",e)}))}))},l.prototype._buildKeyForwardingMessage=async function(e,t,n){const i=await this._olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:i.sender_claimed_ed25519_key,session_id:n,session_key:i.key,chain_index:i.chain_index,forwarding_curve25519_key_chain:i.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":i.shared_history||!1}}},l.prototype.importRoomKey=function(e,t={}){const n={};return t.untrusted&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((()=>{"backup"!==t.source&&this._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch((e=>{r.logger.log("Failed to back up megolm session",e)})),this._retryDecryption(e.sender_key,e.session_id)}))},l.prototype._retryDecryption=async function(e,t){const n=this._pendingEvents[e];if(!n)return!0;const i=n.get(t);return!i||(r.logger.debug("Retrying decryption on events",[...i]),await Promise.all([...i].map((async e=>{try{await e.attemptDecryption(this._crypto,!0)}catch(t){}}))),!(this._pendingEvents[e]||{})[t])},l.prototype.retryDecryptionFromSender=async function(e){const t=this._pendingEvents[e];return!t||(delete this._pendingEvents[e],await Promise.all([...t].map((async([e,t])=>{await Promise.all([...t].map((async e=>{try{await e.attemptDecryption(this._crypto)}catch(t){}})))}))),!this._pendingEvents[e])},l.prototype.sendSharedHistoryInboundSessions=async function(e){await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,e),r.logger.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this._olmDevice.getSharedHistoryInboundGroupSessions(this._roomId);r.logger.log("shared-history sessions",t);for(const[n,i]of t){const t=await this._buildKeyForwardingMessage(this._roomId,n,i),o=[],a={};for(const[n,i]of Object.entries(e)){a[n]={};for(const e of i){const i={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};a[n][e.deviceId]=i,o.push(s.encryptMessageForDevice(i.ciphertext,this._userId,this._deviceId,this._olmDevice,n,e,t))}}await Promise.all(o);for(const e of Object.keys(a)){for(const t of Object.keys(a[e]))0===Object.keys(a[e][t].ciphertext).length&&(r.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete a[e][t]);0===Object.keys(a[e]).length&&(r.logger.log("Pruned all devices for user "+e),delete a[e])}if(0===Object.keys(a).length)return void r.logger.log("No users left to send to: aborting");await this._baseApis.sendToDevice("m.room.encrypted",a)}},(0,a.registerAlgorithm)(s.MEGOLM_ALGORITHM,d,l)},stot:function(e,t,n){"use strict";var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.WebStorageSessionStore=s;var r=i(n("dZ+v"));n("uZMU");const o="session.e2e.";function s(e){if(this.store=e,!r.isFunction(e.getItem)||!r.isFunction(e.setItem)||!r.isFunction(e.removeItem)||!r.isFunction(e.key)||"number"!==typeof e.length)throw new Error("Supplied webStore does not meet the WebStorage API interface")}s.prototype={removeEndToEndAccount:function(){this.store.removeItem(a)},getEndToEndAccount:function(){return this.store.getItem(a)},getAllEndToEndDevices:function(){const e=l(""),t={};for(let n=0;n<this.store.length;++n){const i=this.store.key(n),r=i.substr(e.length);i.startsWith(e)&&(t[r]=p(this.store,i))}return t},getEndToEndDeviceTrackingStatus:function(){return p(this.store,u)},getEndToEndDeviceSyncToken:function(){return p(this.store,c)},removeEndToEndDeviceData:function(){y(this.store,l("")),y(this.store,u),y(this.store,c)},getEndToEndSessions:function(e){return p(this.store,h(e))},getAllEndToEndSessions:function(){const e=f(this.store,h("")),t={};for(const n of e){t[n.substr(h("").length)]=p(this.store,n)}return t},removeAllEndToEndSessions:function(){y(this.store,h(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=o+"inboundgroupsessions/",t=[];for(let n=0;n<this.store.length;n++){const i=this.store.key(n);i.startsWith(e)&&t.push({senderKey:i.substr(e.length,43),sessionId:i.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const n=function(e,t){return o+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(n)},removeAllEndToEndInboundGroupSessions:function(){y(this.store,o+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=f(this.store,g("")),t={};for(const n of e){t[n.substr(g("").length)]=p(this.store,n)}return t},removeAllEndToEndRooms:function(){y(this.store,g(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(d,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(d)}};const a=o+"account",c=o+"device_sync_token",u=o+"device_tracking",d=o+"trusted_backup_pubkey";function l(e){return o+"devices/"+e}function h(e){return o+"sessions/"+e}function g(e){return o+"rooms/"+e}function p(e,t){try{return JSON.parse(e.getItem(t))}catch(n){m("Failed to get key %s: %s",t,n),m(n.stack)}return null}function f(e,t){const n=[];for(let i=0;i<e.length;++i){const r=e.key(i);r.startsWith(t)&&n.push(r)}return n}function y(e,t){const n=[];for(let i=0;i<e.length;++i){const r=e.key(i);r.startsWith(t)&&n.push(r)}for(const i of n)e.removeItem(i)}function m(){false}},tXqB:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAABGdBTUEAALGPC/xhBQAAAGBJREFUWAnt0rENwCAQBEEMlbsmF2gkWpiEYMlXeg33rO/9x8VvXnzbOa0D9YcSTFAFtG+DCaqA9m0wQRXQvg0mqALat8EEVUD7NpigCmjfBhNUAe3bYIIqoH0bTFAFtN+iZQKGzDcWHgAAAABJRU5ErkJggg=="},"u+qw":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAWCAYAAADafVyIAAAAAXNSR0IArs4c6QAAAP9JREFUSA3tlS0OwjAUx+nHSoYkHIYDbAo04QYINJojoDAoFEguMDcDCE5DsqRrUv4vYWKkW1uFWc3eXn/vo/80ryzLsh3nfG2t5aP2YvA9iqLYtN1xf5KSSykXrrC6rg9oYI4id9d+iE+iS9YFGmOuQoh9nudlF9PlR16dJMlNdgHkT9P0WVWVwSmnfZxrD42N0eCpt8C3yMuVIMQHibck0QTGMiQglqHckjHGYcxig0N45BYk0VspdQ4JiGWgzOr37sfm8PJDgUEirwJeYLhF/5eIZhHXWivMbu1tJwLAK6lokFKBC4wSAy+JiPeimNA1oGPzXNK3sb3BgYAFZz8Xck36KhmGbwAAAABJRU5ErkJggg=="},u8TK:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAslJREFUeNq0ls1qGlEUxyfjxyiGqK34QRDSijvBblKKdNUX6CLgc3TTXZd9gD5CHsAsGrLOqrgUKloUEUJCiVqr0WL86jj9xTuQZpzOTNSehXJn7v2dc+89c/5nR9M0yc6m0+lwOByPx5PJhKHP5/P7/Xt7e4qi2K7dsXAA9+Li4vr6ejAYhEIhweW58HRzcxMMBhOJxMHBgYUncwez2azZbDYajWQyCSIajcqybJizWCw6nQ7ur66u0ul0KpXyer2OHPT7/WKxGIlEMplMIBCwPYTRaFSpVLrdbi6XC4fDxtfaQ2u324VCgV/tkcaS09PTy8tLw/MHDngNvdfraWsZW18N7t4BXEJgkraBATGEqDsgYc7OztY4GdOzAgVQDPXcIGe4VbJF2tiAgAIohrLIdzKSnJG2ZKAAgtUd8DWR704ycv7z2/H743p/bj0NFECwugM+lng87iS0xWxYlao/bn/bzuTzBHvngI1QCWKxmLRV4ybAApepYtSZ1UpgafaTAYIF7qZsUcUsTmU+nUvCvcs1XVbTyfh2sZBVVRQkWVE8pivBUhZ36vU6f9ls1rygfv/y4dNn62Dfvvv4et+kmpbLZXy4rRd7gs/yR3nJtRy43Wrr68l59c1RPu6SxEWrqvv5E48FwU2Jpzz88yh39w9f7d+fV2d6cj558fIw4eDKOJi722UXQqec2FwV1+JoMliil1E+tInL2m6aAgQLnBxQUD4qlLN17LWpOpiI2IG9k1IKXq1WK5VKjkrl7Fe33Zs5mAgQrF5NUW10FeWzD8yz+zQa9jgQUYBg9W+SjaDa6Oq2LgAUQNFq6OlGT4Bqc3Cb04GAAmgU/VW1W0+W0V0Tyfy7pVhblkWIhsbC2LbwmhDWa1tM+53/3njZt46IHXJk2joSb6vVenTraNH8CuWYLG2j5te0fQdKgWRICcOTw/b9jwADAAQ2QoT/R/fQAAAAAElFTkSuQmCC"},uDyi:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAjZJREFUeNrslruvYVEUxq9BQwgRRCIqCo9Co9FqRaJQ0vk3/CF0FAqFRLSKaZQTmXgUlCaCCJF4JB5nfiHj3nvsc7hXqOYrZJ9tr+/bZ521v7U1kiS9PRM/3p6Mpwvobq6YTqftdrvf78/n8+VyyYzZbLZarT6fLxQK2e129XCNyjcYDof1en00GgUCAb/fb7PZoGYemdls1uv1ut2uy+WKx+Nut/trAofDoVartVqtWCwWjUZ1OvGL7vf7ZrPZaDTC4XAikdBqtXcJrNfrYrHIIJ1OG43GmzlcrValUolBJpMxGAw3BNh7oVCwWCypVEq4IyGIqlQqi8Uim83KouRVRGb4FbKfdwoYyP5iMSGXcEUBvip5JzPCvZPu3ycwuP6XEAIJh0RRgJrhqyrlnYKRDWQgkHBIPs1K/zAej3O53G63k5Tx5wSVBYRDMplMLjPvb9DpdKh3pYrcbrflcvnnCVSn4rnV6SDhYApSxFnlNClFkmKPx/PrhOPxqFJRkEAlEMAJOKtKYXq9PhKJ3FOykEAlEMAAzk7wICA5W9YT3VSj0QgEZMrfBiQmk0kggAPjkY8LQAKVQAB/x4EfF4AEKoFAMBjE31Vq/B4QDgmNSCDgcDjwAKHP3A/CIfnY5j5VEb2J7nFtlmCz2eTz+fOYAY/CxkA4JGr9oFqtYkrXto7jDwaDy6PX671eQCNxOp3JZPKlDeflLfMVTf8V15aPoHvQKoQXL44Oxf39i9f/y+8JfwUYAC7VxkY4AvOsAAAAAElFTkSuQmCC"},uHjp:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=o;var i=n("zHs9");function r(e,t,n){const i=t.split(".");let r=e;for(let o=0;o<i.length-1;o++)r[i[o]]||(r[i[o]]={}),r=r[i[o]];r[i[i.length-1]]=n}function o(e,t){this.userId=e,this.filterId=t,this.definition={}}o.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},o.prototype.getFilterId=function(){return this.filterId},o.prototype.getDefinition=function(){return this.definition},o.prototype.setDefinition=function(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new i.FilterComponent(n),this._room_timeline_filter=new i.FilterComponent(t&&t.timeline||{})},o.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},o.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},o.prototype.setTimelineLimit=function(e){r(this.definition,"room.timeline.limit",e)},o.prototype.setLazyLoadMembers=function(e){r(this.definition,"room.state.lazy_load_members",!!e)},o.prototype.setIncludeLeaveRooms=function(e){r(this.definition,"room.include_leave",e)},o.fromJson=function(e,t,n){const i=new o(e,t);return i.setDefinition(n),i}},"utK+":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=void 0;var i=n("uZMU"),r=n("dZ+v");function o(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.SyncAccumulator=class{constructor(e){(e=e||{}).maxTimelineEntries=e.maxTimelineEntries||50,this.opts=e,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}accumulate(e,t){this._accumulateRooms(e,t),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}_accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}_accumulateRooms(e,t){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((n=>{this._accumulateRoom(n,"invite",e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((n=>{this._accumulateRoom(n,"join",e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((n=>{this._accumulateRoom(n,"leave",e.rooms.leave[n],t)})))}_accumulateRoom(e,t,n,r){switch(t){case"invite":this._accumulateInviteState(e,n);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,n,r);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:i.logger.error("Unknown cateogory: ",t)}}_accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let i=0;i<n.invite_state.events.length;i++){const r=n.invite_state.events[i];r.type===e.type&&r.state_key==e.state_key&&(n.invite_state.events[i]=e,t=!0)}t||n.invite_state.events.push(e)}))}_accumulateJoinState(e,t,n){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const i=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{i._accountData[e.type]=e})),t.unread_notifications&&(i._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",r="m.joined_member_count",o=i._summary,s=t.summary;o[e]=s[e]||o[e],o[r]=s[r]||o[r],o[n]=s[n]||o[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach((t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach((n=>{i._readReceipts[n]={data:e.content[t]["m.read"][n],eventId:t}}))}))})),t.timeline&&t.timeline.limited&&(i._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((e=>{o(i._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach(((e,r)=>{let s;if(o(i._currentState,e),n)s=e;else{s=Object.assign({},e),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(s._localTs=Date.now()-t)}i._timeline.push({event:s,token:0===r?t.timeline.prev_batch:null})})),i._timeline.length>this.opts.maxTimelineEntries){for(let e=i._timeline.length-this.opts.maxTimelineEntries;e<i._timeline.length;e++)if(i._timeline[e].token){i._timeline=i._timeline.slice(e,i._timeline.length);break}}}_accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach((t=>{this._accumulateGroup(t,"invite",e.groups.invite[t])})),e.groups.join&&Object.keys(e.groups.join).forEach((t=>{this._accumulateGroup(t,"join",e.groups.join[t])})),e.groups.leave&&Object.keys(e.groups.leave).forEach((t=>{this._accumulateGroup(t,"leave",e.groups.leave[t])})))}_accumulateGroup(e,t,n){for(const i of["invite","join","leave"])delete this.groups[i][e];this.groups[t][e]=n}getJSON(e){const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{const i=this.joinRooms[n],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,summary:i._summary};Object.keys(i._accountData).forEach((e=>{s.account_data.events.push(i._accountData[e])}));const a={type:"m.receipt",room_id:n,content:{}};Object.keys(i._readReceipts).forEach((e=>{const t=i._readReceipts[e];a.content[t.eventId]||(a.content[t.eventId]={"m.read":{}}),a.content[t.eventId]["m.read"][e]=t.data})),Object.keys(a.content).length>0&&s.ephemeral.events.push(a),i._timeline.forEach((t=>{if(!s.timeline.prev_batch){if(!t.token)return;s.timeline.prev_batch=t.token}let n;!e&&t.event._localTs?(n=Object.assign({},t.event),void 0!==n.unsigned&&(n.unsigned=Object.assign({},n.unsigned)),delete n._localTs,n.unsigned=n.unsigned||{},n.unsigned.age=Date.now()-t.event._localTs):n=t.event,s.timeline.events.push(n)}));const c=Object.create(null);for(let e=s.timeline.events.length-1;e>=0;e--){const t=s.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=(0,r.deepCopy)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),o(c,n)}Object.keys(i._currentState).forEach((e=>{Object.keys(i._currentState[e]).forEach((t=>{let n=i._currentState[e][t];c[e]&&c[e][t]&&(n=c[e][t]),s.state.events.push(n)}))})),t.join[n]=s}));const n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,groupsData:this.groups,accountData:n}}getNextBatchToken(){return this.nextBatch}}},"v+fN":function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAASxJREFUeNq8ls0KgzAQhJsoKOihIoKefP/H8qQgYg8KCoodXVEoNNo0mzmUVuh8Zn8jlmV5cEpcAoZh6LpuHMd5nqdpwhPXdR3H8TwvDEPf9zUBeP7aBF/F/0F6bhJC/ADo+76ua3rfO8KZkiQJguAWoGmatm01wh1FURzHF4CqqhBx7ZQiK2mafgVov7viHCcAcS/L0khpZll25GMH4LMoivtZvcx5nudUVzsAkUF8DPYXooRY4Yuk36h3sw18GErqVXU3aQiGsN0B/9SlQmS7AjBnOABkK+k4HACyXQGmqvNDZCsfzJLUFxzWZCtppnMAyHYFYDdxAGjZSZqxHACad5JQxqMEw/MEEJaqWcBhaGtcsy8cGyvTxtK3cW2xcfGycXW0cfk1pbcAAwDYm/L1/RlxjwAAAABJRU5ErkJggg=="},v4tl:function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=h;var r=n("Wy6s"),o=i(n("dZ+v")),s=n("hBZP"),a=n("MFoc"),c=n("40xR"),u=n("D67U"),d=n("MwLI"),l=n("uZMU");function h(t){if(r.MemoryStore.call(this,t),!t.indexedDB)throw new Error("Missing required option: indexedDB");if(t.workerScript){let n=t.workerApi;n||(n=e.Worker),this.backend=new c.RemoteIndexedDBStoreBackend(t.workerScript,t.dbName,n)}else this.backend=new a.LocalIndexedDBStoreBackend(t.indexedDB,t.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function g(e,t){return async function(...n){try{return await e.call(this,...n)}catch(i){l.logger.error("IndexedDBStore failure, degrading to MemoryStore",i),this.emit("degraded",i);try{l.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),l.logger.log("IndexedDBStore delete after degrading succeeeded")}catch(i){l.logger.warn("IndexedDBStore delete after degrading failed",i)}if(Object.setPrototypeOf(this,r.MemoryStore.prototype),t)return await r.MemoryStore.prototype[t].call(this,...n)}}}o.inherits(h,r.MemoryStore),o.extend(h.prototype,s.EventEmitter.prototype),h.exists=function(e,t){return a.LocalIndexedDBStoreBackend.exists(e,t)},h.prototype.startup=function(){return this.startedUp?(l.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(l.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((()=>(l.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{l.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach((([e,t])=>{const n=new u.User(e);t&&n.setPresenceEvent(new d.MatrixEvent(t)),this._userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}))})))},h.prototype.getSavedSync=g((function(){return this.backend.getSavedSync()}),"getSavedSync"),h.prototype.isNewlyCreated=g((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),h.prototype.getSavedSyncToken=g((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),h.prototype.deleteAllData=g((function(){return r.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then((()=>{l.logger.log("Deleted indexeddb data.")}),(e=>{throw l.logger.error(`Failed to delete indexeddb data: ${e}`),e}))})),h.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},h.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},h.prototype._reallySave=g((function(){this._syncTs=Date.now();const e=[];for(const t of this.getUsers())this._userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this._userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),h.prototype.setSyncData=g((function(e){return this.backend.setSyncData(e)}),"setSyncData"),h.prototype.getOutOfBandMembers=g((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),h.prototype.setOutOfBandMembers=g((function(e,t){return r.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),h.prototype.clearOutOfBandMembers=g((function(e){return r.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),h.prototype.getClientOptions=g((function(){return this.backend.getClientOptions()}),"getClientOptions"),h.prototype.storeClientOptions=g((function(e){return r.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this,n("bqPV"))},v61F:function(e,t,n){"use strict";var i,r=n("GIk6"),o=(i=r)&&i.__esModule?i:{default:i};e.exports.loadSkin=function(e){o.default.load(e)},e.exports.resetSkin=function(){o.default.reset()},e.exports.getComponent=function(e){return o.default.getComponent(e)}},vIid:function(e,t,n){"use strict";(function(e){var i=n("cFGl");Object.defineProperty(t,"__esModule",{value:!0}),t.SAS=void 0;var r=n("LLMt"),o=i(n("SBNP")),s=n("nk7+"),a=n("uZMU");const c="m.key.verification.start",u=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let d;const l=(0,s.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),h=(0,s.errorFactory)("m.mismatched_commitment","Mismatched commitment");const g=[["\ud83d\udc36","dog"],["\ud83d\udc31","cat"],["\ud83e\udd81","lion"],["\ud83d\udc0e","horse"],["\ud83e\udd84","unicorn"],["\ud83d\udc37","pig"],["\ud83d\udc18","elephant"],["\ud83d\udc30","rabbit"],["\ud83d\udc3c","panda"],["\ud83d\udc13","rooster"],["\ud83d\udc27","penguin"],["\ud83d\udc22","turtle"],["\ud83d\udc1f","fish"],["\ud83d\udc19","octopus"],["\ud83e\udd8b","butterfly"],["\ud83c\udf37","flower"],["\ud83c\udf33","tree"],["\ud83c\udf35","cactus"],["\ud83c\udf44","mushroom"],["\ud83c\udf0f","globe"],["\ud83c\udf19","moon"],["\u2601\ufe0f","cloud"],["\ud83d\udd25","fire"],["\ud83c\udf4c","banana"],["\ud83c\udf4e","apple"],["\ud83c\udf53","strawberry"],["\ud83c\udf3d","corn"],["\ud83c\udf55","pizza"],["\ud83c\udf82","cake"],["\u2764\ufe0f","heart"],["\ud83d\ude42","smiley"],["\ud83e\udd16","robot"],["\ud83c\udfa9","hat"],["\ud83d\udc53","glasses"],["\ud83d\udd27","spanner"],["\ud83c\udf85","santa"],["\ud83d\udc4d","thumbs up"],["\u2602\ufe0f","umbrella"],["\u231b","hourglass"],["\u23f0","clock"],["\ud83c\udf81","gift"],["\ud83d\udca1","light bulb"],["\ud83d\udcd5","book"],["\u270f\ufe0f","pencil"],["\ud83d\udcce","paperclip"],["\u2702\ufe0f","scissors"],["\ud83d\udd12","lock"],["\ud83d\udd11","key"],["\ud83d\udd28","hammer"],["\u260e\ufe0f","telephone"],["\ud83c\udfc1","flag"],["\ud83d\ude82","train"],["\ud83d\udeb2","bicycle"],["\u2708\ufe0f","aeroplane"],["\ud83d\ude80","rocket"],["\ud83c\udfc6","trophy"],["\u26bd","ball"],["\ud83c\udfb8","guitar"],["\ud83c\udfba","trumpet"],["\ud83d\udd14","bell"],["\u2693\ufe0f","anchor"],["\ud83c\udfa7","headphones"],["\ud83d\udcc1","folder"],["\ud83d\udccc","pin"]];const p={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((e=>g[e]))}};function f(e,t){const n={};for(const i of t)i in p&&(n[i]=p[i](e));return n}const y={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function m(e,t){return function(...n){const i=e[y[t]].apply(e,n);return a.logger.log("SAS calculateMAC:",t,n,i),i}}const v={"curve25519-hkdf-sha256":function(e,t,n){const i=`${e._baseApis.getUserId()}|${e._baseApis.deviceId}|${e.ourSASPubKey}|`,r=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?i+r:r+i)+e._channel.transactionId;return t.generate_bytes(o,n)},curve25519:function(e,t,n){const i=`${e._baseApis.getUserId()}${e._baseApis.deviceId}`,r=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?i+r:r+i)+e._channel.transactionId;return t.generate_bytes(o,n)}},_=["curve25519-hkdf-sha256","curve25519"],S=["sha256"],b=["hkdf-hmac-sha256","hmac-sha256"],A=Object.keys(p),w=new Set(_),E=new Set(S),I=new Set(b),k=new Set(A);function R(e,t){return e instanceof Array?e.filter((e=>t.has(e))):[]}class C extends r.VerificationBase{static get NAME(){return"m.sas.v1"}get events(){return u}async _doVerification(){await e.Olm.init(),d=d||new e.Olm.Utility,await this._baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this._doSendVerification():await this._doRespondVerification()}catch(n){if(!(n instanceof r.SwitchStartEventError))throw n;this.startEvent=n.startEvent,t=!0}}while(t)}canSwitchStartEvent(e){if(e.getType()!==c)return!1;const t=e.getContent();return t&&t.method===C.NAME&&this._waitingForAccept}async _sendStart(){const e=this._channel.completeContent(c,{method:C.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:_,hashes:S,message_authentication_codes:b,short_authentication_string:A});return await this._channel.sendCompleted(c,e),e}async _doSendVerification(){let t,n;if(this._waitingForAccept=!0,t=this.startEvent?this._channel.completedContentFromEvent(this.startEvent):await this._sendStart(),!this.initiatedByMe)throw new r.SwitchStartEventError(this.startEvent);try{n=await this._waitForEvent("m.key.verification.accept")}finally{this._waitingForAccept=!1}let i=n.getContent();const a=R(i.short_authentication_string,k);if(!(w.has(i.key_agreement_protocol)&&E.has(i.hash)&&I.has(i.message_authentication_code)&&a.length))throw(0,s.newUnknownMethodError)();if("string"!==typeof i.commitment)throw(0,s.newInvalidMessageError)();const c=i.key_agreement_protocol,u=i.message_authentication_code,g=i.commitment,p=new e.Olm.SAS;try{this.ourSASPubKey=p.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey}),n=await this._waitForEvent("m.key.verification.key"),i=n.getContent();const e=i.key+o.default.stringify(t);if(d.sha256(e)!==g)throw h();this.theirSASPubKey=i.key,p.set_their_key(i.key);const r=v[c](this,p,6),y=new Promise(((e,t)=>{this.sasEvent={sas:f(r,a),confirm:async()=>{try{await this._sendMAC(p,u),e()}catch(n){t(n)}},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(l())},this.emit("show_sas",this.sasEvent)}));[n]=await Promise.all([this._waitForEvent("m.key.verification.mac").then((e=>(this._expectedEvent="m.key.verification.done",e))),y]),i=n.getContent(),await this._checkMAC(p,i,u)}finally{p.free()}}async _doRespondVerification(){let t=this._channel.completedContentFromEvent(this.startEvent);const n=R(_,new Set(t.key_agreement_protocols))[0],i=R(S,new Set(t.hashes))[0],r=R(b,new Set(t.message_authentication_codes))[0],a=R(t.short_authentication_string,k);if(void 0===n||void 0===i||void 0===r||!a.length)throw(0,s.newUnknownMethodError)();const c=new e.Olm.SAS;try{const e=c.get_pubkey()+o.default.stringify(t);await this._send("m.key.verification.accept",{key_agreement_protocol:n,hash:i,message_authentication_code:r,short_authentication_string:a,commitment:d.sha256(e)});let u=await this._waitForEvent("m.key.verification.key");t=u.getContent(),this.theirSASPubKey=t.key,c.set_their_key(t.key),this.ourSASPubKey=c.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey});const h=v[n](this,c,6),g=new Promise(((e,t)=>{this.sasEvent={sas:f(h,a),confirm:async()=>{try{await this._sendMAC(c,r),e()}catch(n){t(n)}},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(l())},this.emit("show_sas",this.sasEvent)}));[u]=await Promise.all([this._waitForEvent("m.key.verification.mac").then((e=>(this._expectedEvent="m.key.verification.done",e))),g]),t=u.getContent(),await this._checkMAC(c,t,r)}finally{c.free()}}_sendMAC(e,t){const n={},i=[],r="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,o=`ed25519:${this._baseApis.deviceId}`;n[o]=m(e,t)(this._baseApis.getDeviceEd25519Key(),r+o),i.push(o);const s=this._baseApis.getCrossSigningId();if(s){const o=`ed25519:${s}`;n[o]=m(e,t)(s,r+o),i.push(o)}const a=m(e,t)(i.sort().join(","),r+"KEY_IDS");return this._send("m.key.verification.mac",{mac:n,keys:a})}async _checkMAC(e,t,n){const i="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId;if(t.keys!==m(e,n)(Object.keys(t.mac).sort().join(","),i+"KEY_IDS"))throw(0,s.newKeyMismatchError)();await this._verifyKeys(this.userId,t.mac,((t,r,o)=>{if(o!==m(e,n)(r.keys[t],i+t))throw(0,s.newKeyMismatchError)()}))}}t.SAS=C}).call(this,n("bqPV"))},vU4u:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAZCAYAAADqrKTxAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RTA5RDBBMDc3MTNEMTFFNTg0MTdEOEZEMjU0RkJEODgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RTA5RDBBMDg3MTNEMTFFNTg0MTdEOEZEMjU0RkJEODgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpFMDlEMEEwNTcxM0QxMUU1ODQxN0Q4RkQyNTRGQkQ4OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpFMDlEMEEwNjcxM0QxMUU1ODQxN0Q4RkQyNTRGQkQ4OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pruy5mUAAABRSURBVHjanNSxDQAhFMNQs9ltBpv7RMEA35FSPqXLUhlmc9Gg2wIswAIswAIswAIswAIs4KHPYd7SKWgEKZACKZACKZACKZACKXCF3zu/AAMA4hYfXABANu0AAAAASUVORK5CYII="},vlvg:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscovery=void 0;var i=n("uZMU"),r=n("ly6l");class o{static get ERROR_INVALID(){return"Invalid homeserver discovery response"}static get ERROR_GENERIC_FAILURE(){return"Failed to get autodiscovery configuration from server"}static get ERROR_INVALID_HS_BASE_URL(){return"Invalid base_url for m.homeserver"}static get ERROR_INVALID_HOMESERVER(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}static get ERROR_INVALID_IS_BASE_URL(){return"Invalid base_url for m.identity_server"}static get ERROR_INVALID_IDENTITY_SERVER(){return"Identity server URL does not appear to be a valid identity server"}static get ERROR_INVALID_IS(){return"Invalid identity server discovery response"}static get ERROR_MISSING_WELLKNOWN(){return"No .well-known JSON file found"}static get ERROR_INVALID_JSON(){return"Invalid JSON"}static get ALL_ERRORS(){return[o.ERROR_INVALID,o.ERROR_GENERIC_FAILURE,o.ERROR_INVALID_HS_BASE_URL,o.ERROR_INVALID_HOMESERVER,o.ERROR_INVALID_IS_BASE_URL,o.ERROR_INVALID_IDENTITY_SERVER,o.ERROR_INVALID_IS,o.ERROR_MISSING_WELLKNOWN,o.ERROR_INVALID_JSON]}static get FAIL_ERROR(){return"FAIL_ERROR"}static get FAIL_PROMPT(){return"FAIL_PROMPT"}static get PROMPT(){return"PROMPT"}static get SUCCESS(){return"SUCCESS"}static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return i.logger.error("No m.homeserver key in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return i.logger.error("No m.homeserver base_url in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return i.logger.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const r=await this._fetchWellKnownObject(`${n}/_matrix/client/versions`);if(!r||!r.raw.versions)return i.logger.error("Invalid /versions response"),t["m.homeserver"].error=o.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=n,Promise.resolve(t);t["m.homeserver"]={state:o.SUCCESS,error:null,base_url:n};let s="";if(e["m.identity_server"]){const n={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:o.FAIL_PROMPT,error:o.ERROR_INVALID_IS,base_url:null}};if(s=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url),!s)return i.logger.error("Invalid base_url for m.identity_server"),n["m.identity_server"].error=o.ERROR_INVALID_IS_BASE_URL,Promise.resolve(n);const r=await this._fetchWellKnownObject(`${s}/_matrix/identity/api/v1`);if(!r||!r.raw||"SUCCESS"!==r.action)return i.logger.error("Invalid /api/v1 response"),n["m.identity_server"].error=o.ERROR_INVALID_IDENTITY_SERVER,n["m.identity_server"].base_url=s,Promise.resolve(n)}return s&&s.length>0&&(t["m.identity_server"]={state:o.SUCCESS,error:null,base_url:s}),Object.keys(e).map((n=>{if("m.homeserver"===n||"m.identity_server"===n){const i=["error","state","base_url"];for(const r of Object.keys(e[n]))i.includes(r)||(t[n][r]=e[n][r])}else t[n]=e[n]})),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}},n=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&"SUCCESS"===n.action?o.fromDiscoveryConfig(n.raw):(i.logger.error("No response or error when parsing .well-known"),n.reason&&i.logger.error(n.reason),"IGNORE"===n.action?t["m.homeserver"]={state:o.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static _sanitizeWellKnownUrl(e){if(!e)return!1;try{let n=null;try{n=r.URL?new r.URL(e):new URL(e)}catch(t){n=new URL(e)}if(!n||!n.hostname)return!1;if("http:"!==n.protocol&&"https:"!==n.protocol)return!1;const i=n.port?`:${n.port}`:"",o=n.pathname?n.pathname:"";let s=`${n.protocol}//${n.hostname}${i}${o}`;return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(t){return i.logger.error(t),!1}}static async _fetchWellKnownObject(e){return new Promise((function(t,i){const r=n("pZw/").getRequest();if(!r)throw new Error("No request library available");r({method:"GET",uri:e,timeout:5e3},((e,n,i)=>{if(e||n&&(n.statusCode<200||n.statusCode>=300)){let i="FAIL_PROMPT",r=(e?e.message:null)||"General failure";return n&&404===n.statusCode&&(i="IGNORE",r=o.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:i,reason:r,error:e})}try{t({raw:JSON.parse(i),action:"SUCCESS"})}catch(r){let e=o.ERROR_INVALID;"SyntaxError"===r.name&&(e=o.ERROR_INVALID_JSON),t({raw:{},action:"FAIL_PROMPT",reason:e,error:r})}}))}))}}t.AutoDiscovery=o},vtWn:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchManager=void 0;var i=c(n("snOE")),r=c(n("tZmG")),o=c(n("t3kO")),s=c(n("Zv/C")),a=c(n("2lBV"));function c(e){return e&&e.__esModule?e:{default:e}}t.WatchManager=function(){function e(){(0,s.default)(this,e),this._watchers={}}return(0,a.default)(e,[{key:"watchSetting",value:function(e,t,n){this._watchers[e]||(this._watchers[e]={}),this._watchers[e][t]||(this._watchers[e][t]=[]),this._watchers[e][t].push(n)}},{key:"unwatchSetting",value:function(e){var t=!0,n=!1,i=void 0;try{for(var s,a=(0,o.default)((0,r.default)(this._watchers));!(t=(s=a.next()).done);t=!0){var c=s.value,u=!0,d=!1,l=void 0;try{for(var h,g=(0,o.default)((0,r.default)(this._watchers[c]));!(u=(h=g.next()).done);u=!0)for(var p=h.value,f=void 0;-1!==(f=this._watchers[c][p].indexOf(e));)this._watchers[c][p].splice(f,1)}catch(y){d=!0,l=y}finally{try{!u&&g.return&&g.return()}finally{if(d)throw l}}}}catch(y){n=!0,i=y}finally{try{!t&&a.return&&a.return()}finally{if(n)throw i}}}},{key:"notifyUpdate",value:function(e,t,n,r){if(this._watchers[e]){var s=this._watchers[e],a=[];null!==t&&s[t]&&a.push.apply(a,(0,i.default)(s[t])),s.null&&a.push.apply(a,(0,i.default)(s.null));var c=!0,u=!1,d=void 0;try{for(var l,h=(0,o.default)(a);!(c=(l=h.next()).done);c=!0){(0,l.value)(t,n,r)}}catch(g){u=!0,d=g}finally{try{!c&&h.return&&h.return()}finally{if(u)throw d}}}}}]),e}()},wIGm:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r=n("4ZFb"),o=(i=r)&&i.__esModule?i:{default:i};function s(e,t,n){return{action:"MatrixActions.sync",state:t,prevState:n,matrixClient:e}}function a(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function c(e,t,n){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:n}}function u(e,t){return{action:"MatrixActions.Room",room:t}}function d(e,t,n){return{action:"MatrixActions.Room.tags",room:n}}function l(e,t,n){return{action:"MatrixActions.Room.receipt",event:t,room:n,matrixClient:e}}function h(e,t,n,i,r,o){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:o.liveEvent,isLiveUnfilteredRoomTimelineEvent:n&&o.timeline.getTimelineSet()===n.getUnfilteredTimelineSet()}}function g(e,t,n,i){return{action:"MatrixActions.Room.myMembership",room:t,membership:n,oldMembership:i}}function p(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}t.default={_matrixClientListenersStop:[],start:function(e){this._addMatrixClientListener(e,"sync",s),this._addMatrixClientListener(e,"accountData",a),this._addMatrixClientListener(e,"Room.accountData",c),this._addMatrixClientListener(e,"Room",u),this._addMatrixClientListener(e,"Room.tags",d),this._addMatrixClientListener(e,"Room.receipt",l),this._addMatrixClientListener(e,"Room.timeline",h),this._addMatrixClientListener(e,"Room.myMembership",g),this._addMatrixClientListener(e,"Event.decrypted",p)},_addMatrixClientListener:function(e,t,n){var i=function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];var s=n.apply(void 0,[e].concat(i));s&&o.default.dispatch(s,!0)};e.on(t,i),this._matrixClientListenersStop.push((function(){e.removeListener(t,i)}))},stop:function(){this._matrixClientListenersStop.forEach((function(e){return e()}))}},e.exports=t.default},wWPc:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAIAAAD9b0jDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAIRJREFUeNpi/P//PwO1AeOooaOGooE9T38ef/3nH1iGiZHBUpTFRZodjzgaYMFqFVBnmhoHBwsjkP3jz/9Zt35ANOMSRwNMWA0FugWiEwiAjH//CYgTZSiFALuhwPAC+g7CBjKYGAmIExWmwBgAhhdyhOAXH02no+l0NJ2OGjpqKECAAQB5+7aJxzaN1AAAAABJRU5ErkJggg=="},wrNs:function(e,t,n){"use strict";(function(t){var i=o(n("Zv/C")),r=o(n("2lBV"));function o(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(){(0,i.default)(this,e),this.platform=null}return(0,r.default)(e,[{key:"get",value:function(){return this.platform}},{key:"set",value:function(e){this.platform=e}}]),e}();t.mxPlatformPeg||(t.mxPlatformPeg=new s),e.exports=t.mxPlatformPeg}).call(this,n("bqPV"))},x4mo:function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAIAAADZrBkAAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OEQxRkZCNkY3MzhCMTFFNUIxQ0JDM0MxNzg5ODc2QTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OEQxRkZCNzA3MzhCMTFFNUIxQ0JDM0MxNzg5ODc2QTIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4RDFGRkI2RDczOEIxMUU1QjFDQkMzQzE3ODk4NzZBMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4RDFGRkI2RTczOEIxMUU1QjFDQkMzQzE3ODk4NzZBMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PrIxV3gAAADeSURBVHjajNMxDkYwFAfw9qtNYrGZHEJichEncJiGdHIJswtYDOIQjGYx0e/Jl6Cfvsebmnq/NH1/5VVVTdOUZRl7Udu2FUURhqEzDEPXdbD1KH+m73vXdUVd1+M4tm0LZ0ZR9GiSJNkP0Fqv65rneZqmZVlqW0GDlPLawI4PmLybk2HSagx2l5iB4js1r66UgtnC1ed5Pmdg1j+7SlhbDdQHGzedoUPksyxL0zT2P4GYNZEKo2eNSUbng0lGG0yyR2OVwvM8LFMjX87jOD7eioBu3/ffPNNDBkHwFWAA7PUBaBqtdx8AAAAASUVORK5CYII="},ydg6:function(e,t){e.exports="/_next/static/images/stickerpack-placeholder-9c54c1300d9fc1449662224859a4bb69.png"},ye32:function(e,t,n){"use strict";(function(e){var i=n("Dlk0");Object.defineProperty(t,"__esModule",{value:!0}),t.OlmDevice=c,t.WITHHELD_MESSAGES=void 0;var r=n("uZMU"),o=n("W92I"),s=i(n("qfve"));function a(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}function c(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={},this._olmPrekeyPromise=Promise.resolve()}c.prototype.init=async function(t={}){let n;const i=new e.Olm.Account,{pickleKey:s,fromExportedDevice:a}=t;try{a?(s&&r.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=a.pickleKey,await async function(e,t,n,i){await t.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(n=>{t.storeAccount(n,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:i,sessionId:r}=e,o={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};t.storeEndToEndSession(i,r,o,n)}))})),i.unpickle(n,e.pickledAccount)}(a,this._cryptoStore,this._pickleKey,i)):(s&&(this._pickleKey=s),await async function(e,t,n){await e.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(i=>{e.getAccount(i,(r=>{null!==r?n.unpickle(t,r):(n.create(),r=n.pickle(t),e.storeAccount(i,r))}))}))}(this._cryptoStore,this._pickleKey,i)),n=JSON.parse(i.identity_keys()),this._maxOneTimeKeys=i.max_number_of_one_time_keys()}finally{i.free()}this.deviceCurve25519Key=n.curve25519,this.deviceEd25519Key=n.ed25519},c.getOlmVersion=function(){return e.Olm.get_library_version()},c.prototype._getAccount=function(t,n){this._cryptoStore.getAccount(t,(t=>{const i=new e.Olm.Account;try{i.unpickle(this._pickleKey,t),n(i)}finally{i.free()}}))},c.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},c.prototype.export=async function(){const e={pickleKey:this._pickleKey};return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this._cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this._cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e},c.prototype._getSession=function(e,t,n,i){this._cryptoStore.getEndToEndSession(e,t,n,(e=>{this._unpickleSession(e,i)}))},c.prototype._unpickleSession=function(t,n){const i=new e.Olm.Session;try{i.unpickle(this._pickleKey,t.session);n(Object.assign({},t,{session:i}))}finally{i.free()}},c.prototype._saveSession=function(e,t,n){const i=t.session.session_id(),r=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,i,r,n)},c.prototype._getUtility=function(t){const n=new e.Olm.Utility;try{return t(n)}finally{n.free()}},c.prototype.sign=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(n=>{this._getAccount(n,(n=>{t=n.sign(e)}))})),t},c.prototype.getOneTimeKeys=async function(){let e;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this._getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e},c.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},c.prototype.markKeysAsPublished=async function(){await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this._getAccount(e,(t=>{t.mark_keys_as_published(),this._storeAccount(e,t)}))}))},c.prototype.generateOneTimeKeys=function(e){return this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this._getAccount(t,(n=>{n.generate_one_time_keys(e),this._storeAccount(t,n)}))}))},c.prototype.generateFallbackKey=async function(){await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this._getAccount(e,(t=>{t.generate_fallback_key(),this._storeAccount(e,t)}))}))},c.prototype.getFallbackKey=async function(){let e;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],(t=>{this._getAccount(t,(t=>{e=JSON.parse(t.fallback_key())}))})),e},c.prototype.createOutboundSession=async function(t,n){let i;return await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(r=>{this._getAccount(r,(o=>{const s=new e.Olm.Session;try{s.create_outbound(o,t,n),i=s.session_id(),this._storeAccount(r,o);const e={session:s,lastReceivedMessageTs:Date.now()};this._saveSession(t,e,r)}finally{s.free()}}))}),r.logger.withPrefix("[createOutboundSession]")),i},c.prototype.createInboundSession=async function(t,n,i){if(0!==n)throw new Error("Need messageType == 0 to create inbound session");let s;return await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ACCOUNT,o.IndexedDBCryptoStore.STORE_SESSIONS],(r=>{this._getAccount(r,(o=>{const a=new e.Olm.Session;try{a.create_inbound_from(o,t,i),o.remove_one_time_keys(a),this._storeAccount(r,o);const e=a.decrypt(n,i),c={session:a,lastReceivedMessageTs:Date.now()};this._saveSession(t,c,r),s={payload:e,session_id:a.session_id()}}finally{a.free()}}))}),r.logger.withPrefix("[createInboundSession]")),s},c.prototype.getSessionIdsForDevice=async function(e){const t=r.logger.withPrefix("[getSessionIdsForDevice]");if(this._sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this._sessionsInProgress[e]}catch(i){}}let n;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this._cryptoStore.getEndToEndSessions(e,t,(e=>{n=Object.keys(e)}))}),t),n},c.prototype.getSessionIdForDevice=async function(e,t,n){const i=await this.getSessionInfoForDevice(e,t,n);if(0===i.length)return null;let r=0;for(let o=1;o<i.length;o++){const e=i[o],t=void 0===e.lastReceivedMessageTs?0:e.lastReceivedMessageTs,n=i[r],s=void 0===n.lastReceivedMessageTs?0:n.lastReceivedMessageTs;(t>s||t===s&&e.sessionId<n.sessionId)&&(r=o)}return i[r].sessionId},c.prototype.getSessionInfoForDevice=async function(e,t,n=r.logger){if(n=n.withPrefix("[getSessionInfoForDevice]"),this._sessionsInProgress[e]&&!t){n.debug(`Waiting for Olm session for ${e} to be created`);try{await this._sessionsInProgress[e]}catch(s){}}const i=[];return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(t=>{this._cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const n of t)this._unpickleSession(e[n],(e=>{i.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})}))}))}),n),i},c.prototype.encryptMessage=async function(e,t,n){let i;return a(n),await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_SESSIONS],(o=>{this._getSession(e,t,o,(s=>{const a=s.session.describe();r.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),i=s.session.encrypt(n),this._saveSession(e,s,o)}))}),r.logger.withPrefix("[encryptMessage]")),i},c.prototype.decryptMessage=async function(e,t,n,i){let s;return await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_SESSIONS],(o=>{this._getSession(e,t,o,(a=>{const c=a.session.describe();r.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(n,i),a.lastReceivedMessageTs=Date.now(),this._saveSession(e,a,o)}))}),r.logger.withPrefix("[decryptMessage]")),s},c.prototype.matchesSession=async function(e,t,n,i){if(0!==n)return!1;let s;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],(n=>{this._getSession(e,t,n,(e=>{s=e.session.matches_inbound(i)}))}),r.logger.withPrefix("[matchesSession]")),s},c.prototype.recordSessionProblem=async function(e,t,n){await this._cryptoStore.storeEndToEndSessionProblem(e,t,n)},c.prototype.sessionMayHaveProblems=async function(e,t){return await this._cryptoStore.getEndToEndSessionProblem(e,t)},c.prototype.filterOutNotifiedErrorDevices=async function(e){return await this._cryptoStore.filterOutNotifiedErrorDevices(e)},c.prototype._saveOutboundGroupSession=function(e){const t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},c.prototype._getOutboundGroupSession=function(t,n){const i=this._outboundGroupSessionStore[t];if(void 0===i)throw new Error("Unknown outbound group session "+t);const r=new e.Olm.OutboundGroupSession;try{return r.unpickle(this._pickleKey,i),n(r)}finally{r.free()}},c.prototype.createOutboundGroupSession=function(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this._saveOutboundGroupSession(t),t.session_id()}finally{t.free()}},c.prototype.encryptGroupMessage=function(e,t){const n=this;return r.logger.log(`encrypting msg with megolm session ${e}`),a(t),this._getOutboundGroupSession(e,(function(e){const i=e.encrypt(t);return n._saveOutboundGroupSession(e),i}))},c.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},c.prototype._unpickleInboundGroupSession=function(t,n){const i=new e.Olm.InboundGroupSession;try{return i.unpickle(this._pickleKey,t.session),n(i)}finally{i.free()}},c.prototype._getInboundGroupSession=function(e,t,n,i,r){this._cryptoStore.getEndToEndInboundGroupSession(t,n,i,((t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this._unpickleInboundGroupSession(t,(e=>{r(e,t,n)}))}else r(null,null,n)}))},c.prototype.addInboundGroupSession=async function(t,n,i,s,a,c,u,d={}){await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,o.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(o=>{this._getInboundGroupSession(t,n,s,o,((l,h)=>{const g=new e.Olm.InboundGroupSession;try{if(u?g.import_session(a):g.create(a),s!=g.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(l&&(r.logger.log("Update for megolm session "+n+"/"+s),l.first_known_index()<=g.first_known_index()&&(l.first_known_index()!=g.first_known_index()||d.untrusted||!h.untrusted)))return void r.logger.log(`Keeping existing megolm session ${s}`);r.logger.info("Storing megolm session "+n+"/"+s+" with first index "+g.first_known_index());const e=Object.assign({},d,{room_id:t,session:g.pickle(this._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:i});this._cryptoStore.storeEndToEndInboundGroupSession(n,s,e,o),!l&&d.sharedHistory&&this._cryptoStore.addSharedHistoryInboundGroupSession(t,n,s,o)}finally{g.free()}}))}),r.logger.withPrefix("[addInboundGroupSession]"))},c.prototype.addInboundGroupSessionWithheld=async function(e,t,n,i,r){await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:i,reason:r},o)}))};const u={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function d(e){return e.code&&e.code in u?u[e.code]:e.reason?e.reason:"decryption key withheld"}t.WITHHELD_MESSAGES=u,c.prototype.decryptGroupMessage=async function(e,t,n,i,a,c){let u,l;if(await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this._getInboundGroupSession(e,t,n,r,((e,o,h)=>{if(null===e)return h&&(l=new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n})),void(u=null);let g;try{g=e.decrypt(i)}catch(f){return void(l=f&&"OLM.UNKNOWN_MESSAGE_INDEX"===f.message&&h?new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n}):f)}let p=g.plaintext;if(void 0===p)p=g;else{const e=t+"|"+n+"|"+g.message_index;if(e in this._inboundGroupSessionMessageIndexes){const t=this._inboundGroupSessionMessageIndexes[e];if(t.id!==a||t.timestamp!==c)return void(l=new Error("Duplicate message index, possible replay attack: "+e))}this._inboundGroupSessionMessageIndexes[e]={id:a,timestamp:c}}o.session=e.pickle(this._pickleKey),this._cryptoStore.storeEndToEndInboundGroupSession(t,n,o,r),u={result:p,keysClaimed:o.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:o.forwardingCurve25519KeyChain||[],untrusted:o.untrusted}}))}),r.logger.withPrefix("[decryptGroupMessage]")),l)throw l;return u},c.prototype.hasInboundSessionKeys=async function(e,t,n){let i;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{this._cryptoStore.getEndToEndInboundGroupSession(t,n,o,(o=>{null!==o?e!==o.room_id?(r.logger.warn(`requested keys for inbound group session ${t}|${n}, with incorrect room_id (expected ${o.room_id}, was ${e})`),i=!1):i=!0:i=!1}))}),r.logger.withPrefix("[hasInboundSessionKeys]")),i},c.prototype.getInboundGroupSessionKey=async function(e,t,n,i){let s;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,o.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this._getInboundGroupSession(e,t,n,r,((e,t)=>{if(null===e)return void(s=null);void 0===i&&(i=e.first_known_index());const n=e.export_session(i),r=(t.keysClaimed||{}).ed25519||null;s={chain_index:i,key:n,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:r,shared_history:t.sharedHistory||!1}}))}),r.logger.withPrefix("[getInboundGroupSessionKey]")),s},c.prototype.exportInboundGroupSession=function(e,t,n){return this._unpickleInboundGroupSession(n,(i=>{const r=i.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:i.export_session(r),forwarding_curve25519_key_chain:i.forwardingCurve25519KeyChain||[],first_known_index:i.first_known_index(),"org.matrix.msc3061.shared_history":n.sharedHistory||!1}}))},c.prototype.getSharedHistoryInboundGroupSessions=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(n=>{t=this._cryptoStore.getSharedHistoryInboundGroupSessions(e,n)}),r.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t},c.prototype.verifySignature=function(e,t,n){this._getUtility((function(i){i.ed25519_verify(e,t,n)}))}}).call(this,n("bqPV"))},ymnI:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.abbreviateUrl=function(e){if(!e)return"";var t=o.default.parse(e);if(!t)return e;if("/"===t.path)return t.host;return e},t.unabbreviateUrl=function(e){if(!e)return"";var t=e;e.startsWith("https://")||(t="https://"+e);return null===o.default.parse(t).hostname?e:t};var i,r=n("ly6l"),o=(i=r)&&i.__esModule?i:{default:i}},zHs9:function(e,t,n){"use strict";function i(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=i,i.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},i.prototype._checkFields=function(e,t,n,i){const r={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.substr(0,n.length)===n}return e===t}(n,e)}},o=this;for(let a=0;a<Object.keys(r).length;a++){const e=Object.keys(r)[a],t=r[e];if(o["not_"+e].filter(t).length>0)return!1;const n=o[e];if(n&&n.length>0){if(!n.some(t))return!1}}const s=this.filter_json.contains_url;return void 0===s||s===i},i.prototype.filter=function(e){return e.filter(this.check,this)},i.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10}},zUyb:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=c(n("PSh9"));t.default=u;var r=n("F41g"),o=c(r),s=c(n("kPC3")),a=c(n("bDtH"));function c(e){return e&&e.__esModule?e:{default:e}}function u(e){var t=u.options,n=t.storeName,c=t.cryptoStoreName,d={useAuthorizationHeader:!0};return a.default&&s.default&&(d.store=new o.default.IndexedDBStore({indexedDB:a.default,dbName:n,localStorage:s.default,workerScript:u.indexedDbWorkerScript})),d.store||(d.store=new r.MemoryStore({localStorage:s.default})),s.default&&(d.sessionStore=new o.default.WebStorageSessionStore(s.default)),a.default&&(d.cryptoStore=new o.default.IndexedDBCryptoStore(a.default,c)),e=(0,i.default)(d,e),o.default.createClient(e)}u.indexedDbWorkerScript=null,u.options={storeName:"riot-web-sync",cryptoStoreName:"matrix-js-sdk:crypto"},e.exports=t.default},zoGq:function(e,t,n){"use strict";function i(){this.fromToken=null}Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=i,i.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,i){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}}}]);